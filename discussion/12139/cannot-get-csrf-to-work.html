---
layout: default
title: 'Cannot get CSRF to work... - Discussion'
---

    <div class="container">
        {% include warning.html %}


<div itemscope itemtype="https://schema.org/Question"><ol class="breadcrumb">
    <li><a href="/">Home</a></li>
    <li><a href="/category/16/security">Security</a></li>
</ol>
<div class="row table-title">
    <div class="col-lg-8 col-md-7 col-sm-6 col-xs-12 wrapper-author">
        <h1 class="" itemprop="name">Cannot get CSRF to work...</h1>
        <div class="visible-xs-block mobile-author">
            <span itemprop="author" itemscope itemtype="https://schema.org/Person"><a href="/user/5743/gnikolopoulos" class="user-moderator-N"><span itemprop="name">George Nikolopoulos</span></a></span>
            <time itemprop="dateCreated" datetime="2016-07-19T15:53:08-07:00">Jul '16</time>
        </div>
    </div>
    <div class="col-lg-4 col-md-5 col-sm-6 hidden-xs text-right wrapper-stats">
        <table class="table-stats" width="100%">
            <tr style="vertical-align: top;">
                <td>
                    <label>Created</label><br>
                    <time itemprop="dateCreated" datetime="2016-07-19T15:53:08-07:00">Jul '16</time>
                </td>
                <td>
                    <label>Last Reply</label><br>Jul '16</td>
                <td>
                    <label>Replies</label><br>
                    <span itemprop="answerCount">6</span>
                </td>
                <td>
                    <label>Views</label><br>592</td>
                <td>
                    <label>Votes</label><br>
                    <span itemprop="upvoteCount">0</span>
                </td>
            </tr>
        </table>
    </div>
</div>
<div class="discussion">
        <div class="row reply-block">
            <div class="col-md-1 col-sm-1 hidden-xs text-center">
                <img src="https://secure.gravatar.com/avatar/a283fd4a491592977f7dc217beaeac4a?s=48&amp;r=pg&amp;d=identicon" class="img-rounded avatar" /><br>
                <span itemprop="author" itemscope itemtype="https://schema.org/Person" class="avatar-name"><a href="/user/5743/gnikolopoulos" class="user-moderator-N"><span itemprop="name">George Nikolopoulos</span></a></span>
                <span class="karma">8.9k</span>
            </div>
            <div class="col-md-11 col-sm-11 col-xs-12 post-body"><div class="posts-date hidden-xs" align="right">
        <a name="C12139" href="#C12139">
        <time class="action-date">Jul '16</time>
    </a>
</div>
<div class="post-content"><div><p>Hi guys,</p>
<p>I am trying to implement CSRF protection to all of my forms, but I cannot seem to be able to make it work.
This is how I declare my field in my form:</p>
<pre><code>$csrf = new Hidden('csrf');
$csrf-&gt;addValidator(new Identical(array(
  'value' =&gt; $this-&gt;security-&gt;getSessionToken(),
  'message' =&gt; 'CSRF validation failed'
)));
$csrf-&gt;clear();
$this-&gt;add($csrf);</code></pre>
<p>And this is how I am rendering it in the view:</p>
<pre><code>{% raw %}{{{% endraw %} form.render('csrf', ['value': security.getToken()]) {% raw %}}}{% endraw %}</code></pre>
<p>And I am using</p>
<pre><code>$this-&gt;request-&gt;isPost() &amp;&amp; $this-&gt;security-&gt;checkToken()</code></pre>
<p>to make sure I am getting a proper call. However, I cannot seem to be able to save a record (using this in a create action), but I am not getting any error messages either....</p>
<p>Any ideas?</p></div>                </div>

                <div class="posts-buttons text-right"><a href="#"  class="btn btn-danger btn-xs" data-cf-modified-0db64d70accceb70fc85c39c-="">
        <span class="glyphicon glyphicon-thumbs-down"></span></a>
    <a href="#"  class="btn btn-success btn-xs" data-cf-modified-0db64d70accceb70fc85c39c-="">
        <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
            </div>
        </div><div itemprop="suggestedAnswer" itemscope itemtype="https://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img src="https://secure.gravatar.com/avatar/1f10cf3015dc4f8e9ff090600b8cf39f?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="https://schema.org/Person">
            <a href="/user/2755/xeleniumz" class="user-moderator-N"><span itemprop="name">xeleniumz</span></a>        </span>
        <br>

        <span class="karma">11.0k</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><a name="C36929" href="#C36929">
                <time itemprop="dateCreated" datetime="2016-07-19T16:29:23-07:00" class="action-date">Jul '16</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>Hello George  , Can you view source in html and check  csrf  value in your form ?</p>
<p>i think csrf should be hidden value because phalcon will check after send request to your controller, pls check on document</p>
<p><a href="https://docs.phalcon.io/en/latest/reference/security.html">https://docs.phalcon.io/en/latest/reference/security.html</a></p></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="36929" data-cf-modified-0db64d70accceb70fc85c39c-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="36929" data-cf-modified-0db64d70accceb70fc85c39c-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
    </div>
</div>
<div itemprop="suggestedAnswer" itemscope itemtype="https://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img src="https://secure.gravatar.com/avatar/a283fd4a491592977f7dc217beaeac4a?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="https://schema.org/Person">
            <a href="/user/5743/gnikolopoulos" class="user-moderator-N"><span itemprop="name">George Nikolopoulos</span></a>        </span>
        <br>

        <span class="karma">8.9k</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><a name="C36935" href="#C36935">
                <time itemprop="dateCreated" datetime="2016-07-20T00:01:17-07:00" class="action-date">Jul '16</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>Hi xeleniumz,</p>
<p>I can see the hidden field in the form just fine, with its value...</p></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="36935" data-cf-modified-0db64d70accceb70fc85c39c-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="36935" data-cf-modified-0db64d70accceb70fc85c39c-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
    </div>
</div>
<div itemprop="suggestedAnswer" itemscope itemtype="https://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img src="https://secure.gravatar.com/avatar/1f10cf3015dc4f8e9ff090600b8cf39f?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="https://schema.org/Person">
            <a href="/user/2755/xeleniumz" class="user-moderator-N"><span itemprop="name">xeleniumz</span></a>        </span>
        <br>

        <span class="karma">11.0k</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><a name="C36943" href="#C36943">
                <time itemprop="dateCreated" datetime="2016-07-20T02:42:38-07:00" class="action-date">Jul '16</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>you want to create csrf form and let user insert csrf value ?</p></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="36943" data-cf-modified-0db64d70accceb70fc85c39c-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="36943" data-cf-modified-0db64d70accceb70fc85c39c-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
    </div>
</div>
<div itemprop="suggestedAnswer" itemscope itemtype="https://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img src="https://secure.gravatar.com/avatar/5915f25e654c4f9e60fe51700cdee683?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="https://schema.org/Person">
            <a href="/user/4769/Izopi4a" class="user-moderator-Y"><span itemprop="name">Izo</span></a>        </span>
        <br>

        <span class="karma">85.5k</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><a name="C36951" href="#C36951">
                <time itemprop="dateCreated" datetime="2016-07-20T03:12:22-07:00" class="action-date">Jul '16</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>do you have any ajax requests between form display and form submision ?</p></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="36951" data-cf-modified-0db64d70accceb70fc85c39c-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="36951" data-cf-modified-0db64d70accceb70fc85c39c-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
    </div>
</div>
<div itemprop="suggestedAnswer" itemscope itemtype="https://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img src="https://secure.gravatar.com/avatar/660e8c9b157b0029b6e0ba24c0ea3eba?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="https://schema.org/Person">
            <a href="/user/4363/lajosbencz" class="user-moderator-N"><span itemprop="name">Lajos Bencz</span></a>        </span>
        <br>

        <span class="karma">77.7k</span></div>
    <div class="col-md-11"><div class="in-reply-to">
                    <a href="#C36951"><span class="glyphicon glyphicon-chevron-up"></span> in reply to
                        <img src="https://secure.gravatar.com/avatar/5915f25e654c4f9e60fe51700cdee683?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" width="24" height="24" />                        Izo                    </a>
                </div><div class="posts-buttons" align="right"><a name="C36957" href="#C36957">
                <time itemprop="dateCreated" datetime="2016-07-20T03:50:04-07:00" class="action-date">Jul '16</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><blockquote>
<p>do you have any ajax requests between form display and form submision ?</p>
</blockquote>
<p>Hey<a href="https://forum.phalcon.io/user/0/Izo"> @Izo</a>,
I'm planning on using CSRF in our project, but there could be ajax requests between page load and submit.
Is there an existing fix/hack for this?</p></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="36957" data-cf-modified-0db64d70accceb70fc85c39c-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="36957" data-cf-modified-0db64d70accceb70fc85c39c-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
    </div>
</div>
<div itemprop="suggestedAnswer" itemscope itemtype="https://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img src="https://secure.gravatar.com/avatar/5915f25e654c4f9e60fe51700cdee683?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="https://schema.org/Person">
            <a href="/user/4769/Izopi4a" class="user-moderator-Y"><span itemprop="name">Izo</span></a>        </span>
        <br>

        <span class="karma">85.5k</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><a name="C36959" href="#C36959">
                <time itemprop="dateCreated" datetime="2016-07-20T04:01:43-07:00" class="action-date">Jul '16</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>kind a .. token should not be deleted after checking, you can see here: <a href="https://forum.phalcon.io/discussion/8093/csrf-problems-on-206">https://forum.phalcon.io/discussion/8093/csrf-problems-on-206</a></p></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="36959" data-cf-modified-0db64d70accceb70fc85c39c-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="36959" data-cf-modified-0db64d70accceb70fc85c39c-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span><span itemprop="upvoteCount">1</span></a></div>
    </div>
</div>
<div itemprop="suggestedAnswer" itemscope itemtype="https://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img src="https://secure.gravatar.com/avatar/5915f25e654c4f9e60fe51700cdee683?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="https://schema.org/Person">
            <a href="/user/4769/Izopi4a" class="user-moderator-Y"><span itemprop="name">Izo</span></a>        </span>
        <br>

        <span class="karma">85.5k</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><a name="C36961" href="#C36961">
                <time itemprop="dateCreated" datetime="2016-07-20T04:23:28-07:00" class="action-date">Jul '16</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>also if it is a must to have this i would use some external source, eather write it myself or use some others like this one.. <a href="https://github.com/schnittstabil/csrf-tokenservice">https://github.com/schnittstabil/csrf-tokenservice</a></p>
<p>its rather simple and doesnt require gazilion amount of knowage.  As someone mension it here <a href="https://github.com/phalcon/forum/issues/194#issuecomment-231327757">https://github.com/phalcon/forum/issues/194#issuecomment-231327757</a> you can check this repo.</p>
<p>Laravel seems to be adding some custom headers, which i think its better, just because you dont have to put any hidden fields and shit. Source here : <a href="https://github.com/laravel/framework/blob/5.0/src/Illuminate/Foundation/Http/Middleware/VerifyCsrfToken.php">https://github.com/laravel/framework/blob/5.0/src/Illuminate/Foundation/Http/Middleware/VerifyCsrfToken.php</a> . Also there implementation is in the routes themselves which i also prefer. docs here: <a href="https://laravel.com/docs/4.2/security">https://laravel.com/docs/4.2/security</a> . </p>
<p>But i am not an expert. I think i preffer google's recapcha. Untless its a banking site, if so none of what i said is valid. </p>
<p>Cheers.</p></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="36961" data-cf-modified-0db64d70accceb70fc85c39c-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="36961" data-cf-modified-0db64d70accceb70fc85c39c-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span><span itemprop="upvoteCount">1</span></a></div>
    </div>
</div>
<div itemprop="suggestedAnswer" itemscope itemtype="https://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img src="https://secure.gravatar.com/avatar/a283fd4a491592977f7dc217beaeac4a?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="https://schema.org/Person">
            <a href="/user/5743/gnikolopoulos" class="user-moderator-N"><span itemprop="name">George Nikolopoulos</span></a>        </span>
        <br>

        <span class="karma">8.9k</span></div>
    <div class="col-md-11"><div class="in-reply-to">
                    <a href="#C36943"><span class="glyphicon glyphicon-chevron-up"></span> in reply to
                        <img src="https://secure.gravatar.com/avatar/1f10cf3015dc4f8e9ff090600b8cf39f?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" width="24" height="24" />                        xeleniumz                    </a>
                </div><div class="posts-buttons" align="right"><a name="C36999" href="#C36999">
                <time itemprop="dateCreated" datetime="2016-07-20T08:56:52-07:00" class="action-date">Jul '16</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><blockquote>
<p>you want to create csrf form and let user insert csrf value ?</p>
</blockquote>
<p>No, the form just creates a hidden field with the value and name inserted, like on the <a href="https://docs.phalcon.io/en/latest/reference/security.html">documentation</a>.</p></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="36999" data-cf-modified-0db64d70accceb70fc85c39c-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="36999" data-cf-modified-0db64d70accceb70fc85c39c-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
    </div>
</div>
<div itemprop="suggestedAnswer" itemscope itemtype="https://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img src="https://secure.gravatar.com/avatar/a283fd4a491592977f7dc217beaeac4a?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="https://schema.org/Person">
            <a href="/user/5743/gnikolopoulos" class="user-moderator-N"><span itemprop="name">George Nikolopoulos</span></a>        </span>
        <br>

        <span class="karma">8.9k</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><span class="action-date action-reply-edit" data-id="37001" data-toggle="modal" data-target="#historyModal">
                edited <span>Jul '16</span>
              </span><br/><a name="C37001" href="#C37001">
                <time itemprop="dateCreated" datetime="2016-07-20T09:01:05-07:00" class="action-date">Jul '16</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>UPDATE:</p>
<p>Now I think I managed to make this work, but another issue came up. I am using the following code in my model in order to insert a timestamp upon creation/update of a record:</p>
<pre><code>public function beforeCreate()
{
    $this-&gt;created = new RawValue('now()');
}

public function beforeUpdate()
{
    $this-&gt;updated = new RawValue('now()');
}</code></pre>
<p>But when I try to submit the form, I get an error saying that created and updated is required, meaning those two functions do not fire...</p>
<p>EDIT: Never mind, this was just a typo in my model...</p></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="37001" data-cf-modified-0db64d70accceb70fc85c39c-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="37001" data-cf-modified-0db64d70accceb70fc85c39c-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
    </div>
</div>
<div itemprop="suggestedAnswer acceptedAnswer" itemscope itemtype="https://schema.org/Answer" class="reply-block row reply-accepted">
    <div class="col-md-1 small" align="center">
        <img src="https://secure.gravatar.com/avatar/a283fd4a491592977f7dc217beaeac4a?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="https://schema.org/Person">
            <a href="/user/5743/gnikolopoulos" class="user-moderator-N"><span itemprop="name">George Nikolopoulos</span></a>        </span>
        <br>

        <span class="karma">8.9k</span><div class="accepted-reply">
                <span class="glyphicon glyphicon-ok"></span>
                Accepted<br>answer
            </div></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><a name="C37063" href="#C37063">
                <time itemprop="dateCreated" datetime="2016-07-22T09:32:17-07:00" class="action-date">Jul '16</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>I ended up using this code, which seems to work just fine:</p>
<pre><code>// CSRF
$this-&gt;add(new Hidden('csrf', array(
  'name'        =&gt; $this-&gt;security-&gt;getTokenKey(),
  'value'       =&gt; $this-&gt;security-&gt;getToken()
)));</code></pre>
<p>Now checkToken() works correctly and my controller stopped complaining...</p></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="37063" data-cf-modified-0db64d70accceb70fc85c39c-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="37063" data-cf-modified-0db64d70accceb70fc85c39c-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span><span itemprop="upvoteCount">1</span></a></div>
    </div>
</div>
<div class="row"><div class="col-md-1 small" align="center"></div>
        <div class="col-md-11 login-comment">
            
        </div></div>
</div><input type="hidden" id="post-id" name="post-id" value="12139" /><div id="suggested-posts"></div>
    <div id="sticky-progress" style='display:none'></div>
</div>
    </div>