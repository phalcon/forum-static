---
layout: default
title: 'Routing performance in Micro app - Discussion'
---

    <div class="container">
        {% include warning.html %}


<div itemscope itemtype="https://schema.org/Question"><ol class="breadcrumb">
    <li><a href="/">Home</a></li>
    <li><a href="/category/13/routing">Routing</a></li>
</ol>
<div class="row table-title">
    <div class="col-lg-8 col-md-7 col-sm-6 col-xs-12 wrapper-author">
        <h1 class="" itemprop="name">Routing performance in Micro app</h1>
        <div class="visible-xs-block mobile-author">
            <span itemprop="author" itemscope itemtype="https://schema.org/Person"><a href="/user/10151/ilogs-sepa" class="user-moderator-N"><span itemprop="name">Stefan</span></a></span>
            <time itemprop="dateCreated" datetime="2017-09-08T13:43:45-07:00">Sep '17</time>
        </div>
    </div>
    <div class="col-lg-4 col-md-5 col-sm-6 hidden-xs text-right wrapper-stats">
        <table class="table-stats" width="100%">
            <tr style="vertical-align: top;">
                <td>
                    <label>Created</label><br>
                    <time itemprop="dateCreated" datetime="2017-09-08T13:43:45-07:00">Sep '17</time>
                </td>
                <td>
                    <label>Last Reply</label><br>Sep '17</td>
                <td>
                    <label>Replies</label><br>
                    <span itemprop="answerCount">5</span>
                </td>
                <td>
                    <label>Views</label><br>875</td>
                <td>
                    <label>Votes</label><br>
                    <span itemprop="upvoteCount">0</span>
                </td>
            </tr>
        </table>
    </div>
</div>
<div class="discussion">
        <div class="row reply-block">
            <div class="col-md-1 col-sm-1 hidden-xs text-center">
                <img  src="https://secure.gravatar.com/avatar/7db67d29ecefe35de0b7bbf2408b51bc?s=48&amp;r=pg&amp;d=identicon" class="img-rounded avatar" /><br>
                <span itemprop="author" itemscope itemtype="https://schema.org/Person" class="avatar-name"><a href="/user/10151/ilogs-sepa" class="user-moderator-N"><span itemprop="name">Stefan</span></a></span>
                <span class="karma">1.0k</span>
            </div>
            <div class="col-md-11 col-sm-11 col-xs-12 post-body"><div class="posts-date hidden-xs" align="right">
        <a name="C16895" href="#C16895">
        <time class="action-date">Sep '17</time>
    </a>
</div>
<div class="post-content"><div><p>Dear valued community and fellow developers!</p>
<p>I am in the process of creating a fairly simple REST API and at the moment this project has about 212 routes.
When doing some basic profiling I noticed that even for actions with complex database queries more than 30% percent of the total execution time for a request is lost even before the correct handler is found and executed.</p>
<p>Some data from the profiling:
<a href="https://owncloud.ilogs.com/index.php/s/dfypBzRyFqmqR3W">webgrind call graph</a>
<a href="https://owncloud.ilogs.com/index.php/s/RHyASAVK8OShGHL">webgrind cost data</a></p>
<p>So as I will get well over 1000 routes - which really is not that much as every GET also is accompanied by an OPTIONS and a HEAD action - I am concerned about performance already.</p>
<p>As it is clear that it is wasted time to completly reinitialize the routing for every new request I tried to cache the (Micro) app object with the help of ACPU but this fails because the object contains some unserializable closures...</p>
<p>I am really looking forward for some advice, thank you for your efforts in advance!</p></div>                </div>

                <div class="posts-buttons text-right"><a href="#"  class="btn btn-danger btn-xs" data-cf-modified-a8d9a0e7ecc5c5386bb9a24b-="">
        <span class="glyphicon glyphicon-thumbs-down"></span></a>
    <a href="#"  class="btn btn-success btn-xs" data-cf-modified-a8d9a0e7ecc5c5386bb9a24b-="">
        <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
            </div>
        </div><div itemprop="suggestedAnswer" itemscope itemtype="https://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img  src="https://secure.gravatar.com/avatar/bcb5cc9f3d1e3c3cab87efd5ac1dc9c7?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="https://schema.org/Person">
            <a href="/user/4525/stamster" class="user-moderator-N"><span itemprop="name">Jonathan Aaron Steel</span></a>        </span>
        <br>

        <span class="karma">79.0k</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><span class="action-date action-reply-edit" data-id="50895" data-toggle="modal" data-target="#historyModal">
                edited <span>Sep '17</span>
              </span><br/><a name="C50895" href="#C50895">
                <time itemprop="dateCreated" datetime="2017-09-08T14:52:41-07:00" class="action-date">Sep '17</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>Post your example route here (i.e. Router configuration). You're not using Micro Collection for your routes? Also, I see you're using Windows OS, have you tried to run tests on GNU/Linux?</p>
<p>And you're not the first one to report performance hit with Phalcon's Router component, I guess that needs to be coded in a better way for that many routes.</p>
<p>Have you considered something like ReactPHP to jump in as a remedy, as Phalcon is &quot;Request/Response framework&quot; too.</p>
<p><a href="https://marcjschmidt.de/blog/2014/02/08/php-high-performance.html">https://marcjschmidt.de/blog/2014/02/08/php-high-performance.html</a></p>
<p><a href="https://gnugat.github.io/2016/04/13/super-speed-sf-react-php.html">https://gnugat.github.io/2016/04/13/super-speed-sf-react-php.html</a></p></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="50895" data-cf-modified-a8d9a0e7ecc5c5386bb9a24b-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="50895" data-cf-modified-a8d9a0e7ecc5c5386bb9a24b-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
    </div>
</div>
<div itemprop="suggestedAnswer" itemscope itemtype="https://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img  src="https://secure.gravatar.com/avatar/a4422d89d7bed6763f236da321a1747f?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="https://schema.org/Person">
            <a href="/user/9683/petermoo" class="user-moderator-N"><span itemprop="name">Peter</span></a>        </span>
        <br>

        <span class="karma">9.7k</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><a name="C50899" href="#C50899">
                <time itemprop="dateCreated" datetime="2017-09-08T20:29:14-07:00" class="action-date">Sep '17</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>If you have a small number of frequently used routes, you can put them at the bottom of the table so they are processed first. That helped in one of my tests.</p>
<p>I also added some code to load only relevant routes. As an example, if the first part of the request is /admin/, only the admin routes are added.</p></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="50899" data-cf-modified-a8d9a0e7ecc5c5386bb9a24b-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="50899" data-cf-modified-a8d9a0e7ecc5c5386bb9a24b-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span><span itemprop="upvoteCount">2</span></a></div>
    </div>
</div>
<div itemprop="suggestedAnswer" itemscope itemtype="https://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img  src="https://secure.gravatar.com/avatar/8da15621865643112c6e3243f2ce4ebe?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="https://schema.org/Person">
            <a href="/user/3812/Jurigag" class="user-moderator-Y"><span itemprop="name">Wojciech Ślawski</span></a>        </span>
        <br>

        <span class="karma">145.0k</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><a name="C50901" href="#C50901">
                <time itemprop="dateCreated" datetime="2017-09-09T06:52:37-07:00" class="action-date">Sep '17</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>Maybe you are using controlles as handlers and not using lazy?</p></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="50901" data-cf-modified-a8d9a0e7ecc5c5386bb9a24b-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="50901" data-cf-modified-a8d9a0e7ecc5c5386bb9a24b-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
    </div>
</div>
<div itemprop="suggestedAnswer" itemscope itemtype="https://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img  src="https://secure.gravatar.com/avatar/7db67d29ecefe35de0b7bbf2408b51bc?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="https://schema.org/Person">
            <a href="/user/10151/ilogs-sepa" class="user-moderator-N"><span itemprop="name">Stefan</span></a>        </span>
        <br>

        <span class="karma">1.0k</span></div>
    <div class="col-md-11"><div class="in-reply-to">
                    <a href="#C50901"><span class="glyphicon glyphicon-chevron-up"></span> in reply to
                        <img  src="https://secure.gravatar.com/avatar/8da15621865643112c6e3243f2ce4ebe?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" width="24" height="24" />                        Wojciech Ślawski                    </a>
                </div><div class="posts-buttons" align="right"><span class="action-date action-reply-edit" data-id="50971" data-toggle="modal" data-target="#historyModal">
                edited <span>Sep '17</span>
              </span><br/><a name="C50971" href="#C50971">
                <time itemprop="dateCreated" datetime="2017-09-12T12:49:12-07:00" class="action-date">Sep '17</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><blockquote>
<p>Maybe you are using controlles as handlers and not using lazy?</p>
</blockquote>
<p>I am quite sure that lazy loading is used, the code for all handlers looks like the following:</p>
<pre><code>    $pathCollection -&gt;setPrefix('/v1/einsatz')
            -&gt;setHandler('\BritApi\Controllers\EinsatzController')
            -&gt;setLazy(true);

    $pathCollection-&gt;options('/', 'optionsBase');
    $pathCollection-&gt;get('/', 'get');
    // $pathCollection-&gt;head('/', 'get');
    $pathCollection-&gt;post('/', 'post');
...
    $app = new \Phalcon\Mvc\Micro($di);
    foreach ($collections as $collection)   $app-&gt;mount($collection);

    $app-&gt;handle();</code></pre></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="50971" data-cf-modified-a8d9a0e7ecc5c5386bb9a24b-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="50971" data-cf-modified-a8d9a0e7ecc5c5386bb9a24b-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
    </div>
</div>
<div itemprop="suggestedAnswer" itemscope itemtype="https://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img  src="https://secure.gravatar.com/avatar/7db67d29ecefe35de0b7bbf2408b51bc?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="https://schema.org/Person">
            <a href="/user/10151/ilogs-sepa" class="user-moderator-N"><span itemprop="name">Stefan</span></a>        </span>
        <br>

        <span class="karma">1.0k</span></div>
    <div class="col-md-11"><div class="in-reply-to">
                    <a href="#C50899"><span class="glyphicon glyphicon-chevron-up"></span> in reply to
                        <img  src="https://secure.gravatar.com/avatar/a4422d89d7bed6763f236da321a1747f?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" width="24" height="24" />                        Peter                    </a>
                </div><div class="posts-buttons" align="right"><span class="action-date action-reply-edit" data-id="50977" data-toggle="modal" data-target="#historyModal">
                edited <span>Sep '17</span>
              </span><br/><a name="C50977" href="#C50977">
                <time itemprop="dateCreated" datetime="2017-09-12T16:28:10-07:00" class="action-date">Sep '17</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><blockquote>
<p>I also added some code to load only relevant routes. As an example, if the first part of the request is /admin/, only the admin routes are added.</p>
</blockquote>
<p>Thank you, as prefix matching is not implemented in Phalcon at the moment I implemented this just as you suggested.
Now, only collections which prefix matches the request URL are mounted.</p>
<p>However, I still think that it would be most efficient if it would be possible to cache the routes or event the whole app object with something like APCU or similar.</p></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="50977" data-cf-modified-a8d9a0e7ecc5c5386bb9a24b-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="50977" data-cf-modified-a8d9a0e7ecc5c5386bb9a24b-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
    </div>
</div>
<div itemprop="suggestedAnswer" itemscope itemtype="https://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img  src="https://secure.gravatar.com/avatar/8da15621865643112c6e3243f2ce4ebe?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="https://schema.org/Person">
            <a href="/user/3812/Jurigag" class="user-moderator-Y"><span itemprop="name">Wojciech Ślawski</span></a>        </span>
        <br>

        <span class="karma">145.0k</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><a name="C51037" href="#C51037">
                <time itemprop="dateCreated" datetime="2017-09-17T23:46:26-07:00" class="action-date">Sep '17</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>It's no point, there will be wasted time for serialize and unserialize. I was testing it, i have around 300-400 routes in my app, no difference between creating each time router and caching it. With caching it was slower even.</p></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="51037" data-cf-modified-a8d9a0e7ecc5c5386bb9a24b-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="51037" data-cf-modified-a8d9a0e7ecc5c5386bb9a24b-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span><span itemprop="upvoteCount">1</span></a></div>
    </div>
</div>
<div itemprop="suggestedAnswer" itemscope itemtype="https://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img  src="https://secure.gravatar.com/avatar/7db67d29ecefe35de0b7bbf2408b51bc?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="https://schema.org/Person">
            <a href="/user/10151/ilogs-sepa" class="user-moderator-N"><span itemprop="name">Stefan</span></a>        </span>
        <br>

        <span class="karma">1.0k</span></div>
    <div class="col-md-11"><div class="in-reply-to">
                    <a href="#C51037"><span class="glyphicon glyphicon-chevron-up"></span> in reply to
                        <img  src="https://secure.gravatar.com/avatar/8da15621865643112c6e3243f2ce4ebe?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" width="24" height="24" />                        Wojciech Ślawski                    </a>
                </div><div class="posts-buttons" align="right"><a name="C51187" href="#C51187">
                <time itemprop="dateCreated" datetime="2017-09-24T13:40:13-07:00" class="action-date">Sep '17</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><blockquote>
<p>It's no point, there will be wasted time for serialize and unserialize. I was testing it, i have around 300-400 routes in my app, no difference between creating each time router and caching it. With caching it was slower even.</p>
</blockquote>
<p>Thank you for testing this and letting us know.
However, I think you agree that there is some optimization potential in route handling.</p></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="51187" data-cf-modified-a8d9a0e7ecc5c5386bb9a24b-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="51187" data-cf-modified-a8d9a0e7ecc5c5386bb9a24b-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
    </div>
</div>
<div itemprop="suggestedAnswer" itemscope itemtype="https://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img  src="https://secure.gravatar.com/avatar/8da15621865643112c6e3243f2ce4ebe?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="https://schema.org/Person">
            <a href="/user/3812/Jurigag" class="user-moderator-Y"><span itemprop="name">Wojciech Ślawski</span></a>        </span>
        <br>

        <span class="karma">145.0k</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><span class="action-date action-reply-edit" data-id="51191" data-toggle="modal" data-target="#historyModal">
                edited <span>Sep '17</span>
              </span><br/><a name="C51191" href="#C51191">
                <time itemprop="dateCreated" datetime="2017-09-25T01:46:00-07:00" class="action-date">Sep '17</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>Yes but not caching stuff. Actually adding routes itself is really fastest part of router.</p></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="51191" data-cf-modified-a8d9a0e7ecc5c5386bb9a24b-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="51191" data-cf-modified-a8d9a0e7ecc5c5386bb9a24b-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
    </div>
</div>
<div class="row"><div class="col-md-1 small" align="center"></div>
        <div class="col-md-11 login-comment">
            
        </div></div>
</div><input type="hidden" id="post-id" name="post-id" value="16895" /><div id="suggested-posts"></div>
    <div id="sticky-progress" style='display:none'></div>
</div>
    </div>