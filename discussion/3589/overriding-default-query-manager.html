---
layout: default
title: 'Overriding default query manager - Discussion'
---

    <div class="container">
        {% include warning.html %}


<div itemscope itemtype="https://schema.org/Question"><ol class="breadcrumb">
    <li><a href="/">Home</a></li>
    <li><a href="/category/21/beginners">Beginners</a></li>
</ol>
<div class="row table-title">
    <div class="col-lg-8 col-md-7 col-sm-6 col-xs-12 wrapper-author">
        <h1 class="" itemprop="name">Overriding default query manager</h1>
        <div class="visible-xs-block mobile-author">
            <span itemprop="author" itemscope itemtype="https://schema.org/Person"><a href="/user/1720/blm14" class="user-moderator-N"><span itemprop="name">blm14</span></a></span>
            <time itemprop="dateCreated" datetime="2014-10-01T10:27:58-07:00">Oct '14</time>
        </div>
    </div>
    <div class="col-lg-4 col-md-5 col-sm-6 hidden-xs text-right wrapper-stats">
        <table class="table-stats" width="100%">
            <tr style="vertical-align: top;">
                <td>
                    <label>Created</label><br>
                    <time itemprop="dateCreated" datetime="2014-10-01T10:27:58-07:00">Oct '14</time>
                </td>
                <td>
                    <label>Last Reply</label><br>Oct '14</td>
                <td>
                    <label>Replies</label><br>
                    <span itemprop="answerCount">3</span>
                </td>
                <td>
                    <label>Views</label><br>873</td>
                <td>
                    <label>Votes</label><br>
                    <span itemprop="upvoteCount">0</span>
                </td>
            </tr>
        </table>
    </div>
</div>
<div class="discussion">
        <div class="row reply-block">
            <div class="col-md-1 col-sm-1 hidden-xs text-center">
                <img src="https://secure.gravatar.com/avatar/82140260df942005abbc598cbba6c688?s=48&amp;r=pg&amp;d=identicon" class="img-rounded avatar" /><br>
                <span itemprop="author" itemscope itemtype="https://schema.org/Person" class="avatar-name"><a href="/user/1720/blm14" class="user-moderator-N"><span itemprop="name">blm14</span></a></span>
                <span class="karma">40.7k</span>
            </div>
            <div class="col-md-11 col-sm-11 col-xs-12 post-body"><div class="posts-date hidden-xs" align="right">
        <a name="C3589" href="#C3589">
        <time class="action-date">Oct '14</time>
    </a>
</div>
<div class="post-content"><div><p>I am building an application which needs to have full auditing. I have already created a ModelBase, ControllerBase and FormBase which allow me to interact with the database to save audit information when child classes are accessed. The problem I am facing now is with PHQL. If I use something like MyModel::find() then methods that MyModel inherits from ModelBase can be called and used and so I get my audit information. But if I do something like </p>
<pre><code class="language-php">$query = $this-&gt;modelsManager-&gt;createQuery("SELECT * from MyModelOne inner join MyModelTwo");
$cars = $query-&gt;execute();</code></pre>
<p>Now $cars is a generic query result without any of my auditing functions built in. Is there some way during dependency injection that I can override all default query objects so that those also include code for auditing?</p></div>                </div>

                <div class="posts-buttons text-right"><a href="#"  class="btn btn-danger btn-xs" data-cf-modified-551f939bd48f504fabb061bb-="">
        <span class="glyphicon glyphicon-thumbs-down"></span></a>
    <a href="#"  class="btn btn-success btn-xs" data-cf-modified-551f939bd48f504fabb061bb-="">
        <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
            </div>
        </div><div itemprop="suggestedAnswer" itemscope itemtype="https://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img src="https://secure.gravatar.com/avatar/5d6f567f9109789fd9f702959768e35d?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="https://schema.org/Person">
            <a href="/user/1/phalcon" class="user-moderator-Y"><span itemprop="name">Phalcon</span></a>        </span>
        <br>

        <span class="karma">98.9k</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><a name="C11814" href="#C11814">
                <time itemprop="dateCreated" datetime="2014-10-02T08:04:55-07:00" class="action-date">Oct '14</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>You can add a listener to your database connection so every SQL generated can be stored/audited:</p>
<p><a href="https://github.com/phalcon/forum/blob/master/app/config/services.php#L114-L131">https://github.com/phalcon/forum/blob/master/app/config/services.php#L114-L131</a></p></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="11814" data-cf-modified-551f939bd48f504fabb061bb-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="11814" data-cf-modified-551f939bd48f504fabb061bb-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
    </div>
</div>
<div itemprop="suggestedAnswer" itemscope itemtype="https://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img src="https://secure.gravatar.com/avatar/82140260df942005abbc598cbba6c688?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="https://schema.org/Person">
            <a href="/user/1720/blm14" class="user-moderator-N"><span itemprop="name">blm14</span></a>        </span>
        <br>

        <span class="karma">40.7k</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><a name="C11816" href="#C11816">
                <time itemprop="dateCreated" datetime="2014-10-02T08:08:23-07:00" class="action-date">Oct '14</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>Not good enough. I need to know what the results are that were returned. If I am looking at SQL 3 months hence I haven't a clue what the results were at the time that they were run. I need a way to track: &quot;As a result of the following SQL, here are the values from tables A,B, and C that the user actually viewed in the cursor returned.&quot;</p></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="11816" data-cf-modified-551f939bd48f504fabb061bb-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="11816" data-cf-modified-551f939bd48f504fabb061bb-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
    </div>
</div>
<div itemprop="suggestedAnswer" itemscope itemtype="https://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img src="https://secure.gravatar.com/avatar/5d6f567f9109789fd9f702959768e35d?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="https://schema.org/Person">
            <a href="/user/1/phalcon" class="user-moderator-Y"><span itemprop="name">Phalcon</span></a>        </span>
        <br>

        <span class="karma">98.9k</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><a name="C11820" href="#C11820">
                <time itemprop="dateCreated" datetime="2014-10-02T08:13:11-07:00" class="action-date">Oct '14</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>You need to check the results at database level or ORM level?</p></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="11820" data-cf-modified-551f939bd48f504fabb061bb-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="11820" data-cf-modified-551f939bd48f504fabb061bb-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
    </div>
</div>
<div itemprop="suggestedAnswer" itemscope itemtype="https://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img src="https://secure.gravatar.com/avatar/82140260df942005abbc598cbba6c688?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="https://schema.org/Person">
            <a href="/user/1720/blm14" class="user-moderator-N"><span itemprop="name">blm14</span></a>        </span>
        <br>

        <span class="karma">40.7k</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><a name="C11821" href="#C11821">
                <time itemprop="dateCreated" datetime="2014-10-02T08:20:20-07:00" class="action-date">Oct '14</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>This is a system which will store HIPAA protected data. I need to be able to provide a complete audit trail of every piece of data inserted, deleted, updated, or viewed by every user in any given sign-in session, and retain that information for 7 years.</p>
<p>So far I have been able to handle insertions, updates, and deletes cleanly by making parent classes for Forms and Models that all of my form and model objects inherit from. I've handled views by overriding render() in Form and implementing a Model method getValue($column_name) which is what I use to pull data from models. The issue is that when I do a query that isn't just a simple call to a single model, my getValue() method isn't implemented because the object returned doesn't inherit from my ModelBase class.</p></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="11821" data-cf-modified-551f939bd48f504fabb061bb-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="11821" data-cf-modified-551f939bd48f504fabb061bb-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
    </div>
</div>
<div itemprop="suggestedAnswer" itemscope itemtype="https://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img src="https://secure.gravatar.com/avatar/5d6f567f9109789fd9f702959768e35d?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="https://schema.org/Person">
            <a href="/user/1/phalcon" class="user-moderator-Y"><span itemprop="name">Phalcon</span></a>        </span>
        <br>

        <span class="karma">98.9k</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><a name="C11823" href="#C11823">
                <time itemprop="dateCreated" datetime="2014-10-02T08:33:38-07:00" class="action-date">Oct '14</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>You can override the default models manager to intercept when query instances are created:</p>
<pre><code class="language-php">class MyModelsManager extends \Phalcon\Mvc\Model\Manager
{
     public function executeQuery($phql, $placeholders=null) { }
     public function createQuery ($phql) { }
}</code></pre>
<p>And register this ModelsManager instead:</p>
<pre><code class="language-php">$di-&gt;set('modelsManager', new MyModelsManager, true);</code></pre></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="11823" data-cf-modified-551f939bd48f504fabb061bb-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="11823" data-cf-modified-551f939bd48f504fabb061bb-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
    </div>
</div>
<div itemprop="suggestedAnswer" itemscope itemtype="https://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img src="https://secure.gravatar.com/avatar/82140260df942005abbc598cbba6c688?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="https://schema.org/Person">
            <a href="/user/1720/blm14" class="user-moderator-N"><span itemprop="name">blm14</span></a>        </span>
        <br>

        <span class="karma">40.7k</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><a name="C11828" href="#C11828">
                <time itemprop="dateCreated" datetime="2014-10-02T08:42:56-07:00" class="action-date">Oct '14</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>This is exactly the sort of solution that I was thinking of. The issue is how can I get result metadata from those methods. In other words, conceptually, I need to take the sql passed, get from it the names of each table being viewed and then the name of each column from each table. Then when I execute the query, I need to make sure that the primary key from each table is in the select list (how?) so that I can store this in my audit logs.</p>
<p>What I have so far. In services.php:</p>
<pre><code class="language-php"> $di-&gt;set('modelsManager', function() {
     return new MyModelManager();
 });</code></pre>
<p>Then in MyModelManager.php:</p>
<pre><code class="language-php">public function executeQuery($phql, $placeholders=false){
    $query = parent::createQuery($phql);    

    $parsed = $query-&gt;parse();
    $columns = $parsed['columns'];
    $results = $query-&gt;execute();
    ...</code></pre>
<p>I just don't see how I can a) guarantee that the primary key field for every table is in the select list, and b) save the data values viewed without walking the entire cursor twice - once to save the audit data and then a second time in the view to display the results. It seems like there is also some limitations on what is returned in parse() like if I use table aliases then parse() returns the alias and not the actual Model name.</p></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="11828" data-cf-modified-551f939bd48f504fabb061bb-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="11828" data-cf-modified-551f939bd48f504fabb061bb-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
    </div>
</div>
<div class="row"><div class="col-md-1 small" align="center"></div>
        <div class="col-md-11 login-comment">
            
        </div></div>
</div><input type="hidden" id="post-id" name="post-id" value="3589" /><div id="suggested-posts"></div>
    <div id="sticky-progress" style='display:none'></div>
</div>
    </div>