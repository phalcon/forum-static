---
layout: default
title: 'How to get all the related lineitem rows and save with main model - Discussion'
---

    <div class="container">
        {% include warning.html %}


<div itemscope itemtype="https://schema.org/Question"><ol class="breadcrumb">
    <li><a href="/">Home</a></li>
    <li><a href="/category/21/beginners">Beginners</a></li>
</ol>
<div class="row table-title">
    <div class="col-lg-8 col-md-7 col-sm-6 col-xs-12 wrapper-author">
        <h1 class="" itemprop="name">How to get all the related lineitem rows and save with main model</h1>
        <div class="visible-xs-block mobile-author">
            <span itemprop="author" itemscope itemtype="https://schema.org/Person"><a href="/user/1578/amsharma9" class="user-moderator-N"><span itemprop="name">Amal</span></a></span>
            <time itemprop="dateCreated" datetime="2016-06-03T18:05:06-07:00">Jun '16</time>
        </div>
    </div>
    <div class="col-lg-4 col-md-5 col-sm-6 hidden-xs text-right wrapper-stats">
        <table class="table-stats" width="100%">
            <tr style="vertical-align: top;">
                <td>
                    <label>Created</label><br>
                    <time itemprop="dateCreated" datetime="2016-06-03T18:05:06-07:00">Jun '16</time>
                </td>
                <td>
                    <label>Last Reply</label><br>Jun '16</td>
                <td>
                    <label>Replies</label><br>
                    <span itemprop="answerCount">2</span>
                </td>
                <td>
                    <label>Views</label><br>325</td>
                <td>
                    <label>Votes</label><br>
                    <span itemprop="upvoteCount">0</span>
                </td>
            </tr>
        </table>
    </div>
</div>
<div class="discussion">
        <div class="row reply-block">
            <div class="col-md-1 col-sm-1 hidden-xs text-center">
                <img  src="https://secure.gravatar.com/avatar/d70ff987c7a6303491da1f538eac35e0?s=48&amp;r=pg&amp;d=identicon" class="img-rounded avatar" /><br>
                <span itemprop="author" itemscope itemtype="https://schema.org/Person" class="avatar-name"><a href="/user/1578/amsharma9" class="user-moderator-N"><span itemprop="name">Amal</span></a></span>
                <span class="karma">16.3k</span>
            </div>
            <div class="col-md-11 col-sm-11 col-xs-12 post-body"><div class="posts-date hidden-xs" align="right">
        <a name="C11737" href="#C11737">
        <time class="action-date">Jun '16</time>
    </a>
</div>
<div class="post-content"><div><p>Hello,</p>
<p>I have a web page with Employee Id/Name etc and then the employees salary components as lineitems on the same web page. The Employee &amp; Employee Component models are related by one-&gt;many relationship. User can modify the employee or component details (lineitems) on this web page as all fields are input boxes. How do I retrieve all the lineitem rows using php and invoke save of employee and all related records. <strong>The php code below gets just one lineitem row.</strong> I believe I will have to use jquery/javascript &amp; ajax. Even if I use that, how do I pass the lineitem info to the PayEmpComponents class before <code>save()</code> is called. I believe I have to get all the employee components as lineitems and set them to empComp[0], empComp[1].... I have searched a lot on the internet but still am unclear how to do it. If somebody can give a code snippet that will be a big help.
Some of my edit Action code in the controller looks like below:</p>
<pre><code class="language-php">            $employee-&gt;setHrEmpIid($this-&gt;request-&gt;getPost("hr_emp_iid", 'striptags'));
            $employee-&gt;setHrEmpId($this-&gt;request-&gt;getPost("hr_emp_id", 'striptags'));
            $employee-&gt;setHrEmpFname($this-&gt;request-&gt;getPost("hr_emp_fname", 'striptags'));
            $employee-&gt;setHrEmpLname($this-&gt;request-&gt;getPost("hr_emp_lname", 'striptags'));
            $employee-&gt;setHrEmpGender($this-&gt;request-&gt;getPost("hr_emp_gender", 'striptags'));
            $employee-&gt;setHrEmpDob($this-&gt;request-&gt;getPost("hr_emp_dob", 'striptags'));
            $employee-&gt;setHrEmpMob($this-&gt;request-&gt;getPost("hr_emp_mob", 'striptags'));
            $employee-&gt;setHrEmpDoj($this-&gt;request-&gt;getPost("hr_emp_doj", 'striptags'));

            //foreach (empComp)
            {
                $empComp = new PayEmpComponents() ;
                $empComp-&gt;setHrEmpIid($this-&gt;request-&gt;getPost("empComp_hr_emp_iid", 'striptags')) ;
                $empComp-&gt;setPayEmpCompoIid($this-&gt;request-&gt;getPost("empComp_pay_emp_compo_iid", 'striptags')) ;
                $empComp-&gt;setPayCompoIid($this-&gt;request-&gt;getPost("empComp_pay_compo_iid", 'striptags')) ;
                $empComp-&gt;setPayCompoPercent($this-&gt;request-&gt;getPost("empComp_pay_compo_percent", 'striptags')) ;
            }
            $employee-&gt;PayEmpComponents = $empComp ;

            if (!$employee-&gt;save()) {
                $this-&gt;flash-&gt;error($employee-&gt;getMessages());
            } else {
.....</code></pre>
<p>Thanks in advance</p></div>                </div>

                <div class="posts-buttons text-right"><a href="#"  class="btn btn-danger btn-xs" data-cf-modified-eced0ba56ea8e28583fc974c-="">
        <span class="glyphicon glyphicon-thumbs-down"></span></a>
    <a href="#"  class="btn btn-success btn-xs" data-cf-modified-eced0ba56ea8e28583fc974c-="">
        <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
            </div>
        </div><div itemprop="suggestedAnswer" itemscope itemtype="https://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img  src="https://secure.gravatar.com/avatar/8da15621865643112c6e3243f2ce4ebe?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="https://schema.org/Person">
            <a href="/user/3812/Jurigag" class="user-moderator-Y"><span itemprop="name">Wojciech Ślawski</span></a>        </span>
        <br>

        <span class="karma">145.0k</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><a name="C35067" href="#C35067">
                <time itemprop="dateCreated" datetime="2016-06-03T23:32:58-07:00" class="action-date">Jun '16</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>First, refractor your code, why you just don't use:</p>
<pre><code class="language-php">$employee-&gt;assign($this-&gt;request-&gt;getPost(), $whitelist);</code></pre>
<p>OR:</p>
<pre><code class="language-php">$employee-&gt;save($this-&gt;request-&gt;getPost(), $whitelist);</code></pre>
<p>You remove so much boilerplate code this way.</p>
<p>Well basically yea, you need to use foreach and put them into array.</p></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="35067" data-cf-modified-eced0ba56ea8e28583fc974c-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="35067" data-cf-modified-eced0ba56ea8e28583fc974c-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
    </div>
</div>
<div itemprop="suggestedAnswer" itemscope itemtype="https://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img  src="https://secure.gravatar.com/avatar/d70ff987c7a6303491da1f538eac35e0?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="https://schema.org/Person">
            <a href="/user/1578/amsharma9" class="user-moderator-N"><span itemprop="name">Amal</span></a>        </span>
        <br>

        <span class="karma">16.3k</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><span class="action-date action-reply-edit" data-id="35109" data-toggle="modal" data-target="#historyModal">
                edited <span>Jun '16</span>
              </span><br/><a name="C35109" href="#C35109">
                <time itemprop="dateCreated" datetime="2016-06-05T18:31:39-07:00" class="action-date">Jun '16</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p><a href="https://forum.phalcon.io/user/0/Wojciech">@Wojciech</a> Thanks for your inputs. If what you wrote works then it will help a lot in reducing my code. I read how to use <code>whitelist</code> &amp; checked. Doesn't seem to work.</p>
<pre><code class="language-php">$whitelistEmp = ['hr_emp_iid', 'hr_emp_id', 'hr_emp_fname', 'hr_emp_lname', 'hr_emp_gender', 'hr_emp_dob', 'hr_emp_mob', 'hr_emp_doj', 'hr_payroll_basis', 'co_user_iid' ] ;
$employee-&gt;assign($this-&gt;request-&gt;getPost(), $whitelistEmp);
echo (new \Phalcon\Debug\Dump([], true))-&gt;variables($this-&gt;request-&gt;getPost()) ;//  exit();
echo (new \Phalcon\Debug\Dump([], true))-&gt;variables($employee) ;  exit();</code></pre>
<p>I debugged, see the output, all the fields from getPost() on $employee are NULL</p>
<pre><code class="language-php">employee, create

var 0 Array (12) (
  [co_comp_iid] =&gt; Numeric string (1) "1"
  [co_location_iid] =&gt; Numeric string (1) "1"
  [hr_emp_iid] =&gt; Numeric string (1) "3"
  [hr_emp_id] =&gt; Numeric string (1) "3"
  [hr_emp_fname] =&gt; String (3) "EF3"
  [hr_emp_lname] =&gt; String (3) "EL3"
  [hr_emp_gender] =&gt; String (1) "M"
  [hr_emp_dob] =&gt; String (10) "2000-10-10"
  [hr_emp_mob] =&gt; String (0) ""
  [hr_payroll_basis] =&gt; String (1) "B"
  [hr_emp_doj] =&gt; String (10) "2010-10-10"
  [co_user_iid] =&gt; Numeric string (1) "1"
)

var 0 Object Baseapp\Models\HrEmployeeM extends Phalcon\Mvc\Model (
...
  -&gt;*hr_emp_iid (public) = NULL
  -&gt;*hr_emp_id (public) = NULL
  -&gt;*hr_emp_fname (public) = NULL
  -&gt;*hr_emp_mname (public) = NULL
  -&gt;*hr_emp_lname (public) = NULL
  -&gt;*hr_emp_gender (public) = NULL
  -&gt;*hr_emp_dob (public) = NULL
  .....</code></pre>
<p>Any suggestions. I faced other issues also but lets resolve this first.</p></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="35109" data-cf-modified-eced0ba56ea8e28583fc974c-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="35109" data-cf-modified-eced0ba56ea8e28583fc974c-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
    </div>
</div>
<div itemprop="suggestedAnswer" itemscope itemtype="https://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img  src="https://secure.gravatar.com/avatar/8da15621865643112c6e3243f2ce4ebe?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="https://schema.org/Person">
            <a href="/user/3812/Jurigag" class="user-moderator-Y"><span itemprop="name">Wojciech Ślawski</span></a>        </span>
        <br>

        <span class="karma">145.0k</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><a name="C35117" href="#C35117">
                <time itemprop="dateCreated" datetime="2016-06-06T01:10:32-07:00" class="action-date">Jun '16</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>To be honest i have no clue what's happening here. It should set correct values in model. Can you just check it with create method ?</p></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="35117" data-cf-modified-eced0ba56ea8e28583fc974c-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="35117" data-cf-modified-eced0ba56ea8e28583fc974c-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
    </div>
</div>
<div itemprop="suggestedAnswer" itemscope itemtype="https://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img  src="https://secure.gravatar.com/avatar/d70ff987c7a6303491da1f538eac35e0?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="https://schema.org/Person">
            <a href="/user/1578/amsharma9" class="user-moderator-N"><span itemprop="name">Amal</span></a>        </span>
        <br>

        <span class="karma">16.3k</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><a name="C35211" href="#C35211">
                <time itemprop="dateCreated" datetime="2016-06-08T21:56:15-07:00" class="action-date">Jun '16</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p><a href="https://forum.phalcon.io/user/0/Wojciech">@Wojciech</a>. I found the issue why <code>assign</code> was not working. The parameters for <code>assign</code> are not the same as for <code>save</code>. The second parameter is a column map. If a column map is present in the model then it can be null as I understand. Below works:</p>
<pre><code>$employee-&gt;assign($this-&gt;request-&gt;getPost(), null, $whitelist);</code></pre>
<p>My other issue is a bit complex. I have used a column name defined as arrays in my view volt file. This is to support multiple rows of data. I had to search hard to find ways to support multiple rows.</p>
<pre><code>{% raw %}{%{% endraw %} for d1 in empComponents {% raw %}%}{% endraw %}
&lt;tr&gt;
    &lt;td align="left"&gt;{% raw %}{{{% endraw %} text_field("pay_emp_compo_iid[]", "size" : 10, 'value' : d1.pay_emp_compo_iid ) {% raw %}}}{% endraw %}&lt;/td&gt;
    &lt;td align="left"&gt;{% raw %}{{{% endraw %} text_field("pay_compo_iid[]", "size" : 10, 'value' : d1.pay_compo_iid ) {% raw %}}}{% endraw %}&lt;/td&gt;
    &lt;td align="right"&gt;{% raw %}{{{% endraw %} text_field("pay_compo_amt[]", "size" : 20, 'value' : d1.pay_compo_amt, 'style' : "text-align:right;" ) {% raw %}}}{% endraw %}&lt;/td&gt;
    &lt;td align="right"&gt;{% raw %}{{{% endraw %} text_field("pay_compo_monthly_amt[]", "size" : 20, 'value' : d1.pay_compo_monthly_amt, 'style' : "text-align:right;" ) {% raw %}}}{% endraw %}&lt;/td&gt;
    &lt;td align="right"&gt;{% raw %}{{{% endraw %} text_field("pay_compo_percent[]", "size" : 10, 'value' : d1.pay_compo_percent, 'style' : "text-align:right;" ) {% raw %}}}{% endraw %}&lt;/td&gt;
    &lt;td align="left"&gt;{% raw %}{{{% endraw %} text_field("pay_compo_perc_amt[]", "size" : 1, 'value' : d1.pay_compo_perc_amt ) {% raw %}}}{% endraw %}&lt;/td&gt;
&lt;/tr&gt;
{% raw %}{%{% endraw %} endfor {% raw %}%}{% endraw %}</code></pre>
<p>Now if I use <code>assign</code> it places the whole array in a single object:</p>
<pre><code>$whitelistEmpComps = [ 'pay_compo_iid', 'pay_compo_amt', 'pay_compo_monthly_amt', 'pay_compo_percent', 'pay_compo_perc_amt' ] ;
$empComp-&gt;assign($this-&gt;request-&gt;getPost(), null, $whitelistEmpComps);</code></pre>
<p>Is there a way to get each of them into a single <code>$empCompo</code>. Any suggestions on how to do it. Or do I have to set each value like I did  in my first post.</p>
<pre><code>for ($liIndex = 0 ; $liIndex &lt; $empCompoCount; $liIndex++ )
{
    $empCompo-&gt;setPayEmpCompoIid($_POST["pay_emp_compo_iid"][$liIndex], 'striptags') ;
    $empCompo-&gt;setPayCompoIid($_POST["pay_compo_iid"][$liIndex], 'striptags') ;
    $empCompo-&gt;setPayCompoAmt($_POST["pay_compo_amt"][$liIndex], 'striptags') ;
    $empCompo-&gt;setPayCompoMonthlyAmt($_POST["pay_compo_monthly_amt"][$liIndex], 'striptags') ;
    $empCompo-&gt;setPayCompoPercent($_POST["pay_compo_percent"][$liIndex], 'striptags') ;
    $empCompo-&gt;setPayCompoPercAmt($_POST["pay_compo_perc_amt"][$liIndex], 'striptags') ;
}
</code></pre>
<p>Thanks</p></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="35211" data-cf-modified-eced0ba56ea8e28583fc974c-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="35211" data-cf-modified-eced0ba56ea8e28583fc974c-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
    </div>
</div>
<div class="row"><div class="col-md-1 small" align="center"></div>
        <div class="col-md-11 login-comment">
            
        </div></div>
</div><input type="hidden" id="post-id" name="post-id" value="11737" /><div id="suggested-posts"></div>
    <div id="sticky-progress" style='display:none'></div>
</div>
    </div>