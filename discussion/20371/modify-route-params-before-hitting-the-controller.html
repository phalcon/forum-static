---
layout: default
title: 'Modify Route Params before hitting the controller - Discussion'
---

    <div class="container">
        {% include warning.html %}


<div itemscope itemtype="http://schema.org/Question"><ol class="breadcrumb">
    <li><a href="/">Home</a></li>
    <li><a href="/category/13/routing">Routing</a></li>
</ol>
<div class="row table-title">
    <div class="col-lg-8 col-md-7 col-sm-6 col-xs-12 wrapper-author">
        <h1 class="" itemprop="name">Modify Route Params before hitting the controller</h1>
        <div class="visible-xs-block mobile-author">
            <span itemprop="author" itemscope itemtype="http://schema.org/Person"><a href="/user/7609/MelzerC" class="user-moderator-N"><span itemprop="name">Christoph Melzer</span></a></span>
            <time itemprop="dateCreated" datetime="2020-02-17T01:39:32-07:00">Feb '20</time>
        </div>
    </div>
    <div class="col-lg-4 col-md-5 col-sm-6 hidden-xs text-right wrapper-stats">
        <table class="table-stats" width="100%">
            <tr style="vertical-align: top;">
                <td>
                    <label>Created</label><br>
                    <time itemprop="dateCreated" datetime="2020-02-17T01:39:32-07:00">Feb '20</time>
                </td>
                <td>
                    <label>Last Reply</label><br>Aug '20</td>
                <td>
                    <label>Replies</label><br>
                    <span itemprop="answerCount">5</span>
                </td>
                <td>
                    <label>Views</label><br>200</td>
                <td>
                    <label>Votes</label><br>
                    <span itemprop="upvoteCount">0</span>
                </td>
            </tr>
        </table>
    </div>
</div>
<div class="discussion">
        <div class="row reply-block">
            <div class="col-md-1 col-sm-1 hidden-xs text-center">
                <img src="https://secure.gravatar.com/avatar/3bc3ab79dafa076f90520c97b5b1ae37?s=48&amp;r=pg&amp;d=identicon" class="img-rounded avatar" /><br>
                <span itemprop="author" itemscope itemtype="http://schema.org/Person" class="avatar-name"><a href="/user/7609/MelzerC" class="user-moderator-N"><span itemprop="name">Christoph Melzer</span></a></span>
                <span class="karma">1.4k</span>
            </div>
            <div class="col-md-11 col-sm-11 col-xs-12 post-body"><div class="posts-date hidden-xs" align="right">
        <a name="C20371" href="#C20371">
        <time class="action-date">Feb '20</time>
    </a>
</div>
<div class="post-content"><div><p>Hey!</p>
<p>I'm currently writing an API (Phalcon Micro, version 3.4) that is versioned. That means, my routes look something like this: e.g. <code>/2.1/my/application/exampleuser</code> or with parameters: <code>/{version}/my/application/{username}</code></p>
<p>These parameters are automatically passed to the Controller::Action Method by Phalcon. So my Controller / Action for beforementioned route looks like this:</p>
<pre><code class="language-php">class ExampleController extends \Phalcon\Di\Injectable
{
    public function userAction(int $version, string $username)
    {
        // my code here
    }
}</code></pre>
<p>Now, I really don't want to add the version parameter to every single action. What I would like to do is to add a Middleware (e.g. hook into the <code>micro:beforeExecuteRoute</code> Event), get the version from the parameters and remove that route parameter so my <code>userAction</code> will look like this instead:</p>
<pre><code class="language-php">public function userAction(string $username)
{
    // my code here
}</code></pre>
<p>What I already tried is to modify the parameter list via the dispatcher:<code>$application-&gt;dispatcher-&gt;setParams($modifiedParams);</code> but without any success. The parameters for this also seem to be only available within the controller itself and not in the middleware. </p>
<p>I would like to know how I can achieve what I want. Can this be done with Phalcon itself, or do I have to write some kind of a script to do so (or tweak nginx configuration)?</p>
<p>If there's any information missing, let me know.</p></div>                </div>

                <div class="posts-buttons text-right"><a href="#"  class="btn btn-danger btn-xs" data-cf-modified-89b18865517f4ab954ae4ea2-="">
        <span class="glyphicon glyphicon-thumbs-down"></span></a>
    <a href="#"  class="btn btn-success btn-xs" data-cf-modified-89b18865517f4ab954ae4ea2-="">
        <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
            </div>
        </div><div itemprop="suggestedAnswer" itemscope itemtype="http://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img src="https://secure.gravatar.com/avatar/747be74e038e35ba2207da09388e3a0d?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="http://schema.org/Person">
            <a href="/user/8217/talal424" class="user-moderator-N"><span itemprop="name">talal424</span></a>        </span>
        <br>

        <span class="karma">8.4k</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><a name="C62215" href="#C62215">
                <time itemprop="dateCreated" datetime="2020-02-17T15:19:14-07:00" class="action-date">Feb '20</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>you can do by altering the defined route</p>
<p>maybe you can share with us how you defined your routes</p></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="62215" data-cf-modified-89b18865517f4ab954ae4ea2-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="62215" data-cf-modified-89b18865517f4ab954ae4ea2-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
    </div>
</div>
<div itemprop="suggestedAnswer" itemscope itemtype="http://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img src="https://secure.gravatar.com/avatar/3bc3ab79dafa076f90520c97b5b1ae37?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="http://schema.org/Person">
            <a href="/user/7609/MelzerC" class="user-moderator-N"><span itemprop="name">Christoph Melzer</span></a>        </span>
        <br>

        <span class="karma">1.4k</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><a name="C62223" href="#C62223">
                <time itemprop="dateCreated" datetime="2020-02-18T01:12:24-07:00" class="action-date">Feb '20</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>Sure, have a look here on how I'm defining and mounting my routes. At least part of it is a custom logic.
My route definition looks like this:</p>
<pre><code class="language-php">return [
    [
        'class'   =&gt; \App\Http\Controller\ExampleController::class,     // the controller that should be used to handle the request
        'prefix'  =&gt; '/{version}/my',                                   // route prefix
        'methods' =&gt; [
            'get'   =&gt; [
                '/application/{username}' =&gt; [
                    'action'  =&gt; 'userAction',                          // the action handling the request
                    'options' =&gt; [                                      // list of options I may apply to the route, only internal usage and not of relevance for this issue
                        'requiredAuthentication' =&gt; false
                    ],
                ],
            ],
            'post' =&gt; [
                // more routes for post
            ]
        ],
    ],
];</code></pre>
<p>This array is then used to create new <code>\Phalcon\Mvc\Micro\Collection</code> Objects adding the routes. This looks basically like this (there's a class around it I did not add here, and I removed error handling for simplicity):</p>
<pre><code class="language-php">foreach ($this-&gt;routes as $route) {                                     // $this-&gt;route is the array from above
    $collection = new \Phalcon\Mvc\Micro\Collection();

    $class = $route['class'];
    $collection-&gt;setHandler(new $class($this-&gt;diContainer));            // setting the handler (controller) class
    if (array_has($route, 'prefix')) {                                  // setting the route prefix if there is one
        $collection-&gt;setPrefix($route['prefix']);
    }

    foreach ($route['methods'] as $verb =&gt; $methods) {                  // looping over all the http methods and ...
            foreach ($methods as $endpoint =&gt; $configuration) {         // ... over all the endpoints within each method to add the uri to the collection
                $collection-&gt;$verb($endpoint, $configuration['action'], $configuration['action']);
            }
        }
    $this-&gt;application-&gt;mount($collection);
}</code></pre>
<p>Everything else after mounting the routes up to the point where the action is executed is basically Phalcon standard. The only additional logic is, that I hook into the <code>micro:beforeExecuteRoute</code> again to call an <code>initialize</code> method of my controller.</p>
<p>Can you explain a bit further on what you mean by altering the defined route? I cannot follow on this one.</p></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="62223" data-cf-modified-89b18865517f4ab954ae4ea2-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="62223" data-cf-modified-89b18865517f4ab954ae4ea2-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
    </div>
</div>
<div itemprop="suggestedAnswer" itemscope itemtype="http://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img src="https://secure.gravatar.com/avatar/747be74e038e35ba2207da09388e3a0d?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="http://schema.org/Person">
            <a href="/user/8217/talal424" class="user-moderator-N"><span itemprop="name">talal424</span></a>        </span>
        <br>

        <span class="karma">8.4k</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><span class="action-date action-reply-edit" data-id="62227" data-toggle="modal" data-target="#historyModal">
                edited <span>Feb '20</span>
              </span><br/><a name="C62227" href="#C62227">
                <time itemprop="dateCreated" datetime="2020-02-18T08:47:48-07:00" class="action-date">Feb '20</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p><code>'prefix'  =&gt; '/{version}/my'</code> this tells the router is that <code>{version}</code> is a required &quot;paramater&quot; not just required</p>
<p>what you need is change <code>{version}</code> to a regex that can verify the input is what you need </p>
<pre><code class="language-php">
$collection = new \Phalcon\Mvc\Micro\Collection;

// this will pass {version} as a paramater
$collection-&gt;setPrefix('/{version}/my'); 

// basicly the same except it must match the regex ([0-9]{1,2}\.[0-9]{1,2})
$collection-&gt;setPrefix('/{version:([0-9]{1,2}\.[0-9]{1,2})}/my'); 

// this is what you want. must supply a version but its not a paramater
$collection-&gt;setPrefix('/([0-9]{1,2}\.[0-9]{1,2})/my'); </code></pre>
<p>just change regex to your needs</p></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="62227" data-cf-modified-89b18865517f4ab954ae4ea2-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="62227" data-cf-modified-89b18865517f4ab954ae4ea2-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
    </div>
</div>
<div itemprop="suggestedAnswer" itemscope itemtype="http://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img src="https://secure.gravatar.com/avatar/3bc3ab79dafa076f90520c97b5b1ae37?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="http://schema.org/Person">
            <a href="/user/7609/MelzerC" class="user-moderator-N"><span itemprop="name">Christoph Melzer</span></a>        </span>
        <br>

        <span class="karma">1.4k</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><a name="C62255" href="#C62255">
                <time itemprop="dateCreated" datetime="2020-02-19T02:51:32-07:00" class="action-date">Feb '20</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>I know that I can simply use a regular expression so version is no longe a parameter.
In fact, when doing so, there's no way (or at least I don't know a way) to grab the information about the version from the url without manually parsing it (Yes, I can do something like <code>substr($url, ...)</code> I just thought maybe phalcon provides a way). I tried to find a way, that I can add the version as a named parameter and remove it within a middleware, so it is not passed to the controller. </p>
<p>For example:
Imagine the application flow is like this: My routes are initialized the way I wrote before. Afterwards my <code>FancyMiddleware</code> is called (by hooking into the <code>micro:beforeExecuteRoute</code> Event) then the controller is executed.</p>
<pre><code class="language-php">// route:
return [
    [
        'class'   =&gt; \App\Http\Controller\ExampleController::class,     // the controller that should be used to handle the request
        'prefix'  =&gt; '/{version}/my',                                   // route prefix
        'methods' =&gt; [
            'get'   =&gt; [
                '/application/{username}' =&gt; [
                    'action'  =&gt; 'userAction',                          // the action handling the request
                    'options' =&gt; [                                      // list of options I may apply to the route, only internal usage and not of relevance for this issue
                        'requiredAuthentication' =&gt; false
                    ],
                ],
            ],
            'post' =&gt; [
                // more routes for post
            ]
        ],
    ],
];</code></pre>
<pre><code class="language-php">// FancyMiddleware
class FancyMiddleware extends Plugin {
    public function beforeExecuteRoute(\Phalcon\Events\Event $event, \Phalcon\Mvc\Micro $app) {
        $params = $app-&gt;router-&gt;getParams();
        if (array_key_exists('version', $params) {
            $app-&gt;getDi()-&gt;setShared('version', $params['version'];
            // code to remove version from params ---- this is what I am looking for
        }
    }
}</code></pre>
<pre><code class="language-php">// Controller
class MyController extends \Phalcon\Di\Injectable {
    public function userAction(string $username) {
        // my code, version is no longer passed to this method, since it is removed
    }
}</code></pre></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="62255" data-cf-modified-89b18865517f4ab954ae4ea2-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="62255" data-cf-modified-89b18865517f4ab954ae4ea2-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
    </div>
</div>
<div itemprop="suggestedAnswer" itemscope itemtype="http://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img src="https://secure.gravatar.com/avatar/747be74e038e35ba2207da09388e3a0d?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="http://schema.org/Person">
            <a href="/user/8217/talal424" class="user-moderator-N"><span itemprop="name">talal424</span></a>        </span>
        <br>

        <span class="karma">8.4k</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><a name="C62267" href="#C62267">
                <time itemprop="dateCreated" datetime="2020-02-19T07:14:36-07:00" class="action-date">Feb '20</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>i'm sure you have your reasons.</p>
<p>did you think about using closures instead of collection</p>
<p>you may want to trace how phalcon does end up calling your method</p></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="62267" data-cf-modified-89b18865517f4ab954ae4ea2-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="62267" data-cf-modified-89b18865517f4ab954ae4ea2-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
    </div>
</div>
<div itemprop="suggestedAnswer" itemscope itemtype="http://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img src="https://secure.gravatar.com/avatar/61ebaf603d5f6118cac48e990ec04906?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="http://schema.org/Person">
            <a href="/user/13419/Hus3s" class="user-moderator-N"><span itemprop="name">Hus3s</span></a>        </span>
        <br>

        <span class="karma">67</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><a name="C62387" href="#C62387">
                <time itemprop="dateCreated" datetime="2020-03-04T01:12:58-07:00" class="action-date">Mar '20</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p><a href="https://www.tellpopeyes.website">TellPopeyes</a> Before looking at the selection algorithm, we need to understand some things about controller actions .</p></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="62387" data-cf-modified-89b18865517f4ab954ae4ea2-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="62387" data-cf-modified-89b18865517f4ab954ae4ea2-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
    </div>
</div>
<div itemprop="suggestedAnswer" itemscope itemtype="http://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img src="https://secure.gravatar.com/avatar/bdafc645cf997481ed4643077d9e82e6?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="http://schema.org/Person">
            <a href="/user/14099/AlvinHoffman" class="user-moderator-N"><span itemprop="name">AlvinHoffman</span></a>        </span>
        <br>

        <span class="karma">87</span></div>
    <div class="col-md-11"><div class="in-reply-to">
                    <a href="#C62255"><span class="glyphicon glyphicon-chevron-up"></span> in reply to
                        <img src="https://secure.gravatar.com/avatar/3bc3ab79dafa076f90520c97b5b1ae37?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" width="24" height="24" />                        Christoph Melzer                    </a>
                </div><div class="posts-buttons" align="right"><span class="action-date action-reply-edit" data-id="64147" data-toggle="modal" data-target="#historyModal">
                edited <span>Aug '20</span>
              </span><br/><a name="C64147" href="#C64147">
                <time itemprop="dateCreated" datetime="2020-08-28T21:55:14-07:00" class="action-date">Aug '20</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><blockquote>
<p>I know that I can simply use a regular expression so version is no longe a parameter.
In fact, when doing so, there's no way (or at least I don't know a way) to grab the information about the version from the url without manually parsing it (Yes, I can do something like <code>substr($url, ...)</code> I just thought maybe phalcon provides a way). I tried to find a way, that I can add the version as a named parameter and remove it within a middleware, so it is not passed to the controller. </p>
<p>For example:
Imagine the application flow is like this: My routes are initialized the way I wrote before <a href="https://www.tellpizzahut.online/">tell pizza hut</a> . Afterwards my <code>FancyMiddleware</code> is called (by hooking into the <code>micro:beforeExecuteRoute</code> Event) then the controller is executed.</p>
<pre><code class="language-php">// route:
return [
  [
       'class'   =&gt; \App\Http\Controller\ExampleController::class,     // the controller that should be used to handle the request
       'prefix'  =&gt; '/{version}/my',                                   // route prefix
       'methods' =&gt; [
           'get'   =&gt; [
               '/application/{username}' =&gt; [
                   'action'  =&gt; 'userAction',                          // the action handling the request
                   'options' =&gt; [                                      // list of options I may apply to the route, only internal usage and not of relevance for this issue
                       'requiredAuthentication' =&gt; false
                   ],
               ],
           ],
           'post' =&gt; [
               // more routes for post
           ]
       ],
   ],
];</code></pre>
<pre><code class="language-php">// FancyMiddleware
class FancyMiddleware extends Plugin {
  public function beforeExecuteRoute(\Phalcon\Events\Event $event, \Phalcon\Mvc\Micro $app) {
      $params = $app-&gt;router-&gt;getParams();
      if (array_key_exists('version', $params) {
          $app-&gt;getDi()-&gt;setShared('version', $params['version'];
          // code to remove version from params ---- this is what I am looking for
      }
  }
}</code></pre>
<pre><code class="language-php">// Controller
class MyController extends \Phalcon\Di\Injectable {
  public function userAction(string $username) {
      // my code, version is no longer passed to this method, since it is removed
  }
}</code></pre>
</blockquote>
<p>Your information is very interesting. Thank you for sharing..I can achieve what I want. Can this be done with Phalcon itself, or do I have to write some kind of a script to do so</p></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="64147" data-cf-modified-89b18865517f4ab954ae4ea2-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="64147" data-cf-modified-89b18865517f4ab954ae4ea2-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
    </div>
</div>
<div class="row"><div class="col-md-1 small" align="center"></div>
        <div class="col-md-11 login-comment">
            
        </div></div>
</div><input type="hidden" id="post-id" name="post-id" value="20371" /><div id="suggested-posts"></div>
    <div id="sticky-progress" style='display:none'></div>
</div>
    </div>