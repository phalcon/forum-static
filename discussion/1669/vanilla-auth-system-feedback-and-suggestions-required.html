---
layout: default
title: 'Vanilla auth system, feedback and suggestions required - Discussion'
---

    <div class="container">
        {% include warning.html %}


<div itemscope itemtype="https://schema.org/Question"><ol class="breadcrumb">
    <li><a href="/">Home</a></li>
    <li><a href="/category/24/show-community">Show to Community</a></li>
</ol>
<div class="row table-title">
    <div class="col-lg-8 col-md-7 col-sm-6 col-xs-12 wrapper-author">
        <h1 class="" itemprop="name">Vanilla auth system, feedback and suggestions required</h1>
        <div class="visible-xs-block mobile-author">
            <span itemprop="author" itemscope itemtype="https://schema.org/Person"><a href="/user/1058/humugus" class="user-moderator-N"><span itemprop="name">humugus</span></a></span>
            <time itemprop="dateCreated" datetime="2014-02-28T00:45:39-07:00">Feb '14</time>
        </div>
    </div>
    <div class="col-lg-4 col-md-5 col-sm-6 hidden-xs text-right wrapper-stats">
        <table class="table-stats" width="100%">
            <tr style="vertical-align: top;">
                <td>
                    <label>Created</label><br>
                    <time itemprop="dateCreated" datetime="2014-02-28T00:45:39-07:00">Feb '14</time>
                </td>
                <td>
                    <label>Last Reply</label><br>Mar '14</td>
                <td>
                    <label>Replies</label><br>
                    <span itemprop="answerCount">5</span>
                </td>
                <td>
                    <label>Views</label><br>2758</td>
                <td>
                    <label>Votes</label><br>
                    <span itemprop="upvoteCount">2</span>
                </td>
            </tr>
        </table>
    </div>
</div>
<div class="discussion">
        <div class="row reply-block">
            <div class="col-md-1 col-sm-1 hidden-xs text-center">
                <img src="https://secure.gravatar.com/avatar/60ffc0e01551cc5809445076da642103?s=48&amp;r=pg&amp;d=identicon" class="img-rounded avatar" /><br>
                <span itemprop="author" itemscope itemtype="https://schema.org/Person" class="avatar-name"><a href="/user/1058/humugus" class="user-moderator-N"><span itemprop="name">humugus</span></a></span>
                <span class="karma">7.9k</span>
            </div>
            <div class="col-md-11 col-sm-11 col-xs-12 post-body"><div class="posts-date hidden-xs" align="right">
        <a name="C1669" href="#C1669">
        <time class="action-date">Feb '14</time>
    </a>
</div>
<div class="post-content"><div><p>Hi to all :)<br />
I discovered phalcon a couple of weeks ago, while I was looking around for a framework to switch from codeigniter,<br />
I was impressed by its power, sense and completeness to mention a few !!<br />
Since then I try to rebuild, based on Vokuro and my codeigniter experience, an authentication system which in turn will be used as a vanilla template to start several projects with different functionalities.  </p>
<p>some of the specifications :  </p>
<ul>
<li>There are only two user roles : admin and user, guests are out of the application and have access only to static content such as &quot;about us&quot;, &quot;terms of use&quot; and login / register / forgot password / contact forms.  </li>
<li>In some applications guests won't have the ability to register at all, users will be created by the admin (or users that have the authority to create new users)  </li>
<li>Only admin(s) has access to any function in the application.  </li>
<li>Users will have access rights on different functions and modules based on their real live role in the company and not based on their user role.    The way i used to handle this was with a database table, a row for every user with on/off fields for every function (e.g. user/create, user/ban, ....., invoice/view, invoice/issue, ...) that the application offers.  </li>
<li>Based on the user's access rights record, I examine either in a controller as a whole or in every action of the controller if access is granted to a specific user  </li>
<li>In some cases, user has access to an action but he has limited access to the result of the action<br />
examples :<br />
a user is allowed to see an employee's data (hire date, position, qualifications) except contact (e.g. personal phone, home address) and financial (salary).<br />
another user is allowed to see a project's financial data (contract, payments, invoices) but is not allowed to edit them.  </li>
<li>Besides the above, the application is split in servers (environments) internally, every record is marked with the server_id and a user can enter only one server at a time. (There are no servers actually, it is &quot;marketing&quot; name of data separation).  </li>
</ul>
<p>All the above are presented in hope to attract attention and hopefully get suggestions and ideas.  </p>
<p>Now I'm at the position where the auth system is almost ready, and I would like to use the community experience in order to evaluate the solutions I picked from the options that phalcon provides.<br />
In the next post(s) i will start presenting some modules with the specific questions I might have.  </p>
<p>Thank you for your time :)  </p></div>                </div>

                <div class="posts-buttons text-right"><a href="#"  class="btn btn-danger btn-xs" data-cf-modified-12505242d4d8464e9f58bfd6-="">
        <span class="glyphicon glyphicon-thumbs-down"></span></a>
    <a href="#"  class="btn btn-success btn-xs" data-cf-modified-12505242d4d8464e9f58bfd6-="">
        <span class="glyphicon glyphicon-thumbs-up"></span><span itemprop="upvoteCount">2</span></a></div>
            </div>
        </div><div itemprop="suggestedAnswer" itemscope itemtype="https://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img src="https://secure.gravatar.com/avatar/60ffc0e01551cc5809445076da642103?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="https://schema.org/Person">
            <a href="/user/1058/humugus" class="user-moderator-N"><span itemprop="name">humugus</span></a>        </span>
        <br>

        <span class="karma">7.9k</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><span class="action-date action-reply-edit" data-id="5700" data-toggle="modal" data-target="#historyModal">
                edited <span>Mar '14</span>
              </span><br/><a name="C5700" href="#C5700">
                <time itemprop="dateCreated" datetime="2014-02-28T01:09:07-07:00" class="action-date">Feb '14</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>ControllerBase
I use it to decide what resources will be available for the request throughout the application  </p>
<p>if visitor is not logged, I preload 3 forms because i use bootstrap 3 with login / register forms as modals and forms should be available to avery public page (splash, about, terms etc) of the application  </p>
<p>if visitor is logged,  i read from session and database some data to keep them throughout the request<br />
in case that i fail to get a user record, i want to clear the session to consider the visitor as guest and send him to the splash page<br />
i'm not sure that i use dispatcher appropriate as i send the visitor to the splash page but the URL in the browser is not changing (not a redirect), i actually want to achieve a redirect.  </p>
<p>Please advise if you think that my approach is not appropriate or if there are better solutions  </p>
<pre><code class="language-php">&lt;?php
use Phalcon\Mvc\Controller;
use Phalcon\Mvc\Dispatcher;

class ControllerBase extends Controller
{
    public function beforeExecuteRoute(Dispatcher $dispatcher)
    {
        if (! $this-&gt;session-&gt;has('logged')){$this-&gt;session-&gt;set('logged', FALSE);}
        if($this-&gt;session-&gt;get('logged') == FALSE)
        {
            // pre-load forms for top nav menu
            $this-&gt;view-&gt;loginform = new LoginForm();
            $this-&gt;view-&gt;forgotform = new ForgotPasswordForm();
            $this-&gt;view-&gt;registerform = new RegisterForm();
            // common csrf for all forms, only one will be submitted in any case
            $this-&gt;view-&gt;tokenKey = $this-&gt;security-&gt;getTokenKey();
            $this-&gt;view-&gt;token = $this-&gt;security-&gt;getToken();
        }
        else
        {
            // variables are set as $this-&gt;var to be available in all controllers
            $this-&gt;sessionUser = $this-&gt;session-&gt;get('user');
            $id = $this-&gt;filter-&gt;sanitize($this-&gt;sessionUser['userID'], 'int');
            // get the user model of the guest, it is useful throughout the application
            $this-&gt;user = HumugusAuth\Models\Users::findFirstById($id);
            if(! $this-&gt;user)
            {
                // in case the model was not set... something is wrong !!!
                $this-&gt;flashSession-&gt;warning('Requested account not found.');
                $this-&gt;session-&gt;remove('logged');
                $this-&gt;session-&gt;remove('user');
                $this-&gt;session-&gt;remove('server');
                $dispatcher-&gt;forward(array('controller' =&gt; 'index', 'action' =&gt; 'index'));
                return false;
            }
            if($this-&gt;session-&gt;has('server') == TRUE){$this-&gt;sessionServer = $this-&gt;session-&gt;get('server');}
            // variable are are set as $this-&gt;view-&gt;var to be available to all views 
            $this-&gt;view-&gt;user = $this-&gt;user;
            $this-&gt;view-&gt;sessionUser = $this-&gt;sessionUser;
            if(isset($this-&gt;sessionServer)){$this-&gt;view-&gt;sessionServer = $this-&gt;sessionServer;}
        }
    }
} //end of class</code></pre></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="5700" data-cf-modified-12505242d4d8464e9f58bfd6-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="5700" data-cf-modified-12505242d4d8464e9f58bfd6-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
    </div>
</div>
<div itemprop="suggestedAnswer" itemscope itemtype="https://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img src="https://secure.gravatar.com/avatar/60ffc0e01551cc5809445076da642103?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="https://schema.org/Person">
            <a href="/user/1058/humugus" class="user-moderator-N"><span itemprop="name">humugus</span></a>        </span>
        <br>

        <span class="karma">7.9k</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><span class="action-date action-reply-edit" data-id="5701" data-toggle="modal" data-target="#historyModal">
                edited <span>Mar '14</span>
              </span><br/><a name="C5701" href="#C5701">
                <time itemprop="dateCreated" datetime="2014-02-28T05:07:20-07:00" class="action-date">Feb '14</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>Index Controller, the typical landing page  </p>
<p>what is important here is to define the status of the visitor,<br />
--if he is guest he sees the splash zone<br />
--if he has login, the possibilities are two :<br />
----if already a server (environment, see first post)  is set,  user will be redirected to a more appropriate page as the account overview (vanilla version)<br />
----or user will be prompted to set a server  </p>
<p>since there is, and that won't change, only one action, all the checks happen in the action itself  </p>
<pre><code class="language-php">&lt;?php
class IndexController extends ControllerBase
{
    public function indexAction()
    {
        if(isset($this-&gt;user))
        {
            //visitor is logged, he is a user
            if(! isset($this-&gt;sessionServer))
            {
                //select server to work
                return $this-&gt;response-&gt;redirect('servers/select');
            }
            // show his/her account page, later will be redirected to a "my tasks" page
            return $this-&gt;response-&gt;redirect('account');
        }
        //visitor is not logged, he is a guest, show splash page (default : views/index/index)
    }
}//end of class</code></pre></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="5701" data-cf-modified-12505242d4d8464e9f58bfd6-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="5701" data-cf-modified-12505242d4d8464e9f58bfd6-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span><span itemprop="upvoteCount">1</span></a></div>
    </div>
</div>
<div itemprop="suggestedAnswer" itemscope itemtype="https://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img src="https://secure.gravatar.com/avatar/60ffc0e01551cc5809445076da642103?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="https://schema.org/Person">
            <a href="/user/1058/humugus" class="user-moderator-N"><span itemprop="name">humugus</span></a>        </span>
        <br>

        <span class="karma">7.9k</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><span class="action-date action-reply-edit" data-id="5702" data-toggle="modal" data-target="#historyModal">
                edited <span>Mar '14</span>
              </span><br/><a name="C5702" href="#C5702">
                <time itemprop="dateCreated" datetime="2014-02-28T05:16:43-07:00" class="action-date">Feb '14</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>Account Controller, with several actions, a couple are presented  </p>
<p>the onConstruct is not recommended in phalcon documentation, but was the only way i could achieve to block access to anonymous guests in the whole controller, othewise i would had to check in every action<br />
that is a part where i need input from more experienced people :)  </p>
<p>indexAction shows user's account by default<br />
profileActions shows the profile of any valid user based on $id parameter  </p>
<pre><code class="language-php">&lt;?php
use HumugusAuth\Models\Users;
use HumugusAuth\Models\Logins;
use HumugusAuth\Models\Profiles;

class AccountController extends ControllerBase
{
    public function onConstruct()
    {
        // the whole controller should NOT be accessible for anonymous guests
        if($this-&gt;session-&gt;get('logged') == FALSE)
        {
            $this-&gt;flashSession-&gt;warning('You have to sign in to access this page.');
            $this-&gt;dispatcher-&gt;forward(array('controller' =&gt; 'index', 'action' =&gt; 'index'));
            return false;
        }
    }

    public function indexAction()
    {
        //just to show some content at vanilla template
        $logins = Logins::find(array('conditions' =&gt; 'user_id = '.$this-&gt;user-&gt;id, 'order' =&gt; 'logtime DESC', 'limit' =&gt; 12));
        $this-&gt;view-&gt;logins = $logins;

        $this-&gt;view-&gt;title = $this-&gt;user-&gt;name;
        $this-&gt;view-&gt;subtitle = 'Account overview';
    }

    public function profileAction($id = 0) 
    {
        //here user might examine somebody else's profile !
        $id = $this-&gt;filter-&gt;sanitize($id, 'int');
        if($id != $this-&gt;user-&gt;id and $id &gt; 0)
        {
            // if user is a different account's profile 
            $profileUser = Users::findFirstById($id);
        }
        else
        {
            // user sees himself
            $profileUser = $this-&gt;user;
        }
        if(! $profileUser)
        {
            $this-&gt;flashSession-&gt;warning('Requested profile not found.');
            return $this-&gt;response-&gt;redirect('account');
        }
        $this-&gt;view-&gt;profileUser = $profileUser;
        $this-&gt;view-&gt;profile = $profileUser-&gt;profile;
        $this-&gt;view-&gt;title = $profileUser-&gt;name;
        $this-&gt;view-&gt;subtitle = 'Profile overview';
    }

// more actions
</code></pre></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="5702" data-cf-modified-12505242d4d8464e9f58bfd6-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="5702" data-cf-modified-12505242d4d8464e9f58bfd6-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span><span itemprop="upvoteCount">1</span></a></div>
    </div>
</div>
<div itemprop="suggestedAnswer" itemscope itemtype="https://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img src="https://secure.gravatar.com/avatar/1eb2415bda000b22fd1f801bb9e8c003?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="https://schema.org/Person">
            <a href="/user/2/niden" class="user-moderator-Y"><span itemprop="name">Nikolaos Dimopoulos</span></a>        </span>
        <br>

        <span class="karma">39.4k</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><a name="C5964" href="#C5964">
                <time itemprop="dateCreated" datetime="2014-03-06T12:17:20-07:00" class="action-date">Mar '14</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>Do you have a Login controller? Where does the LoginForm post?</p></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="5964" data-cf-modified-12505242d4d8464e9f58bfd6-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="5964" data-cf-modified-12505242d4d8464e9f58bfd6-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
    </div>
</div>
<div itemprop="suggestedAnswer" itemscope itemtype="https://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img src="https://secure.gravatar.com/avatar/1eb2415bda000b22fd1f801bb9e8c003?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="https://schema.org/Person">
            <a href="/user/2/niden" class="user-moderator-Y"><span itemprop="name">Nikolaos Dimopoulos</span></a>        </span>
        <br>

        <span class="karma">39.4k</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><span class="action-date action-reply-edit" data-id="5965" data-toggle="modal" data-target="#historyModal">
                edited <span>Mar '14</span>
              </span><br/><a name="C5965" href="#C5965">
                <time itemprop="dateCreated" datetime="2014-03-06T12:30:23-07:00" class="action-date">Mar '14</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>A few suggestions.</p>
<p>You are storing a lot of information in your session/controllers that you don't need - and it is duplicate.</p>
<p>Unless there is a specific requirement that you store the user data from the db and the data that exists already in the session, you are duplicating data.</p>
<p>Here is how I would go about doing it:</p>
<pre><code class="language-php">&lt;?php
use Phalcon\Mvc\Controller;
use Phalcon\Mvc\Dispatcher;

class ControllerBase extends Controller
{
    const AUTH_USER   = 'auth-user';
    const AUTH_SERVER = 'auth-server';

    private $viewVars = [];

    // Set a view var in the internal array
    protected function setViewVar($key, $value)
    {
        $this-&gt;viewVars[$key] = $value;
    }

    // Set all the view vars in the view
    public function afterExecuteRoute(Dispatcher $dispatcher)
    {
        $this-&gt;view-&gt;setVars($this-&gt;viewVars);
    }

    // Logged in or not
    public function isLoggedIn()
    {
        return (bool) ($this-&gt;getUserId() &gt; 0);
    }

    // Get the user from the session
    public function getUser()
    {
        if ($this-&gt;session-&gt;has(self::AUTH_USER)) {
            return $this-&gt;session-&gt;get(self::AUTH_USER);
        }

        return false;
    }

    // Get the user id from the session
    public function getUserId()
    {
        if ($this-&gt;session-&gt;has(self::AUTH_USER)) {
            $user = $this-&gt;session-&gt;get(self::AUTH_USER);
            if (isset($user['id'])) {
                return intval($user['id']);
            }
        }

        return false;
    }

    // Get the server from the session
    public function getServer()
    {
        if ($this-&gt;session-&gt;has(self::AUTH_SERVER)) {
            return $this-&gt;session-&gt;get(self::AUTH_SERVER);
        }

        return false;
    }

    // Set the user array in the session. All the data we need for this user
    public function setUser($user)
    {
        $data['id']   = intval($user['userID']);
        $data['name'] = $user['name'];
        // .....

        $this-&gt;session-&gt;set(self::AUTH_USER, $data);
    }

    public function beforeExecuteRoute(Dispatcher $dispatcher)
    {
        if (!$this-&gt;isLoggedIn()) {

            $this-&gt;setViewVar('loginform', new LoginForm());
            $this-&gt;setViewVar('forgotform', new ForgotPasswordForm());
            $this-&gt;setViewVar('registerform', new RegisterForm());
            // common csrf for all forms, only one will be submitted in any case
            $this-&gt;setViewVar('tokenKey', $this-&gt;security-&gt;getTokenKey());
            $this-&gt;setViewVar('token', $this-&gt;security-&gt;getToken());

        } else {

            /**
             * There is no reason to make this query here. You get the user 
             * from the login form. In here we assume that the session is already
             * set. This logic will need to go to the Login controller
             */
            $this-&gt;setViewVar('user', $this-&gt;getUser());
            $this-&gt;setViewVar('server', $this-&gt;getServer());

            /**
             * All the below needs to go to the login controller
            // variables are set as $this-&gt;var to be available in all controllers
            $this-&gt;sessionUser = $this-&gt;session-&gt;get('user');
            $id = $this-&gt;filter-&gt;sanitize($this-&gt;sessionUser['userID'], 'int');
            // get the user model of the guest, it is useful throughout the application
            $this-&gt;user = HumugusAuth\Models\Users::findFirstById($id);
            if(! $this-&gt;user)
            {
                // in case the model was not set... something is wrong !!!
                $this-&gt;flashSession-&gt;warning('Requested account not found.');
                $this-&gt;session-&gt;remove('logged');
                $this-&gt;session-&gt;remove('user');
                $this-&gt;session-&gt;remove('server');
                $dispatcher-&gt;forward(array('controller' =&gt; 'index', 'action' =&gt; 'index'));
                return false;
            }
            if($this-&gt;session-&gt;has('server') == TRUE){$this-&gt;sessionServer = $this-&gt;session-&gt;get('server');}
            // variable are are set as $this-&gt;view-&gt;var to be available to all views 
            $this-&gt;view-&gt;user = $this-&gt;user;
            $this-&gt;view-&gt;sessionUser = $this-&gt;sessionUser;
            if(isset($this-&gt;sessionServer)){$this-&gt;view-&gt;sessionServer = $this-&gt;sessionServer;}
            */
        }
    }
} //end of class</code></pre>
<p>Your index controller can change slightly to:</p>
<pre><code class="language-php">&lt;?php
class IndexController extends ControllerBase
{
    public function indexAction()
    {
        if ($this-&gt;isLoggedIn()) {

            //visitor is logged, he is a user
            if (!$this-&gt;getServer()) {

                //select server to work
                return $this-&gt;response-&gt;redirect('servers/select');

            }

            // show his/her account page, later will be redirected to a "my tasks" page
            return $this-&gt;response-&gt;redirect('account');
        }
        //visitor is not logged, he is a guest, show splash page (default : views/index/index)
    }
}//end of class</code></pre>
<p>You can achieve the same thing with beforeExecuteRoute vs. onConstruct</p>
<pre><code class="language-php">&lt;?php
use HumugusAuth\Models\Users;
use HumugusAuth\Models\Logins;
use HumugusAuth\Models\Profiles;

class AccountController extends ControllerBase
{
    public function beforeExecuteRoute(Dispatcher $dispatcher)
    {
        // the whole controller should NOT be accessible for anonymous guests
        if (!$this-&gt;isLoggedIn()) {

            $this-&gt;flashSession-&gt;warning('You have to sign in to access this page.');
            $this-&gt;dispatcher-&gt;forward(array('controller' =&gt; 'index', 'action' =&gt; 'index'));
            return false;
        }

        parent::beforeExecuteRoute();
    }

    public function indexAction()
    {
        //just to show some content at vanilla template
        $logins = Logins::find(
           array(
                'conditions' =&gt; 'user_id = '. $this-&gt;getUserId(), 
                'order'      =&gt; 'logtime DESC', 
                'limit'      =&gt; 12
            )
        );

        $user = $this-&gt;getUser();
        $name = ($user) ? $user['name'] : '';

        $this-&gt;setViewVar('logins', $logins);
        $this-&gt;setViewVar('title', $name;
        $this-&gt;setViewVar('subtitle', 'Account overview');
    }

// more actions
}</code></pre>
<p>In your Login controller or wherever your LoginForm posts you can have something like this:</p>
<pre><code class="language-php">&lt;?php
use HumugusAuth\Models\Users;
use HumugusAuth\Models\Logins;
use HumugusAuth\Models\Profiles;

class LoginController extends ControllerBase
{
    public function loginAction()
    {
        $this-&gt;view-&gt;disable();

        if ($this-&gt;request-&gt;isPost()) {

            $suppliedUsername = $this-&gt;request-&gt;getPost('username', 'email');
            $suppliedPassword = $this-&gt;request-&gt;getPost('password');

            // Check for the credentials here querying the user 
            // $user = Users::findFirst(.......);

            if ($user) {

                $this-&gt;setUser($user);

                $this-&gt;flash-&gt;success('Welcome');
                return $this-&gt;response-&gt;redirect('');

            } else {
                $this-&gt;flash-&gt;error('User not found');
            }
        }
    }
}</code></pre></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="5965" data-cf-modified-12505242d4d8464e9f58bfd6-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="5965" data-cf-modified-12505242d4d8464e9f58bfd6-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
    </div>
</div>
<div itemprop="suggestedAnswer" itemscope itemtype="https://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img src="https://secure.gravatar.com/avatar/60ffc0e01551cc5809445076da642103?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="https://schema.org/Person">
            <a href="/user/1058/humugus" class="user-moderator-N"><span itemprop="name">humugus</span></a>        </span>
        <br>

        <span class="karma">7.9k</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><span class="action-date action-reply-edit" data-id="5969" data-toggle="modal" data-target="#historyModal">
                edited <span>Mar '14</span>
              </span><br/><a name="C5969" href="#C5969">
                <time itemprop="dateCreated" datetime="2014-03-06T13:10:22-07:00" class="action-date">Mar '14</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>thank you Nikos you for your reply :)<br />
Yes , i have an auth controller where i take care about login, logout, register, forgot password etc.<br />
My plan  was to open a discussion for best practices with phalconphp and post more bits where i need more suggestions.<br />
Hopefully my needs will cover issues for other newcomers as well.  </p>
<p>I will adapt the suggestions on your second post and i will repost the parts above, although they are more complicated now as i have integrated more features such as translation.  </p>
<p>I'm not familiar with git or any repository, but in case it is helpfull for the community i could pass you the whole thing to make it available.  </p>
<p>ευχαριστώ, Δημήτρης</p></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="5969" data-cf-modified-12505242d4d8464e9f58bfd6-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="5969" data-cf-modified-12505242d4d8464e9f58bfd6-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span><span itemprop="upvoteCount">1</span></a></div>
    </div>
</div>
<div itemprop="suggestedAnswer" itemscope itemtype="https://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img src="https://secure.gravatar.com/avatar/60ffc0e01551cc5809445076da642103?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="https://schema.org/Person">
            <a href="/user/1058/humugus" class="user-moderator-N"><span itemprop="name">humugus</span></a>        </span>
        <br>

        <span class="karma">7.9k</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><span class="action-date action-reply-edit" data-id="5970" data-toggle="modal" data-target="#historyModal">
                edited <span>Mar '14</span>
              </span><br/><a name="C5970" href="#C5970">
                <time itemprop="dateCreated" datetime="2014-03-06T13:33:07-07:00" class="action-date">Mar '14</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>Auth Controller, as it is now , changes pending in the implementation , not the logic<br />
more commenting is required and some issues are not resolved</p>
<p>the flow :<br />
if registration is allowed (config), a guest can fill a registration form,<br />
if successfull an email will be sent with a link to confirm registration  </p>
<p>when a user is logged in he can reset his password</p>
<p>when a user has forgotten his/her password a form to request reset has to be filled with the account email<br />
upon valid request, an email will be sent with  a link to confirm reset<br />
if reset request is confirmed via the sent link, a random password will be sent with  a new email<br />
or if user login with old password the reset request will be cancelled  </p>
<p>emails with PHPMailer</p>
<pre><code class="language-php">&lt;?php

use HumugusAuth\Models\HumAuth\Users;
use HumugusAuth\Models\HumAuth\Logins;
use HumugusAuth\Models\HumAuth\Profiles;

class AuthController extends ControllerBase
{
    public function indexAction()
    {
        if($this-&gt;session-&gt;get('logged') == TRUE)
        {
            return $this-&gt;response-&gt;redirect('account');
        }
        else
        {
            return $this-&gt;response-&gt;redirect('');
        }
    }

    public function loginAction()
    {
        if($this-&gt;session-&gt;get('logged') == TRUE)
        {
            $this-&gt;flashSession-&gt;notice('You are already logged in.');
            return $this-&gt;response-&gt;redirect('account');
        }
        $form = new LoginForm();
        try
        {
            if ($this-&gt;request-&gt;isPost()) 
            {
                if($this-&gt;security-&gt;checkToken() == FALSE)
                {
                    if(! isset($error)){$error = new stdClass();}
                    $error-&gt;CSRF = TRUE;
                }
                if ($form-&gt;isValid($this-&gt;request-&gt;getPost()) == false)
                {
                    foreach ($form-&gt;getMessages() as $message){$this-&gt;flashSession-&gt;error($message);}
                }
                else
                {
                    $user = Users::findFirstByEmail($this-&gt;request-&gt;getPost('email'));
                    if($user)
                    {
                        if ($this-&gt;security-&gt;checkHash($this-&gt;request-&gt;getPost('password'), $user-&gt;password)) 
                        {
                            if($user-&gt;active == 0)
                            {
                                //not confirmed
                                $this-&gt;flashSession-&gt;warning('Your account is not confirmed yet.&lt;br /&gt;Please check your email box for instructions how to activate your account.');
                                return $this-&gt;response-&gt;redirect('');
                            }
                            if($user-&gt;active == -1)
                            {
                                //inactive
                                $this-&gt;flashSession-&gt;error('Your account is inactive.&lt;br /&gt;Please ask your administrator to restore your account.');
                                return $this-&gt;response-&gt;redirect('');
                            }                           

                            /* NOT working, have to resolve it..
                            if(isset($error))
                            {
                                if(isset($error-&gt;CSRF)){$this-&gt;flashSession-&gt;error('Login form session expired, please re-submit the form.');} //'CSRF validation failed'
                            }
                            else
                            */
                            {
                                if($user-&gt;new_pass_key != NULL or $user-&gt;new_pass_time != NULL)
                                {
                                    $user-&gt;new_pass_key = NULL;
                                    $user-&gt;new_pass_time = NULL;
                                    $user-&gt;save();
                                }
                                $this-&gt;session-&gt;set('logged', TRUE);
                                $profile = Profiles::findFirstByUser_id($user-&gt;id);
                                $this-&gt;session-&gt;set('user', array('userID' =&gt; $user-&gt;id, 'bg_body' =&gt; $profile-&gt;bg_body,'bg_well' =&gt; $profile-&gt;bg_well));
                                $this-&gt;flashSession-&gt;success('You have successfully log in.');
                                $login = new Logins();
                                $login-&gt;user_id = $user-&gt;id;
                                $login-&gt;save();
                                return $this-&gt;response-&gt;redirect('');
                            }
                        }
                        else
                        {
                            $this-&gt;flashSession-&gt;warning('Invalid email / password.');
                        }
                    }
                    else
                    {
                        $this-&gt;flashSession-&gt;warning('Email not found in our database.');
                    }
                }
            }
        }catch (AuthException $e){$this-&gt;flashSession-&gt;error($e-&gt;getMessage());}
    }

    public function logoutAction()
    {
        if($this-&gt;session-&gt;get('logged') == TRUE)
        {
            $this-&gt;session-&gt;remove('logged');
            $this-&gt;session-&gt;remove('user');
            $this-&gt;session-&gt;remove('server');
            $this-&gt;flashSession-&gt;notice('You have logout from the application.');
        }
        else
        {
            $this-&gt;flashSession-&gt;warning('You have already logout from the application.');
        }
        return $this-&gt;response-&gt;redirect('');
    }

    public function forgotPasswordAction()
    {
        $form = new ForgotPasswordForm();
        try 
        {
            if ($this-&gt;request-&gt;isPost()) 
            {
                if($this-&gt;security-&gt;checkToken() == FALSE)
                {
                    if(! isset($error)){$error = new stdClass();}
                    $error-&gt;CSRF = TRUE;
                }
                if ($form-&gt;isValid($this-&gt;request-&gt;getPost()) == false)
                {
                    foreach ($form-&gt;getMessages() as $message){$this-&gt;flashSession-&gt;error($message);}
                }
                else
                {
                    $user = Users::findFirstByEmail($this-&gt;request-&gt;getPost('email'));
                    if($user)
                    {
                        if($user-&gt;new_pass_time != NULL)
                        {
                            if(time() - $user-&gt;new_pass_time &lt; (5 * 60)) //5 minutes
                            {
                                $this-&gt;flashSession-&gt;warning('You requested a password reset less than 5 minutes ago. &lt;br /&gt;Please check your email box.');
                                return $this-&gt;response-&gt;redirect('');
                            }
                        }
                        $tempKey = preg_replace('/[^a-zA-Z0-9]/', '', base64_encode(openssl_random_pseudo_bytes(16)));
                        $user-&gt;new_pass_key = $tempKey;
                        $user-&gt;new_pass_time = time();
                        $user-&gt;save();
                        $result = EmailHelper::sendForgotPasswordEmail($user);
                        if($result['output'] == 'error')
                        {
                            $this-&gt;flashSession-&gt;error($result['message']);
                        }
                        else
                        {
                            $this-&gt;flashSession-&gt;success($result['message']);
                        }
                    }
                    else
                    {
                        $this-&gt;flashSession-&gt;warning('Email not found in our database.');
                    }
                }
            }
        }catch (AuthException $e){$this-&gt;flashSession-&gt;error($e-&gt;getMessage());}
        return $this-&gt;response-&gt;redirect('');
    }

    public function confirmPasswordResetAction($id = 0, $key = '')
    {
        if($this-&gt;session-&gt;get('logged') == TRUE)
        {
            $this-&gt;flashSession-&gt;notice('You cannot reset your password while you are logged in.&lt;br /&gt; Change your password in your account settings page.');
            return $this-&gt;response-&gt;redirect('account/settings');
        }
        $id = $this-&gt;filter-&gt;sanitize($id, 'int');
        $key = $this-&gt;filter-&gt;sanitize($key, 'string');
        $user = Users::findFirst($id);
        if(! $user)
        {
            $this-&gt;flashSession-&gt;error('Could not reset password. &lt;br /&gt;The requested account not found in our records.');
            return $this-&gt;response-&gt;redirect('');
        }
        if($user-&gt;new_pass_key != $key)
        {
            $this-&gt;flashSession-&gt;error('Could not reset password. &lt;br /&gt;Reset key is not valid.');
            return $this-&gt;response-&gt;redirect('');
        }
        $tempPassword = preg_replace('/[^a-zA-Z0-9]/', '', base64_encode(openssl_random_pseudo_bytes(12)));
        $user-&gt;password = $this-&gt;security-&gt;hash($tempPassword);
        $user-&gt;new_pass_key = NULL;
        $user-&gt;new_pass_time = NULL;
        $result = EmailHelper::sendNewPasswordEmail($user, $tempPassword);
        if($result['output'] == 'error')
        {
            $this-&gt;flashSession-&gt;error($result['message']);
        }
        else
        {
            $this-&gt;flashSession-&gt;success($result['message']);
            $user-&gt;save();
        }
        return $this-&gt;response-&gt;redirect('');
    }

    public function registerAction()
    {
        $form = new RegisterForm();
        try 
        {
            if ($this-&gt;request-&gt;isPost()) 
            {
                if($this-&gt;security-&gt;checkToken() == FALSE)
                {
                    if(! isset($error)){$error = new stdClass();}
                    $error-&gt;CSRF = TRUE;
                }
                if ($form-&gt;isValid($this-&gt;request-&gt;getPost()) == false) 
                {
                    foreach ($form-&gt;getMessages() as $message){$this-&gt;flashSession-&gt;error($message);}
                } 
                else 
                {
                    /* NOT working, have to resolve it..
                    if(isset($error))
                    {
                        if(isset($error-&gt;CSRF)){$this-&gt;flashSession-&gt;error('Login form session expired, please re-submit the form.');} //'CSRF validation failed'
                    }
                    else
                    */
                    {
                        $user = new Users();
                        $user-&gt;email = $this-&gt;request-&gt;getPost('email');
                        $user-&gt;name = $this-&gt;request-&gt;getPost('name');
                        $password = $this-&gt;request-&gt;getPost('password');
                        $user-&gt;password = $this-&gt;security-&gt;hash($password);
                        $success = $user-&gt;save();
                        if ($success) 
                        {
                            $result = EmailHelper::sendRegistrationEmail($user);
                            if($result['output'] == 'error')
                            {
                                $this-&gt;flashSession-&gt;error($result['message']);
                            }
                            else
                            {
                                $this-&gt;flashSession-&gt;success($result['message']);
                            }               
                        }
                        else
                        {
                            $this-&gt;flashSession-&gt;error('Sorry, the following problems were generated: ');
                            foreach ($user-&gt;getMessages() as $message){$this-&gt;flashSession-&gt;error($message);}
                        }
                    }
                }
            }
        }catch (AuthException $e){$this-&gt;flashSession-&gt;error($e-&gt;getMessage());}
    }

    public function confirmRegistrationAction($name = '', $key = '')
    {
        $name = $this-&gt;filter-&gt;sanitize($name, 'string');
        $key = $this-&gt;filter-&gt;sanitize($key, 'string');

        $user = Users::findFirst(array('conditions' =&gt; 'name = "'.$name.'" AND activation_key = "'.$key.'" AND active = 0'));
        if(! $user)
        {
            $this-&gt;flashSession-&gt;error('Sorry, we could not find any account with your credentials.');
            return $this-&gt;response-&gt;redirect('');
        }
        $user-&gt;active = 1;
        $user-&gt;activation_key = NULL;
        $user-&gt;confirmed_at = time();
        if($user-&gt;save() == FALSE)
        {
            $this-&gt;flashSession-&gt;error('We could not activate your account.&lt;br /&gt;Please try again later.');
        }
        else
        {
            $this-&gt;flashSession-&gt;success('Your account has been activated successfully.&lt;br /&gt;You can now sign in your account.');
        }
        return $this-&gt;response-&gt;redirect('');
    }

}//end of class</code></pre></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="5970" data-cf-modified-12505242d4d8464e9f58bfd6-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="5970" data-cf-modified-12505242d4d8464e9f58bfd6-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
    </div>
</div>
<div itemprop="suggestedAnswer" itemscope itemtype="https://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img src="https://secure.gravatar.com/avatar/1eb2415bda000b22fd1f801bb9e8c003?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="https://schema.org/Person">
            <a href="/user/2/niden" class="user-moderator-Y"><span itemprop="name">Nikolaos Dimopoulos</span></a>        </span>
        <br>

        <span class="karma">39.4k</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><a name="C5971" href="#C5971">
                <time itemprop="dateCreated" datetime="2014-03-06T14:03:53-07:00" class="action-date">Mar '14</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>Good to hear that your project is progressing.</p>
<p>Re: translations, have a look on how we do them for the main website. We use Transifex (www.transifex.com) for our translations which in effect end up as an array of keys/values for the site to use.</p>
<p>Register the component for Volt
<a href="https://github.com/niden/website/blob/master/app/var/bootstrap.php#L251">https://github.com/niden/website/blob/master/app/var/bootstrap.php#L251</a></p>
<p>Usage
<a href="https://github.com/niden/website/blob/master/app/views/download/index.volt#L24">https://github.com/niden/website/blob/master/app/views/download/index.volt#L24</a></p>
<p>Usage with parameters
<a href="https://github.com/niden/website/blob/master/app/views/download/index.volt#L24">https://github.com/niden/website/blob/master/app/views/download/index.volt#L24</a></p>
<p>The actual array of keys/values that Transifex handles.
<a href="https://github.com/niden/website/blob/master/app/var/languages/en.php#L104">https://github.com/niden/website/blob/master/app/var/languages/en.php#L104</a></p>
<p>HTH</p>
<p>PS: Parakalw :)</p></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="5971" data-cf-modified-12505242d4d8464e9f58bfd6-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="5971" data-cf-modified-12505242d4d8464e9f58bfd6-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span><span itemprop="upvoteCount">1</span></a></div>
    </div>
</div>
<div itemprop="suggestedAnswer" itemscope itemtype="https://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img src="https://secure.gravatar.com/avatar/60ffc0e01551cc5809445076da642103?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="https://schema.org/Person">
            <a href="/user/1058/humugus" class="user-moderator-N"><span itemprop="name">humugus</span></a>        </span>
        <br>

        <span class="karma">7.9k</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><span class="action-date action-reply-edit" data-id="5998" data-toggle="modal" data-target="#historyModal">
                edited <span>Mar '14</span>
              </span><br/><a name="C5998" href="#C5998">
                <time itemprop="dateCreated" datetime="2014-03-07T06:54:40-07:00" class="action-date">Mar '14</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p><strong><em>Re: Unless there is a specific requirement that you store the user data from the db and the data that exists already in the session, you are duplicating data.</em></strong>  </p>
<p>There are scenarios where is necessary to have live user data instead of those in stored in session :  </p>
<p>Consider a case where a user (badUser) in a forum is spamming, if an admin ban badUser,  it will take effect only after badUser tries to login again.<br />
Likewise,  consider that Boss requests admin (an employee of Boss)  for more access rights on application resources, it is not always possible to force him / her logout and login again to check if new access rights setting suits his / her needs<br />
I know that i describe rare cases, but we are programmers right  ? :)  </p>
<p><strong><em>Re: Translation</em></strong><br />
thank you for your time to suggest me more options<br />
so far,  \Phalcon\Translate\Adapter\NativeArray() is sufficient for my needs,<br />
as we develop business applications i cannot rely on community for translations, everything has to happen in house.</p></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="5998" data-cf-modified-12505242d4d8464e9f58bfd6-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="5998" data-cf-modified-12505242d4d8464e9f58bfd6-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
    </div>
</div>
<div itemprop="suggestedAnswer" itemscope itemtype="https://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img src="https://secure.gravatar.com/avatar/1eb2415bda000b22fd1f801bb9e8c003?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="https://schema.org/Person">
            <a href="/user/2/niden" class="user-moderator-Y"><span itemprop="name">Nikolaos Dimopoulos</span></a>        </span>
        <br>

        <span class="karma">39.4k</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><span class="action-date action-reply-edit" data-id="5999" data-toggle="modal" data-target="#historyModal">
                edited <span>Mar '14</span>
              </span><br/><a name="C5999" href="#C5999">
                <time itemprop="dateCreated" datetime="2014-03-07T07:09:00-07:00" class="action-date">Mar '14</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>Understood.</p>
<p>For the permissions, you can do this also (another suggestion)</p>
<ol>
<li>In your user table store a column called last_update_date (datetime).</li>
<li>When you first get the user logged in (Login controller) you store the whole user object in the session</li>
<li>You create an action that will return a JSON object (AJAX) with a true/false value</li>
<li>The action effectively picks up the session-user object and checks the last_update_date column. It then queries the db for that user. If the last_update_date has been changed i.e. admin change, then it will force the user to logout immediately.</li>
<li>The AJAX action can be queried using javascript every X minutes OR every beforeExecuteRoute call i.e. every request</li>
</ol>
<p>This way you will have an active user that clicks around the application. When the admin changes their permissions, the ajax related action will return TRUE (i.e. profile has been changed) and that will force a permission refresh or a logout. If the user stays idle, the javascript polling mechanism will call the ajax action and if again it returns TRUE the user will be logged out etc.</p>
<p>Re: Translations
I have found that using Transifex helps a lot in my projects since I don't have to remember what strings to translate and what not. It all depends on the complexity of your project.</p></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="5999" data-cf-modified-12505242d4d8464e9f58bfd6-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="5999" data-cf-modified-12505242d4d8464e9f58bfd6-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span><span itemprop="upvoteCount">1</span></a></div>
    </div>
</div>
<div itemprop="suggestedAnswer" itemscope itemtype="https://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img src="https://secure.gravatar.com/avatar/60ffc0e01551cc5809445076da642103?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="https://schema.org/Person">
            <a href="/user/1058/humugus" class="user-moderator-N"><span itemprop="name">humugus</span></a>        </span>
        <br>

        <span class="karma">7.9k</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><span class="action-date action-reply-edit" data-id="6001" data-toggle="modal" data-target="#historyModal">
                edited <span>Mar '14</span>
              </span><br/><a name="C6001" href="#C6001">
                <time itemprop="dateCreated" datetime="2014-03-07T07:50:15-07:00" class="action-date">Mar '14</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>Thank you for your reply :)<br />
What i usually do to refresh session data is to store the lastUpdated in the session itself, if the session is older than some minutes i query the db once again</p>
<p>Actually what i try to build (as described in this thread) is already up and running (used to use codeigniter) and the logic and analysis is considered sufficient<br />
since i decided to rewrite the whole project, and have chosen phalcon for that what i seek in this thread is mostly suggestions like : <em>you can do that this way in phalcon</em>  </p>
<p>For example, since access settings are per user, ACL is not appropriate for my needs, therefore the old access rights on a database table (a row per user) will be used ,
please see below a combination of my approach with your suggestions :<br />
in ControllerBase :  </p>
<pre><code class="language-php">    const AUTH_ACCESS   = 'authAccess';     // user access settings
    public function setAccess($access)
    {
        foreach($access as $key =&gt; $val){$data[$key] = $val;}
        $this-&gt;session-&gt;set(self::AUTH_ACCESS, $data);
    }
    public function getAccess(){if ($this-&gt;session-&gt;has(self::AUTH_ACCESS)){return $this-&gt;session-&gt;get(self::AUTH_ACCESS);} return false;}

    public function beforeExecuteRoute(Dispatcher $dispatcher)
    {
        if ($this-&gt;isLogged() == TRUE)
        {
            $this-&gt;userAccess = self::getAccess();
            $this-&gt;setViewVar('sessionAccess', $this-&gt;userAccess);
        }
    }
</code></pre>
<p>i still duplicate data, but i do that in order to have the accessRights available everywhere in the application, although duplicated it is more DRY  than examining the session in any place i have to decide if something is available to the specific user or not  </p>
<p>In Auth  / login, if login success :  </p>
<pre><code class="language-php">    $access = UserAccess::findFirst(array('conditions' =&gt; 'user_id = '.$user-&gt;id, 'hydration' =&gt; \Phalcon\Mvc\Model\Resultset::HYDRATE_ARRAYS));  // prefer it as array
    $this-&gt;setAccess($access); </code></pre>
<p>in a random Controller :   </p>
<pre><code class="language-php">    public function indexAction($id = 0)
    {
        if($this-&gt;userAccess['emplView'] == 0)
        {
            $this-&gt;flashSession-&gt;error('You are not allowed to commit this action.');
            return $this-&gt;response-&gt;redirect('account/index');
        }
        $id = $this-&gt;filter-&gt;sanitize($id, 'int');
        $employee = Employees::findFirstById($id);
        ...  
        ...  </code></pre>
<p>in a random View  </p>
<pre><code class="language-php">
        &lt;ul class="dropdown-menu"&gt;
            &lt;?php if($sessionAccess['emplView'] &gt; 0){ ?&gt;
            &lt;li&gt;&lt;?php echo $this-&gt;tag-&gt;linkTo('employees/seek', '&lt;span class="glyphicon glyphicon-user"&gt;&lt;/span&gt; Employees') ?&gt;&lt;/li&gt;
            &lt;?php } ?&gt;
            ..
            ..</code></pre>
<p>Of course good programming technics and habits, and more sophisticated approaches and goodies like that are always welcome<br />
the discussion is fruitfull  and hopefully other users will find them usefull and pick what is best for them,<br />
as you can see some of your earlier suggestions are already implemented although they are not phalcon specific.  </p>
<p>again, athank you for your time !</p></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="6001" data-cf-modified-12505242d4d8464e9f58bfd6-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="6001" data-cf-modified-12505242d4d8464e9f58bfd6-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
    </div>
</div>
<div itemprop="suggestedAnswer" itemscope itemtype="https://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img src="https://secure.gravatar.com/avatar/1eb2415bda000b22fd1f801bb9e8c003?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="https://schema.org/Person">
            <a href="/user/2/niden" class="user-moderator-Y"><span itemprop="name">Nikolaos Dimopoulos</span></a>        </span>
        <br>

        <span class="karma">39.4k</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><a name="C6013" href="#C6013">
                <time itemprop="dateCreated" datetime="2014-03-07T13:29:37-07:00" class="action-date">Mar '14</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>I don't see anything wrong with your implementation. It works and that is what is most important right?</p>
<p>My personal implementation on this would have been a Auth class on its own (to handle authentication) as well as an ACL class. You register those in your DI container and they are available throughout the application.</p>
<p>Your Auth class would give you functions like isLoggedIn, getUserId etc., more like a separation of logic to what I posted earlier in the base controller. </p>
<p>The ACL will offer the same functionality as you have there, but you will move that logic in a separate component which will make it a lot easier for you to test and ensure that there isn't some odd case you missed :)</p></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="6013" data-cf-modified-12505242d4d8464e9f58bfd6-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="6013" data-cf-modified-12505242d4d8464e9f58bfd6-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
    </div>
</div>
<div class="row"><div class="col-md-1 small" align="center"></div>
        <div class="col-md-11 login-comment">
            
        </div></div>
</div><input type="hidden" id="post-id" name="post-id" value="1669" /><div id="suggested-posts"></div>
    <div id="sticky-progress" style='display:none'></div>
</div>
    </div>