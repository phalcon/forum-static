---
layout: default
title: 'Auto join relations - Discussion'
---

    <div class="container">
        {% include warning.html %}


<div itemscope itemtype="http://schema.org/Question"><ol class="breadcrumb">
    <li><a href="/">Home</a></li>
    <li><a href="/category/2/orm">ORM</a></li>
</ol>
<div class="row table-title">
    <div class="col-lg-8 col-md-7 col-sm-6 col-xs-12 wrapper-author">
        <h1 class="" itemprop="name">Auto join relations</h1>
        <div class="visible-xs-block mobile-author">
            <span itemprop="author" itemscope itemtype="http://schema.org/Person"><a href="/user/369/ThinTroll" class="user-moderator-N"><span itemprop="name">ThinTroll</span></a></span>
            <time itemprop="dateCreated" datetime="2013-07-28T05:06:03-07:00">Jul '13</time>
        </div>
    </div>
    <div class="col-lg-4 col-md-5 col-sm-6 hidden-xs text-right wrapper-stats">
        <table class="table-stats" width="100%">
            <tr style="vertical-align: top;">
                <td>
                    <label>Created</label><br>
                    <time itemprop="dateCreated" datetime="2013-07-28T05:06:03-07:00">Jul '13</time>
                </td>
                <td>
                    <label>Last Reply</label><br>Aug '13</td>
                <td>
                    <label>Replies</label><br>
                    <span itemprop="answerCount">2</span>
                </td>
                <td>
                    <label>Views</label><br>2628</td>
                <td>
                    <label>Votes</label><br>
                    <span itemprop="upvoteCount">3</span>
                </td>
            </tr>
        </table>
    </div>
</div>
<div class="discussion">
        <div class="row reply-block">
            <div class="col-md-1 col-sm-1 hidden-xs text-center">
                <img src="https://secure.gravatar.com/avatar/3aac02f4fced7538c1e1764d1709776f?s=48&amp;r=pg&amp;d=identicon" class="img-rounded avatar" /><br>
                <span itemprop="author" itemscope itemtype="http://schema.org/Person" class="avatar-name"><a href="/user/369/ThinTroll" class="user-moderator-N"><span itemprop="name">ThinTroll</span></a></span>
                <span class="karma">2.5k</span>
            </div>
            <div class="col-md-11 col-sm-11 col-xs-12 post-body"><div class="posts-date hidden-xs" align="right">
        <a name="C665" href="#C665">
        <time class="action-date">Jul '13</time>
    </a>
</div>
<div class="post-content"><div><p>Hi.
Is there any way to use relations in query condition, like in yii, without manualy join them using querybuilder?</p>
<p>I want something like this to find all robots with arms:</p>
<pre><code class="language-php">Robot::find( array( "RobotPart.name = :part:", 'bind' =&gt; array( 'part' =&gt; 'arm' ) ) );</code></pre>
<p>instead of this monstrous construction:</p>
<pre><code class="language-php">$this-&gt;modelsManager-&gt;createBuilder()
    -&gt;from('Robots')
    -&gt;join('RobotsParts')
    -&gt;where('RobotPart.name = :part:', array( 'part' =&gt; 'arm' ))
    -&gt;getQuery()
    -&gt;execute();</code></pre></div>                </div>

                <div class="posts-buttons text-right"><a href="#"  class="btn btn-danger btn-xs" data-cf-modified-bb7ab43f800c93df8d92afd2-="">
        <span class="glyphicon glyphicon-thumbs-down"></span></a>
    <a href="#"  class="btn btn-success btn-xs" data-cf-modified-bb7ab43f800c93df8d92afd2-="">
        <span class="glyphicon glyphicon-thumbs-up"></span><span itemprop="upvoteCount">3</span></a></div>
            </div>
        </div><div itemprop="suggestedAnswer" itemscope itemtype="http://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img src="https://secure.gravatar.com/avatar/7e7fb1644bf216836a1da8c36ac9684b?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="http://schema.org/Person">
            <a href="/user/272/Firnis" class="user-moderator-N"><span itemprop="name">Andrey</span></a>        </span>
        <br>

        <span class="karma">404</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><a name="C2741" href="#C2741">
                <time itemprop="dateCreated" datetime="2013-07-28T11:41:29-07:00" class="action-date">Jul '13</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>You need to set relations between models first. <a href="http://docs.phalcon.io/en/latest/reference/models.html#relationships-between-models">http://docs.phalcon.io/en/latest/reference/models.html#relationships-between-models</a>
And then you can get all robots with arms like this:</p>
<pre><code class="language-php">$robots = RobotsParts::findFirst(
    ["part = :part:"],
    "bind" =&gt; ["part" =&gt; "arm"]
)-&gt;Robots;</code></pre></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="2741" data-cf-modified-bb7ab43f800c93df8d92afd2-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="2741" data-cf-modified-bb7ab43f800c93df8d92afd2-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
    </div>
</div>
<div itemprop="suggestedAnswer" itemscope itemtype="http://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img src="https://secure.gravatar.com/avatar/3aac02f4fced7538c1e1764d1709776f?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="http://schema.org/Person">
            <a href="/user/369/ThinTroll" class="user-moderator-N"><span itemprop="name">ThinTroll</span></a>        </span>
        <br>

        <span class="karma">2.5k</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><a name="C2743" href="#C2743">
                <time itemprop="dateCreated" datetime="2013-07-29T03:07:36-07:00" class="action-date">Jul '13</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>Your solution wouldn't work in more complex situation like this:</p>
<pre><code class="language-php">Robot::find( array( "RobotPart.name = :part: AND RobotMotherboard.name = :motherboard:", 'bind' =&gt; array( 'part' =&gt; 'arm', 'motherboard' =&gt; 'intel' ) ) );</code></pre>
<p>Also, I've already made dirty hack:</p>
<pre><code class="language-php">abstract class Model extends \Phalcon\Mvc\Model {

    static protected $modelsManager;
    static public function setModelsManager( $modelsManager ) {
        self::$modelsManager = $modelsManager;
    }

    static protected $relationsMetadata = array();
    static protected function getRelations( $modelName ) {
        if( ! isset( self::$relationsMetadata[$modelName] ) ) {
            $mm = self::$modelsManager;

            // initialize model relations metadata
            if( ! $mm-&gt;isInitialized( $modelName ) ) {
                $mm-&gt;load( $modelName );
            }

            // cache relations
            self::$relationsMetadata[$modelName] = array();
            foreach( $mm-&gt;getRelations( $modelName ) as $relation ) {
                $options = $relation-&gt;getOptions();
                $alias = isset( $options['alias'] ) ? $options['alias'] : $relation-&gt;getReferencedModel();

                if( ! $mm-&gt;isInitialized( $relation-&gt;getReferencedModel() ) ) {
                    $mm-&gt;load( $relation-&gt;getReferencedModel() );
                }

                self::$relationsMetadata[$modelName][$alias] = $relation;
            }
        }

        return self::$relationsMetadata[$modelName];
    }

    static protected function replaceRelations( &amp;$query, &amp;$joins, $modelName, $condition, $parentAlias = '' )
    {
        $nextLevel = array();

        if( $relations = self::getRelations( $modelName ) ) {
            // find child calls
            preg_match_all("/".( $parentAlias ? $parentAlias.'(.|&lt;-|-&gt;)' : '' )."(".implode('|', array_keys($relations)).")[^\w:%\'\"]/i", $condition, $matches, PREG_OFFSET_CAPTURE);

            // replace parent by joined table alias
            foreach( array_reverse($matches[$parentAlias ? 2 : 1]) as $i =&gt; $match ) {
                if( ! isset( $joins[$match[0]] ) ) {
                    $alias = 't'.count($joins);
                    $joins[$match[0]] = array(
                         'alias' =&gt; $alias,
                         'model' =&gt; $relations[$match[0]]-&gt;getReferencedModel(),
                         'cond' =&gt; $alias . '.' . $relations[$match[0]]-&gt;getReferencedFields() . '=' . ($parentAlias ? $parentAlias : $modelName) . '.' . $relations[$match[0]]-&gt;getFields(),
                         'type' =&gt; ( $matches[1][$i][0] == '&lt;-' ? 'LEFT' : ( $matches[1][$i][0] == '-&gt;' ? 'RIGHT' : 'INNER' ) )
                    );
                    $nextLevel[$alias] = $relations[$match[0]]-&gt;getReferencedModel();
                }

                $pal = $parentAlias ? strlen($parentAlias) + strlen($matches[1][$i][0]) : 0;
                $condition = substr_replace($condition, $joins[$match[0]]['alias'], $match[1] - $pal, strlen($match[0]) + $pal );                   
            }
        }

        foreach( $nextLevel as $alias =&gt; $nextModelName ) {
            $condition = self::replaceRelations( $query, $joins, $nextModelName, $condition, $alias );
        }

        return $condition;
    }

    static protected function buildCriteria( $condition, $params ) {
        $info = self::query();

        $query = self::$modelsManager-&gt;createBuilder()-&gt;from( $info-&gt;getModelName() );

        if( $condition ) {
            $joins = array();
            $condition = self::replaceRelations($query, $joins, $info-&gt;getModelName(), $condition);

            foreach( $joins as $join ) {
                $query-&gt;join( $join['model'], $join['cond'], $join['alias'], $join['type'] );
            }

            $query-&gt;where( $condition, $params );
        }

        return $query;
    }

    static public function get( $condition = '', $params = array() ) {
        return self::buildCriteria( $condition, $params )-&gt;getQuery()-&gt;execute();
    }

    static public function getFirst( $condition = '', $params = array() ) {
        return self::buildCriteria( $condition, $params )-&gt;limit(1)-&gt;getQuery()-&gt;execute()-&gt;getFirst();
    }

}</code></pre>
<p>And now I can write queries like this:</p>
<pre><code class="language-php">$robots = Robot::get( "RobotParts.Vendor.name = :vendor: AND RobotMotherboard.Memory.type = :memory:", array( 'vendor' =&gt; 'Umbrella Inc.', 'memory' =&gt; 'DDR2' ) );</code></pre>
<p>but I still wanna find a better solution.</p></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="2743" data-cf-modified-bb7ab43f800c93df8d92afd2-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="2743" data-cf-modified-bb7ab43f800c93df8d92afd2-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
    </div>
</div>
<div itemprop="suggestedAnswer" itemscope itemtype="http://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img src="https://secure.gravatar.com/avatar/fdcb3ffbfc1c98d4898826330cc9f1a5?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="http://schema.org/Person">
            <a href="/user/404/incrize" class="user-moderator-N"><span itemprop="name">incrize</span></a>        </span>
        <br>

        <span class="karma">891</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><a name="C2930" href="#C2930">
                <time itemprop="dateCreated" datetime="2013-08-09T03:34:55-07:00" class="action-date">Aug '13</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>Hi.
I have a similar problem.
Is there a solution?</p></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="2930" data-cf-modified-bb7ab43f800c93df8d92afd2-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="2930" data-cf-modified-bb7ab43f800c93df8d92afd2-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
    </div>
</div>
<div class="row"><div class="col-md-1 small" align="center"></div>
        <div class="col-md-11 login-comment">
            
        </div></div>
</div><input type="hidden" id="post-id" name="post-id" value="665" /><div id="suggested-posts"></div>
    <div id="sticky-progress" style='display:none'></div>
</div>
    </div>