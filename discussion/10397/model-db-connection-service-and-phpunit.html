---
layout: default
title: 'Model, Db connection service and PHPunit - Discussion'
---

    <div class="container">
        {% include warning.html %}


<div itemscope itemtype="http://schema.org/Question"><ol class="breadcrumb">
    <li><a href="/">Home</a></li>
    <li><a href="/category/29/database">Database</a></li>
</ol>
<div class="row table-title">
    <div class="col-lg-8 col-md-7 col-sm-6 col-xs-12 wrapper-author">
        <h1 class="" itemprop="name">Model, Db connection service and PHPunit</h1>
        <div class="visible-xs-block mobile-author">
            <span itemprop="author" itemscope itemtype="http://schema.org/Person"><a href="/user/3151/sboudoux" class="user-moderator-N"><span itemprop="name">stephane</span></a></span>
            <time itemprop="dateCreated" datetime="2016-02-04T09:04:47-07:00">Feb '16</time>
        </div>
    </div>
    <div class="col-lg-4 col-md-5 col-sm-6 hidden-xs text-right wrapper-stats">
        <table class="table-stats" width="100%">
            <tr style="vertical-align: top;">
                <td>
                    <label>Created</label><br>
                    <time itemprop="dateCreated" datetime="2016-02-04T09:04:47-07:00">Feb '16</time>
                </td>
                <td>
                    <label>Last Reply</label><br>Feb '16</td>
                <td>
                    <label>Replies</label><br>
                    <span itemprop="answerCount">1</span>
                </td>
                <td>
                    <label>Views</label><br>926</td>
                <td>
                    <label>Votes</label><br>
                    <span itemprop="upvoteCount">1</span>
                </td>
            </tr>
        </table>
    </div>
</div>
<div class="discussion">
        <div class="row reply-block">
            <div class="col-md-1 col-sm-1 hidden-xs text-center">
                <img src="https://secure.gravatar.com/avatar/076d8254b3d82407f201a00995d41c96?s=48&amp;r=pg&amp;d=identicon" class="img-rounded avatar" /><br>
                <span itemprop="author" itemscope itemtype="http://schema.org/Person" class="avatar-name"><a href="/user/3151/sboudoux" class="user-moderator-N"><span itemprop="name">stephane</span></a></span>
                <span class="karma">24.8k</span>
            </div>
            <div class="col-md-11 col-sm-11 col-xs-12 post-body"><div class="posts-date hidden-xs" align="right">
        <a name="C10397" href="#C10397">
        <time class="action-date">Feb '16</time>
    </a>
</div>
<div class="post-content"><div><p>Hi all,</p>
<p>I'm starting to implement unit test in my Phalcon MVC app, and I'm struggling to make my models work there.
I've picked up the phpunit example from the incubator, working well, I use the [ CoreTestCase-&gt;setUp() ] method to load/overwrite some services on the fly (locale, db, cache...), and my test are running fine.</p>
<p>Now comes the time to test the first function using models, and it fails. I get the following message:
&quot;Service 'db' wasn't found in the dependency injection container&quot;.</p>
<p>Some more details:</p>
<ul>
<li>Service 'db' is managing the db connection (\Phalcon\Db\Adapter\Pdo\Mysql) </li>
<li>That happens when I try to save data using my email model  [$mEmail-&gt;create();]</li>
<li>I make my models inherit from a modelStub class containing the static metaData mapping  (no db connection required to instanciate the models)</li>
<li>if I dump the model DI   [var_dump($mEmail-&gt;getDi()-&gt;getDb());] it shows the db service properly configured</li>
</ul>
<p>I had a look at the modelManager class, but didn't have much success. Can anyone help me ?
If not the model, what class is looking for the 'db' service ? Alternatively, is there a way to enforce all the classes reloading the DI once I've added some services in the setUp helper?</p>
<p>Thanks</p></div>                </div>

                <div class="posts-buttons text-right"><a href="#"  class="btn btn-danger btn-xs" data-cf-modified-ddf2877a71d07463ed54fc57-="">
        <span class="glyphicon glyphicon-thumbs-down"></span></a>
    <a href="#"  class="btn btn-success btn-xs" data-cf-modified-ddf2877a71d07463ed54fc57-="">
        <span class="glyphicon glyphicon-thumbs-up"></span><span itemprop="upvoteCount">1</span></a></div>
            </div>
        </div><div itemprop="suggestedAnswer" itemscope itemtype="http://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img src="https://secure.gravatar.com/avatar/076d8254b3d82407f201a00995d41c96?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="http://schema.org/Person">
            <a href="/user/3151/sboudoux" class="user-moderator-N"><span itemprop="name">stephane</span></a>        </span>
        <br>

        <span class="karma">24.8k</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><a name="C29669" href="#C29669">
                <time itemprop="dateCreated" datetime="2016-02-05T03:43:50-07:00" class="action-date">Feb '16</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>Nobody ever had this problem ?</p></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="29669" data-cf-modified-ddf2877a71d07463ed54fc57-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="29669" data-cf-modified-ddf2877a71d07463ed54fc57-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
    </div>
</div>
<div itemprop="suggestedAnswer" itemscope itemtype="http://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img src="https://secure.gravatar.com/avatar/746a625a9264a203a6ddf711e0c6b120?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="http://schema.org/Person">
            <a href="/user/301/quasipickle" class="user-moderator-Y"><span itemprop="name">Dylan Anderson</span></a>        </span>
        <br>

        <span class="karma">125.8k</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><a name="C29673" href="#C29673">
                <time itemprop="dateCreated" datetime="2016-02-05T12:56:28-07:00" class="action-date">Feb '16</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>This probably isn't the answer you're looking for, but when I'm doing tests, I just use a test database.  Then in my test bootstrap file, I just point the DB service to a different databas.</p></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="29673" data-cf-modified-ddf2877a71d07463ed54fc57-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="29673" data-cf-modified-ddf2877a71d07463ed54fc57-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
    </div>
</div>
<div itemprop="suggestedAnswer" itemscope itemtype="http://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img src="https://secure.gravatar.com/avatar/076d8254b3d82407f201a00995d41c96?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="http://schema.org/Person">
            <a href="/user/3151/sboudoux" class="user-moderator-N"><span itemprop="name">stephane</span></a>        </span>
        <br>

        <span class="karma">24.8k</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><a name="C29687" href="#C29687">
                <time itemprop="dateCreated" datetime="2016-02-08T04:16:43-07:00" class="action-date">Feb '16</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>Hey Dylan,</p>
<p>Thank you for your answer, but my issue is a bit more complex that just loading a different databse.
I use a MVC app and some shared services (not Phalcon once, some php classes uses accross modules/controllers) so I need to load my boostrap file (or most of it) to run tests.</p>
<p>But here is the problem: when using my models it seems like a &quot;high level&quot; phalcon class is not using the DI I've loaded. The models are properly loaded with all the correct attributes and correct DI, but when I try to execute a query it failed to find the 'db' service.
I pressume there's an issue somewhere with  $di = DI::getDefault(); </p>
<p>To make it work, I have refactored all my file inclusions and reload the full app using the setUp method for each test. That seem to work, but that makes the tests seriously slower. See the code below:</p>
<p>A test I've written to test basic phalcon services:</p>
<pre><code class="language-php">class DiTest extends \CoreTestCase
{
    public function testCoreService()
    {
        $this-&gt;setUp(null, null, true);

        $oService = $this-&gt;di-&gt;get('db');
        $this-&gt;assertNotEmpty($oService, 'Db service empty / not loaded');

        $oService = $this-&gt;di-&gt;get('cache');
        $this-&gt;assertNotEmpty($oService, 'Cache/redis service empty / not loaded');

        /* .. */        
    }
}</code></pre>
<p>the updated setUp() method, reloading the full MVC app when requested by the test:</p>
<pre><code class="language-php">
 public function setUp(Phalcon\DiInterface $di = NULL, Phalcon\Config $config = NULL, $pbLoadMvc = false)
    {
        // Load any additional services that might be required during testing
        $di = DI::getDefault(); 

        // Get any DI components here. If you have a config, be sure to pass it to the parent
        if($pbLoadMvc)
        {
            $di = loadMvcDi($di);
        }

        parent::setUp($di);
        $this-&gt;_loaded = true;
    }</code></pre>
<p>And finally the function that relaods the MVC:</p>
<pre><code class="language-php">function loadMvcDi($di)
{
    // Add any needed services to the DI here
    include(PATH_ROOT . '/apps/config/bootstrap.php');

    $oTestUser = $di-&gt;get('user');
    $oTestUser-&gt;loadSystemTestUser();
    $di-&gt;set('user', $oTestUser);

    if($di-&gt;has('session'))
    {
        //overwrite session settings from redis to file
    }

    if($di-&gt;has('db'))
    {
        //overwrite db settings
        $di-&gt;setShared('db', function() use ($___asConfig)
        {
            $oDb =  new \Phalcon\Db\Adapter\Pdo\Mysql($___asConfig['database']['phpunit'];
            if(!$oDb)
                exit('no db for phpunit tests');

            return $oDb;
        });
        $di-&gt;get('db');
    }

    return $di;
}</code></pre>
<p>So if someone has a better/more efficient was to implemnent phpunit with a MVC, I'm a taker.</p></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="29687" data-cf-modified-ddf2877a71d07463ed54fc57-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="29687" data-cf-modified-ddf2877a71d07463ed54fc57-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
    </div>
</div>
<div class="row"><div class="col-md-1 small" align="center"></div>
        <div class="col-md-11 login-comment">
            
        </div></div>
</div><input type="hidden" id="post-id" name="post-id" value="10397" /><div id="suggested-posts"></div>
    <div id="sticky-progress" style='display:none'></div>
</div>
    </div>