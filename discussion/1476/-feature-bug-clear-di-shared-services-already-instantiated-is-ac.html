---
layout: default
title: '[Feature/bug] Clear DI shared services already instantiated is actually impossible. - Discussion'
---

    <div class="container">
        {% include warning.html %}


<div itemscope itemtype="http://schema.org/Question"><ol class="breadcrumb">
    <li><a href="/">Home</a></li>
    <li><a href="/category/20/internals">Internals</a></li>
</ol>
<div class="row table-title">
    <div class="col-lg-8 col-md-7 col-sm-6 col-xs-12 wrapper-author">
        <h1 class="" itemprop="name">[Feature/bug] Clear DI shared services already instantiated is actually impossible.</h1>
        <div class="visible-xs-block mobile-author">
            <span itemprop="author" itemscope itemtype="http://schema.org/Person"><a href="/user/864/aledelgo" class="user-moderator-N"><span itemprop="name">Alessandro Del Gobbo</span></a></span>
            <time itemprop="dateCreated" datetime="2014-01-20T04:09:34-07:00">Jan '14</time>
        </div>
    </div>
    <div class="col-lg-4 col-md-5 col-sm-6 hidden-xs text-right wrapper-stats">
        <table class="table-stats" width="100%">
            <tr style="vertical-align: top;">
                <td>
                    <label>Created</label><br>
                    <time itemprop="dateCreated" datetime="2014-01-20T04:09:34-07:00">Jan '14</time>
                </td>
                <td>
                    <label>Last Reply</label><br>Jul '17</td>
                <td>
                    <label>Replies</label><br>
                    <span itemprop="answerCount">5</span>
                </td>
                <td>
                    <label>Views</label><br>1397</td>
                <td>
                    <label>Votes</label><br>
                    <span itemprop="upvoteCount">1</span>
                </td>
            </tr>
        </table>
    </div>
</div>
<div class="discussion">
        <div class="row reply-block">
            <div class="col-md-1 col-sm-1 hidden-xs text-center">
                <img src="https://secure.gravatar.com/avatar/034f62d4d9c606bf48823edfd1ce187b?s=48&amp;r=pg&amp;d=identicon" class="img-rounded avatar" /><br>
                <span itemprop="author" itemscope itemtype="http://schema.org/Person" class="avatar-name"><a href="/user/864/aledelgo" class="user-moderator-N"><span itemprop="name">Alessandro Del Gobbo</span></a></span>
                <span class="karma">17.8k</span>
            </div>
            <div class="col-md-11 col-sm-11 col-xs-12 post-body"><div class="posts-date hidden-xs" align="right">
        <a name="C1476" href="#C1476">
        <time class="action-date">Jan '14</time>
    </a>
</div>
<div class="post-content"><div><p>Hello,
i'm opening a new topic because this feat could solve also other problem than my actual issues.</p>
<p>I haven't found a way to reset DI shared services already instantiated.</p>
<p>Debuggin my app i discovered that Phalcon use the DI to store also services not initially registered. For example it seems the Response service in added to DI after an MVC action return. That response service is set as a Shared service and there is no way to remove or reset it.
I tried everything </p>
<ul>
<li>add a New response object as single or shared</li>
<li>remove and then re-add a new instance</li>
</ul>
<p>The only solution is to create a new DI (not desirable)...
It could be a cool feature to be able to reset/clear instantiated shared services. The first thing it could help is Unit testing (i'm actually involved with)</p></div>                </div>

                <div class="posts-buttons text-right"><a href="#"  class="btn btn-danger btn-xs" data-cf-modified-6b68bfb6697ef85e5ed76b27-="">
        <span class="glyphicon glyphicon-thumbs-down"></span></a>
    <a href="#"  class="btn btn-success btn-xs" data-cf-modified-6b68bfb6697ef85e5ed76b27-="">
        <span class="glyphicon glyphicon-thumbs-up"></span><span itemprop="upvoteCount">1</span></a></div>
            </div>
        </div><div itemprop="suggestedAnswer" itemscope itemtype="http://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img src="https://secure.gravatar.com/avatar/1eb2415bda000b22fd1f801bb9e8c003?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="http://schema.org/Person">
            <a href="/user/2/niden" class="user-moderator-Y"><span itemprop="name">Nikolaos Dimopoulos</span></a>        </span>
        <br>

        <span class="karma">39.3k</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><a name="C5213" href="#C5213">
                <time itemprop="dateCreated" datetime="2014-01-20T06:27:40-07:00" class="action-date">Jan '14</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p><a href="http://docs.phalcon.io/en/latest/api/Phalcon_DI.html">http://docs.phalcon.io/en/latest/api/Phalcon_DI.html</a></p>
<p>How about reset() to reset the container or for a particular service remove($service) to unset the service and replace it with whatever you want?</p>
<p>I haven't tried those myself, just throwing ideas here.</p></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="5213" data-cf-modified-6b68bfb6697ef85e5ed76b27-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="5213" data-cf-modified-6b68bfb6697ef85e5ed76b27-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
    </div>
</div>
<div itemprop="suggestedAnswer" itemscope itemtype="http://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img src="https://secure.gravatar.com/avatar/034f62d4d9c606bf48823edfd1ce187b?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="http://schema.org/Person">
            <a href="/user/864/aledelgo" class="user-moderator-N"><span itemprop="name">Alessandro Del Gobbo</span></a>        </span>
        <br>

        <span class="karma">17.8k</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><a name="C5216" href="#C5216">
                <time itemprop="dateCreated" datetime="2014-01-20T07:02:26-07:00" class="action-date">Jan '14</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>Hi Nikolas,
actually reset() empty the container so you have to re-add all services like if you create a new DI object (not very desirable)...
remove() remove the service but don't delete the cached shared services...
it mean if you make for example </p>
<pre><code class="language-php">$di-&gt;set("myservice", new MyService(), true);
$di-&gt;get("myservice")-&gt;setField1("FooBar");
$di-&gt;remove("myservice");
$di-&gt;set("myservice", new MyService(), true);
echo $di-&gt;get("myservice")-&gt;getField1(); //this print FooBar</code></pre>
<p>I wrote this code just here, not really tested if it work, but i've verified this via XDEBUG with the Response object of an MVC app...
This is why the title of topic is Feature/Bug... it may be a bug because one expect that &quot;remove()&quot; effectively delete the service and the shared instance too...</p></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="5216" data-cf-modified-6b68bfb6697ef85e5ed76b27-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="5216" data-cf-modified-6b68bfb6697ef85e5ed76b27-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
    </div>
</div>
<div itemprop="suggestedAnswer" itemscope itemtype="http://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img src="https://secure.gravatar.com/avatar/7509b3e1d1db27db44d4f645e406ef45?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="http://schema.org/Person">
            <a href="/user/855/mikegioia" class="user-moderator-N"><span itemprop="name">Mike Gioia</span></a>        </span>
        <br>

        <span class="karma">3.9k</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><a name="C5224" href="#C5224">
                <time itemprop="dateCreated" datetime="2014-01-21T12:23:23-07:00" class="action-date">Jan '14</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>I was able to replicate this bug, here's my github gist: <a href="https://gist.github.com/mikegioia/8546422">https://gist.github.com/mikegioia/8546422</a></p>
<p>You can see that tests 2 and 3 erroneously return the original value &quot;something&quot;. I don't think the -&gt;remove() or second -&gt;setShared() affect the service at all. Only until I do a hard reset on the DI does it allow me to overwrite that service.</p>
<p>While I don't think this affects the majority of use cases, what it does impact is unit tests for anyone using Phalcon\DI as a service locator who doesn't want to reset the DI object for every test.</p></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="5224" data-cf-modified-6b68bfb6697ef85e5ed76b27-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="5224" data-cf-modified-6b68bfb6697ef85e5ed76b27-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
    </div>
</div>
<div itemprop="suggestedAnswer" itemscope itemtype="http://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img src="https://secure.gravatar.com/avatar/7509b3e1d1db27db44d4f645e406ef45?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="http://schema.org/Person">
            <a href="/user/855/mikegioia" class="user-moderator-N"><span itemprop="name">Mike Gioia</span></a>        </span>
        <br>

        <span class="karma">3.9k</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><a name="C5225" href="#C5225">
                <time itemprop="dateCreated" datetime="2014-01-21T12:44:22-07:00" class="action-date">Jan '14</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>I went through the di.c file in cphalcon github and noticed that this might be the cause of the problem: <a href="https://github.com/phalcon/cphalcon/blob/master/ext/di.c#L448">https://github.com/phalcon/cphalcon/blob/master/ext/di.c#L448</a></p>
<p>In the getShared() method of the DI object, line 448 checks if the service name exists in array &quot;shared_instances&quot;. However, in remove() on line 196, the service is only being removed the &quot;services&quot; array. I haven't written C in a while and I certainly am a newb with the cphalcon codebase, but my best guess is that the shared services are staying in shared_instances and not being cleared from that array properly when remove() is called.</p>
<p>I did notice that after I call DI::getDefault()-&gt;remove( 'service' ), a subsequent  call to DI::getDefault()-&gt;getService( 'service' )-&gt;getDefinition() throws an exception saying the service wasn't found in the dependency injection container.</p></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="5225" data-cf-modified-6b68bfb6697ef85e5ed76b27-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="5225" data-cf-modified-6b68bfb6697ef85e5ed76b27-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
    </div>
</div>
<div itemprop="suggestedAnswer" itemscope itemtype="http://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img src="https://secure.gravatar.com/avatar/7509b3e1d1db27db44d4f645e406ef45?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="http://schema.org/Person">
            <a href="/user/855/mikegioia" class="user-moderator-N"><span itemprop="name">Mike Gioia</span></a>        </span>
        <br>

        <span class="karma">3.9k</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><a name="C5226" href="#C5226">
                <time itemprop="dateCreated" datetime="2014-01-21T12:50:34-07:00" class="action-date">Jan '14</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>Sorry for spamming this thread, but I re-ran my gist using -&gt;set() and -&gt;get() instead of -&gt;setShared() and -&gt;getShared() and all of them worked correctly. The DI container was properly removing the services; I think this bug only affects shared services.</p></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="5226" data-cf-modified-6b68bfb6697ef85e5ed76b27-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="5226" data-cf-modified-6b68bfb6697ef85e5ed76b27-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
    </div>
</div>
<div itemprop="suggestedAnswer" itemscope itemtype="http://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img src="https://secure.gravatar.com/avatar/034f62d4d9c606bf48823edfd1ce187b?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="http://schema.org/Person">
            <a href="/user/864/aledelgo" class="user-moderator-N"><span itemprop="name">Alessandro Del Gobbo</span></a>        </span>
        <br>

        <span class="karma">17.8k</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><a name="C5227" href="#C5227">
                <time itemprop="dateCreated" datetime="2014-01-21T16:53:34-07:00" class="action-date">Jan '14</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>Did exactly the same investigation yesterday night and arrived to the same conclusions... i planned to write about it this morning but i had some hitch... Happy to have confirmations on my investigation.
And no, you are absolutely not spamming this thread... on the contrary your posts are verfy helpful!</p></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="5227" data-cf-modified-6b68bfb6697ef85e5ed76b27-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="5227" data-cf-modified-6b68bfb6697ef85e5ed76b27-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span><span itemprop="upvoteCount">1</span></a></div>
    </div>
</div>
<div itemprop="suggestedAnswer" itemscope itemtype="http://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img src="https://secure.gravatar.com/avatar/1c5a05d695b9e910398795de90197829?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="http://schema.org/Person">
            <a href="/user/334/temuri416" class="user-moderator-N"><span itemprop="name">temuri416</span></a>        </span>
        <br>

        <span class="karma">51.3k</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><a name="C49923" href="#C49923">
                <time itemprop="dateCreated" datetime="2017-07-26T16:03:48-07:00" class="action-date">Jul '17</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>The only way ATM:</p>
<pre><code class="language-php">                /**
                 * @var \Phalcon\Di\Service
                 */
                $service = $this-&gt;di-&gt;getService('myService');
                $this-&gt;di-&gt;remove($service-&gt;getName());
                $this-&gt;di-&gt;set($service-&gt;getName(), $service-&gt;getDefinition(), $service-&gt;isShared());

                // Init myService again.
                $this-&gt;di-&gt;get('myService');</code></pre></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="49923" data-cf-modified-6b68bfb6697ef85e5ed76b27-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="49923" data-cf-modified-6b68bfb6697ef85e5ed76b27-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
    </div>
</div>
<div class="row"><div class="col-md-1 small" align="center"></div>
        <div class="col-md-11 login-comment">
            
        </div></div>
</div><input type="hidden" id="post-id" name="post-id" value="1476" /><div id="suggested-posts"></div>
    <div id="sticky-progress" style='display:none'></div>
</div>
    </div>