---
layout: default
title: 'Error handler in Micro not working properly - Discussion'
---

    <div class="container">
        {% include warning.html %}


<div itemscope itemtype="https://schema.org/Question"><ol class="breadcrumb">
    <li><a href="/">Home</a></li>
    <li><a href="/category/22/micro">Micro</a></li>
</ol>
<div class="row table-title">
    <div class="col-lg-8 col-md-7 col-sm-6 col-xs-12 wrapper-author">
        <h1 class="" itemprop="name">Error handler in Micro not working properly</h1>
        <div class="visible-xs-block mobile-author">
            <span itemprop="author" itemscope itemtype="https://schema.org/Person"><a href="/user/10515/mignz" class="user-moderator-N"><span itemprop="name">Miguel Nunes</span></a></span>
            <time itemprop="dateCreated" datetime="2018-01-15T17:03:07-07:00">Jan '18</time>
        </div>
    </div>
    <div class="col-lg-4 col-md-5 col-sm-6 hidden-xs text-right wrapper-stats">
        <table class="table-stats" width="100%">
            <tr style="vertical-align: top;">
                <td>
                    <label>Created</label><br>
                    <time itemprop="dateCreated" datetime="2018-01-15T17:03:07-07:00">Jan '18</time>
                </td>
                <td>
                    <label>Last Reply</label><br>Jul '20</td>
                <td>
                    <label>Replies</label><br>
                    <span itemprop="answerCount">5</span>
                </td>
                <td>
                    <label>Views</label><br>1477</td>
                <td>
                    <label>Votes</label><br>
                    <span itemprop="upvoteCount">0</span>
                </td>
            </tr>
        </table>
    </div>
</div>
<div class="discussion">
        <div class="row reply-block">
            <div class="col-md-1 col-sm-1 hidden-xs text-center">
                <img src="https://secure.gravatar.com/avatar/c941fb704d32764b3b6bc1a9dbfd6ccb?s=48&amp;r=pg&amp;d=identicon" class="img-rounded avatar" /><br>
                <span itemprop="author" itemscope itemtype="https://schema.org/Person" class="avatar-name"><a href="/user/10515/mignz" class="user-moderator-N"><span itemprop="name">Miguel Nunes</span></a></span>
                <span class="karma">1.9k</span>
            </div>
            <div class="col-md-11 col-sm-11 col-xs-12 post-body"><div class="posts-date hidden-xs" align="right">
        <a name="C17623" href="#C17623">
        <time class="action-date">Jan '18</time>
    </a>
</div>
<div class="post-content"><div><p>I'm trying to follow this example:</p>
<p><a href="https://docs.phalcon.io/bg/3.2/application-micro#error-handling"><a href="https://docs.phalcon.io/bg/3.2/application-micro#error-handling">https://docs.phalcon.io/bg/3.2/application-micro#error-handling</a></a></p>
<p>But whenever I throw this on a middleware or a controller:</p>
<pre><code>throw new \Exception('abc', 200);</code></pre>
<p>I get this:</p>
<pre><code>{"code":200,"status":"error","message":"abc"}
( ! ) Fatal error: Uncaught Exception: abc in /Users/mike/Sites/notes/server/app/controllers/UserController.php on line 12
( ! ) Exception: abc in /Users/mike/Sites/notes/server/app/controllers/UserController.php on line 12
Call Stack
#   Time    Memory  Function    Location
1   0.0007  408416  {main}( )   .../index.php:0
2   0.0022  435848  handle ( )  .../index.php:80</code></pre>
<p>I thought it would catch that exception. Am I wrong?</p></div>                </div>

                <div class="posts-buttons text-right"><a href="#"  class="btn btn-danger btn-xs" data-cf-modified-2ffa2b2a81f27dbe194ddbeb-="">
        <span class="glyphicon glyphicon-thumbs-down"></span></a>
    <a href="#"  class="btn btn-success btn-xs" data-cf-modified-2ffa2b2a81f27dbe194ddbeb-="">
        <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
            </div>
        </div><div itemprop="suggestedAnswer" itemscope itemtype="https://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img src="https://secure.gravatar.com/avatar/c897fab3d4f3e07ca673337a1efa9cbf?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="https://schema.org/Person">
            <a href="/user/6133/corentin-begne" class="user-moderator-N"><span itemprop="name">corentin-begne</span></a>        </span>
        <br>

        <span class="karma">12.8k</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><span class="action-date action-reply-edit" data-id="53439" data-toggle="modal" data-target="#historyModal">
                edited <span>Jan '18</span>
              </span><br/><a name="C53439" href="#C53439">
                <time itemprop="dateCreated" datetime="2018-01-16T02:22:06-07:00" class="action-date">Jan '18</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>You throw an exception but to catch it you need to put your executed code inside a try/catch block</p>
<pre><code>try{
 //...
}catch(Exception $e){
    echo $e-&gt;getMessage();
}</code></pre>
<p><a href="https://php.net/manual/en/language.exceptions.php">https://php.net/manual/en/language.exceptions.php</a></p></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="53439" data-cf-modified-2ffa2b2a81f27dbe194ddbeb-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="53439" data-cf-modified-2ffa2b2a81f27dbe194ddbeb-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
    </div>
</div>
<div itemprop="suggestedAnswer" itemscope itemtype="https://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img src="https://secure.gravatar.com/avatar/c941fb704d32764b3b6bc1a9dbfd6ccb?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="https://schema.org/Person">
            <a href="/user/10515/mignz" class="user-moderator-N"><span itemprop="name">Miguel Nunes</span></a>        </span>
        <br>

        <span class="karma">1.9k</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><a name="C53453" href="#C53453">
                <time itemprop="dateCreated" datetime="2018-01-16T05:37:48-07:00" class="action-date">Jan '18</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>So what does this do then?</p>
<pre><code>$app-&gt;error(
    function ($exception) {
        echo json_encode(
            [
                'code'    =&gt; $exception-&gt;getCode(),
                'status'  =&gt; 'error',
                'message' =&gt; $exception-&gt;getMessage(),
            ]
        );
    }
);</code></pre></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="53453" data-cf-modified-2ffa2b2a81f27dbe194ddbeb-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="53453" data-cf-modified-2ffa2b2a81f27dbe194ddbeb-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
    </div>
</div>
<div itemprop="suggestedAnswer" itemscope itemtype="https://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img src="https://secure.gravatar.com/avatar/c897fab3d4f3e07ca673337a1efa9cbf?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="https://schema.org/Person">
            <a href="/user/6133/corentin-begne" class="user-moderator-N"><span itemprop="name">corentin-begne</span></a>        </span>
        <br>

        <span class="karma">12.8k</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><a name="C53455" href="#C53455">
                <time itemprop="dateCreated" datetime="2018-01-16T06:42:43-07:00" class="action-date">Jan '18</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>As you can see this code is executed :</p>
<pre><code>{"code":200,"status":"error","message":"abc"}</code></pre>
<p>It seems that you need to catch the Exception to not have the fatal error, or maybe add a die just after the json_encode (sry never used it)</p></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="53455" data-cf-modified-2ffa2b2a81f27dbe194ddbeb-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="53455" data-cf-modified-2ffa2b2a81f27dbe194ddbeb-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
    </div>
</div>
<div itemprop="suggestedAnswer" itemscope itemtype="https://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img src="https://secure.gravatar.com/avatar/c941fb704d32764b3b6bc1a9dbfd6ccb?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="https://schema.org/Person">
            <a href="/user/10515/mignz" class="user-moderator-N"><span itemprop="name">Miguel Nunes</span></a>        </span>
        <br>

        <span class="karma">1.9k</span></div>
    <div class="col-md-11"><div class="in-reply-to">
                    <a href="#C53455"><span class="glyphicon glyphicon-chevron-up"></span> in reply to
                        <img src="https://secure.gravatar.com/avatar/c897fab3d4f3e07ca673337a1efa9cbf?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" width="24" height="24" />                        corentin-begne                    </a>
                </div><div class="posts-buttons" align="right"><a name="C53457" href="#C53457">
                <time itemprop="dateCreated" datetime="2018-01-16T10:16:33-07:00" class="action-date">Jan '18</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>That doesn't seem right. It is an error handler so it's supposed to handle the exception, right?</p>
<p>I'd like to hear some more opinions. Anyone?</p>
<blockquote>
<p>As you can see this code is executed :</p>
<pre><code>{"code":200,"status":"error","message":"abc"}</code></pre>
<p>It seems that you need to catch the Exception to not have the fatal error, or maybe add a die just after the json_encode (sry never used it)</p>
</blockquote></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="53457" data-cf-modified-2ffa2b2a81f27dbe194ddbeb-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="53457" data-cf-modified-2ffa2b2a81f27dbe194ddbeb-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
    </div>
</div>
<div itemprop="suggestedAnswer" itemscope itemtype="https://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img src="https://secure.gravatar.com/avatar/c897fab3d4f3e07ca673337a1efa9cbf?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="https://schema.org/Person">
            <a href="/user/6133/corentin-begne" class="user-moderator-N"><span itemprop="name">corentin-begne</span></a>        </span>
        <br>

        <span class="karma">12.8k</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><a name="C53459" href="#C53459">
                <time itemprop="dateCreated" datetime="2018-01-16T10:27:21-07:00" class="action-date">Jan '18</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>I've just test it and that work fine without adding anything to catch ...
What version of php / phalcon do you use ?
Can you provide more code to check.</p></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="53459" data-cf-modified-2ffa2b2a81f27dbe194ddbeb-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="53459" data-cf-modified-2ffa2b2a81f27dbe194ddbeb-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
    </div>
</div>
<div itemprop="suggestedAnswer" itemscope itemtype="https://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img src="https://secure.gravatar.com/avatar/c941fb704d32764b3b6bc1a9dbfd6ccb?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="https://schema.org/Person">
            <a href="/user/10515/mignz" class="user-moderator-N"><span itemprop="name">Miguel Nunes</span></a>        </span>
        <br>

        <span class="karma">1.9k</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><span class="action-date action-reply-edit" data-id="53461" data-toggle="modal" data-target="#historyModal">
                edited <span>Jan '18</span>
              </span><br/><a name="C53461" href="#C53461">
                <time itemprop="dateCreated" datetime="2018-01-16T11:06:14-07:00" class="action-date">Jan '18</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>Wow, really? PHP 7.2.1, Phalcon 3.3.0. Can I know yours?</p>
<blockquote>
<p>index.php</p>
</blockquote>
<pre><code class="language-php">namespace Notes;

use Phalcon\Config;
use Phalcon\Db\Adapter\Pdo\Sqlite;
use Phalcon\Mvc\Micro;
use Notes\Middleware\CorsMiddleware;
use Notes\Middleware\PostMiddleware;
use Notes\Middleware\AuthenticationMiddleware;

$app = new Micro();
require __DIR__ . '/../app/config/collections.php';

// ... Middleware, autoloader, config, etc...

$app-&gt;notFound(
    function () use ($app) {
        $app-&gt;response-&gt;setStatusCode(404, 'Not Found');
        $app-&gt;response-&gt;sendHeaders();
        $app-&gt;response-&gt;setContent('Not Found');
        $app-&gt;response-&gt;send();
    }
);
$app-&gt;error(
    function ($exception) {
        echo json_encode(
            [
                'code'    =&gt; $exception-&gt;getCode(),
                'status'  =&gt; 'error',
                'message' =&gt; $exception-&gt;getMessage(),
            ]
        );
    }
);
$app-&gt;handle();</code></pre>
<blockquote>
<p>collections.php</p>
</blockquote>
<pre><code class="language-php">use Phalcon\Mvc\Micro\Collection;

$indexCollection = new Collection();
$indexCollection-&gt;setHandler('Notes\Controllers\IndexController', true);
$indexCollection-&gt;get('/', 'index');
$app-&gt;mount($indexCollection);

$userCollection = new Collection();
$userCollection-&gt;setHandler('Notes\Controllers\UserController', true);
$userCollection-&gt;post('/login', 'login');
$app-&gt;mount($userCollection);</code></pre>
<blockquote>
<p>UserController.php</p>
</blockquote>
<pre><code class="language-php">namespace Notes\Controllers;

use Notes\Controllers\ControllerBase;
use Notes\Models\Users;

class UserController extends ControllerBase
{
    public function login()
    {
        if (!isset($this-&gt;request-&gt;body-&gt;email) or !isset($this-&gt;request-&gt;body-&gt;password)) {
            throw new \Exception('Unspecified email or password.', 400);
        }

        $user = Users::findFirstByEmail($this-&gt;request-&gt;body-&gt;email);

        if (!$user) {
            throw new \Exception('Invalid email or password.', 401);
        }

        throw new \Exception('abc', 200);

        // ...
    }
}</code></pre></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="53461" data-cf-modified-2ffa2b2a81f27dbe194ddbeb-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="53461" data-cf-modified-2ffa2b2a81f27dbe194ddbeb-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
    </div>
</div>
<div itemprop="suggestedAnswer" itemscope itemtype="https://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img src="https://secure.gravatar.com/avatar/c897fab3d4f3e07ca673337a1efa9cbf?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="https://schema.org/Person">
            <a href="/user/6133/corentin-begne" class="user-moderator-N"><span itemprop="name">corentin-begne</span></a>        </span>
        <br>

        <span class="karma">12.8k</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><span class="action-date action-reply-edit" data-id="53485" data-toggle="modal" data-target="#historyModal">
                edited <span>Jan '18</span>
              </span><br/><a name="C53485" href="#C53485">
                <time itemprop="dateCreated" datetime="2018-01-17T02:57:55-07:00" class="action-date">Jan '18</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>Your code seems to be good.<br />
PHP 7.0.22 ; Phalcon 3.2.2<br />
Maybe try only this part of code to see if the pb come from your code or a version bug :</p>
<pre><code class="language-php">&lt;?php

$app = new Phalcon\Mvc\Micro();

$app-&gt;get(
    '/',
    function () {
        throw new \Exception('Some error happened', 401);
    }
);

$app-&gt;error(
    function ($exception) {
        echo json_encode(
            [
                'code'    =&gt; $exception-&gt;getCode(),
                'status'  =&gt; 'error',
                'message' =&gt; $exception-&gt;getMessage(),
            ]
        );
    }
);

$app-&gt;handle();</code></pre></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="53485" data-cf-modified-2ffa2b2a81f27dbe194ddbeb-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="53485" data-cf-modified-2ffa2b2a81f27dbe194ddbeb-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span><span itemprop="upvoteCount">1</span></a></div>
    </div>
</div>
<div itemprop="suggestedAnswer" itemscope itemtype="https://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img src="https://secure.gravatar.com/avatar/c941fb704d32764b3b6bc1a9dbfd6ccb?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="https://schema.org/Person">
            <a href="/user/10515/mignz" class="user-moderator-N"><span itemprop="name">Miguel Nunes</span></a>        </span>
        <br>

        <span class="karma">1.9k</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><span class="action-date action-reply-edit" data-id="53493" data-toggle="modal" data-target="#historyModal">
                edited <span>Jan '18</span>
              </span><br/><a name="C53493" href="#C53493">
                <time itemprop="dateCreated" datetime="2018-01-17T09:15:54-07:00" class="action-date">Jan '18</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>Same thing. I've tried it with Phalcon 3.3 on both PHP 7.1 and 7.2. So it's a version bug. I'll post it on GitHub later. Thanks for the help.</p>
<p>Here: <a href="https://github.com/phalcon/cphalcon/issues/13262">https://github.com/phalcon/cphalcon/issues/13262</a></p></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="53493" data-cf-modified-2ffa2b2a81f27dbe194ddbeb-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="53493" data-cf-modified-2ffa2b2a81f27dbe194ddbeb-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
    </div>
</div>
<div itemprop="suggestedAnswer" itemscope itemtype="https://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img src="https://secure.gravatar.com/avatar/26de205543e62b7803c898cb0c0526ed?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="https://schema.org/Person">
            <a href="/user/13929/EricLyman" class="user-moderator-N"><span itemprop="name">EricLyman</span></a>        </span>
        <br>

        <span class="karma">73</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><span class="action-date action-reply-edit" data-id="63627" data-toggle="modal" data-target="#historyModal">
                edited <span>Jul '20</span>
              </span><br/><a name="C63627" href="#C63627">
                <time itemprop="dateCreated" datetime="2020-07-09T07:36:16-07:00" class="action-date">Jul '20</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>Hi, Miguel Nunes. Thank you to. I predicted that it will be a version bug, but can not be sure. I started my new project <a href="https://notgamstop.com/punter-sites-for-gambling/non-gamstop-football-betting/">site</a> on PHP 7.2 and had the same problem.</p></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="63627" data-cf-modified-2ffa2b2a81f27dbe194ddbeb-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="63627" data-cf-modified-2ffa2b2a81f27dbe194ddbeb-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
    </div>
</div>
<div class="row"><div class="col-md-1 small" align="center"></div>
        <div class="col-md-11 login-comment">
            
        </div></div>
</div><input type="hidden" id="post-id" name="post-id" value="17623" /><div id="suggested-posts"></div>
    <div id="sticky-progress" style='display:none'></div>
</div>
    </div>