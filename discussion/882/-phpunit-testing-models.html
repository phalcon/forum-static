---
layout: default
title: '[PHPUnit]Testing Models - Discussion'
---

    <div class="container">
        {% include warning.html %}


<div itemscope itemtype="https://schema.org/Question"><ol class="breadcrumb">
    <li><a href="/">Home</a></li>
    <li><a href="/category/2/orm">ORM</a></li>
</ol>
<div class="row table-title">
    <div class="col-lg-8 col-md-7 col-sm-6 col-xs-12 wrapper-author">
        <h1 class="" itemprop="name">[PHPUnit]Testing Models</h1>
        <div class="visible-xs-block mobile-author">
            <span itemprop="author" itemscope itemtype="https://schema.org/Person"><a href="/user/522/nexik" class="user-moderator-N"><span itemprop="name">Tomasz Ślązok</span></a></span>
            <time itemprop="dateCreated" datetime="2013-09-12T00:44:15-07:00">Sep '13</time>
        </div>
    </div>
    <div class="col-lg-4 col-md-5 col-sm-6 hidden-xs text-right wrapper-stats">
        <table class="table-stats" width="100%">
            <tr style="vertical-align: top;">
                <td>
                    <label>Created</label><br>
                    <time itemprop="dateCreated" datetime="2013-09-12T00:44:15-07:00">Sep '13</time>
                </td>
                <td>
                    <label>Last Reply</label><br>Dec '15</td>
                <td>
                    <label>Replies</label><br>
                    <span itemprop="answerCount">5</span>
                </td>
                <td>
                    <label>Views</label><br>2795</td>
                <td>
                    <label>Votes</label><br>
                    <span itemprop="upvoteCount">5</span>
                </td>
            </tr>
        </table>
    </div>
</div>
<div class="discussion">
        <div class="row reply-block">
            <div class="col-md-1 col-sm-1 hidden-xs text-center">
                <img src="https://secure.gravatar.com/avatar/e1ea6dd91fb1ca75a6d77cf0fae89e5f?s=48&amp;r=pg&amp;d=identicon" class="img-rounded avatar" /><br>
                <span itemprop="author" itemscope itemtype="https://schema.org/Person" class="avatar-name"><a href="/user/522/nexik" class="user-moderator-N"><span itemprop="name">Tomasz Ślązok</span></a></span>
                <span class="karma">7.5k</span>
            </div>
            <div class="col-md-11 col-sm-11 col-xs-12 post-body"><div class="posts-date hidden-xs" align="right">
        <a name="C882" href="#C882">
        <time class="action-date">Sep '13</time>
    </a>
</div>
<div class="post-content"><div><p>How to test model proper way?</p>
<p>I have some code in models I want to test. I found in phalcon incubator there is class ModelTestCase. It setup db connection base on DI.</p>
<p>My default DI set db service as default db with my data. To not lose data I created new DI for test where db service return connection with test database. I found that I need to manually prepare this database, run migrations on this test database (here is first problem), populate db, run tests, delete database.</p>
<p>Is there maybe easier way of testing models?</p>
<p>Problems:</p>
<ol>
<li>
<p>If I run test in the same directory that I develop app .phalcon/migration-version will be in highest point so I need create hack to run migrations on test connection. Of course I can use Travis CI to run test and then everything works fine, but if I write tests I want first run them locally before commiting something to repository.</p>
</li>
<li>
<p>If I have some Class that use Model::find() method it is nearly impossible to test that code. I don't undestand why using static methods when testing them is so hard.</p>
</li>
<li>Is there maybe ready mock Db adapter which simulate db connection but all ORM relations works in the memory?</li>
</ol>
<p>P.S. Now I'm using phpspec/prophecy to mock almost all ORM functions and testing my code without DB, but again static make this very hard. For example I don't find way to mock Model::create method :(. </p></div>                </div>

                <div class="posts-buttons text-right"><a href="#"  class="btn btn-danger btn-xs" data-cf-modified-ad9d966e01b1e7b9c587a557-="">
        <span class="glyphicon glyphicon-thumbs-down"></span></a>
    <a href="#"  class="btn btn-success btn-xs" data-cf-modified-ad9d966e01b1e7b9c587a557-="">
        <span class="glyphicon glyphicon-thumbs-up"></span><span itemprop="upvoteCount">5</span></a></div>
            </div>
        </div><div itemprop="suggestedAnswer" itemscope itemtype="https://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img src="https://secure.gravatar.com/avatar/bf2876998907a5932aa609a948720862?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="https://schema.org/Person">
            <a href="/user/241/gsouf" class="user-moderator-N"><span itemprop="name">Soufiane Ghzal</span></a>        </span>
        <br>

        <span class="karma">21.8k</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><a name="C3417" href="#C3417">
                <time itemprop="dateCreated" datetime="2013-09-13T02:53:40-07:00" class="action-date">Sep '13</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>For a quick answer, i can say you to use DBUnit (more info on the phpunit doc). It allows you to define unit test with phpunit that initialize/populate your test database following the given set of data. Then it runs the test with your good database.</p>
<p>(you may need to use this &quot;solution&quot; latter with dbunit : <a href="https://gist.github.com/SneakyBobito/6168877#file-phpunittestdb-php">https://gist.github.com/SneakyBobito/6168877#file-phpunittestdb-php</a>)</p></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="3417" data-cf-modified-ad9d966e01b1e7b9c587a557-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="3417" data-cf-modified-ad9d966e01b1e7b9c587a557-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
    </div>
</div>
<div itemprop="suggestedAnswer" itemscope itemtype="https://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img src="https://secure.gravatar.com/avatar/e1ea6dd91fb1ca75a6d77cf0fae89e5f?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="https://schema.org/Person">
            <a href="/user/522/nexik" class="user-moderator-N"><span itemprop="name">Tomasz Ślązok</span></a>        </span>
        <br>

        <span class="karma">7.5k</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><a name="C3420" href="#C3420">
                <time itemprop="dateCreated" datetime="2013-09-13T03:35:02-07:00" class="action-date">Sep '13</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>Of course I can use PHPUnit, but for unit testing using DB is overhead. I was hopping to use something like in Doctrine: </p>
<p>$adapter = new Doctrine_Adapter_Mock('mysql');
$connection = Doctrine_Manager::getInstance()-&gt;openConnection($adapter);</p>
<p>This way ORM is working but I don't need set DB to work. Everything is in Memory. Fast and easy. If you have a lot of tests which use Database you can wait 30 minutes before travis end testing.</p></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="3420" data-cf-modified-ad9d966e01b1e7b9c587a557-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="3420" data-cf-modified-ad9d966e01b1e7b9c587a557-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
    </div>
</div>
<div itemprop="suggestedAnswer" itemscope itemtype="https://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img src="https://secure.gravatar.com/avatar/bf2876998907a5932aa609a948720862?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="https://schema.org/Person">
            <a href="/user/241/gsouf" class="user-moderator-N"><span itemprop="name">Soufiane Ghzal</span></a>        </span>
        <br>

        <span class="karma">21.8k</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><span class="action-date action-reply-edit" data-id="3422" data-toggle="modal" data-target="#historyModal">
                edited <span>Mar '14</span>
              </span><br/><a name="C3422" href="#C3422">
                <time itemprop="dateCreated" datetime="2013-09-13T04:07:03-07:00" class="action-date">Sep '13</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>It looks like i have misunderstood your needs. Actually you are searching for a solution to run tests faster (without db) with a memory adapter for models  (or something that allows to use model without db), right ? </p>
<p>Dont know if phalcon models offer such a tool, but indeed it would be interesting and if it doesnt exist it can be a good NFR.</p>
<p>But one question remains, how do you define your set of data with the doctrine mock adapter ?</p></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="3422" data-cf-modified-ad9d966e01b1e7b9c587a557-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="3422" data-cf-modified-ad9d966e01b1e7b9c587a557-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
    </div>
</div>
<div itemprop="suggestedAnswer" itemscope itemtype="https://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img src="https://secure.gravatar.com/avatar/e1ea6dd91fb1ca75a6d77cf0fae89e5f?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="https://schema.org/Person">
            <a href="/user/522/nexik" class="user-moderator-N"><span itemprop="name">Tomasz Ślązok</span></a>        </span>
        <br>

        <span class="karma">7.5k</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><a name="C3423" href="#C3423">
                <time itemprop="dateCreated" datetime="2013-09-13T05:08:20-07:00" class="action-date">Sep '13</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>For Unit Test I always setup them in tests itself. Sometemise in setUp() sometime in test code.</p>
<p>For example if I have entity Site and Domain. To test simple scenario you use something like this:</p>
<p>$domain = new Domain();
$domain-&gt;setName('name' =&gt; 'google.com');
$site = new Site();
$site-&gt;setDomain($domain);
$this-&gt;assertEqual($site-&gt;getUrl(), '<a href="https://google.com">https://google.com</a>');</p>
<p>Or other test ORM</p>
<p>$domain = new Domain();
$domain-&gt;create(array('name' =&gt; 'google.com'));
$domainRepository = new DomainRepository();
$this-&gt;assertSame($domain, $domainRepository-&gt;findByName('google.com');</p>
<p>DomainRepository i n this example use Domain::findFirst(array('name = :name:', 'bind' =&gt; array('name' =&gt; 'google.com'))); </p>
<p>Now if I want to test this kind of code I must do some sort of mocking hell to mock Domain::findFirst(). Mocking static methods is not easy.</p></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="3423" data-cf-modified-ad9d966e01b1e7b9c587a557-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="3423" data-cf-modified-ad9d966e01b1e7b9c587a557-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
    </div>
</div>
<div itemprop="suggestedAnswer" itemscope itemtype="https://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img src="https://secure.gravatar.com/avatar/ad3d49a73d414003325b585868441e1c?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="https://schema.org/Person">
            <a href="/user/669/MatejBalantic" class="user-moderator-N"><span itemprop="name">Matej Balantič</span></a>        </span>
        <br>

        <span class="karma">1.5k</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><a name="C4081" href="#C4081">
                <time itemprop="dateCreated" datetime="2013-10-30T08:49:49-07:00" class="action-date">Oct '13</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>Sounds exactly like what I need. Did you find any good solution?</p></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="4081" data-cf-modified-ad9d966e01b1e7b9c587a557-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="4081" data-cf-modified-ad9d966e01b1e7b9c587a557-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
    </div>
</div>
<div itemprop="suggestedAnswer" itemscope itemtype="https://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img src="https://secure.gravatar.com/avatar/e1ea6dd91fb1ca75a6d77cf0fae89e5f?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="https://schema.org/Person">
            <a href="/user/522/nexik" class="user-moderator-N"><span itemprop="name">Tomasz Ślązok</span></a>        </span>
        <br>

        <span class="karma">7.5k</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><span class="action-date action-reply-edit" data-id="5741" data-toggle="modal" data-target="#historyModal">
                edited <span>Mar '14</span>
              </span><br/><a name="C5741" href="#C5741">
                <time itemprop="dateCreated" datetime="2014-03-02T10:24:43-07:00" class="action-date">Mar '14</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>I changed my approach. Currently I rewrite whole ORM to DataMapper approach. I working on publishing final version on GitHub.</p>
<p>What is done (classes): </p>
<ul>
<li>Manager</li>
<li>Repositories</li>
<li>Entities with lazy loaded relations</li>
<li>Table (as data source - Mapper)</li>
<li>Entity Hydrator</li>
<li>Collections (for lazy loading)</li>
<li>ProxyEntityAbstract (for lazy loading)</li>
<li>MySql Adapter</li>
</ul>
<p>What need to be done:</p>
<ul>
<li>Query object (to write SQL in OO way inside Table objects)</li>
<li>Criteria object (to work with no-SQL data stores)</li>
<li>Unit of Work to easy saving all relations objects </li>
<li>Autogenerating EntityBase, Repositories, ProxyEntities</li>
<li>Support other adapters</li>
</ul>
<p>because of generators it will be connected with command line tool. It's not easy to write additional tasks in phalcon devtools so I decide to use Symfony\Console and bundle it in my Phalcon Starter so <strong>first</strong> version of DataMapper won't be easy to use outside of my Phalcon Starter.</p></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="5741" data-cf-modified-ad9d966e01b1e7b9c587a557-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="5741" data-cf-modified-ad9d966e01b1e7b9c587a557-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
    </div>
</div>
<div itemprop="suggestedAnswer" itemscope itemtype="https://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img src="https://secure.gravatar.com/avatar/4c7962d39e38318484541817205bc059?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="https://schema.org/Person">
            <a href="/user/3032/AlfonsoPerez" class="user-moderator-N"><span itemprop="name">Alfonso Perez</span></a>        </span>
        <br>

        <span class="karma">77</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><a name="C15502" href="#C15502">
                <time itemprop="dateCreated" datetime="2015-01-29T07:59:17-07:00" class="action-date">Jan '15</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>Hi there!, did you publish it already?</p>
<p>Cheers!</p></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="15502" data-cf-modified-ad9d966e01b1e7b9c587a557-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="15502" data-cf-modified-ad9d966e01b1e7b9c587a557-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
    </div>
</div>
<div itemprop="suggestedAnswer" itemscope itemtype="https://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img src="https://secure.gravatar.com/avatar/f14f7a0c1c40e4c1aee7f4c26287e5f6?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="https://schema.org/Person">
            <a href="/user/2566/TrogWarZ" class="user-moderator-N"><span itemprop="name">Roman</span></a>        </span>
        <br>

        <span class="karma">21.7k</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><a name="C27303" href="#C27303">
                <time itemprop="dateCreated" datetime="2015-12-04T02:44:27-07:00" class="action-date">Dec '15</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>Hello. Enybody can solve this problem easily?</p></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="27303" data-cf-modified-ad9d966e01b1e7b9c587a557-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="27303" data-cf-modified-ad9d966e01b1e7b9c587a557-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
    </div>
</div>
<div class="row"><div class="col-md-1 small" align="center"></div>
        <div class="col-md-11 login-comment">
            
        </div></div>
</div><input type="hidden" id="post-id" name="post-id" value="882" /><div id="suggested-posts"></div>
    <div id="sticky-progress" style='display:none'></div>
</div>
    </div>