---
layout: default
title: '[BUG] Model on update bug - Discussion'
---

    <div class="container">
        {% include warning.html %}


<div itemscope itemtype="https://schema.org/Question"><ol class="breadcrumb">
    <li><a href="/">Home</a></li>
    <li><a href="/category/1/mvc">MVC</a></li>
</ol>
<div class="row table-title">
    <div class="col-lg-8 col-md-7 col-sm-6 col-xs-12 wrapper-author">
        <h1 class="" itemprop="name">[BUG] Model on update bug</h1>
        <div class="visible-xs-block mobile-author">
            <span itemprop="author" itemscope itemtype="https://schema.org/Person"><a href="/user/1852/softdream" class="user-moderator-N"><span itemprop="name">Kamil Hurajt</span></a></span>
            <time itemprop="dateCreated" datetime="2015-03-09T09:49:11-07:00">Mar '15</time>
        </div>
    </div>
    <div class="col-lg-4 col-md-5 col-sm-6 hidden-xs text-right wrapper-stats">
        <table class="table-stats" width="100%">
            <tr style="vertical-align: top;">
                <td>
                    <label>Created</label><br>
                    <time itemprop="dateCreated" datetime="2015-03-09T09:49:11-07:00">Mar '15</time>
                </td>
                <td>
                    <label>Last Reply</label><br>Mar '15</td>
                <td>
                    <label>Replies</label><br>
                    <span itemprop="answerCount">6</span>
                </td>
                <td>
                    <label>Views</label><br>737</td>
                <td>
                    <label>Votes</label><br>
                    <span itemprop="upvoteCount">0</span>
                </td>
            </tr>
        </table>
    </div>
</div>
<div class="discussion">
        <div class="row reply-block">
            <div class="col-md-1 col-sm-1 hidden-xs text-center">
                <img src="https://secure.gravatar.com/avatar/0569eccc292b7d45f4c9c712506168b8?s=48&amp;r=pg&amp;d=identicon" class="img-rounded avatar" /><br>
                <span itemprop="author" itemscope itemtype="https://schema.org/Person" class="avatar-name"><a href="/user/1852/softdream" class="user-moderator-N"><span itemprop="name">Kamil Hurajt</span></a></span>
                <span class="karma">11.2k</span>
            </div>
            <div class="col-md-11 col-sm-11 col-xs-12 post-body"><div class="posts-date hidden-xs" align="right">
        <a name="C6131" href="#C6131">
        <time class="action-date">Mar '15</time>
    </a>
</div>
<div class="post-content"><div><p>Hello, how to solve it, when i try to save, parent model for example i have a car and car have a user ( owner ) and when i try to change user ( owner ) to another one, phalcon php trows error about duplicate entry email. </p>
<p>But why ? Phalcon execute update or insert on update car ???? What's that ? Can you explain me that ? Here is the peace of my code: </p>
<pre><code class="language-php">    $car-&gt;user_id = $user-&gt;id;
    if($car-&gt;save()){
        $this-&gt;response-&gt;redirect('/auto/fotogalerie/'.$car-&gt;car-&gt;id.'/');
    }
</code></pre>
<p>Inside of car model ( initialize): </p>
<pre><code class="language-php">    public function initialize(){
          $this-&gt;hasOne('model_id','\Model\Car\Model','id',array(
              'alias' =&gt; 'model'
          ));

          $this-&gt;hasOne('manufacturer_id','\Model\Car\Manufacturer','id',array(
              'alias' =&gt; 'manufacturer'
          ));

          $this-&gt;hasOne("id",'\Model\Car\Top20','car_id',array(
              'alias' =&gt; 'top20'
          ));

          $this-&gt;hasMany('id','\Model\Photo','car_id',array(
              'alias' =&gt; 'photos'
          ));

          $this-&gt;hasOne("user_id",'\Model\User','id',array(
              'alias' =&gt; 'user'
          ));

          $this-&gt;hasMany("id", "\Model\Car\ParamAssign","car_id",array(
              'alias'     =&gt; "params"
          ));        
    }
</code></pre></div>                </div>

                <div class="posts-buttons text-right"><a href="#"  class="btn btn-danger btn-xs" data-cf-modified-73666fe3697dca175853c784-="">
        <span class="glyphicon glyphicon-thumbs-down"></span></a>
    <a href="#"  class="btn btn-success btn-xs" data-cf-modified-73666fe3697dca175853c784-="">
        <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
            </div>
        </div><div itemprop="suggestedAnswer" itemscope itemtype="https://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img src="https://secure.gravatar.com/avatar/83c11918052630e4dda79206c336924d?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="https://schema.org/Person">
            <a href="/user/569/kaioken" class="user-moderator-N"><span itemprop="name">Max Castro</span></a>        </span>
        <br>

        <span class="karma">16.4k</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><a name="C16460" href="#C16460">
                <time itemprop="dateCreated" datetime="2015-03-09T10:48:44-07:00" class="action-date">Mar '15</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>Yeah phalcon update / save with the methOd save if the primary key iS present</p></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="16460" data-cf-modified-73666fe3697dca175853c784-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="16460" data-cf-modified-73666fe3697dca175853c784-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
    </div>
</div>
<div itemprop="suggestedAnswer" itemscope itemtype="https://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img src="https://secure.gravatar.com/avatar/0569eccc292b7d45f4c9c712506168b8?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="https://schema.org/Person">
            <a href="/user/1852/softdream" class="user-moderator-N"><span itemprop="name">Kamil Hurajt</span></a>        </span>
        <br>

        <span class="karma">11.2k</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><a name="C16461" href="#C16461">
                <time itemprop="dateCreated" datetime="2015-03-09T11:14:53-07:00" class="action-date">Mar '15</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>Then, how to fix it, it's very important to me, because i need to fix this to finish up burned project. :)</p></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="16461" data-cf-modified-73666fe3697dca175853c784-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="16461" data-cf-modified-73666fe3697dca175853c784-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
    </div>
</div>
<div itemprop="suggestedAnswer" itemscope itemtype="https://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img src="https://secure.gravatar.com/avatar/83c11918052630e4dda79206c336924d?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="https://schema.org/Person">
            <a href="/user/569/kaioken" class="user-moderator-N"><span itemprop="name">Max Castro</span></a>        </span>
        <br>

        <span class="karma">16.4k</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><a name="C16462" href="#C16462">
                <time itemprop="dateCreated" datetime="2015-03-09T11:34:42-07:00" class="action-date">Mar '15</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>Can you show the Method wheRe you use then save function? And the model validation</p></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="16462" data-cf-modified-73666fe3697dca175853c784-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="16462" data-cf-modified-73666fe3697dca175853c784-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
    </div>
</div>
<div itemprop="suggestedAnswer" itemscope itemtype="https://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img src="https://secure.gravatar.com/avatar/0569eccc292b7d45f4c9c712506168b8?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="https://schema.org/Person">
            <a href="/user/1852/softdream" class="user-moderator-N"><span itemprop="name">Kamil Hurajt</span></a>        </span>
        <br>

        <span class="karma">11.2k</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><a name="C16463" href="#C16463">
                <time itemprop="dateCreated" datetime="2015-03-09T12:12:48-07:00" class="action-date">Mar '15</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>The request, <strong>$this-&gt;car</strong> is a fa</p>
<pre><code class="language-php">    if($this-&gt;request-&gt;isPost()){
            $data['contact'] = $this-&gt;request-&gt;getPost();
            $car-&gt;car-&gt;fn_data = base64_encode(serialize($data));
            if($form-&gt;isValid($data['contact'])){
                //check if user is exist
                $user = \Model\User::findFirst(array(
                    'email = :email:',
                    'bind' =&gt; array('email' =&gt; $data['contact']['email'])
                ));                

                //when the user doesn't exists create new one
                if(!$user){
                    //then create user and activate user account when is user created by operator
                    $u = new \User();
                    $user = $u-&gt;createFromContact($data['contact'], $car-&gt;car);
                }

                if(!$user){
                    $this-&gt;flash-&gt;notice('Omlouváme se, při pokusu vytvořit Váš uživatelský účet došlo k chybě, opakujte akci prosím později.');
                }
                else {
                    //do other stuff
                    $car-&gt;car-&gt;user_id = $user-&gt;id;
                    if($car-&gt;car-&gt;save()){
                        $this-&gt;response-&gt;redirect('/auto/fotogalerie/'.$car-&gt;car-&gt;id.'/');
                    }

                    $this-&gt;flash-&gt;notice('Při ukládání došlo k chybě, opakujte pokus prosím později.');
                }

            }
            else {
                \Helper\Flash::warning($form-&gt;getMessages(),$this-&gt;flash);
            }
    //            $this-&gt;response-&gt;redirect('auto/kontakt/'.intval($this-&gt;request-&gt;getParam('id')).'/');
        }</code></pre>
<p>And the model: </p>
<pre><code class="language-php">
    namespace Model;

    use Phalcon\Exception;

    /**
     * Description of Car
     *
     * @author Webvizitky, Softdream &lt;<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="b4dddad2dbf4c3d1d6c2ddceddc0dfcd9ad7ce">[email&#160;protected]</a>&gt;,&lt;<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="c1a8afa7ae81b2aea7b5a5b3a4a0acefafa4b5">[email&#160;protected]</a>&gt;
     * @copyright (c) 2013, Softdream, Webvizitky
     * @package name
     * @category name
     * 
     */

    class Car extends \Core\Model {

        public $id;
        public $user_id;
        public $manufacturer_id;

        public $model_id;
        public $title;
        public $price;
        public $description;
        public $color;
        public $bulk;
        public $fuel;
        public $doors;
        public $places;
        public $state;
        public $performance;
        public $body;
        public $vintage;
        public $milage;
        public $owners;
        public $vin;
        public $mark;
        public $service_list;
        public $type;
        public $drive;
        public $stk;
        public $main_image;
        public $top;
        public $highlight;
        public $expiration;
        public $visits;
        public $url;
        public $created_at;
        public $updated_at;
        public $is_leasing;
        public $is_dph;
        public $is_prooved;
        public $is_active;
        public $fn_data;
        public $source_link;
        public $hash;

        public $paramsMap = array(
            1 =&gt; 'color',
            2 =&gt; 'bulk',
            3 =&gt; 'fuel',
            4 =&gt; 'car.doors',
            5 =&gt; 'places',
            6 =&gt; 'state',
            7 =&gt; 'security',
            8 =&gt; 'exterior',
            9 =&gt; 'interior',
            10 =&gt; 'performance',
            15 =&gt; 'body',
            18 =&gt; 'vintage',
            19 =&gt; 'price',
            20 =&gt; 'security',
            21 =&gt; 'manufacturer_id',
            22 =&gt; 'model_id',
            23 =&gt; 'milage',
            24 =&gt; 'mark',
            25 =&gt; 'vin',
            26 =&gt; 'owners',
            27 =&gt; 'pack_size',
            28 =&gt; 'stk',
            29 =&gt; 'type',
            30 =&gt; 'is_leasing',
            31 =&gt; 'is_dph',
            32 =&gt; 'is_prooved',
            33 =&gt; 'drive',
            34 =&gt; 'service_list'

        );

        public function initialize(){
            $this-&gt;hasOne('model_id','\Model\Car\Model','id',array(
                'alias' =&gt; 'model'
            ));

            $this-&gt;hasOne('manufacturer_id','\Model\Car\Manufacturer','id',array(
                'alias' =&gt; 'manufacturer'
            ));

            $this-&gt;hasOne("id",'\Model\Car\Top20','car_id',array(
                'alias' =&gt; 'top20'
            ));

            $this-&gt;hasMany('id','\Model\Photo','car_id',array(
                'alias' =&gt; 'photos'
            ));

            $this-&gt;belongsTo("user_id",'\Model\User','id',array(
                'alias' =&gt; 'user'
            ));

            $this-&gt;hasMany("id", "\Model\Car\ParamAssign","car_id",array(
                'alias'     =&gt; "params"
            ));

        }

        public function getParam($group,$countInfo = false){
            $param = new Car\ParamAssign();
            $param-&gt;setFilter('car_id', $this-&gt;id);
            $param-&gt;setFilter('group_id', $group);
            $params = $param-&gt;load();
            $c = count($params);
            if($c === 1 &amp;&amp; $countInfo === false){
                $params = isset($params{0}) ?  $params{0}-&gt;value : null;
            }

            if($countInfo){
                $half = floor($c/2);
                $half = (($c-$half) &gt; $half) ? $c-$half : $half;
                $p = array(
                    'items' =&gt; $params,
                    'count' =&gt; $c,
                    'half'  =&gt; $half
                );

                return $p;            
            }
            return $params;
        }

    //    public function setFilter($name, $value, $operator = '=', $group = null, $glues = array()) {
    //        if(is_numeric($name)){
    //            $name = $this-&gt;paramsMap[$name];
    //        }
    //        parent::setFilter($name, $value, $operator, $group, $glues);
    //    }

        public function setFilters(array $filters){
            foreach($filters as $column =&gt; $value){
                if(is_array($value)){
                    if(isset($value['from']) || isset($value['to'])){
                        if(isset($value['from']) &amp;&amp; !empty($value['from'])){
                            $this-&gt;setFilter($column, $value['from'],'&gt;',$column.'range');
                        }

                        if(isset($value['to']) &amp;&amp; !empty($value['to'])){
                            $this-&gt;setFilter($column, $value['to'],'&lt;',$column.'range');
                        }
                    }
                    else if(!empty($value)){
                        $this-&gt;setFilter($column, $value);
                    }
                }
                else if(!empty($value)){
                    $this-&gt;setFilter($column, $value);                    
                }
            }
        }

        /**
         * Prepare and calculate vote of quality 
         * @return array
         */
        public function getVoting(){
            $count = $this-&gt;getStateVote()
                    +$this-&gt;getFuelVote()
                    +$this-&gt;getMilageVote()
                    +$this-&gt;getOldVote()
                    +$this-&gt;getServiceListVote()
                    +$this-&gt;getOwnersVote();

            return $count;  
        }

        protected function getStateVote(){
            $s = 0;
            switch($this-&gt;state){
                case 'Dobrý':
                    $s = 15;
                break;
                case 'Odpovídající stáří':
                    $s = 10;
                break;
                case 'Velmi dobrý':
                    $s = 22;
                break;
                case "Pefrektní":
                    $s = 30;
                break;            
            }

            return ($s*1);
        }

        protected function getMilageVote(){
            $s  = 0;
            if($this-&gt;milage &lt; 50000){
                $s = 20;
            }
            else if($this-&gt;milage &gt; 50000 &amp;&amp; $this-&gt;milage &lt; 100000){
                $s = 16;
            }
            else if($this-&gt;milage &gt; 100000 &amp;&amp; $this-&gt;milage &lt; 150000){
                $s = 13;
            }
            else if($this-&gt;milage &gt; 150000 &amp;&amp; $this-&gt;milage &lt; 200000){
                $s = 7;
            }
            else if($this-&gt;milage &gt; 200000 &amp;&amp; $this-&gt;milage &lt; 250000){
                $s = 5;
            }
            else if($this-&gt;milage &gt; 250000 &amp;&amp; $this-&gt;milage &lt; 300000){
                $s = 3;
            }
            else {
                $s = 0;
            }

            return $s;
        }

        protected function getOldVote(){
            $age = date("Y",time())-$this-&gt;vintage;
            if($age &lt; 5){
                $age = 30;
            }
            else if($age &gt; 5 &amp;&amp; $age &lt; 10){
                $age = 20;
            }
            else if($age &gt; 10 &amp;&amp; $age &lt; 15){
                $age = 10;
            }
            else {
                $age = 0;
            }

            return $age;
        }

        protected function getServiceListVote(){
            return ($this-&gt;service_list) ? 10 : 0;
        }

        protected function getOwnersVote(){
            $s = 0;
            if($this-&gt;owners &lt; 2 ){
                $s = 5;
            }
            else if($this-&gt;owners == 3){
                $s = 3;
            }
            else if($this-&gt;owners == 4){
                $s = 1;
            }

            return $s;
        }

        protected function getFuelVote(){
            $s = 0;
            //calculating fuels
            if($this-&gt;fuel == 'Benzín'){
                if($this-&gt;bulk &lt; 1800){
                    $s = 5;
                }
                else if($this-&gt;bulk &gt; 1800 &amp;&amp; $this-&gt;bulk &lt; 2500){
                    $s = 3;
                }
                else {
                    $s = 1;
                }
            }
            else if($this-&gt;fuel == 'Nafta'){
                if($this-&gt;bulk &lt; 2500){
                    $s = 5;
                }
                else if($this-&gt;bulk &gt; 2500 &amp;&amp; $this-&gt;bulk &lt; 3500){
                    $s = 3;
                }
                else {
                    $s = 1;
                }
            }
            else if($this-&gt;fuel == 'LPG'){
                $s = 5;
            }
            else if($this-&gt;fuel == 'CNG'){
                $s = 5;
            }
            else if($this-&gt;fuel == 'Elektro'){
                $s = 5;
            }
            else if($this-&gt;fuel =='Hybridní'){
                if($this-&gt;bulk &lt; 3000){
                    $s = 5;
                }
                else if($this-&gt;bulk &gt; 3000 &amp;&amp; $this-&gt;bulk &lt; 4000){
                    $s = 3;
                }
                else {
                    $s = 1;
                }
            }

            return $s;
        }

        public function getStateData(){
            return array(
                'state'     =&gt; $this-&gt;state,
                'model_id'  =&gt; $this-&gt;model_id,
                'manufacturer_id' =&gt; $this-&gt;manufacturer_id,
                'mark'      =&gt; $this-&gt;mark,
                'vin'       =&gt; $this-&gt;vin,
                21          =&gt; $this-&gt;manufacturer_id,
                22          =&gt; $this-&gt;model_id
            );
        }

         public function getFnData(){
            $data = array(
                'state'     =&gt; array(),
                'desc'      =&gt; array(),
                'outfit'    =&gt; array(),
                'price'     =&gt; array(),
                'contact'   =&gt; array()   
            );

            $data['state'][6] = $this-&gt;state;
            $data['state'][25] = $this-&gt;vin;
            $data['state'][21] = $this-&gt;manufacturer_id;
            $data['state']['model_id'] = $this-&gt;model_id;
            $data['state'][24] = $this-&gt;mark;

            $data['desc'][18] = $this-&gt;vintage;
            $data['desc'][26] = $this-&gt;owners;
            $data['desc'][32] = $this-&gt;is_prooved;
            $data['desc'][4] = $this-&gt;doors;
            $data['desc'][5] = $this-&gt;places;
            $data['desc'][1] = $this-&gt;color;
            $data['desc'][2] = $this-&gt;bulk;
            $data['desc'][3] = $this-&gt;fuel;
            $data['desc'][10] = $this-&gt;performance;
            $data['desc'][23] = $this-&gt;milage;
            $data['desc'][28] = $this-&gt;stk;
            $data['desc'][15] = $this-&gt;body;

            $params = $this-&gt;params;
            foreach($params as $param){
                if(!isset($data['outfit'][$param-&gt;group_id])){
                    $data['outfit'][$param-&gt;group_id] = array();
                }

                $data['outfit'][$param-&gt;group_id][] = $param-&gt;value;
            }

            $data['price'][29] = $this-&gt;type;
            $data['price'][31] = $this-&gt;is_dph;
            $data['price'][19] = $this-&gt;price;
            $data['price']['description'] = $this-&gt;description;
            if($this-&gt;user){
                $user = $this-&gt;user;
                $data['contact']['forename'] = $user-&gt;profile-&gt;forename;
                $data['contact']['surname'] = $user-&gt;profile-&gt;surname;
                $data['contact']['phone'] = $user-&gt;phone;
                $data['contact']['email'] = $user-&gt;email;
                $data['contact']['city'] = $user-&gt;profile-&gt;city;
                $data['contact']['street'] = $user-&gt;profile-&gt;street;
                $data['contact']['postal'] = $user-&gt;profile-&gt;postal;
            }
            return $data;

        }

    }
</code></pre></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="16463" data-cf-modified-73666fe3697dca175853c784-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="16463" data-cf-modified-73666fe3697dca175853c784-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
    </div>
</div>
<div itemprop="suggestedAnswer" itemscope itemtype="https://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img src="https://secure.gravatar.com/avatar/83c11918052630e4dda79206c336924d?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="https://schema.org/Person">
            <a href="/user/569/kaioken" class="user-moderator-N"><span itemprop="name">Max Castro</span></a>        </span>
        <br>

        <span class="karma">16.4k</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><a name="C16466" href="#C16466">
                <time itemprop="dateCreated" datetime="2015-03-09T15:29:52-07:00" class="action-date">Mar '15</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>Can you try something simple, create another instance of car and set the primary key and the user id, try updating it that way</p></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="16466" data-cf-modified-73666fe3697dca175853c784-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="16466" data-cf-modified-73666fe3697dca175853c784-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
    </div>
</div>
<div itemprop="suggestedAnswer" itemscope itemtype="https://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img src="https://secure.gravatar.com/avatar/0569eccc292b7d45f4c9c712506168b8?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="https://schema.org/Person">
            <a href="/user/1852/softdream" class="user-moderator-N"><span itemprop="name">Kamil Hurajt</span></a>        </span>
        <br>

        <span class="karma">11.2k</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><span class="action-date action-reply-edit" data-id="16472" data-toggle="modal" data-target="#historyModal">
                edited <span>Mar '15</span>
              </span><br/><a name="C16472" href="#C16472">
                <time itemprop="dateCreated" datetime="2015-03-09T23:07:14-07:00" class="action-date">Mar '15</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>It happens when i load model at the start:</p>
<pre><code class="language-php">    public function updateCarAction(){
        $car = \Model\Car::findFirst(123);
        //other stuff validaton etc

        $car-&gt;user_id = 12;//new user
        $car-&gt;save();
    }
</code></pre>
<p>So, after save the information is not updated, but when i add loading car model just above save and passing user_id like that: </p>
<pre><code class="language-php">    public function updateCarAction(){
        $car = \Model\Car::findFirst(123);
        //other stuff validaton etc

        $car = \Model\Car::findFirst(123);
        $car-&gt;user_id = 12;;//new user
        $car-&gt;save();
    }</code></pre>
<p>Everything works like charm, can you someone explain me what the fu... is that ? Because i don't understand why it happen.... it refuses all normal coding practics....</p></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="16472" data-cf-modified-73666fe3697dca175853c784-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="16472" data-cf-modified-73666fe3697dca175853c784-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
    </div>
</div>
<div itemprop="suggestedAnswer" itemscope itemtype="https://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img src="https://secure.gravatar.com/avatar/7f19eda68ce7976e552e53f2b09a6c2b?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="https://schema.org/Person">
            <a href="/user/3459/Druid33" class="user-moderator-N"><span itemprop="name">Peter Skultety</span></a>        </span>
        <br>

        <span class="karma">718</span></div>
    <div class="col-md-11"><div class="in-reply-to">
                    <a href="#C16472"><span class="glyphicon glyphicon-chevron-up"></span> in reply to
                        <img src="https://secure.gravatar.com/avatar/0569eccc292b7d45f4c9c712506168b8?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" width="24" height="24" />                        Kamil Hurajt                    </a>
                </div><div class="posts-buttons" align="right"><a name="C16528" href="#C16528">
                <time itemprop="dateCreated" datetime="2015-03-12T07:50:56-07:00" class="action-date">Mar '15</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><blockquote>
<p>It happens when i load model at the start:</p>
<pre><code class="language-php">  public function updateCarAction(){
      $car = \Model\Car::findFirst(123);
      //other stuff validaton etc

      $car-&gt;user_id = 12;//new user
      $car-&gt;save();
  }
</code></pre>
</blockquote>
<p>Can you please copy-paste phalcon error you become after $car-&gt;save()?</p>
<p>If you are sure, that $car exists in database, maybe you can use $car-&gt;update() instead of $car-&gt;save().
When you use save() metod phalcon check if record exist in DB (select to DB) and then execute update or insert.
When you use update() metod, phalcon execute update. So you can save one select operation and you can be sure, you dont create new record instead of update existing record.</p>
<blockquote>
<p>So, after save the information is not updated, but when i add loading car model just above save and passing user_id like that: </p>
<pre><code class="language-php">  public function updateCarAction(){
      $car = \Model\Car::findFirst(123);
      //other stuff validaton etc

      $car = \Model\Car::findFirst(123);
      $car-&gt;user_id = 12;;//new user
      $car-&gt;save();
  }</code></pre>
</blockquote>
<p>Check if instance of Model\Car you select first time is the same as the one you select second time.
Is it possible that you change instance of \Model\Car (selected to variable $car)  in &quot;doing other stuff&quot;.</p></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="16528" data-cf-modified-73666fe3697dca175853c784-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="16528" data-cf-modified-73666fe3697dca175853c784-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
    </div>
</div>
<div itemprop="suggestedAnswer" itemscope itemtype="https://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img src="https://secure.gravatar.com/avatar/0569eccc292b7d45f4c9c712506168b8?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="https://schema.org/Person">
            <a href="/user/1852/softdream" class="user-moderator-N"><span itemprop="name">Kamil Hurajt</span></a>        </span>
        <br>

        <span class="karma">11.2k</span></div>
    <div class="col-md-11"><div class="in-reply-to">
                    <a href="#C16528"><span class="glyphicon glyphicon-chevron-up"></span> in reply to
                        <img src="https://secure.gravatar.com/avatar/7f19eda68ce7976e552e53f2b09a6c2b?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" width="24" height="24" />                        Peter Skultety                    </a>
                </div><div class="posts-buttons" align="right"><span class="action-date action-reply-edit" data-id="16536" data-toggle="modal" data-target="#historyModal">
                edited <span>Mar '15</span>
              </span><br/><a name="C16536" href="#C16536">
                <time itemprop="dateCreated" datetime="2015-03-12T16:03:39-07:00" class="action-date">Mar '15</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>Hi, Pete.</p>
<p>The stuff what are you talking about is here and i describe that below,</p>
<pre><code class="language-php">    if($this-&gt;request-&gt;isPost()){
            $data['contact'] = $this-&gt;request-&gt;getPost();
            $car-&gt;car-&gt;fn_data = base64_encode(serialize($data));
            if($form-&gt;isValid($data['contact'])){
                //check if user is exist
                $user = \Model\User::findFirst(array(
                    'email = :email:',
                    'bind' =&gt; array('email' =&gt; $data['contact']['email'])
                ));                

                //when the user doesn't exists create new one
                if(!$user){
                    //then create user and activate user account when is user created by operator
                    $u = new \User();
                    $user = $u-&gt;createFromContact($data['contact'], $car-&gt;car);
                }

                if(!$user){
                    $this-&gt;flash-&gt;notice('Omlouváme se, při pokusu vytvořit Váš uživatelský účet došlo k chybě, opakujte akci prosím později.');
                }
                else {
                    //do other stuff
                    $car-&gt;car-&gt;user_id = $user-&gt;id;
                    if($car-&gt;car-&gt;save()){
                        $this-&gt;response-&gt;redirect('/auto/fotogalerie/'.$car-&gt;car-&gt;id.'/');
                    }

                    $this-&gt;flash-&gt;notice('Při ukládání došlo k chybě, opakujte pokus prosím později.');
                }

            }
            else {
                \Helper\Flash::warning($form-&gt;getMessages(),$this-&gt;flash);
            }
    //            $this-&gt;response-&gt;redirect('auto/kontakt/'.intval($this-&gt;request-&gt;getParam('id')).'/');
        }</code></pre>
<p>But here is nothing to change, or nothing happen to change the model. The car Facade is here: </p>
<pre><code class="language-php">
    /*
     * To change this license header, choose License Headers in Project Properties.
     * To change this template file, choose Tools | Templates
     * and open the template in the editor.
     */

    /**
     * Description of Car
     *
     * @author flipixo
     */
    class Car extends \Phalcon\Mvc\User\Component {

    /**
     * @var \Model\Car
     */
    public $car;

    protected $hasChange = 0;

    /**
     * @var \Model\Car\ParamAssign
     */
    public $params;

    protected $data;
    public function __construct($id = null) {
        if($id){
            $car = \Model\Car::findFirst($id);
            if(!$car){
                $car = new \Model\Car();
            }
        }
        else {
            $car = new \Model\Car();
        }

        $this-&gt;car = $car;
    }

    public function save(){        
        $data = $this-&gt;request-&gt;getPost();
        if(!isset($data[22]) &amp;&amp; isset($data['model_id'])){
            $data[22] = $data['model_id'];
        }

        $this-&gt;hasChange = 0;
        foreach($data as $paramGroup =&gt; $value){
            if(!is_array($value)){
                $this-&gt;addCarItem($paramGroup, $value);
            }
        }
        $ok = true;
        if(!$this-&gt;car-&gt;id){
            $this-&gt;car-&gt;created_at = date("Y-m-d H:i:s",time());
            $this-&gt;car-&gt;expiration = date("Y-m-d H:i:s",strtotime("+30 days",time()));
        }

        $this-&gt;car-&gt;updated_at = date("Y-m-d H:i:s",time());
        $ok = $this-&gt;car-&gt;save();

        if($this-&gt;car-&gt;id){
            $ok = $this-&gt;addParams($data);
        }

        return $ok;
    }

    protected function addCarItem($group_id, $value){
        if(is_numeric($group_id)){
            $variable = $this-&gt;car-&gt;paramsMap[$group_id];
        }
        else {
            $variable = $group_id;
        }

        if($this-&gt;car-&gt;{$variable} !== $value){
            $this-&gt;car-&gt;$variable = $value;
            $this-&gt;hasChange = 1;
        }
    }

    protected function addParams(array $data){
        $found = 0;
        $saved = 0;
        foreach($data as $group =&gt; $value){
            $group = intval($group);
            if(in_array($group,array(7,8,9,20))){
                $found++;
                if($this-&gt;saveParam($group, $value)){
                    $saved++;
                }
            }
        }

        if($found === $saved){
            return true;
        }

        return false;
    }

    protected function saveParam($group, $value){
        if(is_array($value)){
            //reset params
            $params = new \Model\Car\ParamAssign();
            $params-&gt;setFilter('car_id', $this-&gt;car-&gt;id);
            $params-&gt;setFilter('group_id', $group);
            $paramsToDelete = $params-&gt;load(1,9999);
            $params-&gt;delete($paramsToDelete);

            $saved = true;
            foreach($value as $section =&gt; $val){
                if($val){
                    $param = new \Model\Car\ParamAssign();
                    $param-&gt;group_id = $group;
                    $param-&gt;value = $val;
                    $param-&gt;car_id = $this-&gt;car-&gt;id;
                    if(!$param-&gt;save()){
                        $saved = false;
                    }
                }
            }
            return $saved;
        }
        else {
            if($value){
                $param = \Model\Car\ParamAssign::findFirst(array(
                    'conditions'    =&gt; 'car_id = :car_id: AND group_id = :group:',
                    'bind'          =&gt; array('car_id' =&gt; intval($this-&gt;car-&gt;id), 'group' =&gt; $group)
                ));   

                if(!$param){
                    $param = new \Model\Car\ParamAssign();
                }

                $param-&gt;group_id = $group;
                $param-&gt;value = $value;
                $param-&gt;car_id = $this-&gt;car-&gt;id;

                return $param-&gt;save();
            }            
        }

        return true;
    }

    public function applyPaidProduct(\Model\Order $order){
        $items = json_decode($order-&gt;items,1);
        $carInfo = $items['item'];
        $productInfo = $items['products'];
        $user = \Model\User::findFirst($order-&gt;user_id);

        $car = \Model\Car::findFirst(intval($carInfo['id']));
        switch($productInfo['id']){//todo
            case 1:
                $car-&gt;expiration = date("Y-m-d H:i:s",strtotime('+60 days', strtotime($car-&gt;expiration)));
                $timeHighlight = ($car-&gt;highlight &gt; date("Y-m-d H:i:s",time())) ? strtotime($car-&gt;highlight) : time();
                $timeTop = ($car-&gt;top &gt; date("Y-m-d H:i:s",time())) ? strtotime($car-&gt;top) : time();
                $car-&gt;highlight = date("Y-m-d H:i:s",strtotime("+30 days",$timeHighlight));
                $car-&gt;top = date("Y-m-d H:i:s",strtotime("+30 days",$timeTop));
            break;
            case 2: 
                $car-&gt;expiration = date("Y-m-d H:i:s",strtotime('+60 days', strtotime($car-&gt;expiration)));
                $timeHighlight = ($car-&gt;highlight &gt; date("Y-m-d H:i:s",time())) ? strtotime($car-&gt;highlight) : time();
                $timeTop = ($car-&gt;top &gt; date("Y-m-d H:i:s",time())) ? strtotime($car-&gt;top) : time();
                $car-&gt;highlight = date("Y-m-d H:i:s",strtotime("+30 days",$timeHighlight));
                $car-&gt;top = date("Y-m-d H:i:s",strtotime("+30 days",$timeTop));

                //top 20
                $countTop20 = \Model\Car\Top20::find(array(
                    'from_date &lt; :now: AND to_date &gt; :now:',
                    'order' =&gt; 'to_date DESC',
                    'bind'  =&gt; array('now' =&gt; date("Y-m-d H:i:s",time())),
                    'limit' =&gt; 20
                ));
                $top20 = \Model\Car\Top20::findFirst(array(
                    'car_id = :car:',
                    'bind' =&gt; array('car' =&gt; $car-&gt;id)
                ));                
                if(!$top20){
                    $top20 = new \Model\Car\Top20();
                }

                $count = count($countTop20);
                if($count == 20){
                    $lastItem = $countTop20-&gt;getFirst();  
                    $top20-&gt;from_date = $lastItem-&gt;to_date;
                }
                else {
                    $top20-&gt;from_date = date("Y-m-d H:i:s",time());
                }

                $top20-&gt;to_date = date("Y-m-d H:i:s",strtotime("+7 days",strtotime($top20-&gt;from_date)));
                $top20-&gt;car_id = $car-&gt;id;
                $top20-&gt;created_at = date("Y-m-d H:i:s",time());
                if(!$top20-&gt;save()){
                    return false;
                }

            break;
            case 4: 
                $timeTop = ($car-&gt;top &gt; date("Y-m-d H:i:s",time())) ? strtotime($car-&gt;top) : time();
                $car-&gt;top = date("Y-m-d H:i:s",strtotime("+30 days",$timeTop));
                //when car have expiration less than top expiraiton update the expiration to top expiraiton
                if($car-&gt;expiration &lt; $car-&gt;top){
                    $car-&gt;expiration = $car-&gt;top;
                }
            break;
            case 7:
                $highlightTop = ($car-&gt;highlight &gt; date("Y-m-d H:i:s",time())) ? strtotime($car-&gt;highlight) : time();
                $car-&gt;highlight = date("Y-m-d H:i:s",strtotime("+30 days",$highlightTop));
                //when car have expiration less than top expiraiton update the expiration to top expiraiton
                if($car-&gt;expiration &lt; $car-&gt;highlight){
                    $car-&gt;expiration = $car-&gt;highlight;
                }
            break;
            case 8:
                $countTop20 = \Model\Car\Top20::find(array(
                    'from_date &lt; :now: AND to_date &gt; :now:',
                    'order' =&gt; 'to_date DESC',
                    'bind'  =&gt; array('now' =&gt; date("Y-m-d H:i:s",time())),
                    'limit' =&gt; 20
                ));
                $top20 = \Model\Car\Top20::findFirst(array(
                    'car_id = :car:',
                    'bind' =&gt; array('car' =&gt; $car-&gt;id)
                ));                
                if(!$top20){
                    $top20 = new \Model\Car\Top20();
                }

                $count = count($countTop20);
                if($count == 20){
                    $lastItem = $countTop20-&gt;getFirst();  
                    $top20-&gt;from_date = $lastItem-&gt;to_date;
                }
                else {
                    $top20-&gt;from_date = date("Y-m-d H:i:s",time());
                }

                $top20-&gt;to_date = date("Y-m-d H:i:s",strtotime("+7 days",strtotime($top20-&gt;from_date)));
                $top20-&gt;car_id = $car-&gt;id;
                $top20-&gt;created_at = date("Y-m-d H:i:s",time());
                if(!$top20-&gt;save()){
                    return false;
                }

            break;
            default:
                return false;
            break;                
        }

        if($car-&gt;save()){

            return true;
        }

        return false;
    }

}
</code></pre>
<p>And in both cases, car is founded.</p>
<p>My test cases are: </p>
<ol>
<li>First test with the facade and dump info about car.
<ul>
<li>Result same thing</li>
</ul></li>
<li>Second test with Phalcon ORM model so just a cal Car::findFirst() and apply change
<ul>
<li>Result same thing</li>
</ul></li>
<li>Third test with cal the car again close to before call save
<ul>
<li>Result all works.</li>
</ul></li>
</ol>
<blockquote>
<blockquote>
<p>It happens when i load model at the start:</p>
<pre><code class="language-php"> public function updateCarAction(){
     $car = \Model\Car::findFirst(123);
     //other stuff validaton etc

     $car-&gt;user_id = 12;//new user
     $car-&gt;save();
 }
</code></pre>
</blockquote>
<p>Can you please copy-paste phalcon error you become after $car-&gt;save()?</p>
<p>If you are sure, that $car exists in database, maybe you can use $car-&gt;update() instead of $car-&gt;save().
When you use save() metod phalcon check if record exist in DB (select to DB) and then execute update or insert.
When you use update() metod, phalcon execute update. So you can save one select operation and you can be sure, you dont create new record instead of update existing record.</p>
<blockquote>
<p>So, after save the information is not updated, but when i add loading car model just above save and passing user_id like that: </p>
<pre><code class="language-php"> public function updateCarAction(){
     $car = \Model\Car::findFirst(123);
     //other stuff validaton etc

     $car = \Model\Car::findFirst(123);
     $car-&gt;user_id = 12;;//new user
     $car-&gt;save();
 }</code></pre>
</blockquote>
<p>Check if instance of Model\Car you select first time is the same as the one you select second time.
Is it possible that you change instance of \Model\Car (selected to variable $car)  in &quot;doing other stuff&quot;.</p>
</blockquote></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="16536" data-cf-modified-73666fe3697dca175853c784-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="16536" data-cf-modified-73666fe3697dca175853c784-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
    </div>
</div>
<div itemprop="suggestedAnswer" itemscope itemtype="https://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img src="https://secure.gravatar.com/avatar/7f19eda68ce7976e552e53f2b09a6c2b?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="https://schema.org/Person">
            <a href="/user/3459/Druid33" class="user-moderator-N"><span itemprop="name">Peter Skultety</span></a>        </span>
        <br>

        <span class="karma">718</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><a name="C16541" href="#C16541">
                <time itemprop="dateCreated" datetime="2015-03-13T01:11:18-07:00" class="action-date">Mar '15</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>Try catch sql statement witch Phalcon build and send to database and then run this statement directly from your database IDE (sql developer, mysql workbench, or whatever you use)</p>
<p>Log sgl is great doing in DBListener::beforeQuery().
Take a look here <a href="https://docs.phalcon.io/en/latest/reference/events.html">https://docs.phalcon.io/en/latest/reference/events.html</a></p></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="16541" data-cf-modified-73666fe3697dca175853c784-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="16541" data-cf-modified-73666fe3697dca175853c784-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
    </div>
</div>
<div itemprop="suggestedAnswer acceptedAnswer" itemscope itemtype="https://schema.org/Answer" class="reply-block row reply-accepted">
    <div class="col-md-1 small" align="center">
        <img src="https://secure.gravatar.com/avatar/83c11918052630e4dda79206c336924d?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="https://schema.org/Person">
            <a href="/user/569/kaioken" class="user-moderator-N"><span itemprop="name">Max Castro</span></a>        </span>
        <br>

        <span class="karma">16.4k</span><div class="accepted-reply">
                <span class="glyphicon glyphicon-ok"></span>
                Accepted<br>answer
            </div></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><a name="C16645" href="#C16645">
                <time itemprop="dateCreated" datetime="2015-03-17T10:12:52-07:00" class="action-date">Mar '15</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>Kamil did you find the solution?</p></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="16645" data-cf-modified-73666fe3697dca175853c784-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="16645" data-cf-modified-73666fe3697dca175853c784-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
    </div>
</div>
<div itemprop="suggestedAnswer" itemscope itemtype="https://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img src="https://secure.gravatar.com/avatar/0569eccc292b7d45f4c9c712506168b8?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="https://schema.org/Person">
            <a href="/user/1852/softdream" class="user-moderator-N"><span itemprop="name">Kamil Hurajt</span></a>        </span>
        <br>

        <span class="karma">11.2k</span></div>
    <div class="col-md-11"><div class="in-reply-to">
                    <a href="#C16645"><span class="glyphicon glyphicon-chevron-up"></span> in reply to
                        <img src="https://secure.gravatar.com/avatar/83c11918052630e4dda79206c336924d?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" width="24" height="24" />                        Max Castro                    </a>
                </div><div class="posts-buttons" align="right"><a name="C16648" href="#C16648">
                <time itemprop="dateCreated" datetime="2015-03-17T13:15:48-07:00" class="action-date">Mar '15</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>Hmm i make a bad click ... </p>
<p>No i'm not find a solution, i has do it what i have to write below.</p>
<blockquote>
<p>Kamil did you find the solution?</p>
</blockquote></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="16648" data-cf-modified-73666fe3697dca175853c784-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="16648" data-cf-modified-73666fe3697dca175853c784-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
    </div>
</div>
<div class="row"><div class="col-md-1 small" align="center"></div>
        <div class="col-md-11 login-comment">
            
        </div></div>
</div><input type="hidden" id="post-id" name="post-id" value="6131" /><div id="suggested-posts"></div>
    <div id="sticky-progress" style='display:none'></div>
</div>
    </div>