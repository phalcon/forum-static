---
layout: default
title: 'ORM collate (Postgresql) - Discussion'
---

    <div class="container">
        {% include warning.html %}


<div itemscope itemtype="https://schema.org/Question"><ol class="breadcrumb">
    <li><a href="/">Home</a></li>
    <li><a href="/category/2/orm">ORM</a></li>
</ol>
<div class="row table-title">
    <div class="col-lg-8 col-md-7 col-sm-6 col-xs-12 wrapper-author">
        <h1 class="" itemprop="name">ORM collate (Postgresql)</h1>
        <div class="visible-xs-block mobile-author">
            <span itemprop="author" itemscope itemtype="https://schema.org/Person"><a href="/user/1274/slechtic" class="user-moderator-N"><span itemprop="name">slechtic</span></a></span>
            <time itemprop="dateCreated" datetime="2014-03-17T09:21:42-07:00">Mar '14</time>
        </div>
    </div>
    <div class="col-lg-4 col-md-5 col-sm-6 hidden-xs text-right wrapper-stats">
        <table class="table-stats" width="100%">
            <tr style="vertical-align: top;">
                <td>
                    <label>Created</label><br>
                    <time itemprop="dateCreated" datetime="2014-03-17T09:21:42-07:00">Mar '14</time>
                </td>
                <td>
                    <label>Last Reply</label><br>Mar '14</td>
                <td>
                    <label>Replies</label><br>
                    <span itemprop="answerCount">6</span>
                </td>
                <td>
                    <label>Views</label><br>1535</td>
                <td>
                    <label>Votes</label><br>
                    <span itemprop="upvoteCount">1</span>
                </td>
            </tr>
        </table>
    </div>
</div>
<div class="discussion">
        <div class="row reply-block">
            <div class="col-md-1 col-sm-1 hidden-xs text-center">
                <img src="https://secure.gravatar.com/avatar/82dd10cce237ef1c09ab0e8cb78182be?s=48&amp;r=pg&amp;d=identicon" class="img-rounded avatar" /><br>
                <span itemprop="author" itemscope itemtype="https://schema.org/Person" class="avatar-name"><a href="/user/1274/slechtic" class="user-moderator-N"><span itemprop="name">slechtic</span></a></span>
                <span class="karma">7.5k</span>
            </div>
            <div class="col-md-11 col-sm-11 col-xs-12 post-body"><div class="posts-date hidden-xs" align="right">
        <a name="C1810" href="#C1810">
        <time class="action-date">Mar '14</time>
    </a>
</div>
<div class="post-content"><div><p>Hi,</p>
<p>we would like to use Phalcon (1.2.6) ORM, but we have mulilanguage application and we don't know how to set collation for postgresql (9.3). Posgresql doesn't suppport set collation in connection string. Last option we see is generating queries like:</p>
<p>SELECT a FROM b ORDER BY a COLLATE (de_DE)</p>
<p>We guess it is not possible right now..
So what can we do? Any ideas / tips / hacks?
Can EventManager help us somehow?
We are quite desperate..</p>
<p>Thank you all..</p></div>                </div>

                <div class="posts-buttons text-right"><a href="#"  class="btn btn-danger btn-xs" data-cf-modified-b255498d39e61720da940d09-="">
        <span class="glyphicon glyphicon-thumbs-down"></span></a>
    <a href="#"  class="btn btn-success btn-xs" data-cf-modified-b255498d39e61720da940d09-="">
        <span class="glyphicon glyphicon-thumbs-up"></span><span itemprop="upvoteCount">1</span></a></div>
            </div>
        </div><div itemprop="suggestedAnswer" itemscope itemtype="https://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img src="https://secure.gravatar.com/avatar/5d6f567f9109789fd9f702959768e35d?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="https://schema.org/Person">
            <a href="/user/1/phalcon" class="user-moderator-Y"><span itemprop="name">Phalcon</span></a>        </span>
        <br>

        <span class="karma">98.9k</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><a name="C6279" href="#C6279">
                <time itemprop="dateCreated" datetime="2014-03-17T10:03:26-07:00" class="action-date">Mar '14</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>You can use a raw query there: <a href="https://docs.phalcon.io/en/latest/reference/phql.html#using-raw-sql">https://docs.phalcon.io/en/latest/reference/phql.html#using-raw-sql</a></p></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="6279" data-cf-modified-b255498d39e61720da940d09-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="6279" data-cf-modified-b255498d39e61720da940d09-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
    </div>
</div>
<div itemprop="suggestedAnswer" itemscope itemtype="https://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img src="https://secure.gravatar.com/avatar/90c8736a63045f6e8117032ef3ee90d2?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="https://schema.org/Person">
            <a href="/user/1066/jiff88" class="user-moderator-N"><span itemprop="name">Josef Svoboda</span></a>        </span>
        <br>

        <span class="karma">7.3k</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><a name="C6281" href="#C6281">
                <time itemprop="dateCreated" datetime="2014-03-17T10:51:32-07:00" class="action-date">Mar '14</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>Does it mean everyone using PostgreSQL and having multilanguage app has to give up Phalcon ORM?
We would need to write raw select queries for every situation where collation in ordering matters (hundreds of situations).</p>
<p>Can be PHQL syntax extended somehow in future? As I see it </p>
<pre><code>SELECT a FROM b ORDER BY a COLLATE (de_DE)</code></pre>
<p>is pretty much valid SQL for every RDBMS, isn't it?
For MySQL, you can set it as option for PDO. So no explicit need for this. Maybe that's why nobody noticed yet.
But PgSQL is different, so only direct SQL can make it work.</p>
<p>Do we really need to <strong>give up</strong> things like:</p>
<pre><code>$robot = Robots::findFirst(2);
$robotsParts = $robot-&gt;getRobotsParts();</code></pre>
<p>Because parts will be unorderable (collation can't be specified).</p>
<p>Phalcon ORM is great thing. We love it. Please help us beat / improve this.</p></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="6281" data-cf-modified-b255498d39e61720da940d09-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="6281" data-cf-modified-b255498d39e61720da940d09-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
    </div>
</div>
<div itemprop="suggestedAnswer" itemscope itemtype="https://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img src="https://secure.gravatar.com/avatar/5d6f567f9109789fd9f702959768e35d?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="https://schema.org/Person">
            <a href="/user/1/phalcon" class="user-moderator-Y"><span itemprop="name">Phalcon</span></a>        </span>
        <br>

        <span class="karma">98.9k</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><a name="C6283" href="#C6283">
                <time itemprop="dateCreated" datetime="2014-03-17T11:00:59-07:00" class="action-date">Mar '14</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>To support this it must be added to the PHQL parser and be translated to each supported database system, this cannot be done from one day to another.</p></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="6283" data-cf-modified-b255498d39e61720da940d09-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="6283" data-cf-modified-b255498d39e61720da940d09-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
    </div>
</div>
<div itemprop="suggestedAnswer" itemscope itemtype="https://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img src="https://secure.gravatar.com/avatar/90c8736a63045f6e8117032ef3ee90d2?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="https://schema.org/Person">
            <a href="/user/1066/jiff88" class="user-moderator-N"><span itemprop="name">Josef Svoboda</span></a>        </span>
        <br>

        <span class="karma">7.3k</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><a name="C6285" href="#C6285">
                <time itemprop="dateCreated" datetime="2014-03-17T11:08:27-07:00" class="action-date">Mar '14</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>This i completely understand.
Just want to agree with you if it can be done and get a talk if there is a chance to have it done in the future.</p>
<p>OR find some trick here, <strong>how to set up a PgSQL collation</strong>.
Do you think it is possible to catch a query before execution (via EventManager), manually change it (append a collation) and then execute this changed query? ORM can still be perfectly working. Just as a hack for everybody encountering this now.</p></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="6285" data-cf-modified-b255498d39e61720da940d09-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="6285" data-cf-modified-b255498d39e61720da940d09-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
    </div>
</div>
<div itemprop="suggestedAnswer acceptedAnswer" itemscope itemtype="https://schema.org/Answer" class="reply-block row reply-accepted">
    <div class="col-md-1 small" align="center">
        <img src="https://secure.gravatar.com/avatar/5d6f567f9109789fd9f702959768e35d?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="https://schema.org/Person">
            <a href="/user/1/phalcon" class="user-moderator-Y"><span itemprop="name">Phalcon</span></a>        </span>
        <br>

        <span class="karma">98.9k</span><div class="accepted-reply">
                <span class="glyphicon glyphicon-ok"></span>
                Accepted<br>answer
            </div></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><a name="C6286" href="#C6286">
                <time itemprop="dateCreated" datetime="2014-03-17T11:29:06-07:00" class="action-date">Mar '14</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>This could work. </p>
<p>You can write those queries using a custom syntax:</p>
<pre><code class="language-sql">SELECT a FROM b ORDER BY COLLATE(a, "de_DE")</code></pre>
<p>Then you can create a custom SQL dialect extending the PostgreSQL dialect which intercepts calls to functions returning the right SQL:</p>
<pre><code class="language-php">&lt;?php

class CustomSQLDialect extends \Phalcon\Db\Dialect\PostgreSQL
{

    /**
     * Transforms an intermediate representation for a expression into a database system valid expression
     *
     * @param array expression
     * @param string escapeChar
     * @return string
     */
    public function getSqlExpression($expression, $escapeChar=null)
    {

        if ($expression["type"] == 'functionCall') {
            if ($expression["name"] == 'COLLATE') {
                return $expression["arguments"][0] . ' COLLATE ' . $expression["arguments"][1];
            }
        }

        return parent::getSqlExpression($expression, $escapeChar);
    }

}</code></pre>
<p>The custom dialect must be registered in the connection:</p>
<pre><code class="language-php">$connection = new \Phalcon\Db\Adapter\Pdo\Postgresql(array(
    "host"     =&gt; "localhost",
    "username" =&gt; "postgres",
    "password" =&gt; "secret1",
    "dbname"   =&gt; "template"
    "dialectClass" =&gt; "CustomSQLDialect"
));</code></pre></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="6286" data-cf-modified-b255498d39e61720da940d09-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="6286" data-cf-modified-b255498d39e61720da940d09-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span><span itemprop="upvoteCount">3</span></a></div>
    </div>
</div>
<div itemprop="suggestedAnswer" itemscope itemtype="https://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img src="https://secure.gravatar.com/avatar/90c8736a63045f6e8117032ef3ee90d2?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="https://schema.org/Person">
            <a href="/user/1066/jiff88" class="user-moderator-N"><span itemprop="name">Josef Svoboda</span></a>        </span>
        <br>

        <span class="karma">7.3k</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><a name="C6634" href="#C6634">
                <time itemprop="dateCreated" datetime="2014-03-27T06:03:56-07:00" class="action-date">Mar '14</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>We needed to do some things differently, but it is a life saver!</p>
<p>Just to let others know, &quot;dialectClass&quot; is invalid connection option (i got exception), we had to call </p>
<pre><code>$connection-&gt;setDialect(new CustomSQLDialect());</code></pre>
<p>The actual implementation of COLLATE in getSqlExpression() is much more complex, if you want to do it good and have some validation etc., but it can be done without any problems in a way you showed us. Thanks.</p></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="6634" data-cf-modified-b255498d39e61720da940d09-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="6634" data-cf-modified-b255498d39e61720da940d09-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span><span itemprop="upvoteCount">1</span></a></div>
    </div>
</div>
<div class="row"><div class="col-md-1 small" align="center"></div>
        <div class="col-md-11 login-comment">
            
        </div></div>
</div><input type="hidden" id="post-id" name="post-id" value="1810" /><div id="suggested-posts"></div>
    <div id="sticky-progress" style='display:none'></div>
</div>
    </div>