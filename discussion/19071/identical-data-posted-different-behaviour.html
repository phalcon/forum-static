---
layout: default
title: 'Identical data POSTed, different behaviour - Discussion'
---

    <div class="container">
        {% include warning.html %}


<div itemscope itemtype="http://schema.org/Question"><ol class="breadcrumb">
    <li><a href="/">Home</a></li>
    <li><a href="/category/2/orm">ORM</a></li>
</ol>
<div class="row table-title">
    <div class="col-lg-8 col-md-7 col-sm-6 col-xs-12 wrapper-author">
        <h1 class="" itemprop="name">Identical data POSTed, different behaviour</h1>
        <div class="visible-xs-block mobile-author">
            <span itemprop="author" itemscope itemtype="http://schema.org/Person"><a href="/user/301/quasipickle" class="user-moderator-Y"><span itemprop="name">Dylan Anderson</span></a></span>
            <time itemprop="dateCreated" datetime="2018-12-04T15:22:31-07:00">Dec '18</time>
        </div>
    </div>
    <div class="col-lg-4 col-md-5 col-sm-6 hidden-xs text-right wrapper-stats">
        <table class="table-stats" width="100%">
            <tr style="vertical-align: top;">
                <td>
                    <label>Created</label><br>
                    <time itemprop="dateCreated" datetime="2018-12-04T15:22:31-07:00">Dec '18</time>
                </td>
                <td>
                    <label>Last Reply</label><br>Dec '18</td>
                <td>
                    <label>Replies</label><br>
                    <span itemprop="answerCount">1</span>
                </td>
                <td>
                    <label>Views</label><br>238</td>
                <td>
                    <label>Votes</label><br>
                    <span itemprop="upvoteCount">0</span>
                </td>
            </tr>
        </table>
    </div>
</div>
<div class="discussion">
        <div class="row reply-block">
            <div class="col-md-1 col-sm-1 hidden-xs text-center">
                <img src="https://secure.gravatar.com/avatar/746a625a9264a203a6ddf711e0c6b120?s=48&amp;r=pg&amp;d=identicon" class="img-rounded avatar" /><br>
                <span itemprop="author" itemscope itemtype="http://schema.org/Person" class="avatar-name"><a href="/user/301/quasipickle" class="user-moderator-Y"><span itemprop="name">Dylan Anderson</span></a></span>
                <span class="karma">125.8k</span>
            </div>
            <div class="col-md-11 col-sm-11 col-xs-12 post-body"><div class="posts-date hidden-xs" align="right">
        <a name="C19071" href="#C19071">
        <time class="action-date">Dec '18</time>
    </a>
</div>
<div class="post-content"><div><p>I have a form being submitted via ajax.  In response to that data being submitted, my model actively deletes all associated records, then assigns new records to be saved.  This process is paraphrased below:</p>
<p><strong>Controller</strong></p>
<pre><code class="language-php">$this-&gt;db-&gt;begin();
$TCA = TCA::findFirst(...):
$TCA-&gt;AGPA-&gt;delete();

$new_agpa = [
    new AGPA(...),
    new AGPA(...)
];
$TCA-&gt;AGPA = $new_agpa;
$TCA-&gt;save();
$this-&gt;db-&gt;commit();</code></pre>
<p>For reasons unknown to me, I can submit identical POST data 2 times in a row, and the 1st POST can result in no new AGPA records being created, but the second POST will properly delete old records and create new ones.  Or vice versa.  Or not - sometimes the behaviour is the same.</p>
<p>The POST data is identical, so the code path should be the same too.  I'm at a loss as to why or how there is EVER a time where new AGPA records aren't added.</p></div>                </div>

                <div class="posts-buttons text-right"><a href="#"  class="btn btn-danger btn-xs" data-cf-modified-a69a87a7733e62d9a851c907-="">
        <span class="glyphicon glyphicon-thumbs-down"></span></a>
    <a href="#"  class="btn btn-success btn-xs" data-cf-modified-a69a87a7733e62d9a851c907-="">
        <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
            </div>
        </div><div itemprop="suggestedAnswer" itemscope itemtype="http://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img src="https://secure.gravatar.com/avatar/bcb5cc9f3d1e3c3cab87efd5ac1dc9c7?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="http://schema.org/Person">
            <a href="/user/4525/stamster" class="user-moderator-N"><span itemprop="name">Jonathan Aaron Steel</span></a>        </span>
        <br>

        <span class="karma">79.0k</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><span class="action-date action-reply-edit" data-id="58063" data-toggle="modal" data-target="#historyModal">
                edited <span>Dec '18</span>
              </span><br/><a name="C58063" href="#C58063">
                <time itemprop="dateCreated" datetime="2018-12-05T02:26:56-07:00" class="action-date">Dec '18</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>Do you have some security stuff - starting with browser extensions, AV software, and primarily some WAF at server side?</p>
<p>Test with plain cURL from command line or with POSTman or so.
Also track relevant logs on the server. </p>
<p>Perhaps something's wrong with the model / DB side of things? As you do state POST is being fired each time and server accepts it? But only your part of the code does not execute. </p></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="58063" data-cf-modified-a69a87a7733e62d9a851c907-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="58063" data-cf-modified-a69a87a7733e62d9a851c907-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
    </div>
</div>
<div itemprop="suggestedAnswer" itemscope itemtype="http://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img src="https://secure.gravatar.com/avatar/746a625a9264a203a6ddf711e0c6b120?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="http://schema.org/Person">
            <a href="/user/301/quasipickle" class="user-moderator-Y"><span itemprop="name">Dylan Anderson</span></a>        </span>
        <br>

        <span class="karma">125.8k</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><a name="C58073" href="#C58073">
                <time itemprop="dateCreated" datetime="2018-12-05T10:32:34-07:00" class="action-date">Dec '18</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>Thanks for the response.</p>
<p>This &quot;TCA&quot; model is 1 new part of a system that has been working for over a year, and in production for 6 months.  It runs on a framework that does a lot of the heavy lifting - so I doubt there's any problem client-side or with a firewall.  It's also cross-browser problem.</p>
<p>Thanks for the tip about POSTman - it helps test this sort of thing.  Unfortunately (or perhaps fortunately), the problem still exists when POSTing from POSTman.</p>
<p>It's got to be a model issue...somehow.  I have the relationship between TCA and AGPA (which I have renamed to AGPACourse) set up like this:</p>
<pre><code class="language-php">$this-&gt;hasMany('id','Model\Interaction\TCA\AGPACourse','tca_id',['alias'=&gt;'AGPACourses']);</code></pre>
<p>And I set</p>
<pre><code class="language-php">$TCA-&gt;AGPACourses = [an array of AGPACourse objects]</code></pre>
<p>But when I do a deep toArray() of <code>$TCA</code>, I get this:</p>
<pre><code class="language-php">Array
(
    [id] =&gt; 8
    [interaction_id] =&gt; 431
    [interim_program] =&gt; aaa
    [interim_sending_credits] =&gt; 0
    [interim_ua_credits] =&gt; 0
    [interim_agpa] =&gt; 0
    [interim_requirement_met] =&gt; N
    [interim_comments] =&gt; bbb
    [final_program] =&gt; aaa
    [final_sending_credits] =&gt; 0
    [final_ua_credits] =&gt; 0
    [final_agpa] =&gt; 0
    [final_requirement_met] =&gt; N
    [final_comments] =&gt; ccc
    [agpacourses] =&gt; Array
        (
            [0] =&gt; Array
                (
                    [id] =&gt; 
                    [tca_id] =&gt; 8
                    [type] =&gt; interim
                    [institution] =&gt; blah1
                    [term] =&gt; fall
                    [year] =&gt; 18
                    [course] =&gt; 
                    [credits] =&gt; 0
                    [grade] =&gt; 0
                    [ua_credits] =&gt; 0
                )

            [1] =&gt; Array
                (
                    [id] =&gt; 
                    [tca_id] =&gt; 8
                    [type] =&gt; final
                    [institution] =&gt; blah1
                    [term] =&gt; fall
                    [year] =&gt; 18
                    [course] =&gt; 
                    [credits] =&gt; 0
                    [grade] =&gt; 0
                    [ua_credits] =&gt; 0
                )
        )
)</code></pre>
<p>the case is different - the key is <code>agpacourses</code> instead of <code>AGPACourses</code>.  Perhaps this is just an artifact of toArray()?</p></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="58073" data-cf-modified-a69a87a7733e62d9a851c907-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="58073" data-cf-modified-a69a87a7733e62d9a851c907-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
    </div>
</div>
<div itemprop="suggestedAnswer" itemscope itemtype="http://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img src="https://secure.gravatar.com/avatar/746a625a9264a203a6ddf711e0c6b120?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="http://schema.org/Person">
            <a href="/user/301/quasipickle" class="user-moderator-Y"><span itemprop="name">Dylan Anderson</span></a>        </span>
        <br>

        <span class="karma">125.8k</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><span class="action-date action-reply-edit" data-id="58075" data-toggle="modal" data-target="#historyModal">
                edited <span>Dec '18</span>
              </span><br/><a name="C58075" href="#C58075">
                <time itemprop="dateCreated" datetime="2018-12-05T10:57:09-07:00" class="action-date">Dec '18</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>Ok, I think I have it working.</p>
<p>The full chain of relations I have is this: <code>$Interaction-&gt;TCA-&gt;AGPACourses</code>.  I mentioned this was in a framework - that framework renames <code>TCA</code> to <code>Supplemental</code>, because in lots of places I don't care what the particular model is.  I've rewritten <code>$Interaction-&gt;save()</code> to then save the model identified as <code>Supplemental</code> if any fields have changed.  However, if all that's changed is a related record then <code>getChangedFields()</code> doesn't return anything and the related models don't get added.  So I need to find some generic way to determine if any related models to a model, have changed.</p></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="58075" data-cf-modified-a69a87a7733e62d9a851c907-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="58075" data-cf-modified-a69a87a7733e62d9a851c907-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
    </div>
</div>
<div class="row"><div class="col-md-1 small" align="center"></div>
        <div class="col-md-11 login-comment">
            
        </div></div>
</div><input type="hidden" id="post-id" name="post-id" value="19071" /><div id="suggested-posts"></div>
    <div id="sticky-progress" style='display:none'></div>
</div>
    </div>