---
layout: default
title: 'How to implement Paypal into Phalcon - Discussion'
---

    <div class="container">
        {% include warning.html %}


<div itemscope itemtype="https://schema.org/Question"><ol class="breadcrumb">
    <li><a href="/">Home</a></li>
    <li><a href="/category/5/general">General</a></li>
</ol>
<div class="row table-title">
    <div class="col-lg-8 col-md-7 col-sm-6 col-xs-12 wrapper-author">
        <h1 class="" itemprop="name">How to implement Paypal into Phalcon</h1>
        <div class="visible-xs-block mobile-author">
            <span itemprop="author" itemscope itemtype="https://schema.org/Person"><a href="/user/2249/Stefjoe" class="user-moderator-N"><span itemprop="name">Stefjoe</span></a></span>
            <time itemprop="dateCreated" datetime="2017-10-25T07:55:02-07:00">Oct '17</time>
        </div>
    </div>
    <div class="col-lg-4 col-md-5 col-sm-6 hidden-xs text-right wrapper-stats">
        <table class="table-stats" width="100%">
            <tr style="vertical-align: top;">
                <td>
                    <label>Created</label><br>
                    <time itemprop="dateCreated" datetime="2017-10-25T07:55:02-07:00">Oct '17</time>
                </td>
                <td>
                    <label>Last Reply</label><br>Oct '17</td>
                <td>
                    <label>Replies</label><br>
                    <span itemprop="answerCount">3</span>
                </td>
                <td>
                    <label>Views</label><br>652</td>
                <td>
                    <label>Votes</label><br>
                    <span itemprop="upvoteCount">0</span>
                </td>
            </tr>
        </table>
    </div>
</div>
<div class="discussion">
        <div class="row reply-block">
            <div class="col-md-1 col-sm-1 hidden-xs text-center">
                <img src="https://secure.gravatar.com/avatar/95593bdf7bc6c62dbd16767e520f13c8?s=48&amp;r=pg&amp;d=identicon" class="img-rounded avatar" /><br>
                <span itemprop="author" itemscope itemtype="https://schema.org/Person" class="avatar-name"><a href="/user/2249/Stefjoe" class="user-moderator-N"><span itemprop="name">Stefjoe</span></a></span>
                <span class="karma">59.9k</span>
            </div>
            <div class="col-md-11 col-sm-11 col-xs-12 post-body"><div class="posts-date hidden-xs" align="right">
        <a name="C17161" href="#C17161">
        <time class="action-date">Oct '17</time>
    </a>
</div>
<div class="post-content"><div><p>Hello,</p>
<p>i want to implement Paypal into Vokuro.</p>
<ol>
<li>If a user wants to register, they should have Read-Only permissions</li>
<li>If a user pays, they should have Administrator permissions -&gt; so the permissons should be changed automatically</li>
</ol>
<p>How can i do this? What are the steps?</p>
<p>Rgds
Stefan</p></div>                </div>

                <div class="posts-buttons text-right"><a href="#"  class="btn btn-danger btn-xs" data-cf-modified-15b1992941f996e4e77cf364-="">
        <span class="glyphicon glyphicon-thumbs-down"></span></a>
    <a href="#"  class="btn btn-success btn-xs" data-cf-modified-15b1992941f996e4e77cf364-="">
        <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
            </div>
        </div><div itemprop="suggestedAnswer" itemscope itemtype="https://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img src="https://secure.gravatar.com/avatar/b59fecbff6d1afabf8da316028330df4?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="https://schema.org/Person">
            <a href="/user/2619/emiliodeg" class="user-moderator-N"><span itemprop="name">Emilio Degiovanni</span></a>        </span>
        <br>

        <span class="karma">32.3k</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><a name="C51783" href="#C51783">
                <time itemprop="dateCreated" datetime="2017-10-25T12:31:06-07:00" class="action-date">Oct '17</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>Hi<a href="https://forum.phalcon.io/user/2249/Stefjoe"> @Stefjoe</a> it's easy you can follow examples <a href="https://paypal.github.io/PayPal-PHP-SDK/sample/">paypal php sdk</a></p>
<p>Good luck</p></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="51783" data-cf-modified-15b1992941f996e4e77cf364-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="51783" data-cf-modified-15b1992941f996e4e77cf364-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
    </div>
</div>
<div itemprop="suggestedAnswer" itemscope itemtype="https://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img src="https://secure.gravatar.com/avatar/bcb5cc9f3d1e3c3cab87efd5ac1dc9c7?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="https://schema.org/Person">
            <a href="/user/4525/stamster" class="user-moderator-N"><span itemprop="name">Jonathan Aaron Steel</span></a>        </span>
        <br>

        <span class="karma">79.0k</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><a name="C51793" href="#C51793">
                <time itemprop="dateCreated" datetime="2017-10-25T23:19:20-07:00" class="action-date">Oct '17</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>I strongly suggest you to implement Paypal via their in-browser API only. Basically you only include one JS line then.
Use backend only for validation (callback). If you need something - ask and I'll give you example.</p></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="51793" data-cf-modified-15b1992941f996e4e77cf364-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="51793" data-cf-modified-15b1992941f996e4e77cf364-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
    </div>
</div>
<div itemprop="suggestedAnswer" itemscope itemtype="https://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img src="https://secure.gravatar.com/avatar/a2658b5645f7a791cd1fbf709c4eb9b0?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="https://schema.org/Person">
            <a href="/user/8837/cosmy81" class="user-moderator-N"><span itemprop="name">Cosimo</span></a>        </span>
        <br>

        <span class="karma">12.1k</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><a name="C51845" href="#C51845">
                <time itemprop="dateCreated" datetime="2017-10-28T06:18:05-07:00" class="action-date">Oct '17</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>It depends on what you want. For a paying service only,  I suggest you too to use the paypal JS. If you want something more structured think about realizing payment module that manage payment methods and store payments.
In my case I've used plugins inside a payment module to attacch different payment methods in the same code, storing the results and other useful data.
That’s my solution for paypal without all the module part:</p>
<p>In your controller:</p>
<blockquote>
<p>public function executePaypalAction(){
try{
//recover the values from the DB. I have  a paymentComponent that do it. I’ve cutted its initialization
foreach($paymentComponent-&gt;payment-&gt;getParameters() as $k =&gt; $v) $$k=$v;
//assign the values to the view.
$this-&gt;view-&gt;setVar('formaction', $paypal_url);
$this-&gt;view-&gt;setVar('paypal_merchant', $paypal_merchant);
//YOU NEED AN IPN NOTIFY ACTION CONTROLLER
$this-&gt;view-&gt;setVar('notify_url', '<a href="https://&#039;.$_SERVER[&#039;HTTP_HOST&#039;].&#039;/payment/paypal/paypalipn">https://'.$_SERVER['HTTP_HOST'].'/payment/paypal/paypalipn</a>');
$this-&gt;view-&gt;setVar('returnUrl', $returnURL);
$this-&gt;view-&gt;setVar('language', $language);
$this-&gt;view-&gt;setVar('custom', $this-&gt;payment-&gt;getPaymentCode());
$this-&gt;view-&gt;setVar('ora', $ora);
$this-&gt;view-&gt;setVar('data', $data);
$this-&gt;view-&gt;setVar('descrizione', $descrizione);
$this-&gt;view-&gt;setVar('importo', $amount);
$this-&gt;view-&gt;setVar('id_order', $orderCode);
$this-&gt;view-&gt;setVar('id', $portal.'-'.$orderCode);
}
catch (\Exception $e) {
echo $e-&gt;getMessage() . '&lt;br&gt;';
echo '&lt;pre&gt;' . $e-&gt;getTraceAsString() . '&lt;/pre&gt;';
}</p>
<pre><code>$this-&gt;dispatcher-&gt;forward([
    "namespace" =&gt; "App\Payment\Controllers",
    "controller" =&gt; "paypal",
    "action"     =&gt; "index",
]);</code></pre>
<p>}</p>
</blockquote>
<p>The index.volt for paypal:</p>
<blockquote>
<p>&lt;!DOCTYPE html PUBLIC &quot;-//W3C//DTD XHTML 1.1//EN&quot; &quot;<a href="https://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">https://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd</a>&quot;&gt;
&lt;html xmlns=&quot;<a href="https://www.w3.org/1999/xhtml">https://www.w3.org/1999/xhtml</a>&quot; xml:lang=&quot;en&quot;&gt;</p>
<p>&lt;head&gt;
&lt;script src=&quot;/javascripts/jquery/jquery-3.1.1.min.js&quot;&gt;&lt;/script&gt;
&lt;meta http-equiv=&quot;cache-control&quot; content=&quot;no-cache&quot; /&gt;
&lt;script type=&quot;text/javascript&quot;&gt;
$(function(){
$('#submit').click();
});
&lt;/script&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;form action=&quot;{% raw %}{{{% endraw %}formaction{% raw %}}}{% endraw %}&quot; method=&quot;post&quot;  id='myform'&gt;
&lt;!-- Identify your business so that you can collect the payments. --&gt;
&lt;input type=&quot;hidden&quot; name=&quot;business&quot; value=&quot;{% raw %}{{{% endraw %}paypal_merchant{% raw %}}}{% endraw %}&quot;&gt;
&lt;!-- Specify a Buy Now button. --&gt;
&lt;input type=&quot;hidden&quot; name=&quot;cmd&quot; value=&quot;_xclick&quot;&gt;
&lt;!-- Specify details about the item that buyers will purchase. --&gt;
&lt;input type=&quot;hidden&quot; name=&quot;item_name&quot; value=&quot;{% raw %}{{{% endraw %}descrizione{% raw %}}}{% endraw %}&quot;&gt;
&lt;input type=&quot;hidden&quot; name=&quot;item_number&quot; value=&quot;{% raw %}{{{% endraw %}id{% raw %}}}{% endraw %}&quot;&gt;
&lt;input type=&quot;hidden&quot; name=&quot;lang&quot; value=&quot;{% raw %}{{{% endraw %}language{% raw %}}}{% endraw %}&quot;&gt;
&lt;input type=&quot;hidden&quot; name=&quot;custom&quot; value=&quot;{% raw %}{{{% endraw %}custom{% raw %}}}{% endraw %}&quot;&gt;
&lt;input type=&quot;hidden&quot; name=&quot;amount&quot; value=&quot;{% raw %}{{{% endraw %}importo{% raw %}}}{% endraw %}&quot;&gt;
&lt;input type=&quot;hidden&quot; name=&quot;currency_code&quot; value=&quot;EUR&quot;&gt;
&lt;input type=&quot;hidden&quot; name=&quot;notify_url&quot; value=&quot;{% raw %}{{{% endraw %}notify_url{% raw %}}}{% endraw %}&quot;&gt;
&lt;input type=&quot;hidden&quot; name=&quot;return&quot; value=&quot;{% raw %}{{{% endraw %}returnUrl{% raw %}}}{% endraw %}&quot;&gt;
&lt;input type=&quot;hidden&quot; name=&quot;no_shipping&quot; value=&quot;1&quot;&gt;
&lt;input type=&quot;submit&quot; name=&quot;submit&quot; border=&quot;0&quot; id=&quot;submit&quot; value=&quot;Invia&quot; style=&quot;display:none;&quot;&gt;
&lt;/form&gt;
&lt;/body&gt;
&lt;/html&gt;</p>
</blockquote>
<p>The IPN controller action:</p>
<blockquote>
<p>public function paypalipnAction()
{
$this-&gt;view-&gt;disable();
$this-&gt;logger-&gt;info(&quot;Paypal ipn start&quot;);
$logmessage='';
// impostiamo nella request il 'cmd'
$req = 'cmd=_notify-validate';
//controlla se ci sono o meno i magic_quotes
if(function_exists('get_magic_quotes_gpc')) {
$get_magic_quotes_exists = true;
}
//cicla tutti i valori passati in post e li riallega alla chiamata
foreach ($this-&gt;request-&gt;getPost() as $key =&gt; $value) {
if($get_magic_quotes_exists == true &amp;&amp; get_magic_quotes_gpc() == 1) {
$value = urlencode(stripslashes($value));
} else {
$value = urlencode($value);
}
$req .= &quot;&amp;$key=$value&quot;;
}</p>
<pre><code>// Post IPN data back to PayPal to validate the IPN data is genuine
// Without this step anyone can fake IPN data
//questo environment andrebbe ripreso dal payment
$environment='';
if($environment == 'sandbox') {
  $paypal_url = "https://www.sandbox.paypal.com/cgi-bin/webscr";
} else {
  $paypal_url = "https://www.paypal.com/cgi-bin/webscr";
}

$ch = curl_init();
if ($ch == FALSE) {
  return FALSE;
}

curl_setopt($ch, CURLOPT_HTTP_VERSION, CURL_HTTP_VERSION_1_1);
curl_setopt($ch, CURLOPT_POST, 1);
curl_setopt($ch, CURLOPT_RETURNTRANSFER,1);
curl_setopt($ch, CURLOPT_POSTFIELDS, $req);
curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, 1);
curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 2);
curl_setopt($ch, CURLOPT_FORBID_REUSE, 1);
curl_setopt ($ch, CURLOPT_URL, $paypal_url);
$res = curl_exec($ch);
if (curl_errno($ch) != 0) // cURL error
  {
  $error.=date('[Y-m-d H:i e] '). "Can't connect to PayPal to validate IPN message: " . curl_error($ch) . PHP_EOL;
  curl_close($ch);
  exit;
} else {
      // Log the entire HTTP response if debug is switched on.
      $logmessage.=date('[Y-m-d H:i e] '). "HTTP request of validation request:". curl_getinfo($ch, CURLINFO_HEADER_OUT) ." for IPN payload: $req" . PHP_EOL;
      $logmessage.=date('[Y-m-d H:i e] '). "HTTP response of validation request: $res" . PHP_EOL;
      curl_close($ch);
}

// Inspect IPN validation result and act accordingly
// Split response headers and payload, a better way for strcmp
$tokens = explode("\r\n\r\n", trim($res));
$res = trim(end($tokens));
$logmessage.="PAYPALIPN per ".$this-&gt;request-&gt;getPost('item_number')." - Status: ".$this-&gt;request-&gt;getPost('payment_status')." - res: ".$res;

if (strcmp ($res, "VERIFIED") == 0) {
  $logmessage.=date('[Y-m-d H:i e] '). "Verified IPN POST:  ".print_r($this-&gt;request-&gt;getPost(),1) . PHP_EOL;
  // check whether the payment_status is Completed
  // check that txn_id has not been previously processed
  // check that receiver_email is your PayPal email
  // check that payment_amount/payment_currency are correct
  // process payment and mark item as paid.
  // assign posted variables to local variables
  //$item_name = $_POST['item_name'];
  $item_number = $this-&gt;request-&gt;get('item_number');
  $payment_status = $this-&gt;request-&gt;get('payment_status');
  //$payment_amount = $_POST['mc_gross'];
  //$payment_currency = $_POST['mc_currency'];
  //$txn_id = $_POST['txn_id'];
  //$receiver_email = $_POST['receiver_email'];
  //$payer_email = $_POST['payer_email'];
  $aItemNumber=explode('-',$this-&gt;request-&gt;get('item_number'));
  $order_id=array_pop($aItemNumber);
  //forse il portale sarebbe da recuperare in altro modo direttamente dal payment
  $portal=implode('-',$aItemNumber);
  $logmessage.=date('[Y-m-d H:i e] '). "Verified IPN POST:  ".$portal . PHP_EOL;
  $logmessage.=date('[Y-m-d H:i e] '). "Verified IPN POST:  ".$order_id . PHP_EOL;
  $logmessage.=date('[Y-m-d H:i e] '). "Verified IPN POST:  ".$portal . PHP_EOL;
  $logmessage.=date('[Y-m-d H:i e] '). "Verified IPN POST:  ".$order_id . PHP_EOL;

  // $paymentStatus is part of my payment model and is used to track the payment during his flow
  $payment = Payment::findFirst([
      'conditions' =&gt; 'paymentCode = ?0',
      'bind' =&gt; [$paymentCode],
  ]);
  $paymentStatus=$payment-&gt;getStatus();

  if($paymentStatus == 'FORWARDED') {  //check that the payment has not been processed before
      if($payment_status=="Completed"){
         //payment ok
          $logmessage.=date('[Y-m-d H:i e] '). "Verified IPN: $req ". PHP_EOL;
          //action to se status to ACCEPTED
          $payment=Payment::confirm($paymentCode);
          $logmessage.=date('[Y-m-d H:i e] '). "Paypal: order #$order_id completed" . PHP_EOL;
      }else{
          // pagamento fallito
          //settare pagamento REJECTED
         $payment=Payment::reject($paymentCode);
          $logmessage.='Pagamento respinto';
      }
      exit;
  }else{
      //nothing to do.
      exit;
  }

} else if (strcmp ($res, "INVALID") == 0) {
  //settare il pagamento su error
  $logmessage.='Errore nel sistema';
  exit;
  $filedest = 'pos-receiveko.php';
}</code></pre>
<p>}
}</p>
</blockquote></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="51845" data-cf-modified-15b1992941f996e4e77cf364-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="51845" data-cf-modified-15b1992941f996e4e77cf364-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
    </div>
</div>
<div class="row"><div class="col-md-1 small" align="center"></div>
        <div class="col-md-11 login-comment">
            
        </div></div>
</div><input type="hidden" id="post-id" name="post-id" value="17161" /><div id="suggested-posts"></div>
    <div id="sticky-progress" style='display:none'></div>
</div>
    </div>