---
layout: default
title: 'Phalcon crashing with &quot;trap invalid opcode&quot; - Discussion'
---

    <div class="container">
        {% include warning.html %}


<div itemscope itemtype="https://schema.org/Question"><ol class="breadcrumb">
    <li><a href="/">Home</a></li>
    <li><a href="/category/5/general">General</a></li>
</ol>
<div class="row table-title">
    <div class="col-lg-8 col-md-7 col-sm-6 col-xs-12 wrapper-author">
        <h1 class="" itemprop="name">Phalcon crashing with &quot;trap invalid opcode&quot;</h1>
        <div class="visible-xs-block mobile-author">
            <span itemprop="author" itemscope itemtype="https://schema.org/Person"><a href="/user/334/temuri416" class="user-moderator-N"><span itemprop="name">temuri416</span></a></span>
            <time itemprop="dateCreated" datetime="2016-12-14T08:37:23-07:00">Dec '16</time>
        </div>
    </div>
    <div class="col-lg-4 col-md-5 col-sm-6 hidden-xs text-right wrapper-stats">
        <table class="table-stats" width="100%">
            <tr style="vertical-align: top;">
                <td>
                    <label>Created</label><br>
                    <time itemprop="dateCreated" datetime="2016-12-14T08:37:23-07:00">Dec '16</time>
                </td>
                <td>
                    <label>Last Reply</label><br>Dec '16</td>
                <td>
                    <label>Replies</label><br>
                    <span itemprop="answerCount">3</span>
                </td>
                <td>
                    <label>Views</label><br>1009</td>
                <td>
                    <label>Votes</label><br>
                    <span itemprop="upvoteCount">0</span>
                </td>
            </tr>
        </table>
    </div>
</div>
<div class="discussion">
        <div class="row reply-block">
            <div class="col-md-1 col-sm-1 hidden-xs text-center">
                <img src="https://secure.gravatar.com/avatar/1c5a05d695b9e910398795de90197829?s=48&amp;r=pg&amp;d=identicon" class="img-rounded avatar" /><br>
                <span itemprop="author" itemscope itemtype="https://schema.org/Person" class="avatar-name"><a href="/user/334/temuri416" class="user-moderator-N"><span itemprop="name">temuri416</span></a></span>
                <span class="karma">51.3k</span>
            </div>
            <div class="col-md-11 col-sm-11 col-xs-12 post-body"><div class="posts-date hidden-xs" align="right">
        <a name="C15031" href="#C15031">
        <time class="action-date">Dec '16</time>
    </a>
</div>
<div class="post-content"><div><p><a href="https://forum.phalcon.io/user/1/phalcon">@phalcon</a> devs...</p>
<p>I'm getting this in kern.log:</p>
<blockquote>
<p>kernel: [ 5768.149406] traps: php-fpm[8559] trap invalid opcode ip:7f8cdf11c1e0 sp:7ffe385a55d0 error:0 in phalcon.so[7f8cded9a000+457000]</p>
</blockquote>
<p>Unfortunately, I can't recompile PHP with <code>--enable-debug</code> flag to get you gdb output, but I can send over source code should anyone be willing to take a look.</p>
<p>Thank you.</p></div>                </div>

                <div class="posts-buttons text-right"><a href="#"  class="btn btn-danger btn-xs" data-cf-modified-cb19ff6b95b74f29d0f152cb-="">
        <span class="glyphicon glyphicon-thumbs-down"></span></a>
    <a href="#"  class="btn btn-success btn-xs" data-cf-modified-cb19ff6b95b74f29d0f152cb-="">
        <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
            </div>
        </div><div itemprop="suggestedAnswer" itemscope itemtype="https://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img src="https://secure.gravatar.com/avatar/1c5a05d695b9e910398795de90197829?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="https://schema.org/Person">
            <a href="/user/334/temuri416" class="user-moderator-N"><span itemprop="name">temuri416</span></a>        </span>
        <br>

        <span class="karma">51.3k</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><span class="action-date action-reply-edit" data-id="43895" data-toggle="modal" data-target="#historyModal">
                edited <span>Dec '16</span>
              </span><br/><a name="C43895" href="#C43895">
                <time itemprop="dateCreated" datetime="2016-12-14T08:45:24-07:00" class="action-date">Dec '16</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>This is really weird. Below is the code that causing the crash:</p>
<pre><code>&lt;?php
new Phalcon\Mvc\Router;
?&gt;</code></pre>
<p>That's it - hitting that over HTTP causes the crash.</p>
<p>Any idea?</p>
<p>Latest Phalcon, PHP7.0, Ubuntu 16.04 64bit</p></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="43895" data-cf-modified-cb19ff6b95b74f29d0f152cb-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="43895" data-cf-modified-cb19ff6b95b74f29d0f152cb-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
    </div>
</div>
<div itemprop="suggestedAnswer" itemscope itemtype="https://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img src="https://secure.gravatar.com/avatar/1c5a05d695b9e910398795de90197829?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="https://schema.org/Person">
            <a href="/user/334/temuri416" class="user-moderator-N"><span itemprop="name">temuri416</span></a>        </span>
        <br>

        <span class="karma">51.3k</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><a name="C43899" href="#C43899">
                <time itemprop="dateCreated" datetime="2016-12-14T09:00:50-07:00" class="action-date">Dec '16</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>Looked at it closer and router is only crashing when trying to init default routes.</p>
<p>Thus, this is what causes router to crash:</p>
<pre><code class="language-php">new Phalcon\Mvc\Router\Route("#^/([\\w0-9\\_\\-]+)[/]{0,1}$#u", [
    "controller"=&gt; 1
]);</code></pre></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="43899" data-cf-modified-cb19ff6b95b74f29d0f152cb-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="43899" data-cf-modified-cb19ff6b95b74f29d0f152cb-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
    </div>
</div>
<div itemprop="suggestedAnswer" itemscope itemtype="https://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img src="https://secure.gravatar.com/avatar/bcb5cc9f3d1e3c3cab87efd5ac1dc9c7?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="https://schema.org/Person">
            <a href="/user/4525/stamster" class="user-moderator-N"><span itemprop="name">Jonathan Aaron Steel</span></a>        </span>
        <br>

        <span class="karma">79.0k</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><span class="action-date action-reply-edit" data-id="43905" data-toggle="modal" data-target="#historyModal">
                edited <span>Dec '16</span>
              </span><br/><a name="C43905" href="#C43905">
                <time itemprop="dateCreated" datetime="2016-12-14T09:09:20-07:00" class="action-date">Dec '16</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><pre><code class="language-php">//new Phalcon\Mvc\Router;
new Phalcon\Mvc\Router(); //try with () here</code></pre>
<p>I use exactly the same setup as you, and never had issues with Router component.</p>
<p>Edit: <code>()</code> is not root cause of your problem, but rather your route pattern. Does that happen all the time or just sporadically?</p></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="43905" data-cf-modified-cb19ff6b95b74f29d0f152cb-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="43905" data-cf-modified-cb19ff6b95b74f29d0f152cb-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
    </div>
</div>
<div itemprop="suggestedAnswer" itemscope itemtype="https://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img src="https://secure.gravatar.com/avatar/1c5a05d695b9e910398795de90197829?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="https://schema.org/Person">
            <a href="/user/334/temuri416" class="user-moderator-N"><span itemprop="name">temuri416</span></a>        </span>
        <br>

        <span class="karma">51.3k</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><a name="C43913" href="#C43913">
                <time itemprop="dateCreated" datetime="2016-12-14T09:18:28-07:00" class="action-date">Dec '16</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>This works because it skips default routes init:</p>
<pre><code class="language-php">new Phalcon\Mvc\Router(false);</code></pre>
<p>This crashes:</p>
<pre><code class="language-php">new Phalcon\Mvc\Router();</code></pre>
<p>It happens every time. I am seriously worried now, as I have to port a project from Phalcon 1.3 to PHP7/Phalcon 3 combo. Gonna recompile php with <code>--enable-debug</code> flag.</p></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="43913" data-cf-modified-cb19ff6b95b74f29d0f152cb-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="43913" data-cf-modified-cb19ff6b95b74f29d0f152cb-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
    </div>
</div>
<div itemprop="suggestedAnswer" itemscope itemtype="https://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img src="https://secure.gravatar.com/avatar/bcb5cc9f3d1e3c3cab87efd5ac1dc9c7?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="https://schema.org/Person">
            <a href="/user/4525/stamster" class="user-moderator-N"><span itemprop="name">Jonathan Aaron Steel</span></a>        </span>
        <br>

        <span class="karma">79.0k</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><a name="C43919" href="#C43919">
                <time itemprop="dateCreated" datetime="2016-12-14T09:24:33-07:00" class="action-date">Dec '16</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>PCRE might be your root issue here, and PHP7 if your route patterns worked on previous PHP and Phalcon versions. But 1.3... prior 2.0 Phalcon had no Zephir intermediate, that might be also your root cause of some other issues.</p></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="43919" data-cf-modified-cb19ff6b95b74f29d0f152cb-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="43919" data-cf-modified-cb19ff6b95b74f29d0f152cb-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
    </div>
</div>
<div itemprop="suggestedAnswer" itemscope itemtype="https://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img src="https://secure.gravatar.com/avatar/1c5a05d695b9e910398795de90197829?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="https://schema.org/Person">
            <a href="/user/334/temuri416" class="user-moderator-N"><span itemprop="name">temuri416</span></a>        </span>
        <br>

        <span class="karma">51.3k</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><a name="C43921" href="#C43921">
                <time itemprop="dateCreated" datetime="2016-12-14T09:35:18-07:00" class="action-date">Dec '16</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>I like your username btw. &quot;Jonathan... It's showtime&quot;.</p></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="43921" data-cf-modified-cb19ff6b95b74f29d0f152cb-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="43921" data-cf-modified-cb19ff6b95b74f29d0f152cb-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span><span itemprop="upvoteCount">1</span></a></div>
    </div>
</div>
<div itemprop="suggestedAnswer" itemscope itemtype="https://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img src="https://secure.gravatar.com/avatar/bcb5cc9f3d1e3c3cab87efd5ac1dc9c7?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="https://schema.org/Person">
            <a href="/user/4525/stamster" class="user-moderator-N"><span itemprop="name">Jonathan Aaron Steel</span></a>        </span>
        <br>

        <span class="karma">79.0k</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><span class="action-date action-reply-edit" data-id="43977" data-toggle="modal" data-target="#historyModal">
                edited <span>Dec '16</span>
              </span><br/><a name="C43977" href="#C43977">
                <time itemprop="dateCreated" datetime="2016-12-15T05:26:19-07:00" class="action-date">Dec '16</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>Thanks :)</p>
<p>Try setting your router only to read URLs from REQUEST_URI $_SERVER superglobal.</p>
<pre><code class="language-php">$di-&gt;setShared('router', function (){
// Phalcon\Mvc\Router has a default behavior that provides a very simple routing that always expects a URI that matches the following pattern: /:controller/:action/:params

    $router = new \Phalcon\Mvc\Router(false); //Create the router without default routes

    //we're using Front Page Controller pattern in relation from nginx -&gt; Phalcon, so we need to read superglobal request params as a source for routing
    $router-&gt;setUriSource($router::URI_SOURCE_SERVER_REQUEST_URI);

    //Set whether router must remove the extra slashes in the handled routes
    $router-&gt;removeExtraSlashes(true);

    return $router;
});</code></pre>
<p>And... <strong>Be careful what you wish for - it may come true.</strong></p></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="43977" data-cf-modified-cb19ff6b95b74f29d0f152cb-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="43977" data-cf-modified-cb19ff6b95b74f29d0f152cb-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
    </div>
</div>
<div class="row"><div class="col-md-1 small" align="center"></div>
        <div class="col-md-11 login-comment">
            
        </div></div>
</div><input type="hidden" id="post-id" name="post-id" value="15031" /><div id="suggested-posts"></div>
    <div id="sticky-progress" style='display:none'></div>
</div>
    </div>