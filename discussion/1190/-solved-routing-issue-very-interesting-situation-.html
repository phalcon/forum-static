---
layout: default
title: '[SOLVED]Routing issue (very interesting situation) - Discussion'
---

    <div class="container">
        {% include warning.html %}


<div itemscope itemtype="https://schema.org/Question"><ol class="breadcrumb">
    <li><a href="/">Home</a></li>
    <li><a href="/category/13/routing">Routing</a></li>
</ol>
<div class="row table-title">
    <div class="col-lg-8 col-md-7 col-sm-6 col-xs-12 wrapper-author">
        <h1 class="" itemprop="name">[SOLVED]Routing issue (very interesting situation)</h1>
        <div class="visible-xs-block mobile-author">
            <span itemprop="author" itemscope itemtype="https://schema.org/Person"><a href="/user/659/oleg578" class="user-moderator-N"><span itemprop="name">Oleg</span></a></span>
            <time itemprop="dateCreated" datetime="2013-11-16T10:49:35-07:00">Nov '13</time>
        </div>
    </div>
    <div class="col-lg-4 col-md-5 col-sm-6 hidden-xs text-right wrapper-stats">
        <table class="table-stats" width="100%">
            <tr style="vertical-align: top;">
                <td>
                    <label>Created</label><br>
                    <time itemprop="dateCreated" datetime="2013-11-16T10:49:35-07:00">Nov '13</time>
                </td>
                <td>
                    <label>Last Reply</label><br>Nov '13</td>
                <td>
                    <label>Replies</label><br>
                    <span itemprop="answerCount">4</span>
                </td>
                <td>
                    <label>Views</label><br>2029</td>
                <td>
                    <label>Votes</label><br>
                    <span itemprop="upvoteCount">2</span>
                </td>
            </tr>
        </table>
    </div>
</div>
<div class="discussion">
        <div class="row reply-block">
            <div class="col-md-1 col-sm-1 hidden-xs text-center">
                <img src="https://secure.gravatar.com/avatar/fcae2565ce4d1ed7240231932dec115a?s=48&amp;r=pg&amp;d=identicon" class="img-rounded avatar" /><br>
                <span itemprop="author" itemscope itemtype="https://schema.org/Person" class="avatar-name"><a href="/user/659/oleg578" class="user-moderator-N"><span itemprop="name">Oleg</span></a></span>
                <span class="karma">8.1k</span>
            </div>
            <div class="col-md-11 col-sm-11 col-xs-12 post-body"><div class="posts-date hidden-xs" align="right">
        <a name="C1190" href="#C1190">
        <time class="action-date">Nov '13</time>
    </a>
</div>
<div class="post-content"><div><p><a href="https://forum.phalcon.io////discussion///////////////1189/////-#C4248">https://forum.phalcon.io////discussion///////////////1189/////-#C4248</a>
Why this route is matched?
And  <a href="https://phalcon.io/en///////////support">https://phalcon.io/en///////////support</a></p>
<p>Look, please <a href="https://forum.phalcon.io/discussion/1189/">https://forum.phalcon.io/discussion/1189/</a>-</p></div>                </div>

                <div class="posts-buttons text-right"><a href="#"  class="btn btn-danger btn-xs" data-cf-modified-b2167664483f636ecf73a8c9-="">
        <span class="glyphicon glyphicon-thumbs-down"></span></a>
    <a href="#"  class="btn btn-success btn-xs" data-cf-modified-b2167664483f636ecf73a8c9-="">
        <span class="glyphicon glyphicon-thumbs-up"></span><span itemprop="upvoteCount">2</span></a></div>
            </div>
        </div><div itemprop="suggestedAnswer" itemscope itemtype="https://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img src="https://secure.gravatar.com/avatar/fcae2565ce4d1ed7240231932dec115a?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="https://schema.org/Person">
            <a href="/user/659/oleg578" class="user-moderator-N"><span itemprop="name">Oleg</span></a>        </span>
        <br>

        <span class="karma">8.1k</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><a name="C4256" href="#C4256">
                <time itemprop="dateCreated" datetime="2013-11-16T11:52:05-07:00" class="action-date">Nov '13</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>But this issue does not appear when annotations used.</p></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="4256" data-cf-modified-b2167664483f636ecf73a8c9-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="4256" data-cf-modified-b2167664483f636ecf73a8c9-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
    </div>
</div>
<div itemprop="suggestedAnswer" itemscope itemtype="https://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img src="https://secure.gravatar.com/avatar/177525cf68cabf12fac5fc4c3603ecba?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="https://schema.org/Person">
            <a href="/user/114/roman-kulish" class="user-moderator-N"><span itemprop="name">roman-kulish</span></a>        </span>
        <br>

        <span class="karma">5.7k</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><a name="C4270" href="#C4270">
                <time itemprop="dateCreated" datetime="2013-11-17T03:48:11-07:00" class="action-date">Nov '13</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>In other words Router allows multiple backslashes. See test here <a href="https://forum.phalcon.io/discussion/1189/-#C4250">https://forum.phalcon.io/discussion/1189/-#C4250</a></p></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="4270" data-cf-modified-b2167664483f636ecf73a8c9-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="4270" data-cf-modified-b2167664483f636ecf73a8c9-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
    </div>
</div>
<div itemprop="suggestedAnswer" itemscope itemtype="https://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img src="https://secure.gravatar.com/avatar/fcae2565ce4d1ed7240231932dec115a?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="https://schema.org/Person">
            <a href="/user/659/oleg578" class="user-moderator-N"><span itemprop="name">Oleg</span></a>        </span>
        <br>

        <span class="karma">8.1k</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><a name="C4271" href="#C4271">
                <time itemprop="dateCreated" datetime="2013-11-17T04:40:11-07:00" class="action-date">Nov '13</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>:) This test was done by me.
This post is duplicated from russian <a href="https://forum.phalcon.io/discussion/1189/">https://forum.phalcon.io/discussion/1189/</a>-  for community.
I am interested in how this will comment on Phalcon.</p></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="4271" data-cf-modified-b2167664483f636ecf73a8c9-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="4271" data-cf-modified-b2167664483f636ecf73a8c9-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
    </div>
</div>
<div itemprop="suggestedAnswer" itemscope itemtype="https://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img src="https://secure.gravatar.com/avatar/177525cf68cabf12fac5fc4c3603ecba?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="https://schema.org/Person">
            <a href="/user/114/roman-kulish" class="user-moderator-N"><span itemprop="name">roman-kulish</span></a>        </span>
        <br>

        <span class="karma">5.7k</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><a name="C4273" href="#C4273">
                <time itemprop="dateCreated" datetime="2013-11-17T06:01:51-07:00" class="action-date">Nov '13</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>It's not a bug. On one hand, as per RFC URL path segments must be separated with a single forward slash. So it looks like RFC violation. On the other hand, URL path is a path in a hierarchical structure where each adjacent slash points to a folder named with an empty string, which is not valid for a file system. Phalcon Router may skip duplicate slashes or it does &quot;path normalisation&quot;, which is correct behaviour. That's why using REQUEST_URI works as expected and it does not work if _uri=xxx URL attribute is used.</p>
<p>But the thing is, it's not the Router's job to decide on action should be taken in case of malformed URL path. My suggestion is to add a URL rewrite rule to your web server to redirect 302 to correct URL or fail with 404 on malformed URLs. It's better for SEO and doesn't put load on the application if handled by the web server.</p></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="4273" data-cf-modified-b2167664483f636ecf73a8c9-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="4273" data-cf-modified-b2167664483f636ecf73a8c9-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
    </div>
</div>
<div itemprop="suggestedAnswer" itemscope itemtype="https://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img src="https://secure.gravatar.com/avatar/fcae2565ce4d1ed7240231932dec115a?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="https://schema.org/Person">
            <a href="/user/659/oleg578" class="user-moderator-N"><span itemprop="name">Oleg</span></a>        </span>
        <br>

        <span class="karma">8.1k</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><a name="C4277" href="#C4277">
                <time itemprop="dateCreated" datetime="2013-11-17T07:24:11-07:00" class="action-date">Nov '13</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>RFC 3986 Part 3.3 Path.
... If a URI
does not contain an authority component, then the path cannot begin
with two slash characters (&quot;//&quot;).
...When authority is not present, the path cannot begin with two slash
characters (&quot;//&quot;).
<a href="https://tools.ietf.org/html/rfc3986#appendix-A">https://tools.ietf.org/html/rfc3986#appendix-A</a></p></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="4277" data-cf-modified-b2167664483f636ecf73a8c9-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="4277" data-cf-modified-b2167664483f636ecf73a8c9-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
    </div>
</div>
<div itemprop="suggestedAnswer" itemscope itemtype="https://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img src="https://secure.gravatar.com/avatar/fcae2565ce4d1ed7240231932dec115a?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="https://schema.org/Person">
            <a href="/user/659/oleg578" class="user-moderator-N"><span itemprop="name">Oleg</span></a>        </span>
        <br>

        <span class="karma">8.1k</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><a name="C4278" href="#C4278">
                <time itemprop="dateCreated" datetime="2013-11-17T09:21:46-07:00" class="action-date">Nov '13</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>On the other hand, with annotations all work nice.
For example, we want route with  the following properties (allowable path)</p>
<pre><code class="language-php">/test
/test/
/test/Frank765
/test/7John63</code></pre>
<p>and with double slash prohibition.
We can create route :</p>
<pre><code class="language-php">@Get("test([/])?{user:[a-zA-Z0-9]*?}")</code></pre>
<p>And it work nice.</p></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="4278" data-cf-modified-b2167664483f636ecf73a8c9-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="4278" data-cf-modified-b2167664483f636ecf73a8c9-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
    </div>
</div>
<div itemprop="suggestedAnswer" itemscope itemtype="https://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img src="https://secure.gravatar.com/avatar/177525cf68cabf12fac5fc4c3603ecba?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="https://schema.org/Person">
            <a href="/user/114/roman-kulish" class="user-moderator-N"><span itemprop="name">roman-kulish</span></a>        </span>
        <br>

        <span class="karma">5.7k</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><a name="C4288" href="#C4288">
                <time itemprop="dateCreated" datetime="2013-11-17T17:25:52-07:00" class="action-date">Nov '13</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>I doubt that Router should perform URL path normalization, it can be quite complicated some times. For example:</p>
<pre><code class="language-php">/test/blah/../Frank765 -&gt; /test/Frank765 
/test/./Frank765 -&gt; /test/Frank765 
/test//Frank765 -&gt; /test/Frank765 
Frank765 is a file -&gt; /test/blah/Frank765
Frank765 is a directory -&gt; /test/blah/Frank765/</code></pre>
<p>It should be done by the web server itself or rewrite rules. Router does not have enough knowledge of the end resource and correct behavior if resource is not there. So, following your example, possible actions can be:</p>
<ul>
<li>normalize path and treat /test////Frank765 as /test/Frank765</li>
<li>throw 400 Bad Request</li>
<li>throw 404 Not Found</li>
<li>return permanent 301 redirect</li>
<li>return temporary 302 redirect</li>
</ul>
<p>Each option is different and should be chosen according to the situation.</p></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="4288" data-cf-modified-b2167664483f636ecf73a8c9-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="4288" data-cf-modified-b2167664483f636ecf73a8c9-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
    </div>
</div>
<div itemprop="suggestedAnswer acceptedAnswer" itemscope itemtype="https://schema.org/Answer" class="reply-block row reply-accepted">
    <div class="col-md-1 small" align="center">
        <img src="https://secure.gravatar.com/avatar/5cfc1eb34e142b9035b986311e0e8468?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="https://schema.org/Person">
            <a href="/user/306/sjinks" class="user-moderator-Y"><span itemprop="name">Volodymyr Kolesnykov</span></a>        </span>
        <br>

        <span class="karma">1.2k</span><div class="accepted-reply">
                <span class="glyphicon glyphicon-ok"></span>
                Accepted<br>answer
            </div></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><span class="action-date action-reply-edit" data-id="4297" data-toggle="modal" data-target="#historyModal">
                edited <span>Mar '14</span>
              </span><br/><a name="C4297" href="#C4297">
                <time itemprop="dateCreated" datetime="2013-11-18T04:07:46-07:00" class="action-date">Nov '13</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>Guys, this is how Apache works, not Phalcon :-)</p>
<p>index.php:</p>
<pre><code class="language-php">&lt;?php

class IndexController
{
        public function indexAction()
        {
                echo __METHOD__, PHP_EOL;
                print_r($_SERVER);
        }

        public function helloAction()
        {
                echo __METHOD__, PHP_EOL;
                print_r($_GET);
        }
}

$di = new Phalcon\DI();
$di['router'] = function() {
        $router = new Phalcon\Mvc\Router(false);
//      $router-&gt;setUriSource(Phalcon\Mvc\Router::URI_SOURCE_SERVER_REQUEST_URI); // This line solve the bug
        $router-&gt;removeExtraSlashes(false);

        $router-&gt;add('/home/hello', array(
                'controller' =&gt; 'index',
                'action'     =&gt; 'hello'
        ));

        return $router;
};

$di['dispatcher'] = new \Phalcon\Mvc\Dispatcher();
$di['response'] = new \Phalcon\Http\Response();
$di['view'] = new \Phalcon\Mvc\View();

header('Content-Type: text/plain');
$application = new \Phalcon\Mvc\Application($di);
echo $application-&gt;handle()-&gt;getContent();</code></pre>
<p>.htaccess:</p>
<pre><code class="language-html">&lt;IfModule mod_rewrite.c&gt;
    RewriteEngine On
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteRule ^(.*)$ index.php?_url=/$1 [QSA,L]
&lt;/IfModule&gt;</code></pre>
<p>Now if you go to site/home/////hello, you will see something like this:</p>
<pre><code class="language-php">IndexController::helloAction
Array
(
    [_url] =&gt; /home/hello
)</code></pre>
<p>That is, Apache internally normalizes the request and this is why Phalcon is passed the correct string — /home/hello and not /home/////hello.</p>
<p>If you uncomment <code>$router-&gt;setUriSource(Phalcon\Mvc\Router::URI_SOURCE_SERVER_REQUEST_URI);</code>, you will see something like</p>
<pre><code class="language-php">...
    [REDIRECT_QUERY_STRING] =&gt; _url=/home/hello
    [REDIRECT_URL] =&gt; /home///hello
    [QUERY_STRING] =&gt; _url=/home/hello
    [REQUEST_URI] =&gt; /home///hello
    [SCRIPT_NAME] =&gt; /index.php
    [PHP_SELF] =&gt; /index.php
...</code></pre>
<p>REQUEST_URI is not normalized by Apache and this is why the behavior differs.</p>
<p>Don't know about Apache, but for nginx you can control the behavior with <code>merge_slashes</code> directive (<a href="https://nginx.org/en/docs/http/ngx_http_core_module.html#merge_slashes">https://nginx.org/en/docs/http/ngx_http_core_module.html#merge_slashes</a>)</p></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="4297" data-cf-modified-b2167664483f636ecf73a8c9-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="4297" data-cf-modified-b2167664483f636ecf73a8c9-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
    </div>
</div>
<div itemprop="suggestedAnswer" itemscope itemtype="https://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img src="https://secure.gravatar.com/avatar/fcae2565ce4d1ed7240231932dec115a?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="https://schema.org/Person">
            <a href="/user/659/oleg578" class="user-moderator-N"><span itemprop="name">Oleg</span></a>        </span>
        <br>

        <span class="karma">8.1k</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><a name="C4298" href="#C4298">
                <time itemprop="dateCreated" datetime="2013-11-18T04:20:54-07:00" class="action-date">Nov '13</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>Thank you very much. I read your post on Github too.</p></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="4298" data-cf-modified-b2167664483f636ecf73a8c9-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="4298" data-cf-modified-b2167664483f636ecf73a8c9-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
    </div>
</div>
<div class="row"><div class="col-md-1 small" align="center"></div>
        <div class="col-md-11 login-comment">
            
        </div></div>
</div><input type="hidden" id="post-id" name="post-id" value="1190" /><div id="suggested-posts"></div>
    <div id="sticky-progress" style='display:none'></div>
</div>
    </div>