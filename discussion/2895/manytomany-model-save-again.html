---
layout: default
title: 'ManyToMany - Model::save() again - Discussion'
---

    <div class="container">
        {% include warning.html %}


<div itemscope itemtype="https://schema.org/Question"><ol class="breadcrumb">
    <li><a href="/">Home</a></li>
    <li><a href="/category/23/odm">ODM</a></li>
</ol>
<div class="row table-title">
    <div class="col-lg-8 col-md-7 col-sm-6 col-xs-12 wrapper-author">
        <h1 class="" itemprop="name">ManyToMany - Model::save() again</h1>
        <div class="visible-xs-block mobile-author">
            <span itemprop="author" itemscope itemtype="https://schema.org/Person"><a href="/user/1774/AljoschaPeters" class="user-moderator-N"><span itemprop="name">AljoschaPeters</span></a></span>
            <time itemprop="dateCreated" datetime="2014-07-22T03:49:31-07:00">Jul '14</time>
        </div>
    </div>
    <div class="col-lg-4 col-md-5 col-sm-6 hidden-xs text-right wrapper-stats">
        <table class="table-stats" width="100%">
            <tr style="vertical-align: top;">
                <td>
                    <label>Created</label><br>
                    <time itemprop="dateCreated" datetime="2014-07-22T03:49:31-07:00">Jul '14</time>
                </td>
                <td>
                    <label>Last Reply</label><br>Jul '14</td>
                <td>
                    <label>Replies</label><br>
                    <span itemprop="answerCount">1</span>
                </td>
                <td>
                    <label>Views</label><br>834</td>
                <td>
                    <label>Votes</label><br>
                    <span itemprop="upvoteCount">0</span>
                </td>
            </tr>
        </table>
    </div>
</div>
<div class="discussion">
        <div class="row reply-block">
            <div class="col-md-1 col-sm-1 hidden-xs text-center">
                <img src="https://secure.gravatar.com/avatar/bea16635c1faa4ccc409e82e025dc417?s=48&amp;r=pg&amp;d=identicon" class="img-rounded avatar" /><br>
                <span itemprop="author" itemscope itemtype="https://schema.org/Person" class="avatar-name"><a href="/user/1774/AljoschaPeters" class="user-moderator-N"><span itemprop="name">AljoschaPeters</span></a></span>
                <span class="karma">18.3k</span>
            </div>
            <div class="col-md-11 col-sm-11 col-xs-12 post-body"><div class="posts-date hidden-xs" align="right">
        <a name="C2895" href="#C2895">
        <time class="action-date">Jul '14</time>
    </a>
</div>
<div class="post-content"><div><p>Hello,</p>
<p>I have a many to many relationship entities - entities_keywords (entities_id, keywords_id) - keywords. Searching works fine and as described.
Now I want to save new entities. If the keywords are not stored in the database and I call entity-&gt;save() everything works great. But if just one of the keywords already exists, the whole query fails.
So I want to override the save()-function in the model and after reading documentation and searching in the forum (some users got the same behaviour) I'm not quite clear how to do it properly.</p>
<p>My idea for creation a new entity:
First I get all keyword as comma-seperated string; second I explode the string and search if the keyword exists, if not I save it; third I save entity's main data; fourth I save entity-keywords to the table (entities_keywords).</p>
<p>Questions are now:</p>
<ul>
<li>How do I only save entity's main data? ... probably with parent::save($data)? And should I call it in Entities-&gt;save()?</li>
<li>If I get the keywords in $data['keywords'] where is the best place to check if they already exists? And how to prevent them from being stored by phalcon's built-in save-function?</li>
</ul>
<p>It's very sad, that the manytomany-relation works fine for reading but makes saving much complicated :/</p>
<p>Thanks a lot.</p></div>                </div>

                <div class="posts-buttons text-right"><a href="#"  class="btn btn-danger btn-xs" data-cf-modified-977576e059a1a85ab2dd006b-="">
        <span class="glyphicon glyphicon-thumbs-down"></span></a>
    <a href="#"  class="btn btn-success btn-xs" data-cf-modified-977576e059a1a85ab2dd006b-="">
        <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
            </div>
        </div><div itemprop="suggestedAnswer" itemscope itemtype="https://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img src="https://secure.gravatar.com/avatar/5d6f567f9109789fd9f702959768e35d?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="https://schema.org/Person">
            <a href="/user/1/phalcon" class="user-moderator-Y"><span itemprop="name">Phalcon</span></a>        </span>
        <br>

        <span class="karma">98.9k</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><a name="C9684" href="#C9684">
                <time itemprop="dateCreated" datetime="2014-07-23T20:28:00-07:00" class="action-date">Jul '14</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>Could you please post some code that shows what you're trying to do?</p></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="9684" data-cf-modified-977576e059a1a85ab2dd006b-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="9684" data-cf-modified-977576e059a1a85ab2dd006b-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
    </div>
</div>
<div itemprop="suggestedAnswer" itemscope itemtype="https://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img src="https://secure.gravatar.com/avatar/bea16635c1faa4ccc409e82e025dc417?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="https://schema.org/Person">
            <a href="/user/1774/AljoschaPeters" class="user-moderator-N"><span itemprop="name">AljoschaPeters</span></a>        </span>
        <br>

        <span class="karma">18.3k</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><span class="action-date action-reply-edit" data-id="9690" data-toggle="modal" data-target="#historyModal">
                edited <span>Jul '14</span>
              </span><br/><a name="C9690" href="#C9690">
                <time itemprop="dateCreated" datetime="2014-07-23T23:24:02-07:00" class="action-date">Jul '14</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>Hi and thanks for your answer.</p>
<p>I've got three models: Ideas, Keywords, IdeasKeywords.
Model Ideas does have some fields, especially the PK id.
Model Keywords does have two fields, PK id and Unique title.
Model IdeasKeywords has two fields, FK ideas_id and FK keywords_id; the PK is populated by Database with (ideas_id, keywords_id), so no entries can be doubled.</p>
<p>The idea and keywords are entered in a form by the user. The keywords are sent as a comma-seperated string.</p>
<p>Using the phalcon built-in functionality like shown here <a href="https://docs.phalcon.io/en/latest/reference/models.html#storing-related-records">Phalcon Documentation</a> a new <code>Idea</code> is saved if all <code>Keywords</code> are not yet stored in the database. The process does not succeed, if there is already one of them stored in the database.</p>
<p>Now I built the whole logic for creating (updating will come later) in the controller <code>IdeaController</code>. But I want the whole logic in a seperated file, best place therefore is probalby the Model <code>Idea</code>?!</p>
<p>I implemented the create logic this way:
First it stores the new idea in the database table, now I've got the new ID in the object.
Second it looks for every keyword if it is already in the database (Keywords::findFirst(array('conditions'=&gt;'title=?1', 'bind' =&gt; ...))). If it is already stored it returns the object to an array, if it is not, it will be created and then put to the array.
Third for the whole array, the new relations are stored in the table IdeasKeywords.</p>
<p>The documentation says &quot;Note: Adding related entities by overloading the following methods is not possible: PhalconMvcModel::beforeSave(), PhalconMvcModel::beforeCreate(), PhalconMvcModel::beforeUpdate(). You need to overload PhalconMvcModel::save() for this to work from within a model.&quot;</p>
<p>But it is not said how to do that. As you see, I need to override Model::create() and Model::update(), because updating an idea could mean to delete some entries in <code>IdeasKeywords</code>.</p>
<p>Sorry, that I haven't post some of my code, but I don't know, if this is really helpful, because models are simple ones with no extra functionality for now. Many-to-many-Relationship works well, if I use $idea = findFirstById(1); $keywords = $idea-&gt;getKeywords();</p>
<p>Thanks a lot for your help.</p></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="9690" data-cf-modified-977576e059a1a85ab2dd006b-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="9690" data-cf-modified-977576e059a1a85ab2dd006b-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
    </div>
</div>
<div itemprop="suggestedAnswer" itemscope itemtype="https://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img src="https://secure.gravatar.com/avatar/bea16635c1faa4ccc409e82e025dc417?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="https://schema.org/Person">
            <a href="/user/1774/AljoschaPeters" class="user-moderator-N"><span itemprop="name">AljoschaPeters</span></a>        </span>
        <br>

        <span class="karma">18.3k</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><span class="action-date action-reply-edit" data-id="9696" data-toggle="modal" data-target="#historyModal">
                edited <span>Oct '14</span>
              </span><br/><a name="C9696" href="#C9696">
                <time itemprop="dateCreated" datetime="2014-07-24T01:38:19-07:00" class="action-date">Jul '14</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>Alright, got it. With try and error ...
But docs should be more descriptive:</p>
<p>Override Model::create() means:</p>
<pre><code>MyModel::create($data=null, $whitelist=null)
{
 ... do something
 if (parent::create($data, $whitelist) == FALSE)
     return FALSE;
... do something
return FALSE/TRUE;
}
</code></pre>
<p>Validators still works, and so on ...</p></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="9696" data-cf-modified-977576e059a1a85ab2dd006b-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="9696" data-cf-modified-977576e059a1a85ab2dd006b-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
    </div>
</div>
<div itemprop="suggestedAnswer" itemscope itemtype="https://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img src="https://secure.gravatar.com/avatar/bea16635c1faa4ccc409e82e025dc417?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="https://schema.org/Person">
            <a href="/user/1774/AljoschaPeters" class="user-moderator-N"><span itemprop="name">AljoschaPeters</span></a>        </span>
        <br>

        <span class="karma">18.3k</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><a name="C9697" href="#C9697">
                <time itemprop="dateCreated" datetime="2014-07-24T01:46:05-07:00" class="action-date">Jul '14</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>Only thing, that does not work is the data persistent between the request for the form.</p></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="9697" data-cf-modified-977576e059a1a85ab2dd006b-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="9697" data-cf-modified-977576e059a1a85ab2dd006b-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
    </div>
</div>
<div class="row"><div class="col-md-1 small" align="center"></div>
        <div class="col-md-11 login-comment">
            
        </div></div>
</div><input type="hidden" id="post-id" name="post-id" value="2895" /><div id="suggested-posts"></div>
    <div id="sticky-progress" style='display:none'></div>
</div>
    </div>