---
layout: default
title: 'Add more function to Router, like middleware ? - Discussion'
---

    <div class="container">
        {% include warning.html %}


<div itemscope itemtype="https://schema.org/Question"><ol class="breadcrumb">
    <li><a href="/">Home</a></li>
    <li><a href="/category/13/routing">Routing</a></li>
</ol>
<div class="row table-title">
    <div class="col-lg-8 col-md-7 col-sm-6 col-xs-12 wrapper-author">
        <h1 class="" itemprop="name">Add more function to Router, like middleware ?</h1>
        <div class="visible-xs-block mobile-author">
            <span itemprop="author" itemscope itemtype="https://schema.org/Person"><a href="/user/3635/huoybb" class="user-moderator-N"><span itemprop="name">huoybb</span></a></span>
            <time itemprop="dateCreated" datetime="2016-03-19T17:38:52-07:00">Mar '16</time>
        </div>
    </div>
    <div class="col-lg-4 col-md-5 col-sm-6 hidden-xs text-right wrapper-stats">
        <table class="table-stats" width="100%">
            <tr style="vertical-align: top;">
                <td>
                    <label>Created</label><br>
                    <time itemprop="dateCreated" datetime="2016-03-19T17:38:52-07:00">Mar '16</time>
                </td>
                <td>
                    <label>Last Reply</label><br>Mar '16</td>
                <td>
                    <label>Replies</label><br>
                    <span itemprop="answerCount">4</span>
                </td>
                <td>
                    <label>Views</label><br>1409</td>
                <td>
                    <label>Votes</label><br>
                    <span itemprop="upvoteCount">0</span>
                </td>
            </tr>
        </table>
    </div>
</div>
<div class="discussion">
        <div class="row reply-block">
            <div class="col-md-1 col-sm-1 hidden-xs text-center">
                <img src="https://secure.gravatar.com/avatar/2b4db4eed8ca8b786c8af3d3c5c0598d?s=48&amp;r=pg&amp;d=identicon" class="img-rounded avatar" /><br>
                <span itemprop="author" itemscope itemtype="https://schema.org/Person" class="avatar-name"><a href="/user/3635/huoybb" class="user-moderator-N"><span itemprop="name">huoybb</span></a></span>
                <span class="karma">7.0k</span>
            </div>
            <div class="col-md-11 col-sm-11 col-xs-12 post-body"><div class="posts-date hidden-xs" align="right">
        <a name="C10831" href="#C10831">
        <time class="action-date">Mar '16</time>
    </a>
</div>
<div class="post-content"><div><p>Has anybody implement middleware for router?
like :</p>
<pre><code class="language-php">$router-&gt;addx('/standards/add','standards::add',[middleware::class])-&gt;setName('standards.add');</code></pre></div>                </div>

                <div class="posts-buttons text-right"><a href="#"  class="btn btn-danger btn-xs" data-cf-modified-3afcb8ab0e7e722b4696dec4-="">
        <span class="glyphicon glyphicon-thumbs-down"></span></a>
    <a href="#"  class="btn btn-success btn-xs" data-cf-modified-3afcb8ab0e7e722b4696dec4-="">
        <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
            </div>
        </div><div itemprop="suggestedAnswer" itemscope itemtype="https://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img src="https://secure.gravatar.com/avatar/8da15621865643112c6e3243f2ce4ebe?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="https://schema.org/Person">
            <a href="/user/3812/Jurigag" class="user-moderator-Y"><span itemprop="name">Wojciech Ślawski</span></a>        </span>
        <br>

        <span class="karma">145.0k</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><a name="C31203" href="#C31203">
                <time itemprop="dateCreated" datetime="2016-03-19T22:50:47-07:00" class="action-date">Mar '16</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>For Application there is <a href="https://docs.phalcon.io/pl/latest/reference/dispatching.html#dispatch-loop-events">https://docs.phalcon.io/pl/latest/reference/dispatching.html#dispatch-loop-events</a></p></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="31203" data-cf-modified-3afcb8ab0e7e722b4696dec4-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="31203" data-cf-modified-3afcb8ab0e7e722b4696dec4-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span><span itemprop="upvoteCount">1</span></a></div>
    </div>
</div>
<div itemprop="suggestedAnswer" itemscope itemtype="https://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img src="https://secure.gravatar.com/avatar/e089a17872ac028d8745a75f56e34d54?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="https://schema.org/Person">
            <a href="/user/2493/SidRoberts" class="user-moderator-N"><span itemprop="name">Sid Roberts</span></a>        </span>
        <br>

        <span class="karma">1.6k</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><a name="C31225" href="#C31225">
                <time itemprop="dateCreated" datetime="2016-03-20T06:47:05-07:00" class="action-date">Mar '16</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>See also <a href="https://docs.phalcon.io/en/latest/reference/routing.html#match-callbacks">https://docs.phalcon.io/en/latest/reference/routing.html#match-callbacks</a></p></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="31225" data-cf-modified-3afcb8ab0e7e722b4696dec4-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="31225" data-cf-modified-3afcb8ab0e7e722b4696dec4-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span><span itemprop="upvoteCount">1</span></a></div>
    </div>
</div>
<div itemprop="suggestedAnswer acceptedAnswer" itemscope itemtype="https://schema.org/Answer" class="reply-block row reply-accepted">
    <div class="col-md-1 small" align="center">
        <img src="https://secure.gravatar.com/avatar/2b4db4eed8ca8b786c8af3d3c5c0598d?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="https://schema.org/Person">
            <a href="/user/3635/huoybb" class="user-moderator-N"><span itemprop="name">huoybb</span></a>        </span>
        <br>

        <span class="karma">7.0k</span><div class="accepted-reply">
                <span class="glyphicon glyphicon-ok"></span>
                Accepted<br>answer
            </div></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><span class="action-date action-reply-edit" data-id="31369" data-toggle="modal" data-target="#historyModal">
                edited <span>Mar '16</span>
              </span><br/><a name="C31369" href="#C31369">
                <time itemprop="dateCreated" datetime="2016-03-21T14:03:46-07:00" class="action-date">Mar '16</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>After some digging and trying, I end up with myRouter having middleware manipulating and model binding. </p>
<pre><code class="language-php">... ...
$router-&gt;addMiddlewaresForEveryRoute([isLoggedin::class]);
$router-&gt;addx('/standards/{file:[0-9]+}/edit','standards::edit',[standardRules::class])-&gt;setName('standards.edit');
... ...</code></pre>
<p>For the standardsController, the edit function could set parameters as follow:</p>
<pre><code class="language-php">public function editAction(Files $file)
    {
        $fileable = $file-&gt;getFileable();
       ... ...

        $this-&gt;view-&gt;file = $file;
        $this-&gt;view-&gt;form = myForm::buildFormFromModel($fileable,$extraData);
    }</code></pre>
<p>And middleware like: </p>
<pre><code class="language-php">class standardRules extends myValidationRules
{
    public $rules = [
        'title'=&gt;['validator'=&gt;'PresenceOf','message'=&gt;'评论内容不能为空！']
    ];

}</code></pre>
<p>myRouter is :</p>
<pre><code class="language-php">use Phalcon\Http\Request;
use Phalcon\Http\Response;
use Phalcon\Mvc\Dispatcher;
use Phalcon\Mvc\Router;

/**
 * Created by PhpStorm.
 * User: ThinkPad
 * Date: 2015/3/21
 * Time: 9:30
 * 核心功能如下：
 * 1、中间件的实现
 * 2、模型绑定，model binding的实现，可以在action函数中指定绑定的类型，类似laravel 5.2 提供的一样
 * 3、模型绑定基础上，实现接口绑定
 */

class myRouter extends Router{
    /**
     * @var array
     */
    public $middlewares = [];

    public $middlewaresForEveryRoute = [];

    public $serviceProvider = [];

    /**
     * myRouter constructor.
     */
    public function __construct($defaultRoutes = true)
    {
        parent::__construct($defaultRoutes);
        //        ---------解决中文url不稳定的问题----------
        $this-&gt;setUriSource(Router::URI_SOURCE_SERVER_REQUEST_URI);//这种形式对比$_GET('_url')的要稳定，这个函数没有urldecode()，需要手动执行
        $_SERVER['REQUEST_URI'] = urldecode($_SERVER['REQUEST_URI']);
        //        ---------解决中文url不稳定的问题----------
    }

    public function addMiddlewaresForEveryRoute(array $middleware=[])
    {
        $this-&gt;middlewaresForEveryRoute = $middleware;
    }

    /**
     * 主要是增加了一个中间件的功能，利用short syntax来增加中间件，这样的好处是路由、中间件在一起，便于管理
     * @param $pattern
     * @param string $path
     * @param array $middleware
     * @return \Phalcon\Mvc\Router\Route
     */
    public function addx($pattern,$path,array $middleware=[])//给路由添加中间件
    {
        $this-&gt;middlewares[$pattern]=$middleware;
        return $this-&gt;add($pattern,$path);
    }

    /**中间件过滤检查：
     * 1、识别出适用所有路由的中间件，
     * 2、允许设置排除的几个典型路由的检查，特别是针对所有路由都适用的中间件，对login等几个路由应该可以排除
     * 3、针对当前路由，识别有哪些中间件适用；
     * 4、如果没有通过中间件的检查，则根据中间件提供的redirectUrl进行路由跳转
     * @param Request $request
     * @param Response $response
     * @return bool
     */
    public function executeMiddleWareChecking(Request $request, Response $response, Dispatcher $dispatcher)
    {
        $route = $this-&gt;getMatchedRoute();
        if(null == $route) die('url地址无效，找不到对应的路由设置！');

        $pattern = $route-&gt;getPattern();

        //对每个路由都进行验证的中间件！
        foreach($this-&gt;middlewaresForEveryRoute as $validator){
            $data = null;
            if(preg_match('|.*:.*|',$validator)) {//此处设置了可以带中间件参数
                list($validator,$data) = explode(':',$validator);
                $data = $dispatcher-&gt;getParam($data);
            }

            /** @var myValidation $validator */
            $validator = new $validator;

            if(!in_array($route-&gt;getName(),$validator-&gt;excludedRoutes) and !$validator-&gt;isValid($data)){
                $url = $validator-&gt;getRedirectedUrl();
//                    dd($url);
                $response-&gt;redirect($url,true);
                return false;
            }
        }

        if($this-&gt;hasMatchedMiddleWares($pattern)){
            $middleWares = $this-&gt;getMiddleWares($pattern);
            foreach($middleWares as $validator){
                if($request-&gt;isPost()) $data = $request-&gt;getPost();
//                dd($validator);
                if(preg_match('|[^:]+:[^:]+|',$validator)){
                    list($validator,$data) = explode(':',$validator);
                    $data = $dispatcher-&gt;getParam($data);
                }

                if(preg_match('|.*Rules$|',$validator)){
                    if(!$request-&gt;isPost()) continue;//避免出现get下的错误
                    $rules = new $validator();
                    $validator = (new myValidation())-&gt;take($rules);
                }else{
                    $validator = new $validator();
                }

                if(!$validator-&gt;isValid($data)){
                    $url = $validator-&gt;getRedirectedUrl();
//                    dd($url);
                    $response-&gt;redirect($url,true);
                    return false;
                }
            }
        }
        return true;
    }

    /**将router中参数，按照controller的中Action的类型参数进行绑定
     * @param Dispatcher $dispatcher
     */
    public function executeModelBinding(Dispatcher $dispatcher)
    {
        $reflection = new ReflectionMethod($dispatcher-&gt;getControllerClass(), $dispatcher-&gt;getActiveMethod());
        $actionParams = [];
        foreach($reflection-&gt;getParameters() as $parameter){

            $objectId = $dispatcher-&gt;getParam($parameter-&gt;name);
            if(null == $objectId &amp;&amp; $parameter-&gt;isDefaultValueAvailable()) $objectId = $parameter-&gt;getDefaultValue();

            if($parameter-&gt;getClass()){
                $className = $this-&gt;getProvider($parameter-&gt;getClass()-&gt;name);

                if($objectId){
                    if(is_subclass_of($className,\Phalcon\Mvc\Model::class)){
                        /** @var \Phalcon\Mvc\Model $className */
                        $actionParams[$parameter-&gt;name] = $className::findFirst($objectId);
                    }else{
                        $actionParams[$parameter-&gt;name] = new $className($objectId);
                    }

                }else{
                    $actionParams[$parameter-&gt;name] = new $className;
                }
            }else{
                $actionParams[$parameter-&gt;name] = $objectId;
            }
        }

        if(count($actionParams)){
            $dispatcher-&gt;setParams($actionParams);
        }
    }

// ----------   提供接口绑定, 从interface 到class的绑定----------

    /**
     * @param $key
     * @param $provider
     */
    public function bindProvider($key, $provider)
    {
        $this-&gt;serviceProvider[$key]=$provider;
    }

    /**
     * @param $key
     * @return mixed
     */
    public function getProvider($key)
    {
        if(isset($this-&gt;serviceProvider[$key])) return $this-&gt;serviceProvider[$key];
        return $key;
    }
//--------------helper functions for Middleware-----------------------------------------

    /**判断是否存在对应的中间件
     * @param $pattern
     * @return bool
     */
    private function hasMatchedMiddleWares($pattern)
    {
        return isset($this-&gt;middlewares[$pattern]);
    }

    /**获得指定的中间件字符串
     * @param $pattern
     * @return array
     *
     *
     */
    private function getMiddleWares($pattern)
    {
        return $this-&gt;middlewares[$pattern];
    }

} </code></pre>
<p>And my dispatcher.php file:</p>
<pre><code class="language-php">use Phalcon\Events\Event;
use Phalcon\Mvc\Dispatcher;

$eventsManager = new \Phalcon\Events\Manager();
$eventsManager-&gt;attach("dispatch:beforeDispatchLoop", function(Event $event, Dispatcher $dispatcher){
    //模型注入的功能，这里可以很方便的进行 model binding,这里基本上实现了Laravel中的模型绑定的功能了
    return RouterFacade::executeModelBinding($dispatcher);
//    return false;
});
$eventsManager-&gt;attach('dispatch:beforeExecuteRoute',function(Event $event,Dispatcher $dispatcher){
    return RouterFacade::executeMiddleWareChecking(RequestFacade::getService(),ResponseFacade::getService(),$dispatcher);
});

$dispatcher = new Dispatcher();
$dispatcher-&gt;setEventsManager($eventsManager);
return $dispatcher;</code></pre>
<p>I use Facade pattern  mentioned in post:<a href="https://forum.phalcon.io/discussion/10371/borrow-facade-design-pattern-from-laravel">https://forum.phalcon.io/discussion/10371/borrow-facade-design-pattern-from-laravel</a> .</p></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="31369" data-cf-modified-3afcb8ab0e7e722b4696dec4-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="31369" data-cf-modified-3afcb8ab0e7e722b4696dec4-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
    </div>
</div>
<div itemprop="suggestedAnswer" itemscope itemtype="https://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img src="https://secure.gravatar.com/avatar/8da15621865643112c6e3243f2ce4ebe?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="https://schema.org/Person">
            <a href="/user/3812/Jurigag" class="user-moderator-Y"><span itemprop="name">Wojciech Ślawski</span></a>        </span>
        <br>

        <span class="karma">145.0k</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><a name="C31371" href="#C31371">
                <time itemprop="dateCreated" datetime="2016-03-21T16:31:44-07:00" class="action-date">Mar '16</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>There is already implemented model binding in phalcon 2.1.x branch in zephir:</p>
<p><a href="https://github.com/phalcon/cphalcon/pull/11288">https://github.com/phalcon/cphalcon/pull/11288</a></p></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="31371" data-cf-modified-3afcb8ab0e7e722b4696dec4-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="31371" data-cf-modified-3afcb8ab0e7e722b4696dec4-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
    </div>
</div>
<div itemprop="suggestedAnswer" itemscope itemtype="https://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img src="https://secure.gravatar.com/avatar/2b4db4eed8ca8b786c8af3d3c5c0598d?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="https://schema.org/Person">
            <a href="/user/3635/huoybb" class="user-moderator-N"><span itemprop="name">huoybb</span></a>        </span>
        <br>

        <span class="karma">7.0k</span></div>
    <div class="col-md-11"><div class="in-reply-to">
                    <a href="#C31371"><span class="glyphicon glyphicon-chevron-up"></span> in reply to
                        <img src="https://secure.gravatar.com/avatar/8da15621865643112c6e3243f2ce4ebe?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" width="24" height="24" />                        Wojciech Ślawski                    </a>
                </div><div class="posts-buttons" align="right"><a name="C31373" href="#C31373">
                <time itemprop="dateCreated" datetime="2016-03-21T17:54:05-07:00" class="action-date">Mar '16</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>Oh, that is good, any doc?</p>
<blockquote>
<p>There is already implemented model binding in phalcon 2.1.x branch in zephir:</p>
<p><a href="https://github.com/phalcon/cphalcon/pull/11288">https://github.com/phalcon/cphalcon/pull/11288</a></p>
</blockquote></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="31373" data-cf-modified-3afcb8ab0e7e722b4696dec4-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="31373" data-cf-modified-3afcb8ab0e7e722b4696dec4-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
    </div>
</div>
<div itemprop="suggestedAnswer" itemscope itemtype="https://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img src="https://secure.gravatar.com/avatar/8da15621865643112c6e3243f2ce4ebe?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="https://schema.org/Person">
            <a href="/user/3812/Jurigag" class="user-moderator-Y"><span itemprop="name">Wojciech Ślawski</span></a>        </span>
        <br>

        <span class="karma">145.0k</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><a name="C31383" href="#C31383">
                <time itemprop="dateCreated" datetime="2016-03-22T00:20:21-07:00" class="action-date">Mar '16</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>Just check this repo, docs will be available on phalcon page when 2.1.x it will be finally realased. There is PR waiting to be merged to docs - <a href="https://github.com/phalcon/docs/pull/785/files">https://github.com/phalcon/docs/pull/785/files</a></p></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="31383" data-cf-modified-3afcb8ab0e7e722b4696dec4-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="31383" data-cf-modified-3afcb8ab0e7e722b4696dec4-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
    </div>
</div>
<div class="row"><div class="col-md-1 small" align="center"></div>
        <div class="col-md-11 login-comment">
            
        </div></div>
</div><input type="hidden" id="post-id" name="post-id" value="10831" /><div id="suggested-posts"></div>
    <div id="sticky-progress" style='display:none'></div>
</div>
    </div>