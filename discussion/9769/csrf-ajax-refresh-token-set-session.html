---
layout: default
title: 'CSRF Ajax Refresh Token &amp; set session - Discussion'
---

    <div class="container">
        {% include warning.html %}


<div itemscope itemtype="https://schema.org/Question"><ol class="breadcrumb">
    <li><a href="/">Home</a></li>
    <li><a href="/category/28/session">Session</a></li>
</ol>
<div class="row table-title">
    <div class="col-lg-8 col-md-7 col-sm-6 col-xs-12 wrapper-author">
        <h1 class="" itemprop="name">CSRF Ajax Refresh Token &amp; set session</h1>
        <div class="visible-xs-block mobile-author">
            <span itemprop="author" itemscope itemtype="https://schema.org/Person"><a href="/user/1663/al35mm" class="user-moderator-N"><span itemprop="name">Al</span></a></span>
            <time itemprop="dateCreated" datetime="2015-12-07T13:04:25-07:00">Dec '15</time>
        </div>
    </div>
    <div class="col-lg-4 col-md-5 col-sm-6 hidden-xs text-right wrapper-stats">
        <table class="table-stats" width="100%">
            <tr style="vertical-align: top;">
                <td>
                    <label>Created</label><br>
                    <time itemprop="dateCreated" datetime="2015-12-07T13:04:25-07:00">Dec '15</time>
                </td>
                <td>
                    <label>Last Reply</label><br>Dec '15</td>
                <td>
                    <label>Replies</label><br>
                    <span itemprop="answerCount">2</span>
                </td>
                <td>
                    <label>Views</label><br>1415</td>
                <td>
                    <label>Votes</label><br>
                    <span itemprop="upvoteCount">0</span>
                </td>
            </tr>
        </table>
    </div>
</div>
<div class="discussion">
        <div class="row reply-block">
            <div class="col-md-1 col-sm-1 hidden-xs text-center">
                <img src="https://secure.gravatar.com/avatar/ff9a2f43efac70da87e23ddd6ac5061f?s=48&amp;r=pg&amp;d=identicon" class="img-rounded avatar" /><br>
                <span itemprop="author" itemscope itemtype="https://schema.org/Person" class="avatar-name"><a href="/user/1663/al35mm" class="user-moderator-N"><span itemprop="name">Al</span></a></span>
                <span class="karma">20.4k</span>
            </div>
            <div class="col-md-11 col-sm-11 col-xs-12 post-body"><div class="posts-date hidden-xs" align="right">
        <a name="C9769" href="#C9769">
        <time class="action-date">Dec '15</time>
    </a>
</div>
<div class="post-content"><div><p>OK so I'm trying to be a bit clever, and in forms submitted via ajax, rather than give user a CSRF error if they have not submitted before the token expires, and force them to refresh the page and clear the form, I want to regenerate the CSRF token from within the controller, send it back to the form via the ajax callback. This updates the hidden CSRF field in the form, but as there is no page refresh, the token isn't refreshed in the session.</p>
<p>How can I update the CSRF token in the session manually via the controller?</p></div>                </div>

                <div class="posts-buttons text-right"><a href="#"  class="btn btn-danger btn-xs" data-cf-modified-6ddbfecba155482d5017a387-="">
        <span class="glyphicon glyphicon-thumbs-down"></span></a>
    <a href="#"  class="btn btn-success btn-xs" data-cf-modified-6ddbfecba155482d5017a387-="">
        <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
            </div>
        </div><div itemprop="suggestedAnswer" itemscope itemtype="https://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img src="https://secure.gravatar.com/avatar/ff9a2f43efac70da87e23ddd6ac5061f?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="https://schema.org/Person">
            <a href="/user/1663/al35mm" class="user-moderator-N"><span itemprop="name">Al</span></a>        </span>
        <br>

        <span class="karma">20.4k</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><a name="C27393" href="#C27393">
                <time itemprop="dateCreated" datetime="2015-12-07T13:09:09-07:00" class="action-date">Dec '15</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>I have tried this <code>$this-&gt;session-&gt;set($this-&gt;security-&gt;getTokenKey(), $this-&gt;security-&gt;getToken());</code> but it doesn't work.</p></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="27393" data-cf-modified-6ddbfecba155482d5017a387-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="27393" data-cf-modified-6ddbfecba155482d5017a387-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
    </div>
</div>
<div itemprop="suggestedAnswer" itemscope itemtype="https://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img src="https://secure.gravatar.com/avatar/5915f25e654c4f9e60fe51700cdee683?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="https://schema.org/Person">
            <a href="/user/4769/Izopi4a" class="user-moderator-Y"><span itemprop="name">Izo</span></a>        </span>
        <br>

        <span class="karma">85.5k</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><a name="C27397" href="#C27397">
                <time itemprop="dateCreated" datetime="2015-12-07T15:05:10-07:00" class="action-date">Dec '15</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>can you check if this helps you <a href="https://forum.phalcon.io/discussion/8093/csrf-problems-on-206">https://forum.phalcon.io/discussion/8093/csrf-problems-on-206</a></p></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="27397" data-cf-modified-6ddbfecba155482d5017a387-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="27397" data-cf-modified-6ddbfecba155482d5017a387-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span><span itemprop="upvoteCount">1</span></a></div>
    </div>
</div>
<div itemprop="suggestedAnswer" itemscope itemtype="https://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img src="https://secure.gravatar.com/avatar/ff9a2f43efac70da87e23ddd6ac5061f?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="https://schema.org/Person">
            <a href="/user/1663/al35mm" class="user-moderator-N"><span itemprop="name">Al</span></a>        </span>
        <br>

        <span class="karma">20.4k</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><a name="C27407" href="#C27407">
                <time itemprop="dateCreated" datetime="2015-12-07T18:18:24-07:00" class="action-date">Dec '15</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>Thanks, that is interesting and may well come in handy, but it's not quite what I'm after. I'm now having problems trying to get CSRF working at all in 2.0.9 with my ajax form. I was sure it worked earlier although I hadn't fully tested it then. </p>
<p>That kind of takes me back to my original question on how to manually set the CSRF session. I would like to know more about how the CSRF system actually works. The reason CSRF is failing on my form at the moment seems to be because the CSRF session is not getting set, but the key and token are being generated in the form. If I call <code>getSessionToken ()</code> and display it in my error output, nothing is displayed. I have CSRF working in non ajax forms, and sessions are enabled and working.</p></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="27407" data-cf-modified-6ddbfecba155482d5017a387-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="27407" data-cf-modified-6ddbfecba155482d5017a387-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
    </div>
</div>
<div itemprop="suggestedAnswer" itemscope itemtype="https://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img src="https://secure.gravatar.com/avatar/5915f25e654c4f9e60fe51700cdee683?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="https://schema.org/Person">
            <a href="/user/4769/Izopi4a" class="user-moderator-Y"><span itemprop="name">Izo</span></a>        </span>
        <br>

        <span class="karma">85.5k</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><a name="C27425" href="#C27425">
                <time itemprop="dateCreated" datetime="2015-12-08T04:55:03-07:00" class="action-date">Dec '15</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>for me , in 2.1.x csrf doesn't work at all</p>
<p><a href="https://github.com/phalcon/cphalcon/issues/11009">https://github.com/phalcon/cphalcon/issues/11009</a></p>
<p>hopefully someone else can help you</p></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="27425" data-cf-modified-6ddbfecba155482d5017a387-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="27425" data-cf-modified-6ddbfecba155482d5017a387-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
    </div>
</div>
<div itemprop="suggestedAnswer" itemscope itemtype="https://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img src="https://secure.gravatar.com/avatar/ff9a2f43efac70da87e23ddd6ac5061f?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="https://schema.org/Person">
            <a href="/user/1663/al35mm" class="user-moderator-N"><span itemprop="name">Al</span></a>        </span>
        <br>

        <span class="karma">20.4k</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><a name="C27549" href="#C27549">
                <time itemprop="dateCreated" datetime="2015-12-12T07:59:31-07:00" class="action-date">Dec '15</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>In the end I have made my own CSRF system which turned out to be quite quick and easy and it doesn't suffer from the issues of the built in one. Mine uses a single  cookie with a default expirey which can be overridden when called in a form. <code>{% raw %}{{{% endraw %} csrfField() {% raw %}}}{% endraw %}</code> sets the hidden field and the cookie. The cookie is valid for all forms on the site, so if someone has multiple forms open in multiple tabs, they wont have issues. For ajax form submission, it is also possible to set a new cookie and return a new csrf field with the error in the form. So the user can just resubmit with out refreshing and loosing their content.</p>
<pre><code>/**
 * Generate the CSRF stamp (name) and token in the cookie &amp; field
 */
public static function csrfField($expire = 60) {
    $csrf = \Phalcon\DI::getDefault()-&gt;getShared('cookies')-&gt;get('csrf');
    $exp = explode('|', $csrf);
    if (ISSET($exp[0]) &amp;&amp; ISSET($exp[1])) {
        $stamp = $exp[0];
        $hash = $exp[1];
        return '&lt;input type="hidden" name="' . $stamp . '" value="' . $hash . '"&gt;';
    } else {
        $seed = mt_rand(1000, mt_getrandmax());
        $hash = md5($seed);
        $stamp = time();
        \Phalcon\DI::getDefault()-&gt;getShared('cookies')-&gt;set('csrf', $stamp . '|' . $hash, time() + ($expire * 60));
        if(\Phalcon\DI::getDefault()-&gt;getShared('cookies')-&gt;get('csrf')) {
            return '&lt;input type="hidden" name="' . $stamp . '" value="' . $hash . '"&gt;';
        }
    }
}

/**
 * Check the CSRF tocken
 * @return bool
 */
public static function csrfCheck() {
    $csrf = \Phalcon\DI::getDefault()-&gt;getShared('cookies')-&gt;get('csrf');
    $exp = explode('|', $csrf);
        if (ISSET($exp[0]) &amp;&amp; ISSET($exp[1])) {
            $stamp = $exp[0];
            $token = $exp[1];
            $str = \Phalcon\DI::getDefault()-&gt;getShared('request')-&gt;getPost("$stamp");
            if ($str === $token) {
                return TRUE;
            }
        }
    return FALSE;
}</code></pre></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="27549" data-cf-modified-6ddbfecba155482d5017a387-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="27549" data-cf-modified-6ddbfecba155482d5017a387-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
    </div>
</div>
<div class="row"><div class="col-md-1 small" align="center"></div>
        <div class="col-md-11 login-comment">
            
        </div></div>
</div><input type="hidden" id="post-id" name="post-id" value="9769" /><div id="suggested-posts"></div>
    <div id="sticky-progress" style='display:none'></div>
</div>
    </div>