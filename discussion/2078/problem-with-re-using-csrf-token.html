---
layout: default
title: 'Problem with Re-using CSRF Token - Discussion'
---

    <div class="container">
        {% include warning.html %}


<div itemscope itemtype="http://schema.org/Question"><ol class="breadcrumb">
    <li><a href="/">Home</a></li>
    <li><a href="/category/16/security">Security</a></li>
</ol>
<div class="row table-title">
    <div class="col-lg-8 col-md-7 col-sm-6 col-xs-12 wrapper-author">
        <h1 class="" itemprop="name">Problem with Re-using CSRF Token</h1>
        <div class="visible-xs-block mobile-author">
            <span itemprop="author" itemscope itemtype="http://schema.org/Person"><a href="/user/940/jymboche" class="user-moderator-N"><span itemprop="name">jymboche</span></a></span>
            <time itemprop="dateCreated" datetime="2014-04-14T09:44:32-07:00">Apr '14</time>
        </div>
    </div>
    <div class="col-lg-4 col-md-5 col-sm-6 hidden-xs text-right wrapper-stats">
        <table class="table-stats" width="100%">
            <tr style="vertical-align: top;">
                <td>
                    <label>Created</label><br>
                    <time itemprop="dateCreated" datetime="2014-04-14T09:44:32-07:00">Apr '14</time>
                </td>
                <td>
                    <label>Last Reply</label><br>Jun '14</td>
                <td>
                    <label>Replies</label><br>
                    <span itemprop="answerCount">5</span>
                </td>
                <td>
                    <label>Views</label><br>3681</td>
                <td>
                    <label>Votes</label><br>
                    <span itemprop="upvoteCount">0</span>
                </td>
            </tr>
        </table>
    </div>
</div>
<div class="discussion">
        <div class="row reply-block">
            <div class="col-md-1 col-sm-1 hidden-xs text-center">
                <img src="https://secure.gravatar.com/avatar/1fcf827b80188a603d1a52b9c8f8c859?s=48&amp;r=pg&amp;d=identicon" class="img-rounded avatar" /><br>
                <span itemprop="author" itemscope itemtype="http://schema.org/Person" class="avatar-name"><a href="/user/940/jymboche" class="user-moderator-N"><span itemprop="name">jymboche</span></a></span>
                <span class="karma">16.2k</span>
            </div>
            <div class="col-md-11 col-sm-11 col-xs-12 post-body"><div class="posts-date hidden-xs" align="right">
        <a name="C2078" href="#C2078">
        <time class="action-date">Apr '14</time>
    </a>
</div>
<div class="post-content"><div><p>So, I've never done any web penetration testing and consequently don't know enough about web-security. However I do know about UX and am struggling to create a nice user experience when csrf tokens are re-gerneated each request.</p>
<p>When a user has multiple tabs open and is working in both of them, the security tokens will be invalid when switching. How could you get around this? Also, what do you do when a user hits reload on a form? Do you throw exception or redirect to the form page and re-populate the fields?</p></div>                </div>

                <div class="posts-buttons text-right"><a href="#"  class="btn btn-danger btn-xs" data-cf-modified-bf5ee26fb1ec2d5ac5672d3f-="">
        <span class="glyphicon glyphicon-thumbs-down"></span></a>
    <a href="#"  class="btn btn-success btn-xs" data-cf-modified-bf5ee26fb1ec2d5ac5672d3f-="">
        <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
            </div>
        </div><div itemprop="suggestedAnswer" itemscope itemtype="http://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img src="https://secure.gravatar.com/avatar/ed757d00d1f18f7773ce133e67e43d43?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="http://schema.org/Person">
            <a href="/user/1151/Honzaik" class="user-moderator-N"><span itemprop="name">honzaik</span></a>        </span>
        <br>

        <span class="karma">9.4k</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><span class="action-date action-reply-edit" data-id="7202" data-toggle="modal" data-target="#historyModal">
                edited <span>Apr '14</span>
              </span><br/><a name="C7202" href="#C7202">
                <time itemprop="dateCreated" datetime="2014-04-14T11:32:23-07:00" class="action-date">Apr '14</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>ive done it like this </p>
<pre><code>if($this-&gt;security-&gt;getSessionToken() == "") $this-&gt;view-&gt;token = $this-&gt;security-&gt;getToken();
else $this-&gt;view-&gt;token = $this-&gt;security-&gt;getSessionToken();</code></pre>
<p>getSessionToken returns already set token for a session but getToken generates new one and &quot;sticks&quot; it to the session. Please correct me if this is wrong or can be done better</p></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="7202" data-cf-modified-bf5ee26fb1ec2d5ac5672d3f-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="7202" data-cf-modified-bf5ee26fb1ec2d5ac5672d3f-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
    </div>
</div>
<div itemprop="suggestedAnswer acceptedAnswer" itemscope itemtype="http://schema.org/Answer" class="reply-block row reply-accepted">
    <div class="col-md-1 small" align="center">
        <img src="https://secure.gravatar.com/avatar/24e438429d975d345e4f99e53b740150?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="http://schema.org/Person">
            <a href="/user/1487/Conradaek" class="user-moderator-N"><span itemprop="name">Conradaek</span></a>        </span>
        <br>

        <span class="karma">26.3k</span><div class="accepted-reply">
                <span class="glyphicon glyphicon-ok"></span>
                Accepted<br>answer
            </div></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><a name="C7279" href="#C7279">
                <time itemprop="dateCreated" datetime="2014-04-16T10:20:42-07:00" class="action-date">Apr '14</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p><a href="https://forum.phalcon.io/user/0/jymboche">@jymboche</a></p>
<p>This is my suggestion how to handle problem of multitabs working.</p>
<ol>
<li>Make an hidden input element in your form. It will have token as a value.</li>
<li>When generating formular put the token into session. But store it in an array.</li>
<li>Let's say user has opened 5 new tabs. You will now have 6 diffirent tokens in the array in your session.</li>
<li>When one of the form is sent, a script obtaint a token from the hidden and checks whether there is such token in the array.</li>
<li>If the token exists it means the form is valid. Delete token from the session in order not to be used again.</li>
</ol>
<p>What do you think? Maybe found better solution/</p>
<p>For the second problem (reloading page) i have not solution yet. Do you mean that the user have sent the same formular twice? Or do you mean that the user have by mistake reloaded half-filled formular and what to do not to loose his data?</p></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="7279" data-cf-modified-bf5ee26fb1ec2d5ac5672d3f-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="7279" data-cf-modified-bf5ee26fb1ec2d5ac5672d3f-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
    </div>
</div>
<div itemprop="suggestedAnswer" itemscope itemtype="http://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img src="https://secure.gravatar.com/avatar/1fcf827b80188a603d1a52b9c8f8c859?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="http://schema.org/Person">
            <a href="/user/940/jymboche" class="user-moderator-N"><span itemprop="name">jymboche</span></a>        </span>
        <br>

        <span class="karma">16.2k</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><a name="C7281" href="#C7281">
                <time itemprop="dateCreated" datetime="2014-04-16T14:48:49-07:00" class="action-date">Apr '14</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p><a href="https://forum.phalcon.io/user/0/Conradaek">@Conradaek</a></p>
<p>Thanks for the input. I like your idea. Do you think its necessary to have both a token key and a token stored? I see a lot of people just using token.</p>
<p>In regard to the form reload problem, after thinking about it I dont think its something my end users would encounter anyway. Its mostly just something that affects me during development. I fill out a (long) form, I hit submit, but If I have an error in my controller method, I fix it and hit reload, but my token has expired, so I hit back and my long form has lost its values.</p>
<p>I usually throw an http exception if a token is invalid, like a 403 usually. Is that what others do?</p></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="7281" data-cf-modified-bf5ee26fb1ec2d5ac5672d3f-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="7281" data-cf-modified-bf5ee26fb1ec2d5ac5672d3f-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
    </div>
</div>
<div itemprop="suggestedAnswer" itemscope itemtype="http://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img src="https://secure.gravatar.com/avatar/24e438429d975d345e4f99e53b740150?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="http://schema.org/Person">
            <a href="/user/1487/Conradaek" class="user-moderator-N"><span itemprop="name">Conradaek</span></a>        </span>
        <br>

        <span class="karma">26.3k</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><a name="C7293" href="#C7293">
                <time itemprop="dateCreated" datetime="2014-04-17T04:15:22-07:00" class="action-date">Apr '14</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><blockquote>
<p>Do you think its necessary to have both a token key and a token stored? I see a lot of people just using token.</p>
</blockquote>
<p>I think it is enough if you use only token but I may be wrong. Using both tokens and token-keys is definietly NOT less secure than using tokens only :)</p></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="7293" data-cf-modified-bf5ee26fb1ec2d5ac5672d3f-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="7293" data-cf-modified-bf5ee26fb1ec2d5ac5672d3f-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
    </div>
</div>
<div itemprop="suggestedAnswer" itemscope itemtype="http://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img src="https://secure.gravatar.com/avatar/24e438429d975d345e4f99e53b740150?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="http://schema.org/Person">
            <a href="/user/1487/Conradaek" class="user-moderator-N"><span itemprop="name">Conradaek</span></a>        </span>
        <br>

        <span class="karma">26.3k</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><a name="C8646" href="#C8646">
                <time itemprop="dateCreated" datetime="2014-06-14T13:23:53-07:00" class="action-date">Jun '14</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>Hi! I have read some articles about the topic. </p>
<p>I was completely WRONG with my suggestion before. Huge sorry to everyone who took my advice : / I had no fully understanding of the CSRF issues. </p>
<p><strong>So, what we really need to have a secure protection against CSRF attack is only to generate ONE token and use it for ENTIRE session.</strong></p>
<ol>
<li>You simply generate the token when user logs in to the application and store it in <code>$_SESSION</code>. </li>
<li>It does NOT matter how many tabs/forms the user have opened.</li>
<li>In each form you put hidden element with the same token. </li>
<li>Each time one of the forms is being sent you compare the token from hidden element to the token in session. If they match eachother you process the form.</li>
</ol>
<p>DRY and KISS and so on:) </p>
<p><strong>So Phalcon <code>Security</code> solution has completely no affect to user experience! ;)</strong></p>
<p>Some post from stackoverflow I have read:</p>
<ol>
<li><a href="http://stackoverflow.com/questions/20057225/csrf-token-collisions-with-multiple-tabs"><a href="http://stackoverflow.com/questions/20057225/csrf-token-collisions-with-multiple-tabs">http://stackoverflow.com/questions/20057225/csrf-token-collisions-with-multiple-tabs</a></a></li>
<li><a href="http://stackoverflow.com/questions/15829977/too-many-csrf-tokens-generated-php-how-do-i-deal-with-them?rq=1"><a href="http://stackoverflow.com/questions/15829977/too-many-csrf-tokens-generated-php-how-do-i-deal-with-them?rq=1">http://stackoverflow.com/questions/15829977/too-many-csrf-tokens-generated-php-how-do-i-deal-with-them?rq=1</a></a></li>
<li><a href="http://stackoverflow.com/questions/10466241/new-csrf-token-per-request-or-not"><a href="http://stackoverflow.com/questions/10466241/new-csrf-token-per-request-or-not">http://stackoverflow.com/questions/10466241/new-csrf-token-per-request-or-not</a></a></li>
<li><a href="http://stackoverflow.com/questions/20587746/one-token-vs-multiple-tokens-to-prevent-csrf-attacks"><a href="http://stackoverflow.com/questions/20587746/one-token-vs-multiple-tokens-to-prevent-csrf-attacks">http://stackoverflow.com/questions/20587746/one-token-vs-multiple-tokens-to-prevent-csrf-attacks</a></a></li>
<li><a href="http://stackoverflow.com/questions/6724365/csrf-protection-question?rq=1"><a href="http://stackoverflow.com/questions/6724365/csrf-protection-question?rq=1">http://stackoverflow.com/questions/6724365/csrf-protection-question?rq=1</a></a></li>
<li><a href="http://stackoverflow.com/questions/6929449/are-we-really-secured-from-csrf?rq=1"><a href="http://stackoverflow.com/questions/6929449/are-we-really-secured-from-csrf?rq=1">http://stackoverflow.com/questions/6929449/are-we-really-secured-from-csrf?rq=1</a></a></li>
</ol>
<p>A quatation from official OWASP document:</p>
<blockquote>
<p>In general, <strong>developers need only generate this token once for the current session. After initial generation of this token, the value is stored in the session and is utilized for each subsequent request until the session expires</strong>. When a request is issued by the end-user, the server-side component must verify the existence and validity of the token in the request as compared to the token found in the session. If the token was not found within the request or the value provided does not match the value within the session, then the request should be aborted, token should be reset and the event logged as a potential CSRF attack in progress.</p>
<p><strong>To further enhance the security of this proposed design, consider randomizing the CSRF token parameter name and or value for each request.</strong> Implementing this approach results in the generation of per-request tokens as opposed to per-session tokens. <strong>Note, however, that this may result in usability concerns.</strong> For example, the &quot;Back&quot; button browser capability is often hindered as the previous page may contain a token that is no longer valid. Interaction with this previous page will result in a CSRF false positive security event at the server. Regardless of the approach taken, developers are encouraged to protect the CSRF token the same way they protect authenticated session identifiers, such as the use of SSLv3/TLS.</p>
</blockquote>
<p>Source: <a href="https://www.owasp.org/index.php/Cross-Site_Request_Forgery_%28CSRF%29_Prevention_Cheat_Sheet#General_Recommendation:_Synchronizer_Token_Pattern"><a href="https://www.owasp.org/index.php/Cross-Site_Request_Forgery_%28CSRF%29_Prevention_Cheat_Sheet#General_Recommendation:_Synchronizer_Token_Pattern">https://www.owasp.org/index.php/Cross-Site_Request_Forgery_%28CSRF%29_Prevention_Cheat_Sheet#General_Recommendation:_Synchronizer_Token_Pattern</a></a></p></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="8646" data-cf-modified-bf5ee26fb1ec2d5ac5672d3f-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="8646" data-cf-modified-bf5ee26fb1ec2d5ac5672d3f-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
    </div>
</div>
<div itemprop="suggestedAnswer" itemscope itemtype="http://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img src="https://secure.gravatar.com/avatar/1fcf827b80188a603d1a52b9c8f8c859?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="http://schema.org/Person">
            <a href="/user/940/jymboche" class="user-moderator-N"><span itemprop="name">jymboche</span></a>        </span>
        <br>

        <span class="karma">16.2k</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><a name="C8649" href="#C8649">
                <time itemprop="dateCreated" datetime="2014-06-14T15:04:48-07:00" class="action-date">Jun '14</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p><a href="https://forum.phalcon.io/user/0/Conradaek">@Conradaek</a>
I tend to agree and have read most of those articles and OWASP many times.... I do one extra step though. I have a session token unique to users, and in my forms I generate a form token. The form token is a hash generated based on user data and the specific form, so storing in session isnt even needed. It also has an expiration built into the hash.</p>
<p>I think the argument for having per-request tokens isn't justified. The method used to get the token (like an XSS vulnerability) makes getting the token trivial in any case, per-request or per-session.</p>
<p>Just my two-cents.</p></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="8649" data-cf-modified-bf5ee26fb1ec2d5ac5672d3f-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="8649" data-cf-modified-bf5ee26fb1ec2d5ac5672d3f-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
    </div>
</div>
<div itemprop="suggestedAnswer" itemscope itemtype="http://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img src="https://secure.gravatar.com/avatar/24e438429d975d345e4f99e53b740150?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="http://schema.org/Person">
            <a href="/user/1487/Conradaek" class="user-moderator-N"><span itemprop="name">Conradaek</span></a>        </span>
        <br>

        <span class="karma">26.3k</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><a name="C8655" href="#C8655">
                <time itemprop="dateCreated" datetime="2014-06-15T03:35:44-07:00" class="action-date">Jun '14</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p><a href="https://forum.phalcon.io/user/0/jymboche">@jymboche</a>, does your token change between sessions? I mean a token for specific user and specific form.</p></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="8655" data-cf-modified-bf5ee26fb1ec2d5ac5672d3f-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="8655" data-cf-modified-bf5ee26fb1ec2d5ac5672d3f-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
    </div>
</div>
<div itemprop="suggestedAnswer" itemscope itemtype="http://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img src="https://secure.gravatar.com/avatar/1fcf827b80188a603d1a52b9c8f8c859?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="http://schema.org/Person">
            <a href="/user/940/jymboche" class="user-moderator-N"><span itemprop="name">jymboche</span></a>        </span>
        <br>

        <span class="karma">16.2k</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><a name="C8685" href="#C8685">
                <time itemprop="dateCreated" datetime="2014-06-15T16:11:50-07:00" class="action-date">Jun '14</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>Well I have two tokens. A hash generated when the user logs in (stays the same for life of session), and one for forms. The form token is generated every request since it uses a timestamp in the hash. But since the timestamp and timeout are included with the hash, I can check if the hash is valid. Some people suggests storing tokens in session, and removing them or expiring them as they are used. This method is similar but doesn't require storing lots of tokens in session. All the info is encapsulated in the token itself. The idea came from this article:
<a href="https://josephscott.org/archives/2013/08/better-stateless-csrf-tokens/">https://josephscott.org/archives/2013/08/better-stateless-csrf-tokens/</a></p>
<p>Heres a code sample. getUserKey() returns unique user data from database/session and hash() is just a generic modern hash method:</p>
<pre><code class="language-php">    public function getFormToken($str = "", $timeout = 900)
    {
        $hash_time = microtime(true);
        $key = $this-&gt;getUserKey();
        $toHash = $str . $hash_time . $timeout . $key;
        $hash = $this-&gt;hash($toHash);

        return "{$hash}-{$hash_time}-{$timeout}";
    }

    public function verifyFormToken($str = "", $token = "")
    {
        list($hash, $hash_time, $timeout) = explode("-", $token);

        if(empty($hash) || empty($hash_time) || empty($timeout)) {
            return false;
        }

        if( microtime(true) &gt; $hash_time + $timeout) {
            return false;
        }

        $key = $this-&gt;getUserKey();
        $checkString = $str . $hash_time . $timeout . $key;
        $checkHash = $this-&gt;hash($checkString);
        if($checkHash === $hash) {
            return true;
        }

        return false;
    }</code></pre></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="8685" data-cf-modified-bf5ee26fb1ec2d5ac5672d3f-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="8685" data-cf-modified-bf5ee26fb1ec2d5ac5672d3f-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
    </div>
</div>
<div class="row"><div class="col-md-1 small" align="center"></div>
        <div class="col-md-11 login-comment">
            
        </div></div>
</div><input type="hidden" id="post-id" name="post-id" value="2078" /><div id="suggested-posts"></div>
    <div id="sticky-progress" style='display:none'></div>
</div>
    </div>