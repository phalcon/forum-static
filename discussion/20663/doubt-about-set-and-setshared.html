---
layout: default
title: 'Doubt about set and setshared - Discussion'
---

    <div class="container">
        {% include warning.html %}


<div itemscope itemtype="http://schema.org/Question"><ol class="breadcrumb">
    <li><a href="/">Home</a></li>
    <li><a href="/category/10/di-ioc">DI/IoC</a></li>
</ol>
<div class="row table-title">
    <div class="col-lg-8 col-md-7 col-sm-6 col-xs-12 wrapper-author">
        <h1 class="" itemprop="name">Doubt about set and setshared</h1>
        <div class="visible-xs-block mobile-author">
            <span itemprop="author" itemscope itemtype="http://schema.org/Person"><a href="/user/12109/davidcm86" class="user-moderator-N"><span itemprop="name">David</span></a></span>
            <time itemprop="dateCreated" datetime="2020-05-31T02:39:51-07:00">May '20</time>
        </div>
    </div>
    <div class="col-lg-4 col-md-5 col-sm-6 hidden-xs text-right wrapper-stats">
        <table class="table-stats" width="100%">
            <tr style="vertical-align: top;">
                <td>
                    <label>Created</label><br>
                    <time itemprop="dateCreated" datetime="2020-05-31T02:39:51-07:00">May '20</time>
                </td>
                <td>
                    <label>Last Reply</label><br>Aug '20</td>
                <td>
                    <label>Replies</label><br>
                    <span itemprop="answerCount">5</span>
                </td>
                <td>
                    <label>Views</label><br>214</td>
                <td>
                    <label>Votes</label><br>
                    <span itemprop="upvoteCount">0</span>
                </td>
            </tr>
        </table>
    </div>
</div>
<div class="discussion">
        <div class="row reply-block">
            <div class="col-md-1 col-sm-1 hidden-xs text-center">
                <img src="https://secure.gravatar.com/avatar/1e84b9d35010e783cba59eb03d16c506?s=48&amp;r=pg&amp;d=identicon" class="img-rounded avatar" /><br>
                <span itemprop="author" itemscope itemtype="http://schema.org/Person" class="avatar-name"><a href="/user/12109/davidcm86" class="user-moderator-N"><span itemprop="name">David</span></a></span>
                <span class="karma">3.1k</span>
            </div>
            <div class="col-md-11 col-sm-11 col-xs-12 post-body"><div class="posts-date hidden-xs" align="right">
        <a name="C20663" href="#C20663">
        <time class="action-date">May '20</time>
    </a>
</div>
<div class="post-content"><div><p>Hello,</p>
<p>I know diference <a href="https://forum.phalcon.io/discussion/14695/what-is-the-difference-between-setshared-and-set">between both</a>,  I try instance a class from service.php with set and setShared and works ok but i want to check singleton with setshared, so if I call my class with setshared and i put a log into constructor I supuse i see this log the first time that I call this class, but not happen, because i see all the time this log into constructor as same with set(with set shall be normal)</p>
<p>Is this beahevior normal?</p></div>                </div>

                <div class="posts-buttons text-right"><a href="#"  class="btn btn-danger btn-xs" data-cf-modified-04c52a4c4e26e70cc129c6bc-="">
        <span class="glyphicon glyphicon-thumbs-down"></span></a>
    <a href="#"  class="btn btn-success btn-xs" data-cf-modified-04c52a4c4e26e70cc129c6bc-="">
        <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
            </div>
        </div><div itemprop="suggestedAnswer" itemscope itemtype="http://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img src="https://secure.gravatar.com/avatar/746a625a9264a203a6ddf711e0c6b120?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="http://schema.org/Person">
            <a href="/user/301/quasipickle" class="user-moderator-Y"><span itemprop="name">Dylan Anderson</span></a>        </span>
        <br>

        <span class="karma">125.7k</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><a name="C63275" href="#C63275">
                <time itemprop="dateCreated" datetime="2020-06-01T14:44:06-07:00" class="action-date">Jun '20</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>I think you're using <code>get()</code> instead of <code>getShared()</code></p>
<p>I wrote this test script:</p>
<pre><code class="language-php">$DI = new \Phalcon\DI\FactoryDefault();

$DI-&gt;set('multi',function(){
    echo 'calling multi function&lt;br /&gt;';
});
$DI-&gt;setShared('singleton',function(){
    echo 'calling singleton function&lt;br /&gt;';
});
$DI-&gt;setShared('singletonshared',function(){
    echo 'calling singletonshared function&lt;br /&gt;';
});

$DI-&gt;get('multi');
$DI-&gt;get('multi');
$DI-&gt;get('singleton');
$DI-&gt;get('singleton');
$DI-&gt;getShared('singletonshared');
$DI-&gt;getShared('singletonshared');</code></pre>
<p>and got this output</p>
<pre><code>calling multi function
calling multi function
calling singleton function
calling singleton function
calling singletonshared function</code></pre>
<p>I see in the documentation that it says just setting with <code>setShared()</code> is enough to make it singleton, but that would seem to not be the case.  Using <code>getShared()</code> should work.</p></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="63275" data-cf-modified-04c52a4c4e26e70cc129c6bc-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="63275" data-cf-modified-04c52a4c4e26e70cc129c6bc-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
    </div>
</div>
<div itemprop="suggestedAnswer" itemscope itemtype="http://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img src="https://secure.gravatar.com/avatar/746a625a9264a203a6ddf711e0c6b120?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="http://schema.org/Person">
            <a href="/user/301/quasipickle" class="user-moderator-Y"><span itemprop="name">Dylan Anderson</span></a>        </span>
        <br>

        <span class="karma">125.7k</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><span class="action-date action-reply-edit" data-id="63277" data-toggle="modal" data-target="#historyModal">
                edited <span>Jun '20</span>
              </span><br/><a name="C63277" href="#C63277">
                <time itemprop="dateCreated" datetime="2020-06-01T15:04:22-07:00" class="action-date">Jun '20</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>Ok, I built a little more robust script:</p>
<pre><code class="language-php">$DI = new \Phalcon\DI\FactoryDefault();

$DI-&gt;set('multi',function(){
    return (object)['name'=&gt;'multi','time'=&gt;microtime(TRUE)];
});
$DI-&gt;setShared('singleton',function(){
    return (object)['name'=&gt;'singleton','time'=&gt;microtime(TRUE)];
});
$DI-&gt;setShared('shared',function(){
    return (object)['name'=&gt;'shared','time'=&gt;microtime(TRUE)];
});

echo '&lt;pre&gt;';
print_r($DI-&gt;get('multi'));
usleep(1000);
print_r($DI-&gt;get('multi'));
usleep(1000);
print_r($DI-&gt;get('singleton'));
usleep(1000);
print_r($DI-&gt;get('singleton'));
usleep(1000);
print_r($DI-&gt;getSingleton());
usleep(1000);
print_r($DI-&gt;getShared('shared'));
usleep(1000);
print_r($DI-&gt;getShared('shared'));
echo '&lt;/pre&gt;';</code></pre>
<p>And got this output:</p>
<pre><code>stdClass Object
(
    [name] =&gt; multi
    [time] =&gt; 1591049103.716
)
stdClass Object
(
    [name] =&gt; multi
    [time] =&gt; 1591049103.7171
)
stdClass Object
(
    [name] =&gt; singleton
    [time] =&gt; 1591049103.7182
)
stdClass Object
(
    [name] =&gt; singleton
    [time] =&gt; 1591049103.7182
)
stdClass Object
(
    [name] =&gt; singleton
    [time] =&gt; 1591049103.7182
)
stdClass Object
(
    [name] =&gt; shared
    [time] =&gt; 1591049103.7214
)
stdClass Object
(
    [name] =&gt; shared
    [time] =&gt; 1591049103.7214
)</code></pre>
<p>As you can see, the timestamps on the second invocation of both the <code>singleton</code> and <code>shared</code> service don't change, showing that the service creation function isn't being called on subsequent calls to <code>get()</code>.  </p>
<p>The important difference between my first and second script is the second script returns an object from the creation function.  Phalcon must store that internally - thus if a creation function doesn't return an object, there's nothing to store, so Phalcon calls the function again on subsequent calls to <code>get()</code></p>
<p>Could you post the code that registers the service and the test code you've written?</p></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="63277" data-cf-modified-04c52a4c4e26e70cc129c6bc-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="63277" data-cf-modified-04c52a4c4e26e70cc129c6bc-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
    </div>
</div>
<div itemprop="suggestedAnswer" itemscope itemtype="http://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img src="https://secure.gravatar.com/avatar/1e84b9d35010e783cba59eb03d16c506?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="http://schema.org/Person">
            <a href="/user/12109/davidcm86" class="user-moderator-N"><span itemprop="name">David</span></a>        </span>
        <br>

        <span class="karma">3.1k</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><span class="action-date action-reply-edit" data-id="63335" data-toggle="modal" data-target="#historyModal">
                edited <span>Jun '20</span>
              </span><br/><a name="C63335" href="#C63335">
                <time itemprop="dateCreated" datetime="2020-06-04T12:23:51-07:00" class="action-date">Jun '20</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>Ok, i see it ok, but not in my example, maybe I am wrong.</p>
<p>My Class:</p>
<pre><code class="language-php">&lt;?php
namespace Something\Classes;
use Something\Classes\HelloClass;

class HelloClass {
    public function __construct() {
        $this-&gt;logger = new \Phalcon\Logger\Adapter\File(BASE_PATH . '/tmp/logs/error.log');
        $this-&gt;logger-&gt;info('__construct');
    }

    public function setName($name) {
        $this-&gt;logger-&gt;info('name: ' . $name);
    }
}
</code></pre>
<p>My services.php</p>
<pre><code class="language-php">use Something\Classes\HelloClass;
$di-&gt;setShared('HelloClass', function () {
    return new HelloClass();
});</code></pre>
<p>My Controller where I instance again HelloClass.php</p>
<pre><code class="language-php">&lt;?php

namespace Something\Controllers;

use Something\Classes\HelloClass;

class IndexController extends ControllerBase
{
    public function indexAction()
    {
        $helloClass = new HelloClass();
        $this-&gt;HelloClass-&gt;setName('David');
    }   
}</code></pre>
<p>Output:
_construct
_construct
name: David</p></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="63335" data-cf-modified-04c52a4c4e26e70cc129c6bc-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="63335" data-cf-modified-04c52a4c4e26e70cc129c6bc-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
    </div>
</div>
<div itemprop="suggestedAnswer acceptedAnswer" itemscope itemtype="http://schema.org/Answer" class="reply-block row reply-accepted">
    <div class="col-md-1 small" align="center">
        <img src="https://secure.gravatar.com/avatar/746a625a9264a203a6ddf711e0c6b120?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="http://schema.org/Person">
            <a href="/user/301/quasipickle" class="user-moderator-Y"><span itemprop="name">Dylan Anderson</span></a>        </span>
        <br>

        <span class="karma">125.7k</span><div class="accepted-reply">
                <span class="glyphicon glyphicon-ok"></span>
                Accepted<br>answer
            </div></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><span class="action-date action-reply-edit" data-id="63339" data-toggle="modal" data-target="#historyModal">
                edited <span>Jun '20</span>
              </span><br/><a name="C63339" href="#C63339">
                <time itemprop="dateCreated" datetime="2020-06-04T12:35:27-07:00" class="action-date">Jun '20</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>That makes sense.  You're calling the constructor twice.</p>
<p>The first time you're calling the constructor is in the controller:</p>
<pre><code class="language-php">$helloClass = new HelloClass();</code></pre>
<p>The second time you're calling the constructor is in the function you've set as the service, which is only run when you ask for the service.</p>
<p>There's a couple things to note:</p>
<ol>
<li>Creating a new object from the class has nothing to do with the service of the same name.  They're completely different.</li>
<li>The DI does lazy loading, so the anonymous function you assigned to the <code>HelloClass</code>service isn't run until you ask for the service with <code>$this-&gt;HelloClass</code></li>
</ol>
<p>If you add another line below that:</p>
<pre><code class="language-php">$this-&gt;HelloClass-&gt;setName('James');</code></pre>
<p>Your output will be </p>
<pre><code>__construct 
__construct 
name: David
name: James</code></pre></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="63339" data-cf-modified-04c52a4c4e26e70cc129c6bc-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="63339" data-cf-modified-04c52a4c4e26e70cc129c6bc-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span><span itemprop="upvoteCount">1</span></a></div>
    </div>
</div>
<div itemprop="suggestedAnswer" itemscope itemtype="http://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img src="https://secure.gravatar.com/avatar/1e84b9d35010e783cba59eb03d16c506?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="http://schema.org/Person">
            <a href="/user/12109/davidcm86" class="user-moderator-N"><span itemprop="name">David</span></a>        </span>
        <br>

        <span class="karma">3.1k</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><a name="C63345" href="#C63345">
                <time itemprop="dateCreated" datetime="2020-06-04T13:19:39-07:00" class="action-date">Jun '20</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>You right Dylan, tnahk you for you support in this forum.
Regards.</p></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="63345" data-cf-modified-04c52a4c4e26e70cc129c6bc-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="63345" data-cf-modified-04c52a4c4e26e70cc129c6bc-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
    </div>
</div>
<div itemprop="suggestedAnswer" itemscope itemtype="http://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img src="https://secure.gravatar.com/avatar/746a625a9264a203a6ddf711e0c6b120?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="http://schema.org/Person">
            <a href="/user/301/quasipickle" class="user-moderator-Y"><span itemprop="name">Dylan Anderson</span></a>        </span>
        <br>

        <span class="karma">125.7k</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><a name="C63347" href="#C63347">
                <time itemprop="dateCreated" datetime="2020-06-04T13:21:56-07:00" class="action-date">Jun '20</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>Glad to help.  Please Accept my answer to mark the thread as &quot;[Solved]&quot;.</p></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="63347" data-cf-modified-04c52a4c4e26e70cc129c6bc-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="63347" data-cf-modified-04c52a4c4e26e70cc129c6bc-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
    </div>
</div>
<div itemprop="suggestedAnswer" itemscope itemtype="http://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img src="https://secure.gravatar.com/avatar/d05e888e4723c6a49b2ece95d624975f?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="http://schema.org/Person">
            <a href="/user/14109/AngelinaFloyd" class="user-moderator-N"><span itemprop="name">AngelinaFloyd</span></a>        </span>
        <br>

        <span class="karma">72</span></div>
    <div class="col-md-11"><div class="in-reply-to">
                    <a href="#C63277"><span class="glyphicon glyphicon-chevron-up"></span> in reply to
                        <img src="https://secure.gravatar.com/avatar/746a625a9264a203a6ddf711e0c6b120?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" width="24" height="24" />                        Dylan Anderson                    </a>
                </div><div class="posts-buttons" align="right"><span class="action-date action-reply-edit" data-id="64159" data-toggle="modal" data-target="#historyModal">
                edited <span>Aug '20</span>
              </span><br/><a name="C64159" href="#C64159">
                <time itemprop="dateCreated" datetime="2020-08-30T23:47:27-07:00" class="action-date">Aug '20</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><blockquote>
<p>Ok, I built a little more robust script:</p>
<pre><code class="language-php">$DI = new \Phalcon\DI\FactoryDefault();

$DI-&gt;set('multi',function(){
   return (object)['name'=&gt;'multi','time'=&gt;microtime(TRUE)];
});
$DI-&gt;setShared('singleton',function(){
   return (object)['name'=&gt;'singleton','time'=&gt;microtime(TRUE)];
});
$DI-&gt;setShared('shared',function(){
   return (object)['name'=&gt;'shared','time'=&gt;microtime(TRUE)];
});

echo '&lt;pre&gt;';
print_r($DI-&gt;get('multi'));
usleep(1000);
print_r($DI-&gt;get('multi'));
usleep(1000);
print_r($DI-&gt;get('singleton'));
usleep(1000);
print_r($DI-&gt;get('singleton'));
usleep(1000);
print_r($DI-&gt;getSingleton());
usleep(1000);
print_r($DI-&gt;getShared('shared'));
usleep(1000);
print_r($DI-&gt;getShared('shared'));
echo '&lt;/pre&gt;';  </code></pre>
<p>And got this output:</p>
<pre><code>stdClass Object
(
   [name] =&gt; multi
   [time] =&gt; 1591049103.716
)
stdClass Object
(
   [name] =&gt; multi
   [time] =&gt; 1591049103.7171
)
stdClass Object
(
   [name] =&gt; singleton
   [time] =&gt; 1591049103.7182
)
stdClass Object
(
   [name] =&gt; singleton
   [time] =&gt; 1591049103.7182
)
stdClass Object
(
   [name] =&gt; singleton
   [time] =&gt; 1591049103.7182
)
stdClass Object
(
   [name] =&gt; shared
   [time] =&gt; 1591049103.7214
)
stdClass Object
(
   [name] =&gt; shared
   [time] =&gt; 1591049103.7214
)</code></pre>
<p>As you can see, the timestamps on the second invocation of both the <code>singleton</code> and <code>shared</code> service don't change, showing that the service creation function isn't being called on subsequent calls to <code>get()</code>.  </p>
<p>The important difference between my first and second script is the second script returns an object from the creation function.  Phalcon must store that internally - thus if a creation function doesn't return an object, there's nothing to store, so Phalcon calls the function again on subsequent calls to <code>get()</code></p>
<p>Could you post the code that registers the service and the test code you've written? <a href="https://www.walgreenslistens.mobi/">Walgreens Listens</a></p>
</blockquote>
<p>Thanks, very impressive. Really I appreciate you to continue your work.  thank you for helping</p></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="64159" data-cf-modified-04c52a4c4e26e70cc129c6bc-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="64159" data-cf-modified-04c52a4c4e26e70cc129c6bc-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
    </div>
</div>
<div class="row"><div class="col-md-1 small" align="center"></div>
        <div class="col-md-11 login-comment">
            
        </div></div>
</div><input type="hidden" id="post-id" name="post-id" value="20663" /><div id="suggested-posts"></div>
    <div id="sticky-progress" style='display:none'></div>
</div>
    </div>