---
layout: default
title: '[2.0.10] PHQL Join With Subquery - Discussion'
---

    <div class="container">
        {% include warning.html %}


<div itemscope itemtype="http://schema.org/Question"><ol class="breadcrumb">
    <li><a href="/">Home</a></li>
    <li><a href="/category/29/database">Database</a></li>
</ol>
<div class="row table-title">
    <div class="col-lg-8 col-md-7 col-sm-6 col-xs-12 wrapper-author">
        <h1 class="" itemprop="name">[2.0.10] PHQL Join With Subquery</h1>
        <div class="visible-xs-block mobile-author">
            <span itemprop="author" itemscope itemtype="http://schema.org/Person"><a href="/user/3576/rkeplin" class="user-moderator-N"><span itemprop="name">Rob</span></a></span>
            <time itemprop="dateCreated" datetime="2016-06-30T07:04:12-07:00">Jun '16</time>
        </div>
    </div>
    <div class="col-lg-4 col-md-5 col-sm-6 hidden-xs text-right wrapper-stats">
        <table class="table-stats" width="100%">
            <tr style="vertical-align: top;">
                <td>
                    <label>Created</label><br>
                    <time itemprop="dateCreated" datetime="2016-06-30T07:04:12-07:00">Jun '16</time>
                </td>
                <td>
                    <label>Last Reply</label><br>Jul '16</td>
                <td>
                    <label>Replies</label><br>
                    <span itemprop="answerCount">3</span>
                </td>
                <td>
                    <label>Views</label><br>851</td>
                <td>
                    <label>Votes</label><br>
                    <span itemprop="upvoteCount">0</span>
                </td>
            </tr>
        </table>
    </div>
</div>
<div class="discussion">
        <div class="row reply-block">
            <div class="col-md-1 col-sm-1 hidden-xs text-center">
                <img src="https://secure.gravatar.com/avatar/05b196967e6d529da34c125a4567b641?s=48&amp;r=pg&amp;d=identicon" class="img-rounded avatar" /><br>
                <span itemprop="author" itemscope itemtype="http://schema.org/Person" class="avatar-name"><a href="/user/3576/rkeplin" class="user-moderator-N"><span itemprop="name">Rob</span></a></span>
                <span class="karma">3.6k</span>
            </div>
            <div class="col-md-11 col-sm-11 col-xs-12 post-body"><div class="posts-date hidden-xs" align="right">
        <a name="C11977" href="#C11977">
        <time class="action-date">Jun '16</time>
    </a>
</div>
<div class="post-content"><div><p>I heard that as of Phalcon 2.0.2, PHQL supports subqueries.  I am receiving an error while joining on a subquery.  Is this case not supported?  I am using Phalcon 2.0.10</p>
<p><strong>PHQL:</strong>
<code>SELECT invoice.* FROM \Domain\Model\Invoice invoice LEFT JOIN (SELECT payment.invoiceId FROM \Domain\Model\Payment payment GROUP BY payment.invoiceId) paymentsum ON paymentsum.invoiceId = invoice.id</code></p>
<p><strong>Error:</strong>
<code>Syntax error, unexpected token SELECT, near to ' payment.invoiceId FROM \\Domain\\Model\\Payment payment GROUP BY payment.invoiceId paymentsum ON paymentsum.invoiceId = invoice.id', when parsing: SELECT invoice.* FROM \\Domain\\Model\\Invoice invoice LEFT JOIN SELECT payment.invoiceId FROM \\Domain\\Model\\Payment payment GROUP BY payment.invoiceId paymentsum ON paymentsum.invoiceId = invoice.id (196)</code></p></div>                </div>

                <div class="posts-buttons text-right"><a href="#"  class="btn btn-danger btn-xs" data-cf-modified-9485009963f05117faf3c281-="">
        <span class="glyphicon glyphicon-thumbs-down"></span></a>
    <a href="#"  class="btn btn-success btn-xs" data-cf-modified-9485009963f05117faf3c281-="">
        <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
            </div>
        </div><div itemprop="suggestedAnswer acceptedAnswer" itemscope itemtype="http://schema.org/Answer" class="reply-block row reply-accepted">
    <div class="col-md-1 small" align="center">
        <img src="https://secure.gravatar.com/avatar/8da15621865643112c6e3243f2ce4ebe?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="http://schema.org/Person">
            <a href="/user/3812/Jurigag" class="user-moderator-Y"><span itemprop="name">Wojciech Ślawski</span></a>        </span>
        <br>

        <span class="karma">145.0k</span><div class="accepted-reply">
                <span class="glyphicon glyphicon-ok"></span>
                Accepted<br>answer
            </div></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><span class="action-date action-reply-edit" data-id="36205" data-toggle="modal" data-target="#historyModal">
                edited <span>Jul '16</span>
              </span><br/><a name="C36205" href="#C36205">
                <time itemprop="dateCreated" datetime="2016-07-01T02:06:09-07:00" class="action-date">Jul '16</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>Yes, it's supporting subqueries but not in this case. Only in select(that we can subselect something). Soory for that. But this join looks kind of weird, is something like this even working in raw sql ?</p></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="36205" data-cf-modified-9485009963f05117faf3c281-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="36205" data-cf-modified-9485009963f05117faf3c281-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
    </div>
</div>
<div itemprop="suggestedAnswer" itemscope itemtype="http://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img src="https://secure.gravatar.com/avatar/05b196967e6d529da34c125a4567b641?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="http://schema.org/Person">
            <a href="/user/3576/rkeplin" class="user-moderator-N"><span itemprop="name">Rob</span></a>        </span>
        <br>

        <span class="karma">3.6k</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><span class="action-date action-reply-edit" data-id="36221" data-toggle="modal" data-target="#historyModal">
                edited <span>Jul '16</span>
              </span><br/><a name="C36221" href="#C36221">
                <time itemprop="dateCreated" datetime="2016-07-01T06:48:27-07:00" class="action-date">Jul '16</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>Yes.  My example above could be rewritten without the SELECT in the JOIN.  However, I am working on something that requires gathering a separate SUM  from two separate tables.</p>
<p>For exmple, I have an invoice table, payments table and invoice_item table.   I would like to get the invoices along with the sum of the payments and the sum of the invoice_item's prices.</p>
<p>The accepted answer <a href="http://stackoverflow.com/questions/12207200/mysql-join-with-multiple-tables-and-sums">here</a>  helped me come up with the query.</p>
<p>Since it's not supported in PHQL, my solution is just executing this as Raw SQL.</p></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="36221" data-cf-modified-9485009963f05117faf3c281-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="36221" data-cf-modified-9485009963f05117faf3c281-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
    </div>
</div>
<div itemprop="suggestedAnswer" itemscope itemtype="http://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img src="https://secure.gravatar.com/avatar/8da15621865643112c6e3243f2ce4ebe?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="http://schema.org/Person">
            <a href="/user/3812/Jurigag" class="user-moderator-Y"><span itemprop="name">Wojciech Ślawski</span></a>        </span>
        <br>

        <span class="karma">145.0k</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><a name="C36223" href="#C36223">
                <time itemprop="dateCreated" datetime="2016-07-01T07:10:03-07:00" class="action-date">Jul '16</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>Imho i think it can be done justi in select, not sure why you need it in join.</p></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="36223" data-cf-modified-9485009963f05117faf3c281-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="36223" data-cf-modified-9485009963f05117faf3c281-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
    </div>
</div>
<div itemprop="suggestedAnswer" itemscope itemtype="http://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img src="https://secure.gravatar.com/avatar/05b196967e6d529da34c125a4567b641?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="http://schema.org/Person">
            <a href="/user/3576/rkeplin" class="user-moderator-N"><span itemprop="name">Rob</span></a>        </span>
        <br>

        <span class="karma">3.6k</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><span class="action-date action-reply-edit" data-id="36233" data-toggle="modal" data-target="#historyModal">
                edited <span>Jul '16</span>
              </span><br/><a name="C36233" href="#C36233">
                <time itemprop="dateCreated" datetime="2016-07-01T08:48:49-07:00" class="action-date">Jul '16</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>I thought so too at first, but was not able to come up with anything.  Here is a more accurate example of what I am trying to accomplish.   Any suggestions on rewriting the query are welcome. </p>
<pre><code class="language-php">&lt;?php
$db = new PDO(
    sprintf('mysql:host=%s;dbname=%s', '127.0.0.1', 'test'),
    'root',
    ''
);
$db-&gt;setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);

$sql = '
DROP TABLE IF EXISTS `invoices`;
CREATE TABLE `invoices` (
  `id` INT UNSIGNED NOT NULL AUTO_INCREMENT,
  `name` VARCHAR(45) NULL,
  PRIMARY KEY (`id`)
);
INSERT INTO invoices (name) VALUES ("Invoice #1"), ("Invoice #2");
';
$db-&gt;exec($sql);

$sql = '
DROP TABLE IF EXISTS `items`;
CREATE TABLE `items` (
  `id` INT UNSIGNED NOT NULL AUTO_INCREMENT,
  `invoiceId` INT NOT NULL,
  `price` DOUBLE NOT NULL DEFAULT 0,
  PRIMARY KEY (`id`)
);
INSERT INTO items (invoiceId, price) VALUES (1, 10), (1, 15), (1, 15), (2, 5), (2, 10)
';
$db-&gt;exec($sql);

$sql = '
DROP TABLE IF EXISTS `payments`;
CREATE TABLE `payments` (
  `id` INT UNSIGNED NOT NULL AUTO_INCREMENT,
  `invoiceId` INT NOT NULL,
  `amount` DOUBLE NOT NULL DEFAULT 0,
  PRIMARY KEY (`id`)
);
INSERT INTO payments (invoiceId, amount) VALUES (1, 5), (1, 10), (2, 5)
';
$db-&gt;exec($sql);

$sql = '
SELECT invoices.name, paymentsum.payments, itemsum.subtotal
FROM invoices
LEFT JOIN (
   SELECT items.invoiceId, SUM(items.price) AS subtotal FROM items GROUP BY items.invoiceId
) itemsum ON itemsum.invoiceId = invoices.id
LEFT JOIN (
   SELECT payments.invoiceId, SUM(payments.amount) AS payments FROM payments GROUP BY payments.invoiceId
) paymentsum ON paymentsum.invoiceId = invoices.id
';

$records = $db-&gt;query($sql)-&gt;fetchAll();

foreach ($records as $record) {
    echo $record['name'] . ' - Item Total: ' . $record['subtotal'] . ' | Payments: ' . $record['payments'] . "\r\n";
}</code></pre>
<p><strong>Output:</strong></p>
<p>Invoice #1 - Item Total: 40 | Payments: 15</p>
<p>Invoice #2 - Item Total: 15 | Payments: 5</p></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="36233" data-cf-modified-9485009963f05117faf3c281-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="36233" data-cf-modified-9485009963f05117faf3c281-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
    </div>
</div>
<div itemprop="suggestedAnswer" itemscope itemtype="http://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img src="https://secure.gravatar.com/avatar/8da15621865643112c6e3243f2ce4ebe?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="http://schema.org/Person">
            <a href="/user/3812/Jurigag" class="user-moderator-Y"><span itemprop="name">Wojciech Ślawski</span></a>        </span>
        <br>

        <span class="karma">145.0k</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><a name="C36247" href="#C36247">
                <time itemprop="dateCreated" datetime="2016-07-01T10:42:32-07:00" class="action-date">Jul '16</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>You can do raw sql in phalcon.</p></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="36247" data-cf-modified-9485009963f05117faf3c281-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="36247" data-cf-modified-9485009963f05117faf3c281-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
    </div>
</div>
<div class="row"><div class="col-md-1 small" align="center"></div>
        <div class="col-md-11 login-comment">
            
        </div></div>
</div><input type="hidden" id="post-id" name="post-id" value="11977" /><div id="suggested-posts"></div>
    <div id="sticky-progress" style='display:none'></div>
</div>
    </div>