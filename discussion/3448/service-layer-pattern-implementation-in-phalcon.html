---
layout: default
title: 'service layer pattern implementation in Phalcon - Discussion'
---

    <div class="container">
        {% include warning.html %}


<div itemscope itemtype="https://schema.org/Question"><ol class="breadcrumb">
    <li><a href="/">Home</a></li>
    <li><a href="/category/1/mvc">MVC</a></li>
</ol>
<div class="row table-title">
    <div class="col-lg-8 col-md-7 col-sm-6 col-xs-12 wrapper-author">
        <h1 class="" itemprop="name">service layer pattern implementation in Phalcon</h1>
        <div class="visible-xs-block mobile-author">
            <span itemprop="author" itemscope itemtype="https://schema.org/Person"><a href="/user/1487/Conradaek" class="user-moderator-N"><span itemprop="name">Conradaek</span></a></span>
            <time itemprop="dateCreated" datetime="2014-09-15T02:23:04-07:00">Sep '14</time>
        </div>
    </div>
    <div class="col-lg-4 col-md-5 col-sm-6 hidden-xs text-right wrapper-stats">
        <table class="table-stats" width="100%">
            <tr style="vertical-align: top;">
                <td>
                    <label>Created</label><br>
                    <time itemprop="dateCreated" datetime="2014-09-15T02:23:04-07:00">Sep '14</time>
                </td>
                <td>
                    <label>Last Reply</label><br>Sep '14</td>
                <td>
                    <label>Replies</label><br>
                    <span itemprop="answerCount">3</span>
                </td>
                <td>
                    <label>Views</label><br>3029</td>
                <td>
                    <label>Votes</label><br>
                    <span itemprop="upvoteCount">0</span>
                </td>
            </tr>
        </table>
    </div>
</div>
<div class="discussion">
        <div class="row reply-block">
            <div class="col-md-1 col-sm-1 hidden-xs text-center">
                <img src="https://secure.gravatar.com/avatar/24e438429d975d345e4f99e53b740150?s=48&amp;r=pg&amp;d=identicon" class="img-rounded avatar" /><br>
                <span itemprop="author" itemscope itemtype="https://schema.org/Person" class="avatar-name"><a href="/user/1487/Conradaek" class="user-moderator-N"><span itemprop="name">Conradaek</span></a></span>
                <span class="karma">26.3k</span>
            </div>
            <div class="col-md-11 col-sm-11 col-xs-12 post-body"><div class="posts-date hidden-xs" align="right">
        <a name="C3448" href="#C3448">
        <time class="action-date">Sep '14</time>
    </a>
</div>
<div class="post-content"><div><p>I have looked at the GitHub examples at <a href="https://github.com/phalcon/mvc/tree/master/multiple-service-layer-model"><a href="https://github.com/phalcon/mvc/tree/master/multiple-service-layer-model">https://github.com/phalcon/mvc/tree/master/multiple-service-layer-model</a></a>. There is a service layer pattern implementation but it is very simple. It does not perform any real operation - because of that it looks a little bit abstract (contrary to other Phalcon's valueable examples like vokuro, invo etc).  </p>
<p>Does anyone can provide any code of implementation of the service layer pattern in Phalcon? I mean the code that actually do something? Some GitHub's repo? Some articles? Fragments (even small) of your own code?</p>
<p>I know this forum might not be the best place to look for information how service layer shoud be implemented but I have read some articles recently and still have problems how it should be done good under Phalcon. Thanks a lot in advance!</p></div>                </div>

                <div class="posts-buttons text-right"><a href="#"  class="btn btn-danger btn-xs" data-cf-modified-0f98b20e03590c965b8e309f-="">
        <span class="glyphicon glyphicon-thumbs-down"></span></a>
    <a href="#"  class="btn btn-success btn-xs" data-cf-modified-0f98b20e03590c965b8e309f-="">
        <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
            </div>
        </div><div itemprop="suggestedAnswer" itemscope itemtype="https://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img src="https://secure.gravatar.com/avatar/5d6f567f9109789fd9f702959768e35d?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="https://schema.org/Person">
            <a href="/user/1/phalcon" class="user-moderator-Y"><span itemprop="name">Phalcon</span></a>        </span>
        <br>

        <span class="karma">98.9k</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><a name="C11313" href="#C11313">
                <time itemprop="dateCreated" datetime="2014-09-15T02:35:54-07:00" class="action-date">Sep '14</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>What problems are you having with that example? It just use a common directory for models that can be used between modules</p></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="11313" data-cf-modified-0f98b20e03590c965b8e309f-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="11313" data-cf-modified-0f98b20e03590c965b8e309f-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
    </div>
</div>
<div itemprop="suggestedAnswer" itemscope itemtype="https://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img src="https://secure.gravatar.com/avatar/24e438429d975d345e4f99e53b740150?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="https://schema.org/Person">
            <a href="/user/1487/Conradaek" class="user-moderator-N"><span itemprop="name">Conradaek</span></a>        </span>
        <br>

        <span class="karma">26.3k</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><span class="action-date action-reply-edit" data-id="11315" data-toggle="modal" data-target="#historyModal">
                edited <span>Sep '14</span>
              </span><br/><a name="C11315" href="#C11315">
                <time itemprop="dateCreated" datetime="2014-09-15T03:18:24-07:00" class="action-date">Sep '14</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>A little misunderstanding. I don't have any problems with that example at all! ;)</p>
<p>I have found lot of articles about the service layer pattern in the Internet. The problem is they are all <strong>theoretical</strong> and my mind is messed up. I am trying to figure out how this pattern should be implemented <strong>in practice</strong>. I would like to see how <strong>real</strong> tasks are performed within this pattern under PHP MVC framework. The best would be Phalcon as this is the only framework I have ever used.</p></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="11315" data-cf-modified-0f98b20e03590c965b8e309f-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="11315" data-cf-modified-0f98b20e03590c965b8e309f-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
    </div>
</div>
<div itemprop="suggestedAnswer" itemscope itemtype="https://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img src="https://secure.gravatar.com/avatar/758de2db098b8bbb31a3b1bd37e2b028?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="https://schema.org/Person">
            <a href="/user/185/nazwa" class="user-moderator-N"><span itemprop="name">nazwa</span></a>        </span>
        <br>

        <span class="karma">15.1k</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><span class="action-date action-reply-edit" data-id="11488" data-toggle="modal" data-target="#historyModal">
                edited <span>Sep '14</span>
              </span><br/><a name="C11488" href="#C11488">
                <time itemprop="dateCreated" datetime="2014-09-21T21:53:00-07:00" class="action-date">Sep '14</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>We have recently rewritten out project to use the service layer approach, mostly based on the github example form your link. The basic project structure is similar, but slightly modified to better fit a medium size project - <a href="https://u.mdfz.pl/image/2Q030D103Y1l">screenshot</a></p>
<p>The service loader is once again, is once again a modified version from the example.</p>
<pre><code class="language-php">abstract class Services
{
    private static $registry = null;

    public static function getService($name)
    {
        if( self::$registry == null) {
             self::$registry = new \Phalcon\Registry();
             //self::$registry = new \Phalcon\DI();
        }

        if( !isset(self::$registry-&gt;{$name})) { 
            $className = "\\Xxx\\Services\\Service\\{$name}";

            if ( ! class_exists($className)) {
                throw new Exceptions\InvalidServiceException("Class {$className} doesn't exists.");
            }
            self::$registry-&gt;{$name} = new $className();
        }

        return self::$registry-&gt;{$name};
    }

        /**
    * Returns account service
    *
    * @return \Xxx\Services\Service\Account
    */
    public static function getAccountService()
    {
        return self::getService('account');
    }

    (...)
}</code></pre>
<p>Identical function is used for loading model repositories and with all logic being moved to services, actions become really small. </p>
<p>All services throw a common ‘control’ exception in case of an error, which is then caught and converted into a user friendly response – JSON in this case.
We also have a bunch of helper function for getting the most popular services (like <code>Services::getAccountService()</code> ), but they serve purely aesthetic purpose for IDE autocomplete to work correctly :)  </p>
<pre><code class="language-php">    public function checkEmailAction() {
        try {
            Services::getAccountService()-&gt;checkEmail($this-&gt;request);
        } catch (InternalServiceException $e) {
            $this-&gt;returnErrorResponse($e-&gt;getMessage());
        }            
    }</code></pre>
<p>Hope this helps a bit. Let me know if you’d like some more info!</p></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="11488" data-cf-modified-0f98b20e03590c965b8e309f-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="11488" data-cf-modified-0f98b20e03590c965b8e309f-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span><span itemprop="upvoteCount">1</span></a></div>
    </div>
</div>
<div itemprop="suggestedAnswer" itemscope itemtype="https://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img src="https://secure.gravatar.com/avatar/d0d38bb2fe6ddd4995064a1a9d911328?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="https://schema.org/Person">
            <a href="/user/656/brandonlamb" class="user-moderator-N"><span itemprop="name">Brandon Lamb</span></a>        </span>
        <br>

        <span class="karma">2.3k</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><span class="action-date action-reply-edit" data-id="11667" data-toggle="modal" data-target="#historyModal">
                edited <span>Sep '14</span>
              </span><br/><a name="C11667" href="#C11667">
                <time itemprop="dateCreated" datetime="2014-09-28T10:09:43-07:00" class="action-date">Sep '14</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p><strong>Disclaimers</strong></p>
<ol>
<li>Not a CS graduate, just self taught since 1999</li>
<li>Not an expert on design patterns/principles, just try my best</li>
<li>Have spent the last year building out an &quot;onion architecture&quot; based RESTful codebase</li>
</ol>
<p><strong>Main Components</strong></p>
<ul>
<li>Controllers (resources)</li>
<li>Services (Service Pattern, Service Facade, Boundary)</li>
<li>Repositories (Repository Pattern, DAO - Data Access Object)</li>
<li>Queries (to keep repos a bit cleaner we push out ORM query builder creation to individual query classes)</li>
<li>Entity (model, entity - represents a row in a table)</li>
<li>DTO and assemblers (Data Transfer Object)</li>
<li>Request / Response Mappers (turn DTO into a json/xml object)</li>
<li>Factories (Factory Pattern, Factory Method Pattern)</li>
</ul>
<p><strong>DI / SL / IoC</strong></p>
<p>Dependency Injection, Service Locator, Inversion of Control.</p>
<p>We currently use Phalcon\Di as a service locator. This is an anti-pattern however. We have factories and the normal request, response, dispatcher framework components loaded using closures (lazy loading).</p>
<p>We are currently in the process of switching to a DI container that recursively builds out dependencies using constructor injection.</p>
<p>An example:</p>
<pre><code class="language-php">$di-&gt;set('queryFactory', function () use ($di) {
    return new \Example\Query\Factory($di);
}, true);</code></pre>
<p>A service factory would then be injected with the DIC so it can use it to load up service objects.</p>
<p><strong> Namespaces </strong></p>
<p>We have our code organized as such:</p>
<ul>
<li>Example\Controller\UserController, Example\Controller\User\AddressController</li>
<li>Example\Service\UserService, Example\Service\User\AddressService</li>
<li>Example\Repository\UserRepo, Example\Repository\User\AddressRepository</li>
<li>Example\Query\UserQuery, Example\Query\User\AddressQuery</li>
<li>Example\Dto\UserDto, Example\Dto\User\AddressDto</li>
<li>Example\Entity\UserEntity, Example\Entity\User\AddressEntity</li>
</ul>
<p>Some factories:</p>
<ul>
<li>Example\Service\Factory</li>
<li>Example\Repository\Factory</li>
<li>Example\Query\Factory</li>
<li>Example\Dto\Factory</li>
<li>Example\Entity\Factory</li>
</ul>
<p><strong> Services </strong></p>
<p>Services are called from controllers. We aim for thin controllers. An example might look like below (formatting for brevity, not PSR standards). Services are responsible for business logic, filtering, validation, etc.</p>
<pre><code class="language-php">namespace Example\Controller;
class UserController extends BaseController {
    /** GET /users/{id} */
    public function getInstance() {
        // access service factory
        $user = $this-&gt;serviceFactory
            // create a service, the context is "user" which just maps to a class via yaml config
            -&gt;create('user')
                // call the service-&gt;findById() and pass in the id from route match
                -&gt;findById($this-&gt;dispatcher-&gt;getParam('id', 'int'));
    }
}</code></pre>
<p>The service probably looks like:</p>
<pre><code class="language-php">namespace Example\Service;
class UserService  {
    public function findById($id) {
        // do some business stuff
        if (!$this-&gt;isValidId($id)) { throw Exception; }
        // userRepo is injected or retrieved from service locator
        return $this-&gt;userRepo-&gt;findById($id);
    }
}</code></pre>
<p><strong> Repositories </strong></p>
<p>Also DAO I guess? Repository is responsible for talking to database layer.</p>
<p>To keep repository methods smaller, we break out bigger query building code into query classes when appropriate.</p>
<pre><code class="language-php">namespace Example\Repository;
class UserRepo  {
    public function findById($id) {
        // queryFactory is injected or retrieved via service locator
        return $this-&gt;queryFactory
            // user query factory to return a UserQuery object
            -&gt;create('user')
                // pass the id to the query object, real implementation could vary
                -&gt;set('id', $id)
                    // the build method just creates a QueryBuilder object (ORM) and returns it
                    -&gt;build();
    }
}</code></pre>
<p><strong> Conclusion </strong></p>
<p>You can probably figure out where the rest of this is going. Some of the design principle stuff we tried to go with was avoiding &quot;new Blah&quot; dependencies in our code (hence factories for everything). </p>
<p>We are also working on switching from service location to injection (better testability).</p>
<p>Things we make big attempts to avoid - singletons, static methods/properties, hard coding of class names, follow PSR standards</p>
<p><strong> PhalconPHP Components </strong></p>
<p>Off the top of my head, we use these:</p>
<ul>
<li>Di</li>
<li>Dispatcher</li>
<li>Controller</li>
<li>Http Request and Response</li>
<li>Class autoloader</li>
<li>File logger</li>
<li>Filter/validator</li>
</ul></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="11667" data-cf-modified-0f98b20e03590c965b8e309f-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="11667" data-cf-modified-0f98b20e03590c965b8e309f-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span><span itemprop="upvoteCount">1</span></a></div>
    </div>
</div>
<div class="row"><div class="col-md-1 small" align="center"></div>
        <div class="col-md-11 login-comment">
            
        </div></div>
</div><input type="hidden" id="post-id" name="post-id" value="3448" /><div id="suggested-posts"></div>
    <div id="sticky-progress" style='display:none'></div>
</div>
    </div>