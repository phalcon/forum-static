---
layout: default
title: 'phpunit tests failing with &quot;invalid superglobal&quot; exception - Discussion'
---

    <div class="container">
        {% include warning.html %}


<div itemscope itemtype="http://schema.org/Question"><ol class="breadcrumb">
    <li><a href="/">Home</a></li>
    <li><a href="/category/5/general">General</a></li>
</ol>
<div class="row table-title">
    <div class="col-lg-8 col-md-7 col-sm-6 col-xs-12 wrapper-author">
        <h1 class="" itemprop="name">phpunit tests failing with &quot;invalid superglobal&quot; exception</h1>
        <div class="visible-xs-block mobile-author">
            <span itemprop="author" itemscope itemtype="http://schema.org/Person"><a href="/user/8847/sdragnev" class="user-moderator-N"><span itemprop="name">Stan</span></a></span>
            <time itemprop="dateCreated" datetime="2017-07-28T05:48:18-07:00">Jul '17</time>
        </div>
    </div>
    <div class="col-lg-4 col-md-5 col-sm-6 hidden-xs text-right wrapper-stats">
        <table class="table-stats" width="100%">
            <tr style="vertical-align: top;">
                <td>
                    <label>Created</label><br>
                    <time itemprop="dateCreated" datetime="2017-07-28T05:48:18-07:00">Jul '17</time>
                </td>
                <td>
                    <label>Last Reply</label><br>May '18</td>
                <td>
                    <label>Replies</label><br>
                    <span itemprop="answerCount">4</span>
                </td>
                <td>
                    <label>Views</label><br>1214</td>
                <td>
                    <label>Votes</label><br>
                    <span itemprop="upvoteCount">0</span>
                </td>
            </tr>
        </table>
    </div>
</div>
<div class="discussion">
        <div class="row reply-block">
            <div class="col-md-1 col-sm-1 hidden-xs text-center">
                <img src="https://secure.gravatar.com/avatar/09ad3e138c7f9a313d38eea4ea79bfc1?s=48&amp;r=pg&amp;d=identicon" class="img-rounded avatar" /><br>
                <span itemprop="author" itemscope itemtype="http://schema.org/Person" class="avatar-name"><a href="/user/8847/sdragnev" class="user-moderator-N"><span itemprop="name">Stan</span></a></span>
                <span class="karma">2.1k</span>
            </div>
            <div class="col-md-11 col-sm-11 col-xs-12 post-body"><div class="posts-date hidden-xs" align="right">
        <a name="C16607" href="#C16607">
        <time class="action-date">Jul '17</time>
    </a>
</div>
<div class="post-content"><div><p>I recently updated phalcon on a project that I hadn't looked at for a while (running on 3.0) and now the unit tests which ran before are failing with a &quot;Exception: Invalid superglobal&quot; error.</p>
<p>I'm extending the incubator's UnitTestCase and adding some more services to the DI.
The DI is visible and accessible in the unit tests but doesn't exist in the code the tests are calling.</p>
<p>So for example, I would be testing a class which extends Component which would use $this-&gt;session to get the session service. During the test however that variable does not exist resulting in the invalid superglobal error.</p>
<p>I'm using a test helper file as described in the docs to load up a config, register namespaces and include the incubator. All the classes are included and executed fine; the only issue is the lack of those services in the app code extending Component...</p>
<p>Thanks!</p></div>                </div>

                <div class="posts-buttons text-right"><a href="#"  class="btn btn-danger btn-xs" data-cf-modified-1aa8eddb0c3a204f377aa5d0-="">
        <span class="glyphicon glyphicon-thumbs-down"></span></a>
    <a href="#"  class="btn btn-success btn-xs" data-cf-modified-1aa8eddb0c3a204f377aa5d0-="">
        <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
            </div>
        </div><div itemprop="suggestedAnswer" itemscope itemtype="http://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img src="https://secure.gravatar.com/avatar/e551053274114c51c47004223c8e65b3?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="http://schema.org/Person">
            <a href="/user/9839/ChangePlaces" class="user-moderator-N"><span itemprop="name">ChangePlaces</span></a>        </span>
        <br>

        <span class="karma">10.4k</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><a name="C49947" href="#C49947">
                <time itemprop="dateCreated" datetime="2017-07-29T06:35:41-07:00" class="action-date">Jul '17</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>Is the session being started?</p></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="49947" data-cf-modified-1aa8eddb0c3a204f377aa5d0-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="49947" data-cf-modified-1aa8eddb0c3a204f377aa5d0-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span><span itemprop="upvoteCount">1</span></a></div>
    </div>
</div>
<div itemprop="suggestedAnswer" itemscope itemtype="http://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img src="https://secure.gravatar.com/avatar/09ad3e138c7f9a313d38eea4ea79bfc1?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="http://schema.org/Person">
            <a href="/user/8847/sdragnev" class="user-moderator-N"><span itemprop="name">Stan</span></a>        </span>
        <br>

        <span class="karma">2.1k</span></div>
    <div class="col-md-11"><div class="in-reply-to">
                    <a href="#C49947"><span class="glyphicon glyphicon-chevron-up"></span> in reply to
                        <img src="https://secure.gravatar.com/avatar/e551053274114c51c47004223c8e65b3?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" width="24" height="24" />                        ChangePlaces                    </a>
                </div><div class="posts-buttons" align="right"><a name="C49999" href="#C49999">
                <time itemprop="dateCreated" datetime="2017-08-01T06:02:06-07:00" class="action-date">Aug '17</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>Yah, here's part of the code of the test class' setUp() function:</p>
<pre><code class="language-php">
$di-&gt;setShared('session', function () {
      $session = new SessionAdapter();
      $session-&gt;start();
      return $session;
    });
$this-&gt;setDI($di);
</code></pre>
<blockquote>
<p>Is the session being started?</p>
</blockquote></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="49999" data-cf-modified-1aa8eddb0c3a204f377aa5d0-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="49999" data-cf-modified-1aa8eddb0c3a204f377aa5d0-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
    </div>
</div>
<div itemprop="suggestedAnswer" itemscope itemtype="http://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img src="https://secure.gravatar.com/avatar/09ad3e138c7f9a313d38eea4ea79bfc1?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="http://schema.org/Person">
            <a href="/user/8847/sdragnev" class="user-moderator-N"><span itemprop="name">Stan</span></a>        </span>
        <br>

        <span class="karma">2.1k</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><a name="C50075" href="#C50075">
                <time itemprop="dateCreated" datetime="2017-08-04T12:14:39-07:00" class="action-date">Aug '17</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>I got it to work but I still don't know why this fixes it.</p>
<p><a href="https://forum.phalcon.io/user/0/ChangePlaces">@ChangePlaces</a>, your question made me doublecheck my assumption about the session so I found that despite doing $session-&gt;start, checking if $session-&gt;isStarted() in the test setup returned false.  There is no indication that anything failed so I don't know why it wouldn't have started. (this is the downside of not being able to trace through phalcon's code)</p>
<p>Next I tried registering the session adapter in the default DI in the helper file that phpunit uses to bootsrapt the tests (TestHelper.php).</p>
<pre><code class="language-php">$di = new FactoryDefault();

$di-&gt;setShared('session', function () {
  $session = new SessionAdapter();
  $session-&gt;start();
  return $session;
});</code></pre>
<p>This still didn't do it, so I doublechecked what's going on by adding:</p>
<pre><code class="language-php">$session = $di-&gt;get('session')-&gt;isStarted();</code></pre>
<p>Suddenly $session was <em>true</em> and my tests were working.</p>
<p>I still had to register the session in setUp() or my code didn't have the session global even though the session <em>technically</em> failed to start there.</p>
<p>I have no idea why it the session can't start in the test setup or why it needs to be asked whether it's alive before it is in TestHelper.php.
This is in php 7.0.7 btw and I know the tests used to work on php 5 (though it may have been an ealier version of phalcon as well.</p></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="50075" data-cf-modified-1aa8eddb0c3a204f377aa5d0-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="50075" data-cf-modified-1aa8eddb0c3a204f377aa5d0-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
    </div>
</div>
<div itemprop="suggestedAnswer" itemscope itemtype="http://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img src="https://secure.gravatar.com/avatar/877a54304e07c8cb38c47b43e1d6b6b3?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="http://schema.org/Person">
            <a href="/user/2828/sergeyklay" class="user-moderator-Y"><span itemprop="name">Serghei Iakovlev</span></a>        </span>
        <br>

        <span class="karma">39.2k</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><a name="C54841" href="#C54841">
                <time itemprop="dateCreated" datetime="2018-04-14T04:10:08-07:00" class="action-date">Apr '18</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>Please take a look at <a href="https://github.com/phalcon/zephir/issues/1623">https://github.com/phalcon/zephir/issues/1623</a></p></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="54841" data-cf-modified-1aa8eddb0c3a204f377aa5d0-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="54841" data-cf-modified-1aa8eddb0c3a204f377aa5d0-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
    </div>
</div>
<div itemprop="suggestedAnswer" itemscope itemtype="http://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img src="https://secure.gravatar.com/avatar/0828fbc874b3d01a4844719e5b270535?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="http://schema.org/Person">
            <a href="/user/9053/iamdann" class="user-moderator-N"><span itemprop="name">Daan</span></a>        </span>
        <br>

        <span class="karma">1.8k</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><a name="C55189" href="#C55189">
                <time itemprop="dateCreated" datetime="2018-05-04T03:35:15-07:00" class="action-date">May '18</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>A workaround for me was adding <code>stderr="true"</code> to my <code>phpunit.xml</code>. </p>
<p>However I'm migrating my tests to a Codeception testsuite in which the above no longer works. I'm getting the following error:</p>
<pre><code>1) AuthTest: Auth by valid id
 Test  tests/unit/AuthTest.php:authByValidId

  [Exception] Invalid superglobal  

/Users/daan/Sites/danq-cms/app/modules/admin/library/auth/Auth.php:266
/Users/daan/Sites/danq-cms/tests/unit/AuthTest.php:185
/Users/daan/Sites/danq-cms/vendor/phpunit/phpunit/src/Framework/TestCase.php:1145
/Users/daan/Sites/danq-cms/vendor/phpunit/phpunit/src/Framework/TestCase.php:840
/Users/daan/Sites/danq-cms/vendor/phpunit/phpunit/src/Framework/TestResult.php:645
/Users/daan/Sites/danq-cms/vendor/phpunit/phpunit/src/Framework/TestCase.php:798
/Users/daan/Sites/danq-cms/vendor/phpunit/phpunit/src/Framework/TestSuite.php:776
/Users/daan/Sites/danq-cms/vendor/codeception/phpunit-wrapper/src/Runner.php:114
/Users/daan/Sites/danq-cms/vendor/codeception/codeception/src/Codeception/SuiteManager.php:157
/Users/daan/Sites/danq-cms/vendor/codeception/codeception/src/Codeception/Codecept.php:189
/Users/daan/Sites/danq-cms/vendor/codeception/codeception/src/Codeception/Codecept.php:158
/Users/daan/Sites/danq-cms/vendor/codeception/codeception/src/Codeception/Command/Run.php:466
/Users/daan/Sites/danq-cms/vendor/codeception/codeception/src/Codeception/Command/Run.php:361
/Users/daan/Sites/danq-cms/vendor/symfony/console/Command/Command.php:252
/Users/daan/Sites/danq-cms/vendor/symfony/console/Application.php:865
/Users/daan/Sites/danq-cms/vendor/symfony/console/Application.php:241
/Users/daan/Sites/danq-cms/vendor/symfony/console/Application.php:143
/Users/daan/Sites/danq-cms/vendor/codeception/codeception/src/Codeception/Application.php:108
/Users/daan/Sites/danq-cms/vendor/codeception/codeception/package/bin:37
phar:///usr/local/bin/codecept/autoload.php:12
/usr/local/bin/codecept:5</code></pre>
<p>It fails on setting a session variable like so: <code>$this-&gt;session-&gt;set('key', 'value');</code>.</p>
<p>Any of you have a clue what is going wrong, I can't seem to find any info about this issue.</p></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="55189" data-cf-modified-1aa8eddb0c3a204f377aa5d0-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="55189" data-cf-modified-1aa8eddb0c3a204f377aa5d0-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
    </div>
</div>
<div itemprop="suggestedAnswer" itemscope itemtype="http://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img src="https://secure.gravatar.com/avatar/0828fbc874b3d01a4844719e5b270535?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="http://schema.org/Person">
            <a href="/user/9053/iamdann" class="user-moderator-N"><span itemprop="name">Daan</span></a>        </span>
        <br>

        <span class="karma">1.8k</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><a name="C55195" href="#C55195">
                <time itemprop="dateCreated" datetime="2018-05-04T06:19:21-07:00" class="action-date">May '18</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>Adding <code>backup_globals: false</code> to the <code>codeception.yml</code> seems to fix my issues..</p></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="55195" data-cf-modified-1aa8eddb0c3a204f377aa5d0-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="55195" data-cf-modified-1aa8eddb0c3a204f377aa5d0-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
    </div>
</div>
<div class="row"><div class="col-md-1 small" align="center"></div>
        <div class="col-md-11 login-comment">
            
        </div></div>
</div><input type="hidden" id="post-id" name="post-id" value="16607" /><div id="suggested-posts"></div>
    <div id="sticky-progress" style='display:none'></div>
</div>
    </div>