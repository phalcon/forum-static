---
layout: default
title: 'problem with security plugins - Discussion'
---

    <div class="container">
        {% include warning.html %}


<div itemscope itemtype="https://schema.org/Question"><ol class="breadcrumb">
    <li><a href="/">Home</a></li>
    <li><a href="/category/28/session">Session</a></li>
</ol>
<div class="row table-title">
    <div class="col-lg-8 col-md-7 col-sm-6 col-xs-12 wrapper-author">
        <h1 class="" itemprop="name">problem with security plugins</h1>
        <div class="visible-xs-block mobile-author">
            <span itemprop="author" itemscope itemtype="https://schema.org/Person"><a href="/user/3162/Graphmatic" class="user-moderator-N"><span itemprop="name">graphmatic</span></a></span>
            <time itemprop="dateCreated" datetime="2016-04-16T14:44:30-07:00">Apr '16</time>
        </div>
    </div>
    <div class="col-lg-4 col-md-5 col-sm-6 hidden-xs text-right wrapper-stats">
        <table class="table-stats" width="100%">
            <tr style="vertical-align: top;">
                <td>
                    <label>Created</label><br>
                    <time itemprop="dateCreated" datetime="2016-04-16T14:44:30-07:00">Apr '16</time>
                </td>
                <td>
                    <label>Last Reply</label><br>Apr '16</td>
                <td>
                    <label>Replies</label><br>
                    <span itemprop="answerCount">3</span>
                </td>
                <td>
                    <label>Views</label><br>810</td>
                <td>
                    <label>Votes</label><br>
                    <span itemprop="upvoteCount">0</span>
                </td>
            </tr>
        </table>
    </div>
</div>
<div class="discussion">
        <div class="row reply-block">
            <div class="col-md-1 col-sm-1 hidden-xs text-center">
                <img src="https://secure.gravatar.com/avatar/a20d655bbeff97e2c393510348ddb7cd?s=48&amp;r=pg&amp;d=identicon" class="img-rounded avatar" /><br>
                <span itemprop="author" itemscope itemtype="https://schema.org/Person" class="avatar-name"><a href="/user/3162/Graphmatic" class="user-moderator-N"><span itemprop="name">graphmatic</span></a></span>
                <span class="karma">11.6k</span>
            </div>
            <div class="col-md-11 col-sm-11 col-xs-12 post-body"><div class="posts-date hidden-xs" align="right">
        <a name="C11199" href="#C11199">
        <time class="action-date">Apr '16</time>
    </a>
</div>
<div class="post-content"><div><p>my application works well when I loggin then go to a controller page but as soon as I try to go back/refresh or click menu link to another controller, the app trigger &quot;$this-&gt;session-&gt;destroy();&quot; and apache log report &quot; the Trying to destroy uninitialized session in ..&quot; a lot of time.</p>
<p>my app was working properly before I implement layouts in volt...</p>
<p>some ideas?</p></div>                </div>

                <div class="posts-buttons text-right"><a href="#"  class="btn btn-danger btn-xs" data-cf-modified-1b7b71ae269869f1e25193bf-="">
        <span class="glyphicon glyphicon-thumbs-down"></span></a>
    <a href="#"  class="btn btn-success btn-xs" data-cf-modified-1b7b71ae269869f1e25193bf-="">
        <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
            </div>
        </div><div itemprop="suggestedAnswer" itemscope itemtype="https://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img src="https://secure.gravatar.com/avatar/34ef78e56d2941cf48ecc4ab24219c9a?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="https://schema.org/Person">
            <a href="/user/6699/aaronimming" class="user-moderator-N"><span itemprop="name">Aaron Imming</span></a>        </span>
        <br>

        <span class="karma">133</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><a name="C32637" href="#C32637">
                <time itemprop="dateCreated" datetime="2016-04-16T15:01:21-07:00" class="action-date">Apr '16</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>Can you post your Security Plugin code?</p></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="32637" data-cf-modified-1b7b71ae269869f1e25193bf-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="32637" data-cf-modified-1b7b71ae269869f1e25193bf-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
    </div>
</div>
<div itemprop="suggestedAnswer" itemscope itemtype="https://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img src="https://secure.gravatar.com/avatar/a20d655bbeff97e2c393510348ddb7cd?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="https://schema.org/Person">
            <a href="/user/3162/Graphmatic" class="user-moderator-N"><span itemprop="name">graphmatic</span></a>        </span>
        <br>

        <span class="karma">11.6k</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><a name="C32639" href="#C32639">
                <time itemprop="dateCreated" datetime="2016-04-16T15:39:59-07:00" class="action-date">Apr '16</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><pre><code class="language-php">&lt;?php
use Phalcon\Acl;
use Phalcon\Acl\Role;
use Phalcon\Acl\Resource;
use Phalcon\Events\Event;
use Phalcon\Mvc\User\Plugin;
use Phalcon\Mvc\Dispatcher;
use Phalcon\Acl\Adapter\Memory as AclList;
/**
 * SecurityPlugin
 *
 * This is the security plugin which controls that users only have access to the modules they're assigned to
 */
class SecurityPlugin extends Plugin
{
    /**
     * Returns an existing or new access control list
     *
     * @returns AclList
     */
    public function getAcl()
    {
        if (!isset($this-&gt;persistent-&gt;acl)) {
            $acl = new AclList();
            $acl-&gt;setDefaultAction(Acl::DENY);
            // Register roles
            $roles = [
                'salarie'  =&gt; new Role(
                    'salarie',
                    'accès limité.'
                ),
                'guests' =&gt; new Role(
                    'Guests',
                    'accès limité.'
                ),
                'admin' =&gt; new Role(
                    'admin',
                    'accès à l\'ensemble de l\'application.'
                ),
                'comptable' =&gt; new Role(
                    'comptable',
                    'accès au fonctions comptables de l\'application.'
                )
            ];
            foreach ($roles as $role) {
                $acl-&gt;addRole($role);
            }
            //Admin area resources
            $privateResources = array(
                'index'    =&gt; array('index', 'search', 'new', 'edit', 'save', 'create', 'delete'),
                'dashboard'   =&gt; array('index', 'search', 'new', 'edit', 'save', 'create', 'delete'),
                'clients' =&gt; array('index', 'search', 'nouveau', 'edit', 'save', 'creation', 'delete'),
                'articles' =&gt; array('index', 'search', 'new', 'edit', 'save', 'create', 'delete'),
                'parametres' =&gt; array('index', 'search', 'new', 'edit', 'save', 'create', 'delete'),
                'session'    =&gt; array('index', 'register', 'start', 'end'),

            );
            foreach ($privateResources as $resource =&gt; $actions) {
                $acl-&gt;addResource(new Resource($resource), $actions);
            }
            //Public area resources
            $publicResources = array(
                'index'      =&gt; array('index'),
                'about'      =&gt; array('index'),
                'errors'     =&gt; array('show401', 'show404', 'show500'),
                'session'    =&gt; array('index', 'register', 'start', 'end'),
                'contact'    =&gt; array('index', 'send')
            );
            foreach ($publicResources as $resource =&gt; $actions) {
                $acl-&gt;addResource(new Resource($resource), $actions);
            }
            //Grant access to public areas
            foreach ($roles as $role) {
                foreach ($publicResources as $resource =&gt; $actions) {
                    foreach ($actions as $action){
                        $acl-&gt;allow($role-&gt;getName(), $resource, $action);
                    }
                }
            }
            //Grant access to private area to role Users
            foreach ($privateResources as $resource =&gt; $actions) {
                foreach ($actions as $action){
                    $acl-&gt;allow('admin', $resource, $action);
                }
            }
            //The acl is stored in session, APC would be useful here too
            $this-&gt;persistent-&gt;acl = $acl;
        }
        return $this-&gt;persistent-&gt;acl;
    }
    /**
     * This action is executed before execute any action in the application
     *
     * @param Event $event
     * @param Dispatcher $dispatcher
     * @return bool
     */
    public function beforeDispatch(Event $event, Dispatcher $dispatcher)
    {
        $auth = $this-&gt;session-&gt;get('auth');
        if (!$auth){
            $role = 'Guests';
        } else {
            $role = $auth['role'];
        }
        $controller = $dispatcher-&gt;getControllerName();
        $action = $dispatcher-&gt;getActionName();
        $acl = $this-&gt;getAcl();
        if (!$acl-&gt;isResource($controller)) {
            $dispatcher-&gt;forward([
                'controller' =&gt; 'errors',
                'action'     =&gt; 'show404'
            ]);
            return false;
        }
        $allowed = $acl-&gt;isAllowed($role, $controller, $action);
        if ($allowed != Acl::ALLOW) {
            $dispatcher-&gt;forward(array(
                'controller' =&gt; 'errors',
                'action'     =&gt; 'show401'
            ));
            $this-&gt;session-&gt;destroy();
            return false;
        }
    }
}
</code></pre>
<p>I've now commented the '$this-&gt;session-&gt;destroy();' line and now it's works and ACL seems to are still working (i.e. protected pages are still not accessible as guest...)</p></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="32639" data-cf-modified-1b7b71ae269869f1e25193bf-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="32639" data-cf-modified-1b7b71ae269869f1e25193bf-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
    </div>
</div>
<div itemprop="suggestedAnswer" itemscope itemtype="https://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img src="https://secure.gravatar.com/avatar/1f92c8832155ca96cb3147af3cad27b0?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="https://schema.org/Person">
            <a href="/user/6311/davihu" class="user-moderator-N"><span itemprop="name">David Hübner</span></a>        </span>
        <br>

        <span class="karma">9.3k</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><a name="C32681" href="#C32681">
                <time itemprop="dateCreated" datetime="2016-04-18T03:26:57-07:00" class="action-date">Apr '16</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>Everytime an user has not priviledges you want to clear your persistent storage? This way evertime user access page without privs, he will be logged out. Is it really what you want?</p></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="32681" data-cf-modified-1b7b71ae269869f1e25193bf-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="32681" data-cf-modified-1b7b71ae269869f1e25193bf-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
    </div>
</div>
<div itemprop="suggestedAnswer" itemscope itemtype="https://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img src="https://secure.gravatar.com/avatar/a20d655bbeff97e2c393510348ddb7cd?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="https://schema.org/Person">
            <a href="/user/3162/Graphmatic" class="user-moderator-N"><span itemprop="name">graphmatic</span></a>        </span>
        <br>

        <span class="karma">11.6k</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><a name="C32693" href="#C32693">
                <time itemprop="dateCreated" datetime="2016-04-18T08:29:55-07:00" class="action-date">Apr '16</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>after a reboot of the staging server, I can uncomment the line and it re-work as expected...I can't say what happened, sorry..</p></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="32693" data-cf-modified-1b7b71ae269869f1e25193bf-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="32693" data-cf-modified-1b7b71ae269869f1e25193bf-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
    </div>
</div>
<div itemprop="suggestedAnswer" itemscope itemtype="https://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img src="https://secure.gravatar.com/avatar/1f92c8832155ca96cb3147af3cad27b0?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="https://schema.org/Person">
            <a href="/user/6311/davihu" class="user-moderator-N"><span itemprop="name">David Hübner</span></a>        </span>
        <br>

        <span class="karma">9.3k</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><a name="C32715" href="#C32715">
                <time itemprop="dateCreated" datetime="2016-04-19T00:03:19-07:00" class="action-date">Apr '16</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>Maybe some cache :)</p></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="32715" data-cf-modified-1b7b71ae269869f1e25193bf-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="32715" data-cf-modified-1b7b71ae269869f1e25193bf-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
    </div>
</div>
<div class="row"><div class="col-md-1 small" align="center"></div>
        <div class="col-md-11 login-comment">
            
        </div></div>
</div><input type="hidden" id="post-id" name="post-id" value="11199" /><div id="suggested-posts"></div>
    <div id="sticky-progress" style='display:none'></div>
</div>
    </div>