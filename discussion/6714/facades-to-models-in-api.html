---
layout: default
title: 'Facades to Models in API? - Discussion'
---

    <div class="container">
        {% include warning.html %}


<div itemscope itemtype="https://schema.org/Question"><ol class="breadcrumb">
    <li><a href="/">Home</a></li>
    <li><a href="/category/2/orm">ORM</a></li>
</ol>
<div class="row table-title">
    <div class="col-lg-8 col-md-7 col-sm-6 col-xs-12 wrapper-author">
        <h1 class="" itemprop="name">Facades to Models in API?</h1>
        <div class="visible-xs-block mobile-author">
            <span itemprop="author" itemscope itemtype="https://schema.org/Person"><a href="/user/2566/TrogWarZ" class="user-moderator-N"><span itemprop="name">Roman</span></a></span>
            <time itemprop="dateCreated" datetime="2015-05-12T09:48:54-07:00">May '15</time>
        </div>
    </div>
    <div class="col-lg-4 col-md-5 col-sm-6 hidden-xs text-right wrapper-stats">
        <table class="table-stats" width="100%">
            <tr style="vertical-align: top;">
                <td>
                    <label>Created</label><br>
                    <time itemprop="dateCreated" datetime="2015-05-12T09:48:54-07:00">May '15</time>
                </td>
                <td>
                    <label>Last Reply</label><br>May '15</td>
                <td>
                    <label>Replies</label><br>
                    <span itemprop="answerCount">1</span>
                </td>
                <td>
                    <label>Views</label><br>933</td>
                <td>
                    <label>Votes</label><br>
                    <span itemprop="upvoteCount">0</span>
                </td>
            </tr>
        </table>
    </div>
</div>
<div class="discussion">
        <div class="row reply-block">
            <div class="col-md-1 col-sm-1 hidden-xs text-center">
                <img  src="https://secure.gravatar.com/avatar/f14f7a0c1c40e4c1aee7f4c26287e5f6?s=48&amp;r=pg&amp;d=identicon" class="img-rounded avatar" /><br>
                <span itemprop="author" itemscope itemtype="https://schema.org/Person" class="avatar-name"><a href="/user/2566/TrogWarZ" class="user-moderator-N"><span itemprop="name">Roman</span></a></span>
                <span class="karma">21.7k</span>
            </div>
            <div class="col-md-11 col-sm-11 col-xs-12 post-body"><div class="posts-date hidden-xs" align="right">
        <a name="C6714" href="#C6714">
        <time class="action-date">May '15</time>
    </a>
</div>
<div class="post-content"><div><p>Hello!</p>
<p>I'm using Phalcon 2 and \Phalcon\Mvc\Micro as a start for my API and need best practices.</p>
<p>For example, i have models Users, Cars, Settings, Contacts. I need to give out a completely different (but stable) structure. Then, i think, i need some facade into Users model that covers all use cases like CRUD, advanced searching (by parameters too) and so on.</p>
<p>I've tried getters but they don't solve problem cuz i need to use normal models in code. Facade just for response to client. And (important!) able to create different independent facades for different clients (e.g., iOS app, website, smth else). Plus, i can in this case better optimize queries to database (if i know that i need user country and city on every request for iOS app only but not for website).</p>
<p>Right now i have method toAPI() in each model of my app when i'm doing it by my hand. This is problem cuz i need to proxy data from request into models from controllers and they are may be different. On the other hand, i'm trying to implement this logic in \App\Controllers\Rest (that is base for others excepth \App\Controllers\Auth and so on) but have too much duplicate code or too much complexity and very low readability, or too much is..else/switch..case.</p>
<p>How do you solve same problems? Maybe, Phalcon-specific library, book, example application source or smth similar?</p>
<p>Thanks in advance!</p>
<p>ps: sorry for my, possibly bad, english ):</p></div>                </div>

                <div class="posts-buttons text-right"><a href="#"  class="btn btn-danger btn-xs" data-cf-modified-5ba6e15f697caa86e7c1e8d7-="">
        <span class="glyphicon glyphicon-thumbs-down"></span></a>
    <a href="#"  class="btn btn-success btn-xs" data-cf-modified-5ba6e15f697caa86e7c1e8d7-="">
        <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
            </div>
        </div><div itemprop="suggestedAnswer" itemscope itemtype="https://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img  src="https://secure.gravatar.com/avatar/2e0bae293948bec8ffec40de279cbe41?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="https://schema.org/Person">
            <a href="/user/210/andresgutierrez" class="user-moderator-Y"><span itemprop="name">Andres Gutierrez</span></a>        </span>
        <br>

        <span class="karma">34.6k</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><a name="C18277" href="#C18277">
                <time itemprop="dateCreated" datetime="2015-05-13T07:27:19-07:00" class="action-date">May '15</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>For the sake of clarity, could you please post something of the code you're expecting to work?</p></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="18277" data-cf-modified-5ba6e15f697caa86e7c1e8d7-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="18277" data-cf-modified-5ba6e15f697caa86e7c1e8d7-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
    </div>
</div>
<div itemprop="suggestedAnswer" itemscope itemtype="https://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img  src="https://secure.gravatar.com/avatar/f14f7a0c1c40e4c1aee7f4c26287e5f6?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="https://schema.org/Person">
            <a href="/user/2566/TrogWarZ" class="user-moderator-N"><span itemprop="name">Roman</span></a>        </span>
        <br>

        <span class="karma">21.7k</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><span class="action-date action-reply-edit" data-id="18538" data-toggle="modal" data-target="#historyModal">
                edited <span>May '15</span>
              </span><br/><a name="C18538" href="#C18538">
                <time itemprop="dateCreated" datetime="2015-05-19T05:13:20-07:00" class="action-date">May '15</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>If we have User model with cars relation (one to many) then i need to send in response:</p>
<ul>
<li>Always attach cars array to user (but in code before response i don't need them at all)</li>
<li>Always send settings as key-value object, but Settings is another model with another fields (id, userId, key, value, status)</li>
<li>Send some fields in another format that used by internal code (e.g. send &quot;human readable&quot; datetime instead of iso8601, used everywhere in code)</li>
</ul>
<p>I need some facade/service that will allow me to set response logic inside it and not write garbase in models or controllers. Without them i got very strange and bad code ): Need help here.</p>
<p>Example.</p>
<pre><code class="language-php">class \Api\Models\Users extends \Phalcon\MVC\Model
{
    protected $id;
    protected $email;
    protected $username;
    protected $password;
    protected $status;
    protected $registered;

    const STATUS_ACTIVE = 1;
    const STATUS_DELETED = 0;

    /* bunch of setters/setters here like Users::getUsername() */

    public function getSettings()
    {
        $settings = Setting::find("userId = $this-&gt;id AND status = " . self::STATUS_ACTIVE);
        if (!$settings) return [];

        // What i need in internal code
        return $settings;

        // What users of my API expecting
        $map = [];
        foreach ($settings as $setting)
            $map[$setting-&gt;key] = $setting-&gt;value;
    }

    public function getRegistered()
    {
        // What i need in internal code
        return $this-&gt;registered;

        // What users of my API expecting
        // This may change fglobally for set of models or even set for every user differently
        return (new \DateTime($this-&gt;registered))-&gt;format(\DateTime::ISO8601);
    }

    public static function getFieldsVisibleForExternal()
    {
        return [
            // Own fields
            'username',
            'status',
            // Formatted
            'registered',
            // Relations
            'cars',
            'settings',
        ];
    }
}</code></pre>
<pre><code class="language-php">class \Api\Models\Settigs extends \Phalcon\MVC\Model
{
    protected $userId;
    protected $key;
    protected $value;
    protected $status;

    /* bunch of setters/setters here like Settings::getKey() */
}</code></pre>
<pre><code class="language-php">class \Api\Controllers\Users extends \Phalcon\Mvc\Controller
{
    public function search()
    {
        $carsFiltersAllowed = [
            'id' =&gt; 'int',
            'model' =&gt; ['trim', 'string'],
            'driver' =&gt; 'int',
        ];
        $carsFilters = [];
        foreach ($carsFiltersAllowed as $field =&gt; $type)
            $carsFilters[$field] = $this-&gt;request-&gt;get($field, $type);

        /* ... Users filters here too ... */

        // Now, getting data, yay!
        $users = Users::findByAttributes($filters);
        if (!$users) return [];

        // What i want to do
        return $users;

        // Or, maybe this?
        return $users-&gt;scope('external')-&gt;with(['cars', 'settings']);

        // What i need to do cuz users expecting another format )-:
        $totalUsersArray = [];
        foreach ($users as $user) {
            $tmp[] = $user-&gt;toArray();
            /**
             * I can't just use $user-&gt;cars because it will be empty after $user-&gt;toArray().
             *
             * Plus, there is strange behaviuor when i try to use this feature
             * Related: https://forum.phalcon.io/discussion/3867/preloading-model-relations
             * 
             * Also, Cars model can have same logic and i need to do something similar for them too
             * But not fall in recursion for $car-&gt;getDriver()!
             */
            $cars = $user-&gt;getCars($carsFilters);
            $tmp['cars'] = [];
            foreach ($cars as $car) {
                // Note that this same code will be used below (see comment there too)
                $tmp = $car-&gt;toArray();
                $carArray = [];
                foreach ($car::getFieldsVisibleForExternal() as $field)
                    $carArray[$car-&gt;id] = $tmp[$field];
                $tmp['cars'][$car-&gt;id] = $carArray;
            }

            // Getter solve this problem
            $tmp['setings'] = $user-&gt;getSettings();

            /**
             * Only whitelisted fields must be sent to response.
             * i can't use "$user-&gt;toArray(['settings'])" here
             * Because this will be empty )-:
             */
            $userArray = [];
            foreach ($user::getFieldsVisibleForExternal() as $field)
                $userArray[$user-&gt;id] = $tmp[$field];

            $totalUsersArray = $userArray;
        }

        // MAH AIS UR BLEEDING NOW
        return $totalUsersArray;
    }
}
</code></pre></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="18538" data-cf-modified-5ba6e15f697caa86e7c1e8d7-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="18538" data-cf-modified-5ba6e15f697caa86e7c1e8d7-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
    </div>
</div>
<div itemprop="suggestedAnswer acceptedAnswer" itemscope itemtype="https://schema.org/Answer" class="reply-block row reply-accepted">
    <div class="col-md-1 small" align="center">
        <img  src="https://secure.gravatar.com/avatar/f14f7a0c1c40e4c1aee7f4c26287e5f6?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="https://schema.org/Person">
            <a href="/user/2566/TrogWarZ" class="user-moderator-N"><span itemprop="name">Roman</span></a>        </span>
        <br>

        <span class="karma">21.7k</span><div class="accepted-reply">
                <span class="glyphicon glyphicon-ok"></span>
                Accepted<br>answer
            </div></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><a name="C36157" href="#C36157">
                <time itemprop="dateCreated" datetime="2016-06-29T07:30:25-07:00" class="action-date">Jun '16</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>Kinda old question but i use now <a href="https://github.com/thephpleague/fractal">Fractal from the Php League</a> that solves my issue.</p></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="36157" data-cf-modified-5ba6e15f697caa86e7c1e8d7-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="36157" data-cf-modified-5ba6e15f697caa86e7c1e8d7-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
    </div>
</div>
<div class="row"><div class="col-md-1 small" align="center"></div>
        <div class="col-md-11 login-comment">
            
        </div></div>
</div><input type="hidden" id="post-id" name="post-id" value="6714" /><div id="suggested-posts"></div>
    <div id="sticky-progress" style='display:none'></div>
</div>
    </div>