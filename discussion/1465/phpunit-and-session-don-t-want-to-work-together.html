---
layout: default
title: 'Phpunit and Session don&#039;t want to work together - Discussion'
---

    <div class="container">
        {% include warning.html %}


<div itemscope itemtype="http://schema.org/Question"><ol class="breadcrumb">
    <li><a href="/">Home</a></li>
    <li><a href="/category/5/general">General</a></li>
</ol>
<div class="row table-title">
    <div class="col-lg-8 col-md-7 col-sm-6 col-xs-12 wrapper-author">
        <h1 class="" itemprop="name">Phpunit and Session don&#039;t want to work together</h1>
        <div class="visible-xs-block mobile-author">
            <span itemprop="author" itemscope itemtype="http://schema.org/Person"><a href="/user/864/aledelgo" class="user-moderator-N"><span itemprop="name">Alessandro Del Gobbo</span></a></span>
            <time itemprop="dateCreated" datetime="2014-01-18T09:37:28-07:00">Jan '14</time>
        </div>
    </div>
    <div class="col-lg-4 col-md-5 col-sm-6 hidden-xs text-right wrapper-stats">
        <table class="table-stats" width="100%">
            <tr style="vertical-align: top;">
                <td>
                    <label>Created</label><br>
                    <time itemprop="dateCreated" datetime="2014-01-18T09:37:28-07:00">Jan '14</time>
                </td>
                <td>
                    <label>Last Reply</label><br>Jan '14</td>
                <td>
                    <label>Replies</label><br>
                    <span itemprop="answerCount">4</span>
                </td>
                <td>
                    <label>Views</label><br>4405</td>
                <td>
                    <label>Votes</label><br>
                    <span itemprop="upvoteCount">1</span>
                </td>
            </tr>
        </table>
    </div>
</div>
<div class="discussion">
        <div class="row reply-block">
            <div class="col-md-1 col-sm-1 hidden-xs text-center">
                <img src="https://secure.gravatar.com/avatar/034f62d4d9c606bf48823edfd1ce187b?s=48&amp;r=pg&amp;d=identicon" class="img-rounded avatar" /><br>
                <span itemprop="author" itemscope itemtype="http://schema.org/Person" class="avatar-name"><a href="/user/864/aledelgo" class="user-moderator-N"><span itemprop="name">Alessandro Del Gobbo</span></a></span>
                <span class="karma">17.8k</span>
            </div>
            <div class="col-md-11 col-sm-11 col-xs-12 post-body"><div class="posts-date hidden-xs" align="right">
        <a name="C1465" href="#C1465">
        <time class="action-date">Jan '14</time>
    </a>
</div>
<div class="post-content"><div><p>Hi all,
i've a problem testing my MVC project with phpunit (i use phpstorm as phpunit runner)</p>
<p>My apps use the Redis adapter as session adapter (a custom class inherited from the Redis adapter of the incubator) and works good in browser.
Unfortunately when i run tests with phpunit, session became empty... simply Redis don't receive any value.
I then discovered the session isn't started (isStarted in the tests return false).</p>
<p>I set the session in the DI that i create in setUp() function but i can't understand why it is not started.</p>
<p>do you have any solution?</p></div>                </div>

                <div class="posts-buttons text-right"><a href="#"  class="btn btn-danger btn-xs" data-cf-modified-5b2f011c554a902fcb99dfbf-="">
        <span class="glyphicon glyphicon-thumbs-down"></span></a>
    <a href="#"  class="btn btn-success btn-xs" data-cf-modified-5b2f011c554a902fcb99dfbf-="">
        <span class="glyphicon glyphicon-thumbs-up"></span><span itemprop="upvoteCount">1</span></a></div>
            </div>
        </div><div itemprop="suggestedAnswer" itemscope itemtype="http://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img src="https://secure.gravatar.com/avatar/034f62d4d9c606bf48823edfd1ce187b?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="http://schema.org/Person">
            <a href="/user/864/aledelgo" class="user-moderator-N"><span itemprop="name">Alessandro Del Gobbo</span></a>        </span>
        <br>

        <span class="karma">17.8k</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><a name="C5158" href="#C5158">
                <time itemprop="dateCreated" datetime="2014-01-18T11:26:41-07:00" class="action-date">Jan '14</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>Actually the only workaround i've found is to run php unit with the parameter --stderr .
Wondering if there is a better way.</p></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="5158" data-cf-modified-5b2f011c554a902fcb99dfbf-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="5158" data-cf-modified-5b2f011c554a902fcb99dfbf-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
    </div>
</div>
<div itemprop="suggestedAnswer" itemscope itemtype="http://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img src="https://secure.gravatar.com/avatar/7509b3e1d1db27db44d4f645e406ef45?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="http://schema.org/Person">
            <a href="/user/855/mikegioia" class="user-moderator-N"><span itemprop="name">Mike Gioia</span></a>        </span>
        <br>

        <span class="karma">3.9k</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><a name="C5164" href="#C5164">
                <time itemprop="dateCreated" datetime="2014-01-18T14:22:21-07:00" class="action-date">Jan '14</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>Hi Alessando -</p>
<p>I've tested both Redis and native sessions with PHPUnit and have both working without the stderr flag. In my unit test bootstrap file I call this right before \Phalcon\Di::setDefault( $di ):</p>
<pre><code class="language-php">if ( ! $di-&gt;getSession()-&gt;isStarted() ):
    $di-&gt;getSession()-&gt;start();
endif;</code></pre>
<p>The service itself calls $session-&gt;start() in the DI service registration callback but manually calling it this way seems to work. I also remember calling &quot;<a href="https://forum.phalcon.io/user/0/session">@session</a>_start()&quot; in the bootstrap and having that work too.</p>
<p>If none of this helps, could you post your code or a sample?</p></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="5164" data-cf-modified-5b2f011c554a902fcb99dfbf-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="5164" data-cf-modified-5b2f011c554a902fcb99dfbf-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
    </div>
</div>
<div itemprop="suggestedAnswer" itemscope itemtype="http://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img src="https://secure.gravatar.com/avatar/034f62d4d9c606bf48823edfd1ce187b?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="http://schema.org/Person">
            <a href="/user/864/aledelgo" class="user-moderator-N"><span itemprop="name">Alessandro Del Gobbo</span></a>        </span>
        <br>

        <span class="karma">17.8k</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><a name="C5195" href="#C5195">
                <time itemprop="dateCreated" datetime="2014-01-19T04:43:00-07:00" class="action-date">Jan '14</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>Well i moved back again the DI instantiation in the bootstrap file and there manually started the session. it simply worked and in the debug i can see the session is started.</p>
<p>But another problem i worked-around yesteday came up again now.
The problem is that the session test continue to fail as phpunit report the DI is not an object when i call -&gt;get(&quot;session&quot;).</p>
<p>Well i've investigated more on the issue, and the problem seems to be on the phpUnit execution...
The first time it execute a test (eg. test1) i see DI:getDefault() return my DI with the session shared service instantiated and started... but when it execute other tests methods  (eg. test2)  DI:getDefault() return NULL...
this is why yesterday i moved the DI initialization in the setUp method of a baseTestCase class ally my testcases inherit from...</p>
<p>setting backupGlobals and backupStaticAttributes in the phpunit xml config file haven't worked... on the contrart backupGlobals=true made phpunit raise serialization exceptions...</p>
<p>thanks for the help!</p></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="5195" data-cf-modified-5b2f011c554a902fcb99dfbf-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="5195" data-cf-modified-5b2f011c554a902fcb99dfbf-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
    </div>
</div>
<div itemprop="suggestedAnswer" itemscope itemtype="http://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img src="https://secure.gravatar.com/avatar/7509b3e1d1db27db44d4f645e406ef45?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="http://schema.org/Person">
            <a href="/user/855/mikegioia" class="user-moderator-N"><span itemprop="name">Mike Gioia</span></a>        </span>
        <br>

        <span class="karma">3.9k</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><a name="C5204" href="#C5204">
                <time itemprop="dateCreated" datetime="2014-01-19T14:42:45-07:00" class="action-date">Jan '14</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>Hi Alessandro, I share your pain in trying to get PHPUnit working correctly with Phalcon. I ran into the same problems with the DI is not an object. In my unit test bootstrap I instantiate my services and then call </p>
<p><code>php\Phalcon\DI::setDefault( $di );</code></p>
<p>In the UnitTestCase parent class, I have the following;</p>
<pre><code class="language-php">protected function setUp()
{
    $di = DI::getDefault();
    parent::setUp( $di );
    $this-&gt;_loaded = TRUE;
}</code></pre>
<p>This seems to work and allows me to continue to pass the default DI object into the parent's setUp. However, I cannot say for certain if this is the correct way to set up the DI with PHPUnit. I would greatly appreciate any code samples you might have or any new info you may have discovered.</p></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="5204" data-cf-modified-5b2f011c554a902fcb99dfbf-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="5204" data-cf-modified-5b2f011c554a902fcb99dfbf-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
    </div>
</div>
<div itemprop="suggestedAnswer" itemscope itemtype="http://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img src="https://secure.gravatar.com/avatar/034f62d4d9c606bf48823edfd1ce187b?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="http://schema.org/Person">
            <a href="/user/864/aledelgo" class="user-moderator-N"><span itemprop="name">Alessandro Del Gobbo</span></a>        </span>
        <br>

        <span class="karma">17.8k</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><a name="C5212" href="#C5212">
                <time itemprop="dateCreated" datetime="2014-01-20T02:04:44-07:00" class="action-date">Jan '14</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>Hi Mike! Thanks for your interest, I really feel better knowing i'm not the only one had pain on this subject!
Your code is exactly what i have in my project and it works only on the first test method called.
I investigated and when it run the first test, in the setUp  DI::getDefault(); return an object,
when the secont test method is called, DI::getDefault(); return null.
[Edit], i solved this problem, it was code i've inserted in my parent-parent test class to workaround another issue. It is a feature-lack of the Phalcon library, and i will open a new topic on this. To be short, there is no way to reset shared services dinamically in phalcon.</p>
<p>The only solution that has worked was that i had when i started the topic, that's to instantiate DI in the setUp method of the parent test case class so it created a new DI for each test-method run.
Obviously this solution  was not compatible with the session service initialization because phpunit run all tests in the same context and when session-&gt;start is called multiple time in the same context it raise errors... so i fixed this creating a test session class that store values in a temp file and replacing the standard session class (i use the Redis adapter) with the test-session class in the test setUp method. It's not very elegant and i think it could evolve the test project in something horrible and unmaintenable, but actually it worked .</p>
<p>The real problem with sessions and other request-context related problem is that phpunit run all test one after the another in the same context and especially with shared services there is no a real working way to reset it all for each method without involve workarounds and some strategy that increase code complexity. (i'm one of those that think that code (especially testing code) must be kept simple)
As emerged in other topics i've joined, i think the best solution to test controller's actions is actually to use acceptance test and reserve unit-test to services/library only where the developer has more control on requirements and can mock it all up in test methods.
Acceptance test are slower but they are run each in their own isolated context and well emulating user behavior.</p></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="5212" data-cf-modified-5b2f011c554a902fcb99dfbf-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="5212" data-cf-modified-5b2f011c554a902fcb99dfbf-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
    </div>
</div>
<div itemprop="suggestedAnswer" itemscope itemtype="http://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img src="https://secure.gravatar.com/avatar/7509b3e1d1db27db44d4f645e406ef45?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="http://schema.org/Person">
            <a href="/user/855/mikegioia" class="user-moderator-N"><span itemprop="name">Mike Gioia</span></a>        </span>
        <br>

        <span class="karma">3.9k</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><a name="C5219" href="#C5219">
                <time itemprop="dateCreated" datetime="2014-01-20T12:38:23-07:00" class="action-date">Jan '14</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>So I've spent a lot of time thinking about this stuff and I'm on the same page as you: (a) the DI services should be reset and loaded for each test, and (b) services should be &quot;stubbed&quot; for things like session, cookies, etc in the tests' setUp() when needed.</p>
<p>Nikos has a good example of loading services through a class (<a href="https://github.com/niden/phalcon-angular-harryhogfootball/blob/master/app/library/NDN/Bootstrap.php">https://github.com/niden/phalcon-angular-harryhogfootball/blob/master/app/library/NDN/Bootstrap.php</a>). I'm going to try to convert my boilerplate app to use this system for my unit tests and application. I can post an update here once I do if you're interested.</p>
<p>I'm thinking of moving my service registrations to a class that returns a \Phalcon\DI object. So the app's index.php will load this into $di, the unit tests will get a fresh copy of the DI object for each request, and the tests themselves can modify the DI object in their own setUp() method if I further need to stub any dependencies.</p></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="5219" data-cf-modified-5b2f011c554a902fcb99dfbf-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="5219" data-cf-modified-5b2f011c554a902fcb99dfbf-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
    </div>
</div>
<div itemprop="suggestedAnswer" itemscope itemtype="http://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img src="https://secure.gravatar.com/avatar/1eb2415bda000b22fd1f801bb9e8c003?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="http://schema.org/Person">
            <a href="/user/2/niden" class="user-moderator-Y"><span itemprop="name">Nikolaos Dimopoulos</span></a>        </span>
        <br>

        <span class="karma">39.3k</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><a name="C5220" href="#C5220">
                <time itemprop="dateCreated" datetime="2014-01-20T13:07:50-07:00" class="action-date">Jan '14</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>You can also see the same loader/bootstrap mechanism in the website repo (which powers the main website)</p>
<p><a href="https://github.com/phalcon/website/blob/master/app/var/bootstrap.php">https://github.com/phalcon/website/blob/master/app/var/bootstrap.php</a></p></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="5220" data-cf-modified-5b2f011c554a902fcb99dfbf-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="5220" data-cf-modified-5b2f011c554a902fcb99dfbf-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
    </div>
</div>
<div class="row"><div class="col-md-1 small" align="center"></div>
        <div class="col-md-11 login-comment">
            
        </div></div>
</div><input type="hidden" id="post-id" name="post-id" value="1465" /><div id="suggested-posts"></div>
    <div id="sticky-progress" style='display:none'></div>
</div>
    </div>