---
layout: default
title: 'phpunit: Phalcon\DI\Exception: Service &#039;db&#039; was not found in the dependency injection container - Discussion'
---

    <div class="container">
        {% include warning.html %}


<div itemscope itemtype="https://schema.org/Question"><ol class="breadcrumb">
    <li><a href="/">Home</a></li>
    <li><a href="/category/21/beginners">Beginners</a></li>
</ol>
<div class="row table-title">
    <div class="col-lg-8 col-md-7 col-sm-6 col-xs-12 wrapper-author">
        <h1 class="" itemprop="name">phpunit: Phalcon\DI\Exception: Service &#039;db&#039; was not found in the dependency injection container</h1>
        <div class="visible-xs-block mobile-author">
            <span itemprop="author" itemscope itemtype="https://schema.org/Person"><a href="/user/1017/baychae" class="user-moderator-N"><span itemprop="name">baychae</span></a></span>
            <time itemprop="dateCreated" datetime="2014-04-15T07:51:09-07:00">Apr '14</time>
        </div>
    </div>
    <div class="col-lg-4 col-md-5 col-sm-6 hidden-xs text-right wrapper-stats">
        <table class="table-stats" width="100%">
            <tr style="vertical-align: top;">
                <td>
                    <label>Created</label><br>
                    <time itemprop="dateCreated" datetime="2014-04-15T07:51:09-07:00">Apr '14</time>
                </td>
                <td>
                    <label>Last Reply</label><br>Apr '15</td>
                <td>
                    <label>Replies</label><br>
                    <span itemprop="answerCount">8</span>
                </td>
                <td>
                    <label>Views</label><br>4852</td>
                <td>
                    <label>Votes</label><br>
                    <span itemprop="upvoteCount">0</span>
                </td>
            </tr>
        </table>
    </div>
</div>
<div class="discussion">
        <div class="row reply-block">
            <div class="col-md-1 col-sm-1 hidden-xs text-center">
                <img  src="https://secure.gravatar.com/avatar/e1731ca2cc82170fb565554fd13b9f7c?s=48&amp;r=pg&amp;d=identicon" class="img-rounded avatar" /><br>
                <span itemprop="author" itemscope itemtype="https://schema.org/Person" class="avatar-name"><a href="/user/1017/baychae" class="user-moderator-N"><span itemprop="name">baychae</span></a></span>
                <span class="karma">47.7k</span>
            </div>
            <div class="col-md-11 col-sm-11 col-xs-12 post-body"><div class="posts-date hidden-xs" align="right">
        <a name="C2089" href="#C2089">
        <time class="action-date">Apr '14</time>
    </a>
</div>
<div class="post-content"><div><p>Hi,</p>
<p>In my phpunit tests I have a test helper where I load in my models.</p>
<pre><code class="language-php">// use the application autoloader to autoload the classes
// autoload the dependencies found in composer
$loader = new \Phalcon\Loader();

$loader-&gt;registerDirs(array(
    ROOT_PATH,
    PATH_CONFIG,
    PATH_MODELS
));

$loader-&gt;registerNamespaces(array(
    'Phalcon' =&gt; PATH_INCUBATOR.'Library/Phalcon/'
));

$loader-&gt;register();

$config = include PATH_CONFIG;

$di = new FactoryDefault();

DI::reset();

// add any needed services to the DI here
/**
     * Database connection is created based in the parameters defined in the configuration file
     */
    $di-&gt;set('db', function() use ($config) {
        return new \Phalcon\Db\Adapter\Pdo\Mysql(array(
            "host" =&gt; $config-&gt;database-&gt;host,
            "username" =&gt; $config-&gt;database-&gt;username,
            "password" =&gt; $config-&gt;database-&gt;password,
            "dbname" =&gt; $config-&gt;database-&gt;dbname
        ));
    });

DI::setDefault($di);</code></pre>
<p>I know this works as I can create a new model on which my other tests depend:</p>
<pre><code class="language-php">public function testCreateUser() {
        $user = new \Users();
        return $user;
    }</code></pre>
<p>My problem comes in when I attempt this:</p>
<pre><code class="language-php">$all_users = \Users::find();</code></pre>
<p>I get the following error:</p>
<blockquote>
<p>Phalcon\DI\Exception: Service 'db' was not found in the dependency injection container</p>
</blockquote>
<p>Can anyone help?</p></div>                </div>

                <div class="posts-buttons text-right"><a href="#"  class="btn btn-danger btn-xs" data-cf-modified-1a994b671df9b7adae611e7c-="">
        <span class="glyphicon glyphicon-thumbs-down"></span></a>
    <a href="#"  class="btn btn-success btn-xs" data-cf-modified-1a994b671df9b7adae611e7c-="">
        <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
            </div>
        </div><div itemprop="suggestedAnswer" itemscope itemtype="https://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img  src="https://secure.gravatar.com/avatar/30505176a836c2cadd5bcd08283e5c94?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="https://schema.org/Person">
            <a href="/user/696/sumeko" class="user-moderator-N"><span itemprop="name">Sum</span></a>        </span>
        <br>

        <span class="karma">16.3k</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><a name="C7238" href="#C7238">
                <time itemprop="dateCreated" datetime="2014-04-15T12:55:31-07:00" class="action-date">Apr '14</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>Why you add DI::reset();
and whats that?</p></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="7238" data-cf-modified-1a994b671df9b7adae611e7c-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="7238" data-cf-modified-1a994b671df9b7adae611e7c-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span><span itemprop="upvoteCount">1</span></a></div>
    </div>
</div>
<div itemprop="suggestedAnswer" itemscope itemtype="https://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img  src="https://secure.gravatar.com/avatar/e1731ca2cc82170fb565554fd13b9f7c?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="https://schema.org/Person">
            <a href="/user/1017/baychae" class="user-moderator-N"><span itemprop="name">baychae</span></a>        </span>
        <br>

        <span class="karma">47.7k</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><span class="action-date action-reply-edit" data-id="7256" data-toggle="modal" data-target="#historyModal">
                edited <span>Apr '14</span>
              </span><br/><a name="C7256" href="#C7256">
                <time itemprop="dateCreated" datetime="2014-04-16T03:14:38-07:00" class="action-date">Apr '14</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>I added DI::reset(); as it is given in the unit testing example in phalcon documentation <a href="https://docs.phalcon.io/en/latest/reference/unit-testing.html">here</a></p>
<p>I'm not sure what you are referring to when you say 'and whats that?'.</p>
<p>My guess is that DI::reset() nulls all values from the dependency injector container from memory before adding new stuff to the dependency injector to ensure the dependency injector is fresh. </p>
<p>The di is reset and set by class methods so I don't understand the issue.</p></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="7256" data-cf-modified-1a994b671df9b7adae611e7c-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="7256" data-cf-modified-1a994b671df9b7adae611e7c-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
    </div>
</div>
<div itemprop="suggestedAnswer" itemscope itemtype="https://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img  src="https://secure.gravatar.com/avatar/e1731ca2cc82170fb565554fd13b9f7c?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="https://schema.org/Person">
            <a href="/user/1017/baychae" class="user-moderator-N"><span itemprop="name">baychae</span></a>        </span>
        <br>

        <span class="karma">47.7k</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><a name="C7308" href="#C7308">
                <time itemprop="dateCreated" datetime="2014-04-17T08:08:14-07:00" class="action-date">Apr '14</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>Ok so I could get access to the database doing the following:</p>
<pre><code class="language-php">    $di = $this-&gt;getDI();
    $connection = $di-&gt;getDb();
    $result = $connection-&gt;fetchOne("SELECT * FROM UNIVERSE");</code></pre>
<p>But only in the same method where a newly created object model had been created.</p>
<p>To get the di in another test method I had to pass model object to the test method and get the db service from the model object.</p>
<pre><code class="language-php">    $di = $that-&gt;getDI();
    $connection = $di-&gt;getDb();
    $result = $connection-&gt;fetchOne("SELECT * FROM UNIVERSE");</code></pre>
<p>I might be missing the point but this is keeps things thread safe.</p></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="7308" data-cf-modified-1a994b671df9b7adae611e7c-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="7308" data-cf-modified-1a994b671df9b7adae611e7c-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
    </div>
</div>
<div itemprop="suggestedAnswer" itemscope itemtype="https://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img  src="https://secure.gravatar.com/avatar/c58542c4c2b9171a023c69e6711c16f1?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="https://schema.org/Person">
            <a href="/user/662/ogarbe" class="user-moderator-N"><span itemprop="name">Olivier.Garbé</span></a>        </span>
        <br>

        <span class="karma">24.1k</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><a name="C7315" href="#C7315">
                <time itemprop="dateCreated" datetime="2014-04-17T12:07:29-07:00" class="action-date">Apr '14</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>try to set your db as shared service :</p>
<pre><code class="language-php">$di-&gt;set('db', function() use ($config) {
        return new \Phalcon\Db\Adapter\Pdo\Mysql(array(
            "host" =&gt; $config-&gt;database-&gt;host,
            "username" =&gt; $config-&gt;database-&gt;username,
            "password" =&gt; $config-&gt;database-&gt;password,
            "dbname" =&gt; $config-&gt;database-&gt;dbname
        ));
    }, true);</code></pre></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="7315" data-cf-modified-1a994b671df9b7adae611e7c-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="7315" data-cf-modified-1a994b671df9b7adae611e7c-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span><span itemprop="upvoteCount">1</span></a></div>
    </div>
</div>
<div itemprop="suggestedAnswer" itemscope itemtype="https://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img  src="https://secure.gravatar.com/avatar/e1731ca2cc82170fb565554fd13b9f7c?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="https://schema.org/Person">
            <a href="/user/1017/baychae" class="user-moderator-N"><span itemprop="name">baychae</span></a>        </span>
        <br>

        <span class="karma">47.7k</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><span class="action-date action-reply-edit" data-id="7394" data-toggle="modal" data-target="#historyModal">
                edited <span>Apr '14</span>
              </span><br/><a name="C7394" href="#C7394">
                <time itemprop="dateCreated" datetime="2014-04-22T07:00:36-07:00" class="action-date">Apr '14</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>Ok so to be able to user $all_users = \Users::find() in tests that are after the first test (after the first tear down has executed after the di has been reset)</p>
<p>In the UnitTestCase class:</p>
<pre><code class="language-php">...
abstract class UnitTestCase extends PhalconTestCase...</code></pre>
<p>I have added:</p>
<pre><code class="language-php">use Phalcon\DI\FactoryDefault,
...</code></pre>
<pre><code class="language-php">...
$di = new FactoryDefault();        

$di-&gt;set('db', function() use ($config) {
    return new \Phalcon\Db\Adapter\Pdo\Mysql(array(
    "host" =&gt; $config-&gt;database-&gt;host,
    "username" =&gt; $config-&gt;database-&gt;username,
    "password" =&gt; $config-&gt;database-&gt;password,
    "dbname" =&gt; $config-&gt;database-&gt;dbname
));
...    </code></pre>
<p>The parent class setUp in incubator will see that the $di is not null and not attempt to create a new $di.</p></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="7394" data-cf-modified-1a994b671df9b7adae611e7c-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="7394" data-cf-modified-1a994b671df9b7adae611e7c-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
    </div>
</div>
<div itemprop="suggestedAnswer" itemscope itemtype="https://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img  src="https://secure.gravatar.com/avatar/06b4ea8468175ae04182e19621653ac6?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="https://schema.org/Person">
            <a href="/user/1535/stumpdk" class="user-moderator-N"><span itemprop="name">stumpdk</span></a>        </span>
        <br>

        <span class="karma">60</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><a name="C7459" href="#C7459">
                <time itemprop="dateCreated" datetime="2014-04-24T09:23:02-07:00" class="action-date">Apr '14</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>Hi baychae
Can you post the whole code?</p>
<p>I'm struggling with exactly the same problem, and can't find a solution. The database service is not registred in the dependency container....</p></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="7459" data-cf-modified-1a994b671df9b7adae611e7c-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="7459" data-cf-modified-1a994b671df9b7adae611e7c-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
    </div>
</div>
<div itemprop="suggestedAnswer" itemscope itemtype="https://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img  src="https://secure.gravatar.com/avatar/e1731ca2cc82170fb565554fd13b9f7c?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="https://schema.org/Person">
            <a href="/user/1017/baychae" class="user-moderator-N"><span itemprop="name">baychae</span></a>        </span>
        <br>

        <span class="karma">47.7k</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><span class="action-date action-reply-edit" data-id="7482" data-toggle="modal" data-target="#historyModal">
                edited <span>Apr '14</span>
              </span><br/><a name="C7482" href="#C7482">
                <time itemprop="dateCreated" datetime="2014-04-25T02:47:26-07:00" class="action-date">Apr '14</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>Apologies. I am following the phalcon phpunit testing docs here:</p>
<p><a href="https://docs.phalcon.io/en/latest/reference/unit-testing.html">https://docs.phalcon.io/en/latest/reference/unit-testing.html</a></p>
<p>So assuming you have installed phalcon incubator (mine is in my project)....</p>
<p>Here is my TestHelper.php as in the example:</p>
<p>I have loaded the config included it and used it to set the db service in the dependency injector.</p>
<pre><code class="language-php">&lt;?php
use Phalcon\DI,
    Phalcon\DI\FactoryDefault;

ini_set('display_errors',1);
error_reporting(E_ALL);

define('ROOT_PATH', __DIR__);
define('PATH_INCUBATOR', __DIR__ . '/../vendor/incubator/');
define('PATH_CONFIG', __DIR__ . '/../app/config/config.php');
define('PATH_MODELS', __DIR__ . '/../app/models/');

set_include_path(
    ROOT_PATH . PATH_SEPARATOR . get_include_path()
);

// use the application autoloader to autoload the classes
// autoload the dependencies found in composer
$loader = new \Phalcon\Loader();

$loader-&gt;registerDirs(array(
    ROOT_PATH,
    PATH_CONFIG,
    PATH_MODELS
));

$loader-&gt;registerNamespaces(array(
    'Phalcon' =&gt; PATH_INCUBATOR.'Library/Phalcon/'
));

$loader-&gt;register();

$config = include PATH_CONFIG;

$di = new FactoryDefault();

DI::reset();

// add any needed services to the DI here
/**
* Database connection is created based in the parameters defined in the configuration file
*/
$di-&gt;set('db', function() use ($config) {
       return new \Phalcon\Db\Adapter\Pdo\Mysql(array(
               "host" =&gt; $config-&gt;database-&gt;host,
               "username" =&gt; $config-&gt;database-&gt;username,
               "password" =&gt; $config-&gt;database-&gt;password,
               "dbname" =&gt; $config-&gt;database-&gt;dbname
       ));
},true);

DI::setDefault($di);</code></pre>
<p>Then in the UnitTestCase which extends the PhalconTestCase from incubator I have accessed the global  config which I use to set the dependency injector with the db service (this is so we can have the db service available in each and every test). </p>
<pre><code class="language-php">&lt;?php
    use Phalcon\DI,
    Phalcon\DI\FactoryDefault,
    \Phalcon\Test\UnitTestCase as PhalconTestCase;

abstract class UnitTestCase extends PhalconTestCase {

  /**
  * @var \Voice\Cache
  */
  protected $_cache;

  /**
  * @var \Phalcon\Config
  */
  protected $_config;

  /**
  * @var bool
  */
  private $_loaded = false;

  public function setUp(Phalcon\DiInterface $di = NULL, Phalcon\Config $config = NULL) {

    global $config;

    // Load any additional services that might be required during testing
    $di = DI::getDefault();

    $di = new FactoryDefault();        

    $di-&gt;set('db', function() use ($config) {
          return new \Phalcon\Db\Adapter\Pdo\Mysql(array(
          "host" =&gt; $config-&gt;database-&gt;host,
          "username" =&gt; $config-&gt;database-&gt;username,
          "password" =&gt; $config-&gt;database-&gt;password,
          "dbname" =&gt; $config-&gt;database-&gt;dbname
                ));
    });

    // get any DI components here. If you have a config, be sure to pass it to the parent
    parent::setUp($di,$config);

    $this-&gt;_loaded = true;
  }

  /**
  * Check if the test case is setup properly
  * @throws \PHPUnit_Framework_IncompleteTestError;
  */
  public function __destruct() {
      if(!$this-&gt;_loaded) {
      throw new \PHPUnit_Framework_IncompleteTestError('Please run parent::setUp().');
      }
    }
}</code></pre>
<p>My unit tests extend \UnitTestCase as defined above.</p>
<p>I can't recommend doing this. It might be better to setup a database adapter in the phpunit test itself.</p></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="7482" data-cf-modified-1a994b671df9b7adae611e7c-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="7482" data-cf-modified-1a994b671df9b7adae611e7c-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
    </div>
</div>
<div itemprop="suggestedAnswer" itemscope itemtype="https://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img  src="https://secure.gravatar.com/avatar/06b4ea8468175ae04182e19621653ac6?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="https://schema.org/Person">
            <a href="/user/1535/stumpdk" class="user-moderator-N"><span itemprop="name">stumpdk</span></a>        </span>
        <br>

        <span class="karma">60</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><a name="C7504" href="#C7504">
                <time itemprop="dateCreated" datetime="2014-04-26T15:54:19-07:00" class="action-date">Apr '14</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>Thank you very much for your code! It really helped me get on with the my tests.
Your code works just fine.</p>
<p>You can simplify it by removing the &quot;$di-&gt;set('db', function() use ($config) {...&quot; part from TestHelper.php.</p>
<p>I can't see any differences when I remove the code, but maybe I'm missing something?</p>
<p>Again, thanks alot!</p></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="7504" data-cf-modified-1a994b671df9b7adae611e7c-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="7504" data-cf-modified-1a994b671df9b7adae611e7c-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
    </div>
</div>
<div itemprop="suggestedAnswer" itemscope itemtype="https://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img  src="https://secure.gravatar.com/avatar/e1731ca2cc82170fb565554fd13b9f7c?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="https://schema.org/Person">
            <a href="/user/1017/baychae" class="user-moderator-N"><span itemprop="name">baychae</span></a>        </span>
        <br>

        <span class="karma">47.7k</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><a name="C7516" href="#C7516">
                <time itemprop="dateCreated" datetime="2014-04-28T01:50:23-07:00" class="action-date">Apr '14</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>You're welcome.</p>
<p>Yes removing the whole dependency injector setup worked for me. The $di must not be present in the TestHelper.php at all for my first test to run.</p>
<p>I now setup the $di wholly in the UnitTestCase.php:</p>
<p>This is what I removed in my test helper to get it to work:</p>
<pre><code class="language-php">$di = new FactoryDefault();

DI::reset();

// add any needed services to the DI here
/**
* Database connection is created based in the parameters defined in the configuration file
*/
$di-&gt;set('db', function() use ($config) {
       return new \Phalcon\Db\Adapter\Pdo\Mysql(array(
               "host" =&gt; $config-&gt;database-&gt;host,
               "username" =&gt; $config-&gt;database-&gt;username,
               "password" =&gt; $config-&gt;database-&gt;password,
               "dbname" =&gt; $config-&gt;database-&gt;dbname
       ));
});

DI::setDefault($di);</code></pre>
<p>This is what I have in my UnitTestCase.php:</p>
<pre><code class="language-php">    public function setUp(Phalcon\DiInterface $di = NULL, Phalcon\Config $config = NULL) {

        global $config;

        // Load any additional services that might be required during testing
        $di = DI::getDefault();

        $di = new FactoryDefault();        

        $di-&gt;setShared('db', function() use ($config) {
        return new \Phalcon\Db\Adapter\Pdo\Mysql(array(
            "host" =&gt; $config-&gt;database-&gt;host,
            "username" =&gt; $config-&gt;database-&gt;username,
            "password" =&gt; $config-&gt;database-&gt;password,
            "dbname" =&gt; $config-&gt;database-&gt;dbname
                        ));
        });

        // get any DI components here. If you have a config, be sure to pass it to the parent
        parent::setUp($di,$config);

        $this-&gt;_loaded = true;
    }</code></pre></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="7516" data-cf-modified-1a994b671df9b7adae611e7c-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span><span itemprop="downvoteCount">1</span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="7516" data-cf-modified-1a994b671df9b7adae611e7c-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
    </div>
</div>
<div itemprop="suggestedAnswer" itemscope itemtype="https://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img  src="https://secure.gravatar.com/avatar/adffc287ba07fb8de1466c5b31a2fba4?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="https://schema.org/Person">
            <a href="/user/2321/sententia" class="user-moderator-N"><span itemprop="name">Rhys Tague</span></a>        </span>
        <br>

        <span class="karma">65</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><a name="C11425" href="#C11425">
                <time itemprop="dateCreated" datetime="2014-09-18T07:23:30-07:00" class="action-date">Sep '14</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>Yes, putting the Dependency Injector in the Boostraper seems to cause a bit of a headache. The methods aren't accessible for some reason within the tests and the abstract <code>UnitTestCase.php</code> - well for me that is. <code>Phalcon\DI:getDefault()</code> should return your configured services from the bootstrap after you set the default because its in a global scope, however I'm thinking maybe it is the way PHPUnit deals with things between each test - who knows, someone out there does. Anyhow, after looking at the UnitTestCase file in the incubator it is a better approach to keep it within the abstract <code>setUp($di, $config)</code> function. Why? Well I find it a better design when it comes to inheritance.</p>
<p>Here is my setup:</p>
<p><code>TestHelper.php</code></p>
<pre><code class="language-php">
&lt;?php

ini_set('display_errors',1);
error_reporting(E_ALL);

define('ROOT_PATH', __DIR__);
define('MODEL_PATH', __DIR__ . '/../app/models/');

set_include_path(
    ROOT_PATH . PATH_SEPARATOR . get_include_path()
);
// Using the incubator
require __DIR__ . "/../../vendor/autoload.php";

$loader = new \Phalcon\Loader();
$loader-&gt;registerDirs(array(
    ROOT_PATH,
    MODEL_PATH
));
$loader-&gt;registerNamespaces(array(
    'App\Models' =&gt; '../models',
));
$loader-&gt;register();</code></pre>
<p>As you can see I've removed the Dependency Injector out of the bootstrap.</p>
<p><code>UnitTestCase.php</code></p>
<pre><code class="language-php">
&lt;?php
use Phalcon\DI,
       \Phalcon\Test\UnitTestCase as PhalconTestCase;

abstract class UnitTestCase extends PhalconTestCase {

    /**
     * @var \Voice\Cache
     */
    protected $_cache;

    /**
     * @var \Phalcon\Config
     */
    protected $_config;

    /**
     * @var bool
     */
    private $_loaded = false;

    /**
     * Default fixture for each test
     */
    public function setUp(Phalcon\DiInterface $di = NULL, Phalcon\Config $config = NULL) {
        if(is_null($di)) {
            $di = new Phalcon\DI\FactoryDefault();
        }
        // Load your additional dependencies and services here

        // We should check the config state also
        // We can put it into the DI also if we wanted to
        if(is_null($config)) {
            $this-&gt;_config = new Phalcon\Config\Adapter\Ini('../config.ini');
        } else {
            $this-&gt;_config = $config
        }

        // Set it as default if anything else uses the DI::getDefault() static method
        DI::setDefault($di);

        // Pass it up the chain
        parent::setUp($di, $this-&gt;_config);

        $this-&gt;_loaded = true;
    }

    /**
     * Check if the test case is setup properly
     * @throws \PHPUnit_Framework_IncompleteTestError;
     */
    public function __destruct() {
        if(!$this-&gt;_loaded) {
            throw new \PHPUnit_Framework_IncompleteTestError('Please run parent::setUp().');
        }
    }
}</code></pre>
<p>Here is a example test to see how you would use it</p>
<p><code>ExampleTest.php</code></p>
<pre><code class="language-php">&lt;?php

namespace App\Test;

use App\Models\TestModel;

class ExampleTest extends \UnitTestCase {

    public function setUp(\Phalcon\DiInterface $di = NULL, \Phalcon\Config $config = NULL) {
        // You now have the option. You can leave out this setUp to use the defaults
        // in the abstract class UnitTestCase.php call, however if this test has
        // specific requirements you can set a new DI with those services. Then when it gets 
        // passed up the inheritance chain the defaults will be applied. 
        $di = new \Phalcon\DI\FactoryDefault();
        $di-&gt;set('simple', function() {
            $simpleService = new stdClass();
            $simpleService-&gt;name = "Simple";
            return $simpleService;
        }

        // Here is where you take advantage of inheritance the use of the abstract object
        parent::($di, $config);
    }

    public function testTestCase() {
        $this-&gt;assertEquals('works', 'works', 'This is OK');
    }

    public function testHello() {
        $newTest = new TestModel();
        $newTest-&gt;hello('jim');
        $this-&gt;expectOutputString('Hello jim');

        // Let's test the DI with the new structure
        echo $this-&gt;di-&gt;get('config')-&gt;database-&gt;adapter;
        $this-&gt;expectOutputString('Mysql');

        echo $this-&gt;di-&gt;get('simple')-&gt;name;
        $this-&gt;expectOutputString('Simple');

    }
}</code></pre>
<p>This works perfect for me and allows me to change my fixtures to the way I wan instead of throwing everthing in the abstract class. Hope this helps someone!</p></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="11425" data-cf-modified-1a994b671df9b7adae611e7c-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="11425" data-cf-modified-1a994b671df9b7adae611e7c-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
    </div>
</div>
<div itemprop="suggestedAnswer" itemscope itemtype="https://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img  src="https://secure.gravatar.com/avatar/25213d39268bdd01324dd00aa8470f31?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="https://schema.org/Person">
            <a href="/user/2487/nilsm" class="user-moderator-N"><span itemprop="name">Nils Millahn</span></a>        </span>
        <br>

        <span class="karma">552</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><span class="action-date action-reply-edit" data-id="12297" data-toggle="modal" data-target="#historyModal">
                edited <span>Oct '14</span>
              </span><br/><a name="C12297" href="#C12297">
                <time itemprop="dateCreated" datetime="2014-10-17T08:49:09-07:00" class="action-date">Oct '14</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>I'd like to expand on Rhys' answer above in case it helps others.</p>
<p>Phalcon's UnitTestCase seems to remove all DI services in the setUp() function, so you have to recreate them in your own setUp() function. But you don't have to fetch a new FactoryDefault DI as well, Phalcon's UnitTestCase does that for you and you can access the DI via $this-&gt;di.</p>
<p>My own setup is like this:</p>
<p>A basic TestCase which only pulls in the config file:</p>
<pre><code class="language-php">abstract class TestCase extends \Phalcon\Test\UnitTestCase {
    public function setUp(\Phalcon\DiInterface $di = NULL, \Phalcon\Config $config = NULL) {
        parent::setUp($di, $config);

        if(is_null($config))
        {
            $config = new \Phalcon\Config\Adapter\Ini('../config.ini');
        }
        $this-&gt;di-&gt;set('config', $config);
    }
}</code></pre>
<p>A basic TestCaseDb which also injects a database connector:</p>
<pre><code class="language-php">abstract class TestCaseDb extends TestCase {

    /**
     * Default fixture for each test
     */
    public function setUp(\Phalcon\DiInterface $di = NULL, \Phalcon\Config $config = NULL) {
        parent::setUp($di, $config);

        // db
        $dbConfig = $this-&gt;di-&gt;get('config')-&gt;database;
        $this-&gt;di-&gt;set('db', function() use ($dbConfig) {
              return new \Phalcon\Db\Adapter\Pdo\Mysql(array(
              'host' =&gt; $dbConfig-&gt;host,
              'username' =&gt; $dbConfig-&gt;username,
              'password' =&gt; $dbConfig-&gt;password,
              'dbname' =&gt; $dbConfig-&gt;name,
              'options' =&gt; array(
                \PDO::MYSQL_ATTR_INIT_COMMAND =&gt; 'SET NAMES utf8',
                \PDO::ATTR_EMULATE_PREPARES  =&gt; false,
                \PDO::ATTR_STRINGIFY_FETCHES =&gt; false,
              )
            ));
          }, true);
        $this-&gt;di-&gt;set('modelsManager', function() {
          return new \Phalcon\Mvc\Model\Manager();
        });

        $this-&gt;di-&gt;set('modelsMetadata', function() {
          return new \Phalcon\Mvc\Model\Metadata\Memory();
        });
    }
}</code></pre>
<p>The config file looks like this:</p>
<pre><code>[database]
host     = localhost
username = test
password = test
name     = testdb</code></pre>
<p>And then you simply extend either TestCase or TestCaseDb, depending on whether you need database access in your tests or not.</p></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="12297" data-cf-modified-1a994b671df9b7adae611e7c-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="12297" data-cf-modified-1a994b671df9b7adae611e7c-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
    </div>
</div>
<div itemprop="suggestedAnswer" itemscope itemtype="https://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img  src="https://secure.gravatar.com/avatar/e5b9449555b2fabf1a8b56c801c9945b?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="https://schema.org/Person">
            <a href="/user/1342/loleksy" class="user-moderator-N"><span itemprop="name">loleksy</span></a>        </span>
        <br>

        <span class="karma">82</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><span class="action-date action-reply-edit" data-id="12995" data-toggle="modal" data-target="#historyModal">
                edited <span>Nov '14</span>
              </span><br/><a name="C12995" href="#C12995">
                <time itemprop="dateCreated" datetime="2014-11-10T10:10:05-07:00" class="action-date">Nov '14</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>Hi, today I have same problem. Tests were working perfectly on earlier versions.
I moved project to new server, updated Phalcon and incubator and here I come.</p>
<p>Currently, DI is reset on every test method finish.</p>
<pre><code>protected function tearDown()
{
    $di = $this-&gt;getDI();
    $di::reset();
    parent::tearDown();
}</code></pre>
<p>Sorce taken from<a href="https://github.com/phalcon/incubator/blob/master/Library/Phalcon/Test/UnitTestCase.php"> github</a>.</p>
<p>If you want to have shared DI in all tests, you can use my workaround. Just redeclare tearDown in your UnitTestCase class. Call second parent and ignore above code:</p>
<pre><code>protected function tearDown()
{
   \PHPUnit_Framework_TestCase::tearDown();
}</code></pre></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="12995" data-cf-modified-1a994b671df9b7adae611e7c-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="12995" data-cf-modified-1a994b671df9b7adae611e7c-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
    </div>
</div>
<div itemprop="suggestedAnswer" itemscope itemtype="https://schema.org/Answer" class="reply-block row">
    <div class="col-md-1 small" align="center">
        <img  src="https://secure.gravatar.com/avatar/b52c43b0b233d4aac50998c0d2f13e9a?s=48&amp;r=pg&amp;d=identicon" class="img-rounded" />        <br>

        <span itemprop="author" itemscope itemtype="https://schema.org/Person">
            <a href="/user/3685/mattvb91" class="user-moderator-N"><span itemprop="name">Matthias von Bargen</span></a>        </span>
        <br>

        <span class="karma">3.0k</span></div>
    <div class="col-md-11"><div class="posts-buttons" align="right"><a name="C17639" href="#C17639">
                <time itemprop="dateCreated" datetime="2015-04-25T02:33:52-07:00" class="action-date">Apr '15</time>
            </a>
        </div>
        <div class="post-content"><div itemprop="text"><p>I am having the exact same issue with the Model::findFirst function but just using it inside a controller?</p>
<p><a href="https://https://forum.phalcon.io/discussion/6439/service-db-was-not-found">Any help?</a></p></div></div>
        <div class="posts-buttons" align="right"><a href="#"  class="btn btn-danger btn-xs vote-login" data-id="17639" data-cf-modified-1a994b671df9b7adae611e7c-="">
                    <span class="glyphicon glyphicon-thumbs-down"></span></a>
                <a href="#"  class="btn btn-success btn-xs vote-login" data-id="17639" data-cf-modified-1a994b671df9b7adae611e7c-="">
                    <span class="glyphicon glyphicon-thumbs-up"></span></a></div>
    </div>
</div>
<div class="row"><div class="col-md-1 small" align="center"></div>
        <div class="col-md-11 login-comment">
            
        </div></div>
</div><input type="hidden" id="post-id" name="post-id" value="2089" /><div id="suggested-posts"></div>
    <div id="sticky-progress" style='display:none'></div>
</div>
    </div>